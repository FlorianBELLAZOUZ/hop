#!/bin/sh
#*=====================================================================*/
#*    serrano/prgm/project/hop/configure                               */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Sat Jul 31 06:49:37 2004                          */
#*    Last change :  Thu Jul 20 15:37:33 2006 (serrano)                */
#*    Copyright   :  2004-06 Manuel Serrano                            */
#*    -------------------------------------------------------------    */
#*    HOP autoconfiguration                                            */
#*=====================================================================*/

#*---------------------------------------------------------------------*/
#*    User flags                                                       */
#*---------------------------------------------------------------------*/
prefix=/usr/local

bigloo=bigloo
afile=bglafile
jfile=bgljfile
btags=bgltags
bdepend=bgldepend
cc=
backend=native
unzip=unzip
jar="jar cfm"

bcflags="-fsharing -Wall -wslots -L \$(BUILDLIBDIR)"

bcflagsdbg="-g -O2"
bcflagsbmem="-g2 -O2"
bcflagsopt="-unsafe -O3"

blflags="-copt \$(CPICFLAGS)"

mimetypes=/etc/mime.types

#*---------------------------------------------------------------------*/
#*    Private variables                                                */
#*---------------------------------------------------------------------*/
version="1.4.1"
devel=pre

url="http://hop.inria.fr/"

etcdir=$prefix/etc
bindir=$prefix/bin;
libdir=$prefix/lib
sharedir=$prefix/share/hop
webletsdir=
contribsdir=$prefix/share/hop/contribs
buildlibdir=$PWD/lib
buildsharedir=$PWD/share
distribdir=$HOME/prgm/distrib
buildbindir=$PWD/bin

repository=$HOME/prgm/project/hop/devel/repository

bigloorequired=2.8a
bigloourl=http://www.inria.fr/mimosa/fp/Bigloo

svn=ssh://hop@hop.inria.fr/hop

if [ $USER = "serrano" ]; then
  distribdir=$HOME/prgm/distrib
else
  distribdir=.
fi

# Argument parsing
while : ; do
  case $1 in
    "")
      break;;

    --prefix=*)
      prefix="`echo $1 | sed 's/^[^=]*=//'`";
      bindir=$prefix/bin;
      libdir=$prefix/lib;
      sharedir=$prefix/share/hop;
      etcdir=$prefix/etc;
      contribsdir=$prefix/share/hop/contribs;;

    --etcdir=*)
      etcdir="`echo $1 | sed 's/^[^=]*=//'`";;

    --bindir=*)
      bindir="`echo $1 | sed 's/^[^=]*=//'`";;

    --libdir=*)
      libdir="`echo $1 | sed 's/^[^=]*=//'`";;

    --sharedir=*)
      sharedir="`echo $1 | sed 's/^[^=]*=//'`";;

    --webletsdir=*)
      webletsdir="`echo $1 | sed 's/^[^=]*=//'`";;

    --contribsdir=*)
      contribsdir="`echo $1 | sed 's/^[^=]*=//'`";;

    --distribdir=*)
      distribdir="`echo $1 | sed 's/^[^=]*=//'`";;

    --mimetypes=*)
      mimetypes="`echo $1 | sed 's/^[^=]*=//'`";;

    --bigloo=*)
      bigloo="`echo $1 | sed 's/^[^=]*=//'`";;

    --backend=*)
      backend="`echo $1 | sed 's/^[^=]*=//'`";;

    --cigloo=*)
      cigloo="`echo $1 | sed 's/^[^=]*=//'`";;

    --afile=*)
      afile="`echo $1 | sed 's/^[^=]*=//'`";;

    --btags=*)
      btags="`echo $1 | sed 's/^[^=]*=//'`";;

    --bdepend=*)
      bdepend="`echo $1 | sed 's/^[^=]*=//'`";;

    --cc=*)
      cc="`echo $1 | sed 's/^[^=]*=//'`";;

    --bcflags=*)
      bcflags="`echo $1 | sed 's/^[-a-z]*=//'`";;

    --blflags=*)
      blflags="`echo $1 | sed 's/^[-a-z]*=//'`";;

    --bhflags=*)
      bhflags="`echo $1 | sed 's/^[-a-z]*=//'`";;

    --brflags=*)
      brflags="`echo $1 | sed 's/^[-a-z]*=//'`";;

    --ccflags=*)
      ccflags="`echo $1 | sed 's/^[-a-z]*=//'`";;

    --debug)
      bcflags="$bcflags $bcflagsdbg";;

    --bmem)
      bcflags="$bcflags $bcflagsbmem";;

    --optimize)
      bcflags="$bcflags $bcflagsopt";;

    -*)
      echo "*** Configure error, unknown option $1" >&2;
      echo >&2;
      echo "Usage: configure [options]" >&2;
      echo "   --prefix=dir.......... prefix to HOP install" >&2;
      echo "   --etcdir=dir.......... Hop etc directory" >&2;
      echo "   --bindir=dir.......... alternative Hop bin directory" >&2;
      echo "   --libdir=dir.......... alternative Hop lib directory" >&2;
      echo "   --sharedir=dir........ alternative Hop share directory" >&2;
      echo "   --webletsdir=dir...... alternative Hop weblets directory" >&2;
      echo "   --contribsdir=dir..... alternative Hop contribs directory" >&2;
      echo "   --mimetypes=file...... default mime.types file" >&2;
      echo "   --bigloo=comp......... The Bigloo compiler" >&2;
      echo "   --backend=backend..... The execution platform [native,jvm,dotnet]" >&2;
      echo "   --cigloo=comp......... The Cigloo compiler" >&2;
      echo "   --afile=afile......... The Bigloo afile tool" >&2;
      echo "   --btags=btags......... The Bigloo btags tool" >&2;
      echo "   --bdepend=bdepend..... The Bigloo dependence tool" >&2;
      echo "   --ccs=cc.............. The C compiler" >&2;
      echo "   --bcflags=args........ The compilation options" >&2;
      echo "   --blflags=args........ The link options" >&2;
      echo "   --bhflags=args........ The heap options" >&2;
      echo "   --brflags=args........ The heap options" >&2;
      echo "   --ccflags=args........ The heap options" >&2;
      echo "   --debug............... Enables Bigloo debug mode" >&2;
      echo "   --bmem................ Enables Bigloo bmem mode" >&2;
      echo "   --optimize............ Enables Bigloo optimization mode (default)" >&2;
      exit -1;
  esac
  shift
done

#*---------------------------------------------------------------------*/
#*    First check if bigloo exists and if it is recent enough          */
#*---------------------------------------------------------------------*/
if [ ! -f $bigloo ]; then
   which $bigloo > /dev/null 2> /dev/null
   if [ "$?" != "0" ]; then
      echo "*** ERROR:configure:bigloo. Aborting"
      echo "Can't find bigloo."
      exit 1;
   fi
fi

bglversion=`$bigloo -q -eval "(exit (display *bigloo-version*))"`

$bigloo -q -eval "(exit (if (string>=? *bigloo-version* \"$bigloorequired\") 0 1))"

if [ $? != "0" ]; then
  echo "*** ERROR:configure:bigloo. Aborting"
  echo "Your version of Bigloo ($bglversion) is too old. Release"
  echo "   $bigloorequired"
  echo "or more recent is required. It may be downloaded at:"
  echo "   $bigloourl"
  exit 1;
fi

#*---------------------------------------------------------------------*/
#*    Then check if bglafile exists this is a good indicator of a      */
#*    correct Bigloo installation.                                     */
#*---------------------------------------------------------------------*/
$afile runtime/*.scm > /dev/null 2> /dev/null

if [ $? != "0" ]; then
  echo "*** ERROR:configure:$afile. Aborting"
  echo ""
  echo "This error is due to a bad Bigloo installation. It might be that"
  echo "you have installed Bigloo but not ran \"ldconfig\" afterward."
  echo "In such a case, binaries produced by Bigloo cannot be executed"
  echo "because the loader cannot find the Bigloo dynamic library."
  exit 1;
fi

#*---------------------------------------------------------------------*/
#*    Check the backend                                                */
#*---------------------------------------------------------------------*/
case $backend in
  "native")
     break;;
  "jvm")
     etcdir=/resource/etc
     libdir=/resource/lib
     webletsdir=/resource/share/weblets
     contribsdir=/resource/share/contribs
     sharedir=/resource/share
     break;;
  "dotnet")
     break;;
  *)
      echo "*** Configure error, Illegal backend $backend" >&2;
      echo "see configure --help" >&2;
      exit -1;
esac

#*---------------------------------------------------------------------*/
#*    Weblets dir                                                      */
#*---------------------------------------------------------------------*/
if [ "$webletsdir " = " " ]; then
  webletsdir=$sharedir/weblets;
fi

#*---------------------------------------------------------------------*/
#*    We are now able to set the correct value for cc since we know    */
#*    what Bigloo is.                                                  */
#*---------------------------------------------------------------------*/
if [ "$cc " = " " ]; then
  cc=`$bigloo -eval '(begin (print *cc*) (exit 0))'`
fi

bigloolibdir=`$bigloo -q -eval "(begin (print *default-lib-dir*) (exit 0))"`
if [ "$ccflags " = " " ]; then
  ccflags=`grep '^CFLAGS=' $bigloolibdir/Makefile.config | sed 's/^[A-Z]*=//'`
  ccflags="$ccflags -I $bigloolibdir"
fi


#*---------------------------------------------------------------------*/
#*    Jvm zip libs                                                     */
#*---------------------------------------------------------------------*/
jvmziplibs=
jvminits=

# Hop librairies
for p in scheme2js hopscheme hopwiki hop; do
  elib="$buildlibdir/$p"_e-$version.zip;
  slib="$buildlibdir/$p"_s-$version.zip;
  jvmziplibs="$elib $slib $jvmziplibs";
done

# Bigloo libraries
for p in pth web multimedia sqlite ssl calendar; do
  elib="$bigloolibdir/bigloo$p"_e-$bglversion.zip;
  slib="$bigloolibdir/bigloo$p"_s-$bglversion.zip;
  jvmziplibs="$elib $slib $jvmziplibs";
  jvminits="$bigloolibdir/$p"".init $jvminits";
done

slib="$bigloolibdir/bigloo_s.zip";
jvmziplibs="$slib $jvmziplibs";
jvminits="$bigloolibdir/pthread.init $jvminits";

#*---------------------------------------------------------------------*/
#*    Makefile.hopconfig                                               */
#*---------------------------------------------------------------------*/
mkmf=etc/Makefile.hopconfig

rm -f $mkmf 2> /dev/null
echo "#* Automatically generated file (don't edit) */" > $mkmf

cat $mkmf.in \
    | sed -e "s|@RELEASE@|$version|" \
          -e "s|@DEVEL@|$devel|" \
          -e "s|@BIGLOO@|$bigloo|" \
          -e "s|@BACKEND@|$backend|" \
          -e "s|@BIGLOOLIBDIR@|$bigloolibdir|" \
          -e "s|@CIGLOO@|$cigloo|" \
          -e "s|@AFILE@|$afile|" \
          -e "s|@JFILE@|$jfile|" \
          -e "s|@BTAGS@|$btags|" \
          -e "s|@BDEPEND@|$bdepend|" \
          -e "s|@CC@|$cc|" \
          -e "s|@UNZIP@|$unzip|" \
          -e "s|@JAR@|$jar|" \
          -e "s|@BCFLAGS@|$bcflags|" \
          -e "s|@BLFLAGS@|$blflags|" \
          -e "s|@JVMZIPLIBS@|$jvmziplibs|" \
          -e "s|@JVMINITS@|$jvminits|" \
          -e "s|@CCFLAGS@|$ccflags|" \
          -e "s|@BUILDLIBDIR@|$PWD/lib|" \
          -e "s|@BUILDETCDIR@|$PWD/etc|" \
          -e "s|@BUILDBINDIR@|$PWD/bin|" \
          -e "s|@BINDIR@|$bindir|" \
          -e "s|@LIBDIR@|$libdir|" \
          -e "s|@SHAREDIR@|$sharedir|" \
          -e "s|@ETCDIR@|$etcdir|" \
          -e "s|@WEBLETSDIR@|$webletsdir|" \
          -e "s|@CONTRIBSDIR@|$contribsdir|" \
          -e "s|@BUILDSHAREDIR@|$buildsharedir|" \
          -e "s|@DISTRIBDIR@|$distribdir|" \
          -e "s|@HOPSVN@|$svn|" \
          -e "s|@HOPREPOSITORY@|$repository|" \
          -e "s|@HOPDISTRIBDIR@|$distribdir|" \
    >> $mkmf

# src/configure.scm
configure=runtime/configure.scm
rm -f $configure 2> /dev/null
echo ";* Automatically generated file (don't edit) */" > $configure

cat etc/configure.scm.in \
    | sed -e "s|@VERSION@|$version|" \
          -e "s|@BACKEND@|$backend|" \
          -e "s|@URL@|$url|" \
          -e "s|@BINDIR@|$bindir|" \
          -e "s|@LIBDIR@|$libdir|" \
          -e "s|@SHAREDIR@|$sharedir|" \
          -e "s|@ETCDIR@|$etcdir|" \
          -e "s|@WEBLETSDIR@|$webletsdir|" \
          -e "s|@CONTRIBSDIR@|$contribsdir|" \
          -e "s|@MIMETYPES@|$mimetypes|" \
    >> $configure

# etc/hoprc.hop
hoprc=etc/hoprc.hop
rm -f $hoprc 2> /dev/null
cat etc/hoprc.hop.in \
    | sed -e "s|@VERSION@|$version|" \
          -e "s|@BINDIR@|$bindir|" \
          -e "s|@LIBDIR@|$libdir|" \
          -e "s|@SHAREDIR@|$sharedir|" \
          -e "s|@ETCDIR@|$etcdir|" \
          -e "s|@WEBLETSDIR@|$webletsdir|" \
          -e "s|@CONTRIBSDIR@|$contribsdir|" \
          -e "s|@MIMETYPES@|$mimetypes|" \
    >> $hoprc

# lib/hop.init
init=lib/hop.init
mkdir -p lib
rm -f $init 2> /dev/null
echo ";* Automatically generated file (don't edit) */" > $init

cat etc/hop.init.in \
    | sed -e "s|@VERSION@|$version|" \
    >> $init
echo "" >> $init

cat runtime/compiler-macro.sch >> $init
echo "" >> $init
cat runtime/xml.sch >> $init
echo "" >> $init
cat runtime/param.sch >> $init
echo "" >> $init
cat runtime/prefs.sch >> $init
echo "" >> $init
cat runtime/service.sch >> $init

# lib/scheme2js.init
init=lib/scheme2js.init
mkdir -p lib
rm -f $init 2> /dev/null
echo ";* Automatically generated file (don't edit) */" > $init

cat etc/scheme2js.init.in \
    | sed -e "s|@VERSION@|$version|" \
    >> $init
echo "" >> $init

# lib/hopscheme.init
init=lib/hopscheme.init
mkdir -p lib
rm -f $init 2> /dev/null
echo ";* Automatically generated file (don't edit) */" > $init

cat etc/hopscheme.init.in \
    | sed -e "s|@VERSION@|$version|" \
    >> $init
echo "" >> $init

# lib/hopwiki.init
init=lib/hopwiki.init
mkdir -p lib
rm -f $init 2> /dev/null
echo ";* Automatically generated file (don't edit) */" > $init

cat etc/hopwiki.init.in \
    | sed -e "s|@VERSION@|$version|" \
    >> $init
echo "" >> $init

#*---------------------------------------------------------------------*/
#*    Summary                                                          */
#*---------------------------------------------------------------------*/
echo "** Configuration summary **"
echo 
echo "Release features:"
echo "  Hop release number.................... $version"
echo "  Bigloo................................ $bigloo ($bglversion)"
echo "  Backend............................... $backend"
echo "  Bigloo compilation flags.............. $bcflags"
echo
echo "Directories where Hop will be installed:"
echo "  etc directory......................... $etcdir"
echo "  binaries.............................. $bindir"
echo "  libraries............................. $libdir"
echo "  share directory....................... $sharedir"
echo "  weblets directory..................... $webletsdir"
echo "  contribs directory.................... $contribsdir"
echo 
