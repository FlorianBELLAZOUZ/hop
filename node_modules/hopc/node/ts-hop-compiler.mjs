/*=====================================================================*/
/*    .../hop/hop/node_modules/hopc/node/ts-hop-compiler.mjs           */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Fri Feb 23 09:14:05 2024                          */
/*    Last change :  Fri Mar  8 14:11:44 2024 (serrano)                */
/*    Copyright   :  2024 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Native TS compiler                                               */
/*=====================================================================*/
"use hopscript";

/*---------------------------------------------------------------------*/
/*    Module                                                           */
/*---------------------------------------------------------------------*/
import fs from "fs";
import path from "path";
import util from "util";
import { config } from "hop:config";
import { systemSync as system } from "hop:system";

export { compile };

/*---------------------------------------------------------------------*/
/*    compile ...                                                      */
/*---------------------------------------------------------------------*/
async function compile(source, conf = {}) {
   const node = conf?.node || "node";
   const tsc = require.resolve("./ts-loader.mjs");
   const cmd = ["sh", "-c", `${node} --input_type=module -e "import { compile } from '${tsc}'; await compile('file://${source}')"`];

   const res = system(cmd);

   if (res.status !== 0) {
      console.error(res.data);
      process.exit(res.status);
   } else {
      return source;
   }
}
