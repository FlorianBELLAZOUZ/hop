#*=====================================================================*/
#*    serrano/prgm/project/hop/hop/node_modules/hopc/node/Makefile     */
#*    -------------------------------------------------------------    */
#*    Author      :  manuel serrano                                    */
#*    Creation    :  Fri Oct 27 07:55:44 2023                          */
#*    Last change :  Fri Jun 14 11:38:24 2024 (serrano)                */
#*    Copyright   :  2023-24 manuel serrano                            */
#*    -------------------------------------------------------------    */
#*    Node's hopc precompilation                                       */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
PACKAGE=hopc
include ../../Makefile.modules

PARSER_SRC=$(BUILDDIR)/js2scheme/parser.scm
AST_SCH=$(BUILDDIR)/js2scheme/ast.sch
AST_SRC=

BEAUTIFY=cat

#*---------------------------------------------------------------------*/
#*    Goals                                                            */
#*---------------------------------------------------------------------*/
build: parser.mjs ast.mjs error.mjs
	mkdir -p $(NPMDIR)/bin
	echo "#!/usr/bin/env node" > $(NPMDIR)/bin/hopc.mjs
	echo "import * as hopc from \"../node/hopc.mjs\"" >> $(NPMDIR)/bin/hopc.mjs
	chmod $(MODEXE) $(NPMDIR)/bin/hopc.mjs
	echo "#!/usr/bin/env node" > $(NPMDIR)/bin/rsmap.mjs
	echo "import * as rsmap from \"../node/rsmap.mjs\"" >> $(NPMDIR)/bin/rsmap.mjs
	chmod $(MODEXE) $(NPMDIR)/bin/rsmap.mjs

error.mjs: ../error.mjs
	date +'/* generated file (node_modules/hopc/hop/Makefile), do not edit (%d %B %Y) */' > $@
	cat $< >> $@
	chmod $(MODFILE) $@

parser.mjs: parser.js parser-module.js
	cat parser-module.js > $@
	cat parser.js >> $@

parser.js: $(PARSER_SRC)
	$(BUILDBINDIR)/hop2js $(AST_SCH) $(PARSER_SRC) | $(BEAUTIFY) > $@

ast.mjs: ast-extra.js $(BUILDDIR)/js2scheme/ast.scm
	date +'/* generated file (mkjsast), do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	$(BUILDBINDIR)/mkjsast -m node ../../../js2scheme/ast.scm >> $@
	cat ast-extra.js >> $@

postbuild:

clean:
	rm -f parser.js parser.mjs
	rm -f ast.mjs

cleanall: clean

