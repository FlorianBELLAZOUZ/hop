#*=====================================================================*/
#*    serrano/prgm/project/hop/hop/node_modules/hopc/node/Makefile     */
#*    -------------------------------------------------------------    */
#*    Author      :  manuel serrano                                    */
#*    Creation    :  Fri Oct 27 07:55:44 2023                          */
#*    Last change :  Sat Nov  4 06:43:26 2023 (serrano)                */
#*    Copyright   :  2023 manuel serrano                               */
#*    -------------------------------------------------------------    */
#*    Node's hopc precompilation                                       */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
PACKAGE=hopc
include ../../Makefile.modules

PARSER_SRC=$(BUILDDIR)/js2scheme/parser.scm
AST_SCH=$(BUILDDIR)/js2scheme/ast.sch
AST_SRC=$(BUILDDIR)/js2scheme/ast.scm

BEAUTIFY=cat

#*---------------------------------------------------------------------*/
#*    Goals                                                            */
#*---------------------------------------------------------------------*/
build: parser.mjs ast.mjs # j2sast.mjs

parser.mjs: parser.js parser-module.js
	cat parser-module.js > $@
	cat parser.js >> $@

parser.js: hop2js $(PARSER_SRC)
	hop2js $(AST_SCH) $(PARSER_SRC) | $(BEAUTIFY) > $@

ast.mjs: ../../../js2scheme/ast.scm ../mkjsast.scm ast-extra.js
	date +'/* generated file (mkjsast), do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	$(BIGLOO) -i ../mkjsast.scm "node" ../../../js2scheme/ast >> $@
	cat ast-extra.js >> $@

#* j2sast.mjs: ast2js                                                  */
#* 	ast2js $(AST_SRC) > $@                                         */

hop2js: hop2js.o
	$(BIGLOO) $< -o $@

hop2js.o: hop2js.scm
	$(BIGLOO) -c $< -o $@

ast2js: ast2js.o
	$(BIGLOO) $< -o $@

ast2js.o: ast2js.scm
	$(BIGLOO) -c $< -o $@

clean:
	rm -f ast2js.o ast2js
	rm -f hop2js.o hop2js

cleanall: clean
	rm -f parser.js parser.mjs
	rm -f ast.mjs

