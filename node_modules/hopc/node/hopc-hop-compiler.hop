;*=====================================================================*/
;*    .../hop/hop/node_modules/hopc/node/hopc-hop-compiler.hop         */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Sun Jul  6 06:15:53 2014                          */
;*    Last change :  Thu Mar  7 18:21:37 2024 (serrano)                */
;*    Copyright   :  2014-24 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    Sqlite JS bindings                                               */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _hopc_hop-compiler

   (library hopscript hop js2scheme)

   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (js-export (compile)
      
      (define exports (js-get %module (& "exports") %this))
      
      (define compile
	 (js-make-function %this
	    (lambda (this source target conf)
	       (let* ((src (js-tostring source %this)))
		  (tprint "src=" src " " (member (suffix src) '("js" "mjs")))
		  (if (member (suffix src) '("js" "mjs"))
		      source
		      (hopc src target conf %this))))
	    (js-function-arity 3 0)
	    (js-function-info :name "compile" :len 3)))

      (js-bind! %this exports (& "compile")
	 :value compile
	 :writable #f
	 :enumerable #t)

      #unspecified))

;*---------------------------------------------------------------------*/
;*    hopc ...                                                         */
;*---------------------------------------------------------------------*/
(define (hopc fname target conf %this)
   (tprint "hopc fname=" fname)
   (let ((mmap (when (and (string? fname) (file-exists? fname))
		  (open-mmap fname :read #t :write #f))))
      (call-with-input-file fname
	 (lambda (in)
	    (let ((o (j2s-compile in
			:return-as-exit #t
			:filename fname
			:mmap-src mmap
			:driver (j2s-javascript-optim-driver)
			:driver-name j2s-javascript-optim-driver
			:worker-slave #f
			:module-main #f
			:type-annotations #f
			:optim 2
			:verbose 0
			:debug (bigloo-debug)
			:warning (bigloo-warning)
			:es6-module-client #t)))
	       (fprint (current-error-port) "**** hopc fname=" fname)
	       (call-with-output-file (js-tostring target %this)
		  (lambda (out)
		     (for-each (lambda (exp)
				  (unless (isa? exp J2SNode)
				     (display exp out)))
			o))))))))
