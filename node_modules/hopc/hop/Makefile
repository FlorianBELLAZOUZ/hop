#*=====================================================================*/
#*    serrano/prgm/project/hop/hop/node_modules/hopc/hop/Makefile      */
#*    -------------------------------------------------------------    */
#*    Author      :  Manuel Serrano                                    */
#*    Creation    :  Fri Aug 28 10:00:50 2015                          */
#*    Last change :  Fri Jun 14 08:05:22 2024 (serrano)                */
#*    Copyright   :  2015-24 Manuel Serrano                            */
#*    -------------------------------------------------------------    */
#*    hopc precompilation                                              */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
PACKAGE=hopc
SCOPE=@hop
BIGLOOEXTRAAPPLIBS=

include ../../Makefile.modules
include ../../Makefile.scoped

#*---------------------------------------------------------------------*/
#*    The entries                                                      */
#*---------------------------------------------------------------------*/
.PHONY: build install uninstall

build: o ast.mjs walk.mjs
	$(MAKE) o/ast.$(SHAREDSUFFIX) TARGETNAME=ast OBJECTS=o/ast.o
	$(MAKE) o/_ast.$(SHAREDSUFFIX) TARGETNAME=_ast OBJECTS=o/ast.o
	$(MAKE) o/error.$(SHAREDSUFFIX) TARGETNAME=error OBJECTS=o/error.o
	$(MAKE) o/generate.$(SHAREDSUFFIX) TARGETNAME=generate OBJECTS=o/generate.o
	$(MAKE) o/hopc.$(SHAREDSUFFIX) TARGETNAME=hopc OBJECTS=o/hopc.o
	$(MAKE) o/_js2scheme.$(SHAREDSUFFIX) TARGETNAME=_js2scheme OBJECTS=o/_js2scheme.o
	$(MAKE) o/_list.$(SHAREDSUFFIX) TARGETNAME=_list OBJECTS=o/_list.o
	$(MAKE) o/walk.$(SHAREDSUFFIX) TARGETNAME=walk OBJECTS=o/walk.o

npm: clean

install: mkdirs
	$(MAKE) install-so TARGETNAME=ast
	$(MAKE) install-so TARGETNAME=_ast
	$(MAKE) install-so TARGETNAME=error
	$(MAKE) install-so TARGETNAME=generate
	$(MAKE) install-so TARGETNAME=hopc
	$(MAKE) install-so TARGETNAME=_js2scheme
	$(MAKE) install-so TARGETNAME=_list
	$(MAKE) install-so TARGETNAME=walk
	$(RM) -rf $(DESTDIR)$(HOPLIBDIR)/$(HOPFILDIR)/node_modules/$(PACKAGE)/hop/o
	$(INSTALL) ast.mjs $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/ast.mjs
	$(INSTALL) _ast.hop $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/_ast.hop
	$(INSTALL) error.mjs $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/error.mjs
	$(INSTALL) generate.mjs $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/generate.mjs
	$(INSTALL) hopc.mjs $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/hopc.mjs
	$(INSTALL) _js2scheme.hop $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/_js2scheme.hop
	$(INSTALL) _list.hop $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/_list.hop
	$(INSTALL) walk.mjs $(INSTALLDIR)/hop && chmod $(MODFILE) $(INSTALLDIR)/hop/walk.mjs

#*---------------------------------------------------------------------*/
#*    error.mjs                                                        */
#*---------------------------------------------------------------------*/
error.mjs: ../error.mjs
	date +'/* generated file (node_modules/hopc/hop/Makefile), do not edit (%d %B %Y) */' > $@
	cat $< >> $@

#*---------------------------------------------------------------------*/
#*    walk.mjs ...                                                     */
#*---------------------------------------------------------------------*/
walk.mjs: ../../../js2scheme/ast.scm
	date +'/* generated file (node_modules/hopc/hop/Makefile), do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	echo "import * as ast from './ast.mjs';" >> $@
	echo "" >> $@
	echo "" >> $@
	(cd $(BUILDDIR)/js2scheme; $(BIGLOO) -srfi generate-javascript-walker -expand -o /dev/null ast.scm) >> $@

#*---------------------------------------------------------------------*/
#*    ast.mjs ...                                                      */
#*---------------------------------------------------------------------*/
ast.mjs: ast-extra.js $(BUILDDIR)/js2scheme/ast.scm
	date +'/* generated file (mkjsast.scm), do not edit (%d %B %Y) */' > $@
	echo "" >> $@
	$(BUILDBINDIR)/mkjsast -m hop $(BUILDDIR)/js2scheme/ast.scm >> $@
	cat ast-extra.js >> $@
