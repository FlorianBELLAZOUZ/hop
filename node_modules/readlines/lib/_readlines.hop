;*=====================================================================*/
;*    .../hop/hop/node_modules/readlines/lib/_readlines.hop            */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Thu Mar  9 14:57:50 2023                          */
;*    Last change :  Thu Mar  9 15:40:55 2023 (serrano)                */
;*    Copyright   :  2023 Manuel Serrano                               */
;*    -------------------------------------------------------------    */
;*    Hop readlines implementation.                                    */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _readlines

   (library hopscript hop hopwidget nodejs multimedia)
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    read-lines ...                                                   */
;*---------------------------------------------------------------------*/
(define (read-lines ip)
   (let loop ((ls '()))
      (let ((l (read-line ip)))
	 (if (eof-object? l)
	     (reverse! ls)
	     (loop (cons (js-string->jsstring l) ls))))))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (js-export (readLines)

      (define (js-readlines this fd)
	 (let ((p (open-input-descriptor fd)))
	    (unwind-protect
	       (js-vector->jsarray (list->vector (read-lines p)) %this)
	       (close-input-port p))))

      (define readLines
	 (js-make-function %this
	    js-readlines
	    (js-function-arity 1 0)
	    (js-function-info :name "readLines" :len 1)
	    :size 1))

      readLines))
