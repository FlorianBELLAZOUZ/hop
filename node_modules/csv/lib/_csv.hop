;*=====================================================================*/
;*    serrano/prgm/project/hop/hop/node_modules/feed/lib/_feed.hop     */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Thu Sep  6 15:19:35 2018                          */
;*    Last change :  Mon Mar  9 10:03:25 2020 (serrano)                */
;*    Copyright   :  2018-20 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    FEED Hop parser                                                  */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module csv
   (library hopscript hop hopwidget nodejs web csv)
   (export (hopscript %this this %scope %module)))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*    -------------------------------------------------------------    */
;*    This is the function called by JavaScript when the Hop module    */
;*    is required. It binds the exports field of the newly             */
;*    allocated module                                                 */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (define (literal->js v)
      (cond
	 ((string? v) (js-string->jsstring v))
	 ((number? v) (js-number->jsnumber v))
	 (else v)))
   
   (define (literal->js/enc enc)
      (let ((conv (charset-converter
		     (string->symbol (js-jsstring->string enc))
		     (hop-locale))))
	 (lambda (v)
	    (cond
	       ((string? v) (js-string->jsstring (conv v)))
	       ((number? v) (js-number->jsnumber v))
	       (else v)))))
   
   (with-access::JsGlobalObject %this (js-object)
      (let ((exports (js-new0 %this js-object)))
         (js-put! %module (& "exports") exports #f %this)
         ;; bind the load function is the pseudo javascript module
         (js-put! exports (& "load")
            (js-make-function %this
               ;; wrap the Hop read-csv records function into a JS function
               (lambda (this url sep encoding)
		  (call-with-input-file url
		     (let ((conv (if (js-jsstring? encoding)
				     (literal->js/enc encoding)
				     literal->js))
			   (lexer (if (js-jsstring? sep)
				      (let ((str (js-jsstring->string sep)))
					 (cond
					    ((string=? str ";") +ssv-lexer+)
					    ((string=? str ",") +csv-lexer+)
					    ((string=? str "\t") +tsv-lexer+)
					    ((string=? str "|") +psv-lexer+)
					    (else (error "csv" "Illegal separator" str))))
				      +csv-lexer+)))
			(lambda (p)
			   (js-vector->jsarray
			      (apply vector
				 (map (lambda (row)
					 (js-vector->jsarray
					    (apply vector (map conv row))
					    %this))
				    (read-csv-records p lexer)))
			      %this)))))
	       (js-function-arity 3 0)
	       (js-function-info :name "load" :len 3))
	    #f %this))))
