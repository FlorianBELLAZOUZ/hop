;*=====================================================================*/
;*    .../prgm/project/hop/hop/node_modules/syslog/lib/_syslog.hop     */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Sun Jul  6 06:15:53 2014                          */
;*    Last change :  Tue Apr 26 08:53:34 2022 (serrano)                */
;*    Copyright   :  2014-22 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    SYSLOG JS bindings                                               */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _syslog

   (library hopscript hop hopwidget nodejs)
   
   (export (class SyslogInclude
	      (val read-only)))
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    define-js ...                                                    */
;*---------------------------------------------------------------------*/
(define-macro (define-js id syslog-value)
   `(define ,id
       (let ((v (,syslog-value ',id)))
	  (js-bind! %this exports
	     (& ,(symbol->string! id))
	     :value v
	     :writable #f
	     :enumerable #f)
	  v)))
       
;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (define (js-tofixnum n %this)
      (let ((n (js-tointeger n %this)))
	 (cond
	    ((fixnum? n) n)
	    ((flonum? n) (flonum->fixnum n))
	    (else 0))))
   
   (js-export (open log close
		 LOG_CONS LOG_NDELAY LOG_ODELAY LOG_PID
		 LOG_AUTH LOG_AUTHPRIV LOG_CRON LOG_DAEMON LOG_FTP LOG_KERN
		 LOG_LOCAL0 LOG_LOCAL1 LOG_LOCAL2 LOG_LOCAL3 LOG_LOCAL4
		 LOG_LOCAL5 LOG_LOCAL6 LOG_LOCAL7
		 LOG_LPR LOG_MAIL LOG_NEWS LOG_SYSLOG LOG_USER LOG_UUCP
		 LOG_EMERG LOG_ALERT LOG_CRIT LOG_ERR LOG_WARNING LOG_NOTICE
		 LOG_INFO LOG_DEBUG)
      
      (define exports (js-get %module (& "exports") %this))
      
      ;; bind the module in the syslog scope
      (js-put! %scope (& "module") %module #f %this)
      
      ;; open
      (define open
	 (js-make-function %this
	    (lambda (this name option facility)
	       (openlog (js-tostring name %this)
		  (js-tofixnum option %this)
		  (js-tofixnum facility %this)))
	    (js-function-arity 3 0)
	    (js-function-info :name "open" :len 3)))
      
      (js-bind! %this exports (& "open")
	 :value open
	 :writable #f
	 :enumerable #f)
      
      ;; log
      (define log
	 (js-make-function %this
	    (lambda (this level msg)
	       (syslog (js-tofixnum level %this)
		  (js-tostring msg %this)))
	    (js-function-arity 2 0)
	    (js-function-info :name "log" :len 2)))
      
      (js-bind! %this exports (& "log")
	 :value log
	 :writable #f
	 :enumerable #f)
      
      ;; close objects
      (define close
	 (js-make-function %this
	    (lambda (this)
	       (closelog))
	    (js-function-arity 0 0)
	    (js-function-info :name "close" :len 0)))
      
      (js-bind! %this exports (& "close")
	 :value close
	 :writable #f
	 :enumerable #f)
      
      ;; options
      (define-js LOG_CONS syslog-option)
      (define-js LOG_NDELAY syslog-option)
      (define-js LOG_ODELAY syslog-option)
      (define-js LOG_PID syslog-option)
      
      ;; facilities
      (define-js LOG_AUTH syslog-facility)
      (define-js LOG_AUTHPRIV syslog-facility)
      (define-js LOG_CRON syslog-facility)
      (define-js LOG_DAEMON syslog-facility)
      (define-js LOG_FTP syslog-facility)
      (define-js LOG_KERN syslog-facility)
      (define-js LOG_LOCAL0 syslog-facility)
      (define-js LOG_LOCAL1 syslog-facility)
      (define-js LOG_LOCAL2 syslog-facility)
      (define-js LOG_LOCAL3 syslog-facility)
      (define-js LOG_LOCAL4 syslog-facility)
      (define-js LOG_LOCAL5 syslog-facility)
      (define-js LOG_LOCAL6 syslog-facility)
      (define-js LOG_LOCAL7 syslog-facility)
      (define-js LOG_LPR syslog-facility)
      (define-js LOG_MAIL syslog-facility)
      (define-js LOG_NEWS syslog-facility)
      (define-js LOG_SYSLOG syslog-facility)
      (define-js LOG_USER syslog-facility)
      (define-js LOG_UUCP syslog-facility)
      
      ;; levels
      (define-js LOG_EMERG syslog-level)
      (define-js LOG_ALERT syslog-level)
      (define-js LOG_CRIT syslog-level)
      (define-js LOG_ERR syslog-level)
      (define-js LOG_WARNING syslog-level)
      (define-js LOG_NOTICE syslog-level)
      (define-js LOG_INFO syslog-level)
      (define-js LOG_DEBUG syslog-level)
      
      exports))

;*---------------------------------------------------------------------*/
;*    The return value for dynamic-load                                */
;*---------------------------------------------------------------------*/
hopscript

