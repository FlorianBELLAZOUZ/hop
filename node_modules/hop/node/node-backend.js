/*=====================================================================*/
/*    .../project/hop/hop/node_modules/hop/node/node-backend.js        */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Tue Feb 27 12:04:16 2024                          */
/*    Last change :  Fri Mar  1 11:10:38 2024 (serrano)                */
/*    Copyright   :  2024 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Nodejs Hop backend (lives in the CommonJS land).                 */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    The module                                                       */
/*---------------------------------------------------------------------*/
const http = require("node:http");
const https = require("node:https");
const express = require("../../../express");
const { existsSync, statSync, readFileSync } = require("node:fs");

/*---------------------------------------------------------------------*/
/*    init ...                                                         */
/*---------------------------------------------------------------------*/
function init(config) {
   const app = express();
   
   if (config.ports.http >= 0) {
      http.createServer(app)
	 .listen(config.ports.http);
   }
   if (config.ports.https >= 0) {
      const credentials = {};
      for (let k in config.credentials) {
	 credentials[k] = readFileSync(config.credentials[k]);
      }
      https.createServer(credentials, app)
	 .listen(config.ports.https);
   }
   // app.use(`${hopBase}/0`, express.static(dirname(getRootDir(import.meta.url))));

   // hop resolver
   app.static = (base, root) => {
      app.use(base, express.static(root, { dotfiles: "allow" }));
   }
   
   return app;
}

/*---------------------------------------------------------------------*/
/*    exports                                                          */
/*---------------------------------------------------------------------*/
module.exports = { init };
