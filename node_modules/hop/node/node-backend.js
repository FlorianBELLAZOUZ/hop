/*=====================================================================*/
/*    .../project/hop/hop/node_modules/hop/node/node-backend.js        */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Tue Feb 27 12:04:16 2024                          */
/*    Last change :  Tue Apr  2 13:38:07 2024 (serrano)                */
/*    Copyright   :  2024 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Nodejs Hop backend (lives in the CommonJS land).                 */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    The module                                                       */
/*---------------------------------------------------------------------*/
const http = require("node:http");
const https = require("node:https");
const express = require("express");
const ws = require("ws");
const { existsSync, statSync, readFileSync } = require("node:fs");

/*---------------------------------------------------------------------*/
/*    init ...                                                         */
/*---------------------------------------------------------------------*/
function init(config, registerWebsocket) {
   const app = express();

   // listen method
   app.listen = () => {
      let bcastserver;
      
      if (config.ports.http >= 0) {
	 bcastserver = http.createServer(app)
	    .listen(config.ports.http);
      }
      if (config.ports.https >= 0) {
	 const credentials = {};
	 for (let k in config.credentials) {
	    credentials[k] = readFileSync(config.credentials[k]);
	 }
	 bcastserver = https.createServer(credentials, app)
	    .listen(config.ports.https);
      }

      // websocket for event broadcast
      const wsServer = new ws.Server({ noServer: true });
      bcastserver.on('upgrade', (req, socket, head) => {
	 const i = req.rawHeaders.findIndex(n => n.toLowerCase() === "host");
	 if (i < 0) {
	    throw "Cannot register websocket, because cannot find host";
	 } else {
	    const host = req.rawHeaders[i + 1];
	    wsServer.handleUpgrade(req, socket, head, socket => {
	       registerWebsocket(host, socket);
	    });
	 }
      });
   }
   
   // default static for hop-client module
   app.use("/hop/0", express.static(__dirname));

   // hop resolver
   app.static = (id, root) => {
      app.use(`/hop/${id}`, express.static(root, { dotfiles: "allow" }));
   }

   return app;
}


/*---------------------------------------------------------------------*/
/*    exports                                                          */
/*---------------------------------------------------------------------*/
module.exports = { init };
