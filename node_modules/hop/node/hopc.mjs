/*=====================================================================*/
/*    .../prgm/project/hop/3.7.x/node_modules/hop/node/hopc.mjs        */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Jan 18 15:55:24 2024                          */
/*    Last change :  Thu Jan 18 16:12:04 2024 (serrano)                */
/*    Copyright   :  2024 Manuel Serrano                               */
/*    -------------------------------------------------------------    */
/*    Compiler driver                                                  */
/*=====================================================================*/
"use strict"
"use hopscript"

/*---------------------------------------------------------------------*/
/*    es6 module                                                       */
/*---------------------------------------------------------------------*/
import { compile } from "./hopc-compiler.mjs";

/*---------------------------------------------------------------------*/
/*    usage ...                                                        */
/*---------------------------------------------------------------------*/
function usage(argv, i) {
   if (i >= 0) {
      console.log(`hopc: wrong option "${argv[i]}" (see hopc --help)`);
   } else {
      console.log("hopc usage: source [-o target] [--help]");
   }
   process.exit(0);
}

/*---------------------------------------------------------------------*/
/*    main ...                                                         */
/*---------------------------------------------------------------------*/
async function main(argv) {
   let src = undefined;
   let tgt = undefined;
   let i = 2;

   while (i < argv.length) {
      switch (argv[i]) {
	 case "--help": {
	    usage(argv, -1);
	 }
	 case "-o": {
	    if (i < argv.length - 1) {
	       tgt = argv[i+1];
	       i += 2;
	       break;
	    } else {
	       usage(argv, i);
	    }
	 }
	 default: {
	    if (src) {
	       usage(argv, i);
	    } else {
	       src = argv[i];
	       i++;
	       break;
	    }
	 }
      }
   }

   if (!src) {
      usage(argv, -1);
   } else {
      const fragment = compile(src);
      await fragment.output(tgt);
      await fragment.sourcemap(tgt);
   }
}

/*---------------------------------------------------------------------*/
/*    toplevel                                                         */
/*---------------------------------------------------------------------*/
main(process.argv);
