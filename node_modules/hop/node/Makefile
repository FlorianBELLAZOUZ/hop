#*=====================================================================*/
#*    serrano/prgm/project/hop/hop/node_modules/hop/node/Makefile      */
#*    -------------------------------------------------------------    */
#*    Author      :  manuel serrano                                    */
#*    Creation    :  Fri Oct 27 07:55:44 2023                          */
#*    Last change :  Wed May  1 09:33:29 2024 (serrano)                */
#*    Copyright   :  2023-24 manuel serrano                            */
#*    -------------------------------------------------------------    */
#*    Node's hop module                                                */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
PACKAGE=hop
include ../../Makefile.modules

#*---------------------------------------------------------------------*/
#*    Goals                                                            */
#*---------------------------------------------------------------------*/
build:
	mkdir -p $(NPMDIR)/bin
	echo "#!/usr/bin/env node" > $(NPMDIR)/bin/hopuser.mjs
	echo "import { init } from \"../lib/config.mjs\"" >> $(NPMDIR)/bin/hopuser.mjs
	echo "import { digestPassword } from \"../lib/auth.mjs\"" >> $(NPMDIR)/bin/hopuser.mjs
	echo "init({q: true});" >> $(NPMDIR)/bin/hopuser.mjs
	echo "console.log(JSON.stringify({name: process.argv[2], password: digestPassword(process.argv[2], process.argv[3], process.argv[4] || 'hop'), services: [], directories: []}))" >> $(NPMDIR)/bin/hopuser.mjs
	chmod a+rx $(NPMDIR)/bin/hopuser.mjs
	cp hop-backend.hop $(NPMDIR)/lib
	cat config.mjs.in | sed -e 's|@VERSION@|$(HOPRELEASE)|' -e 's|@BUILDTAG@|$(HOPBUILDTAG)|' > $(NPMDIR)/lib/config.mjs

postbuild:
	mv $(NPMDIR)/lib/client.mjs $(NPMDIR)

clean:

cleanall: clean

