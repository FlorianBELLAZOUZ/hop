#*=====================================================================*/
#*    .../prgm/project/hop/3.7.x/node_modules/hop/node/Makefile        */
#*    -------------------------------------------------------------    */
#*    Author      :  manuel serrano                                    */
#*    Creation    :  Fri Oct 27 07:55:44 2023                          */
#*    Last change :  Thu Feb  1 11:38:00 2024 (serrano)                */
#*    Copyright   :  2023-24 manuel serrano                            */
#*    -------------------------------------------------------------    */
#*    Node's hop module                                                */
#*=====================================================================*/
do: build

#*---------------------------------------------------------------------*/
#*    Configuration                                                    */
#*---------------------------------------------------------------------*/
PACKAGE=hop
include ../../Makefile.modules

#*---------------------------------------------------------------------*/
#*    Goals                                                            */
#*---------------------------------------------------------------------*/
build:
	mkdir -p $(NPMDIR)/bin
	echo "#!/usr/bin/env node" > $(NPMDIR)/bin/hopc.mjs
	echo "import * as hopc from \"../lib/hopc.mjs\"" >> $(NPMDIR)/bin/hopc.mjs
	chmod a+rx $(NPMDIR)/bin/hopc.mjs
	mv $(NPMDIR)/lib/hop-client.mjs $(NPMDIR)
	cat config.mjs.in | sed -e 's|@VERSION@|$(HOPRELEASE)|' -e 's|@BUILDTAG@|$(HOPBUILDTAG)|' > $(NPMDIR)/lib/config.mjs

clean:

cleanall: clean


build.old:
	mkdir -p $(NPMDIR)/bin
	echo "#!/usr/bin/env node" > $(NPMDIR)/bin/hopc.mjs
	echo "import * as hopc from \"../lib/hopc.mjs\"" >> $(NPMDIR)/bin/hopc.mjs
	chmod a+rx $(NPMDIR)/bin/hopc.mjs
	echo "const sc_jsstring2symbol = x => x;" > $(NPMDIR)/lib/hop-serialize.mjs
	echo "const sc_jsstring2keyword = x => x;" >> $(NPMDIR)/lib/hop-serialize.mjs
	echo "const sc_isSymbol = x => false;" >> $(NPMDIR)/lib/hop-serialize.mjs
	echo "const sc_isKeyword = x => false;" >> $(NPMDIR)/lib/hop-serialize.mjs
	echo "const hop_config = { Uint8Array: true };" >> $(NPMDIR)/lib/hop-serialize.mjs
	echo "const sc_cons = (a, d) => { return { car: a, cdr: d } };" >> $(NPMDIR)/lib/hop-serialize.mjs
	$(BGLCPP) -DHOPJS -DHOP_NOBROWSER ../../../share/hop-serialize.js >> $(NPMDIR)/lib/hop-serialize.mjs
	mv $(NPMDIR)/lib/hop-client.mjs $(NPMDIR)

