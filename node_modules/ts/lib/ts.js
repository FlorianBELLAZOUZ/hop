/*=====================================================================*/
/*    serrano/prgm/project/hop/hop/node_modules/ts/lib/ts.js           */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Tue Mar 13 07:37:34 2018                          */
/*    Last change :  Sat Apr 17 07:22:02 2021 (serrano)                */
/*    Copyright   :  2018-21 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    TS Hop.js language                                               */
/*=====================================================================*/
"use hopscript";

/*---------------------------------------------------------------------*/
/*    imports                                                          */
/*---------------------------------------------------------------------*/
const fs = require( "fs" );
const path = require( "path" );
const util = require( "util" );
import { config } from hop.config;
import { systemSync as system } from hop.system;

/*---------------------------------------------------------------------*/
/*    global configuration                                             */
/*---------------------------------------------------------------------*/
const tjson = require( "./tsrc.json" );
const tsrc = path.join( config.rcDirectory, "tsrc.js" );

const node = "node";
const tmp = process.env.TMP || "/tmp";

/*---------------------------------------------------------------------*/
/*    modified ...                                                     */
/*---------------------------------------------------------------------*/
function modified( src, tgt ) {
   return fs.statSync( src ).mtime > fs.statSync( tgt ).mtime;
}

/*---------------------------------------------------------------------*/
/*    Symbol.compiler ...                                              */
/*---------------------------------------------------------------------*/
exports[ Symbol.compiler ] = (file, options) => {
   const target = `${config.cacheDir}/${path.basename( file ).replace( /[.]ts$/, "" )}.ast.json`;
   const ts = require.resolve( "../comp/comp.js" );

   if( !fs.existsSync( config.cacheDir ) ) {
      fs.mkdirSync( config.cacheDir, { recursive : true } );
   }
   const cmd = `sh -c "${node} ${ts} ${file} ${target} 2>&1"`;
   
   const res = system( cmd );

   if( typeof res !== "object" ) {
      if( typeof res === "string" ) {
	 console.error( res );
      }
      return { type: "filename", syntax: "ast.json", value: target }
   } else {
      return { type: "json-error", value: res.data };
   }
}
