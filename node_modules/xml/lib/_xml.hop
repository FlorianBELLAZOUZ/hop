;*=====================================================================*/
;*    serrano/prgm/project/hop/hop/node_modules/feed/lib/_feed.hop     */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Thu Sep  6 15:19:35 2018                          */
;*    Last change :  Mon Mar  9 10:03:25 2020 (serrano)                */
;*    Copyright   :  2018-20 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    FEED Hop parser                                                  */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _feedn

   (library hopscript hop hopwidget nodejs web)
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    alist->kplist ...                                                */
;*---------------------------------------------------------------------*/
(define (alist->kplist alist)
   (append-map (lambda (a) (list (symbol->keyword (car a)) (cdr a))) alist))

;*---------------------------------------------------------------------*/
;*    make-xml-element ...                                             */
;*---------------------------------------------------------------------*/
(define (make-xml-element tag attrs nodes)
   (instantiate::xml-element
      (tag tag)
      (attributes (alist->kplist attrs))
      (body nodes)))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this scope module)
   (with-access::JsGlobalObject %this (__proto__)

      (define exports (js-get module (& "exports") %this))

      (js-bind! %this exports (& "createElement")
	 :value (js-make-function %this
		   (lambda (this tag attrs nodes)
		      (instantiate::xml-element
			 (tag (string->symbol (js-tostring tag %this)))
			 (attributes (js-jsobject->keyword-plist attrs %this))
			 (body (xml-unpack nodes %this))))
		   (js-function-arity 3 0)
		   (js-function-info :name "createElement" :len 3))
	 :writable #f
	 :enumerable #f)

      (js-bind! %this exports (& "load")
	 :value (js-make-function %this
		   (lambda (this file encoding)
		      (let ((path (js-tostring file %this))
			    (enc (if (eq? encoding (js-undefined))
				     'UTF-8
				     (string->symbol
					(js-tostring encoding %this)))))
			 (let ((xml (call-with-input-file path
					(lambda (in)
					   (xml-parse in
					      :encoding enc
					      :procedure make-xml-element)))))
			    (if (pair? xml)
				(if (string? (car xml))
				    (js-string->jsstring (car xml))
				    (car xml))
				(js-undefined)))))
		   (js-function-arity 2 0)
		   (js-function-info :name "parse" :len 2))
	 :writable #f
	 :enumerable #f)

      ))

      

