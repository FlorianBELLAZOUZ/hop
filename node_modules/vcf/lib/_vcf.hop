;*=====================================================================*/
;*    serrano/prgm/project/hop/hop/node_modules/feed/lib/_feed.hop     */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Thu Sep  6 15:19:35 2018                          */
;*    Last change :  Mon Mar  9 10:03:25 2020 (serrano)                */
;*    Copyright   :  2018-20 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    FEED Hop parser                                                  */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module csv
   (library hopscript hop hopwidget nodejs web mail)
   (export (hopscript %this this %scope %module)))

;*---------------------------------------------------------------------*/
;*    read-vcard                                                       */
;*---------------------------------------------------------------------*/
(cond-expand
   (|bigloo-4.4a|
    (define (read-vcard port)
       (or (port->vcard port) beof)))
   (else
    #unspecified))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*    -------------------------------------------------------------    */
;*    This is the function called by JavaScript when the Hop module    */
;*    is required. It binds the exports field of the newly             */
;*    allocated module                                                 */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (define vcard-cmap
      (js-strings->cmap
	 '#("familyname" "firstname" "emails" "phones" "addresses"
	    "id" "url" "face")
	 %this))

   (with-access::JsGlobalObject %this (js-object)
      (let ((exports (js-new0 %this js-object)))
         (js-put! %module (& "exports") exports #f %this)
         ;; bind the load function is the pseudo javascript module
         (js-put! exports (& "load")
            (js-make-function %this
               ;; wrap the Hop read-csv records function into a JS function
               (lambda (this url)
		  (call-with-input-file url
		     (lambda (port)
			(let loop ((cards '()))
			   (let ((vc (read-vcard port)))
			      (if (eof-object? vc)
				  (js-vector->jsarray
				     (list->vector (reverse! cards))
				     %this)
				  (loop 
				     (cons (vcard->jsobject vc vcard-cmap %this)
					cards))))))))
	       (js-function-arity 1 0)
	       (js-function-info :name "load" :len 1))
	    #f %this))))

;*---------------------------------------------------------------------*/
;*    vcard->jsobject ...                                              */
;*---------------------------------------------------------------------*/
(define (vcard->jsobject vcard cmap %this)
   
   (define (get-note key notes)
      (if (pair? notes)
	  (let ((c (assq key notes)))
	     (if (pair? c)
		 (js-obj->jsobject (cdr c) %this)
		 (js-undefined)))
	  (js-undefined)))
   
   (with-access::vcard vcard (familyname firstname emails
				phones addresses face notes)
      (js-object-literal-init!
	 (instantiateJsObject
	    (cmap cmap)
	    (__proto__ (js-object-proto %this))
	    (elements (vector
			 ;; familyname
			 (js-obj->jsobject familyname %this)
			 ;; firstname
			 (js-obj->jsobject firstname %this)
			 ;; emails
			 (js-vector->jsarray
			    (vector-map! (lambda (o)
					    (js-obj->jsobject o %this))
			       (list->vector emails))
			    %this)
			 ;; phones
			 (js-alist->jsobject phones %this)
			 ;; addresses
			 (js-alist->jsobject addresses %this)
			 ;; id
			 (get-note 'android-id notes)
			 ;; url
			 (get-note 'url notes)
			 ;; face
			 face))))))

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
hopscript
