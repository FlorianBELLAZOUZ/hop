;*=====================================================================*/
;*    .../project/hop/hop/node_modules/hopdroid/lib/_hopdroid.hop      */
;*    -------------------------------------------------------------    */
;*    Author      :  Manuel Serrano                                    */
;*    Creation    :  Sun Jul  6 06:15:53 2014                          */
;*    Last change :  Thu May 21 13:39:16 2020 (serrano)                */
;*    Copyright   :  2014-20 Manuel Serrano                            */
;*    -------------------------------------------------------------    */
;*    hopdroid bindings                                                */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _texinfo

   (library hopscript hop hopwidget nodejs phone)

   (cond-expand ((library hopdroid) (library hopdroid)))
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    phone-sig ...                                                    */
;*---------------------------------------------------------------------*/
(define phone-sig (cons 1 2))

;*---------------------------------------------------------------------*/
;*    phone? ...                                                       */
;*---------------------------------------------------------------------*/
(define (phone? o)
   (cond-expand
      ((library hopdroid)
       (when (isa? o JsWrapper)
	  (with-access::JsWrapper o (data)
	     (isa? data androidphone))))
      (else
       #f)))

;*---------------------------------------------------------------------*/
;*    number->llong ...                                                */
;*---------------------------------------------------------------------*/
(define (number->llong n)
   (cond
      ((fixnum? n) (fixnum->llong n))
      ((flonum? n) (flonum->llong n))
      (else #l0)))
       
;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this scope module)
   (&with!
      
      (define exports (js-get module (& "exports") %this))
      
      ;; bind the module in the texinfo scope
      (js-put! scope (& "module") module #f %this)
      
      (define (bind-phone-getter! obj name getter)
	 (js-bind! %this obj name
	    :get (js-make-function %this
		    (lambda (this)
		       (if (phone? this)
			   (with-access::JsWrapper this (data)
			      (js-string->jsstring (getter data)))
			   (js-undefined)))
		    0 name)
	    :writable #f
	    :enumerable #t))
      
      ;; phone-prototype
      (define phone-prototype
	 (with-access::JsGlobalObject %this (js-object)
	    (cond-expand
	       ((library hopdroid)
		(let ((obj (js-new0 %this js-object)))
		   ;; toString
		   (js-bind! %this obj (& "toString")
		      :value (js-make-function %this
				(lambda (this)
				   (& "[Object Phone]"))
				0 (& "toString")))
		   ;; sdk
		   (bind-phone-getter! obj (& "sdk")
		      (lambda (data)
			 (with-access::androidphone data (sdk) sdk)))
		   ;; model
		   (bind-phone-getter! obj (& "model")
		      (lambda (data)
			 (with-access::androidphone data (model) model)))
		   ;; product
		   (bind-phone-getter! obj (& "product")
		      (lambda (data)
			 (with-access::androidphone data (product) product)))
		   ;; addEventListener
		   (js-bind! %this obj (& "addEventListener")
		      :value (js-make-function %this
				(lambda (this evt ltn)
				   (when (phone? this)
				      (with-access::JsWrapper this (data)
					 (let ((w (js-current-worker)))
					    (add-event-listener! data
						  (js-tostring evt %this)
					       (lambda (e)
						  (with-access::event e (value)
						     (js-worker-push-thunk! w "listener"
							(lambda ()
							   (with-handler
							      (lambda (exn)
								 (exception-notify exn)
								 (raise exn))
							      (let ((o (js-alist->jsobject
									  `((target . ,this)
									    (name . ,evt)
									    (value . ,(if (pair? value)
											  (js-vector->jsarray
											     (list->vector
												(map (lambda (v)
													(js-obj->jsobject v %this))
												   value))
											     %this)
											  value)))
									  %this)))
								 (js-call1 %this ltn this o))))))))))))
				2 (& "addEventListener"))
		      :writable #f
		      :enumerable #t)
		   ;; sms
		   (js-bind! %this obj (& "sendSms")
		      :value (js-make-function %this
				(lambda (this no text)
				   (when (phone? this)
				       (with-access::JsWrapper this (data)
					  (phone-sms-send data
					     (js-tostring no %this)
					     (js-tostring text %this)))))
				2 (& "sendSms"))
		      :writable #f
		      :enumerable #t)
		   ;; call
		   (js-bind! %this obj (& "placeCall")
		      :value (js-make-function %this
				(lambda (this no window)
				   (when (phone? this)
				       (with-access::JsWrapper this (data)
					  (phone-call-start data
					     (js-tostring no %this)
					     (if (eq? window (js-undefined)) #f window)))))
				2 (& "placeCall"))
		      :writable #f
		      :enumerable #t)
		   (js-bind! %this obj (& "stopCall")
		      :value (js-make-function %this
				(lambda (this)
				   (when (phone? this)
				       (with-access::JsWrapper this (data)
					  (phone-call-stop data))))
				0 (& "stopCall"))
		      :writable #f
		      :enumerable #t)
		   ;; vibrate
		   (js-bind! %this obj (& "vibrate")
		      :value (js-make-function %this
				(lambda (this frequency repetition)
				   (when (phone? this)
				      (with-access::JsWrapper this (data)
					 (cond
					    ((js-array? frequency)
					     (if (and (fixnum? repetition) (integer? repetition))
						 (phone-vibrate data
						    (vector-map number->llong
						       (jsarray->vector frequency %this))
						    repetition)
						 (phone-vibrate data
						    (vector-map number->llong
						       (jsarray->vector frequency %this) 1))))
					    ((integer? frequency)
					     (if (and (fixnum? repetition) (integer? repetition))
						 (phone-vibrate data (number->llong frequency) repetition)
						 (phone-vibrate data frequency 1)))
					    ((eq? frequency (js-undefined))
					     (phone-vibrate data #unspecified 1))))))
				2 (& "vibrate"))
		      :writable #f
		      :enumerable #t)
		   (js-bind! %this obj (& "vibrateStop")
		      :value (js-make-function %this
				(lambda (this)
				   (when (phone? this)
				      (with-access::JsWrapper this (data)
					 (phone-vibrate-stop data))))
				2 (& "vibrateStop"))
		      :writable #f
		      :enumerable #t)
		   ;; the prototype
		   obj))
	       (else
		(js-new0 %this js-object)))))

      (define (js-phone-alloc::JsWrapper %this constructor::JsFunction)
	 (with-access::JsGlobalObject %this (js-object)
	    (instantiateJsWrapper
	       (__proto__ phone-prototype)
	       (data (cond-expand
			((library hopdroid)
			 (instantiate::androidphone))
			(else
			 (js-undefined))))
	       (obj phone-sig))))

      ;; phone
      (letrec* ((js-phone-construct (lambda (this)
				       (if (phone? this)
					   this
					   (js-phone-alloc %this js-phone))))
		(js-phone (js-make-function %this
			     js-phone-construct
			     0 (& "phone")
			     :prototype phone-prototype
			     :alloc js-phone-alloc
			     :construct js-phone-construct)))
	 (js-bind! %this exports (& "phone")
	    :value js-phone
	    :writable #f
	    :enumerable #t))))

hopscript
