;*=====================================================================*/
;*    .../hop/3.5.x/node_modules/hopdroid/lib/_simulator.hop           */
;*    -------------------------------------------------------------    */
;*    Author      :  manuel serrano                                    */
;*    Creation    :  Mon Nov 30 07:29:00 2020                          */
;*    Last change :  Tue Jan 25 16:56:44 2022 (serrano)                */
;*    Copyright   :  2020-22 manuel serrano                            */
;*    -------------------------------------------------------------    */
;*    Simulated phone (for debug)                                      */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _simulator

   (library hopscript hop hopwidget nodejs mail phone)

   (cond-expand ((library hopdroid) (library hopdroid)))
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))

;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this scope module)
   (&with!
      (define exports (js-get module (& "exports") %this))

      (js-bind! %this exports (& "setEmulatedPhone")
	 :value (js-make-function %this
		   (lambda (this phone)
		      (set-simulated-phone! phone))
		   (js-function-arity 1 0)
		   (js-function-info :name "setEmulatedPhone" :len 1))
	 :writable #f
	 :enumerable #t)

      (js-bind! %this exports (& "getEmulatedPhone")
	 :value (js-make-function %this
		   (lambda (this)
		      (get-simulated-phone))
		   (js-function-arity 0 0)
		   (js-function-info :name "getEmulatedPhone" :len 0))
	 :writable #f
	 :enumerable #t)))

;*---------------------------------------------------------------------*/
;*    phone-simulated ...                                              */
;*---------------------------------------------------------------------*/
(define phone-simulated #f)

;*---------------------------------------------------------------------*/
;*    get-simulated-phone ...                                          */
;*---------------------------------------------------------------------*/
(define (get-simulated-phone)
   phone-simulated)

;*---------------------------------------------------------------------*/
;*    set-simulated-phone! ...                                         */
;*---------------------------------------------------------------------*/
(define (set-simulated-phone! phone)
   (set! phone-simulated phone))

;*---------------------------------------------------------------------*/
;*    simulated-contacts ...                                           */
;*    -------------------------------------------------------------    */
;*    Must be a pre-allocated list to accomodate possible              */
;*    side effects and the dummy contact database.                     */
;*---------------------------------------------------------------------*/
(define simulated-contacts
   (list (instantiate::vcard
	    (uid "34")
	    (familyname "Dupont")
	    (firstname "Jean")
	    (emails '((label: "work" email: "jean@dupont.org")))
	    (phones '((label: "default" number: "1111-111-11")
		      (label: "work" number: "4444-444-44")))
	    (x-color "#7227FF")
	    (addresses '()))
      (instantiate::vcard
	 (uid "35")
	 (familyname "Dulac")
	 (firstname "Michel")
	 (emails '((label: "home" email: "Michel@dulac.org")))
	 (phones '((label: "default" number: "2222-222-22")))
	 (addresses '((label: "work" address: #("2004 route des Lucioles")
			 :city "Sophia Antipolis" :pobox "BP 93" :zip "0690")))
	 (x-color "#FFB227"))
      (instantiate::vcard
	 (uid "35")
	 (familyname "Durant")
	 (firstname "Paul")
	 (emails '((label: "home" email: "Paul@durant.org")))
	 (phones '())
	 (addresses '())
	 (x-color "#27BEFF"))))

;*---------------------------------------------------------------------*/
;*    simulator-trigger-event ...                                      */
;*---------------------------------------------------------------------*/
(define (simulator-trigger-event this::JsWrapper event . vals)
   (with-access::JsWrapper this (obj)
      (let ((events (phone-get obj 'events)))
	 (phone-set! obj 'events (cons (cons event vals) events)))))

;*---------------------------------------------------------------------*/
;*    hopdroid/simulator ...                                           */
;*---------------------------------------------------------------------*/
(define-service (hopdroid/simulator)
   (if phone-simulated
       (with-access::JsWrapper phone-simulated (obj data)
	  (let ((%this (vector-ref data 1))
		(%worker (vector-ref data 0)))
	     (js-worker-exec %worker "hopdroid/simulator" #t
		(lambda ()
		   (let ((conn (<DIV>)))
		      (<HTML>
			 (<H1> (js-tostring (js-get phone-simulated (js-string->jsstring "product") %this) %this))
			 (js-tostring (js-get phone-simulated (js-string->jsstring "model") %this) %this)
			 " - "
			 (js-tostring (js-get phone-simulated (js-string->jsstring "sdk") %this) %this)
			 (<H1> "Events")
			 (let ((smsno (<INPUT> type: "tel" :class "sms-number"))
			       (smstext (<TEXTAREA> :class "sms-text")))
			    (<H2> "smsreceived")
			    (<DIV>
			       (<BUTTON> :onclick ~(with-hop ($hopdroid/simulator/emit "smsreceived"
								(list $smsno.value $smstext.value))
						      (lambda ()
							 (innerHTML-set! $conn "smsreceived emitted")))
				  "emit smsreceived")
			       " no" smsno
			       " text" smstext))
			 (let ((smsno (<INPUT> type: "tel" :class "sms-number"))
			       (smstext (<TEXTAREA> :class "sms-text")))
			    (<H2> "smsdelivered")
			    (<DIV>
			       (<BUTTON> :onclick ~(with-hop ($hopdroid/simulator/emit "smsdelivered"
								(list $smsno.value $smstext.value))
						      (lambda ()
							 (innerHTML-set! $conn "smsdelivered sent")))
				  "emit smsdelivered")
			       " no" smsno
			       " text" smstext))
			 (<H1> "Console")
			 conn))))))
       (<HTML>
	  "no simulated phone")))

;*---------------------------------------------------------------------*/
;*    emit ...                                                         */
;*---------------------------------------------------------------------*/
(define (emit evt val)
   (with-access::JsWrapper phone-simulated (obj data)
      (let ((%worker (vector-ref data 0))
	    (%this (vector-ref data 1)))
	 (js-worker-exec %worker "hopdroid/simulator" #t
	    (lambda ()
	       (for-each (lambda (listener)
			    (when (string=? (car listener) evt)
			       ((cdr listener)
				(instantiate::event
				   (target phone-simulated)
				   (name evt)
				   (value val)))))
		  (phone-get obj 'listeners)))))))

;*---------------------------------------------------------------------*/
;*    phone-get ...                                                    */
;*---------------------------------------------------------------------*/
(define (phone-get obj::phone field::symbol)
   (let* ((k (object-class obj))
	  (f (find-class-field k field)))
      (if (class-field? f)
	  ((class-field-accessor f) obj)
	  (error "phone-get" "cannot find field" field))))

;*---------------------------------------------------------------------*/
;*    phone-set! ...                                                   */
;*---------------------------------------------------------------------*/
(define (phone-set! obj::phone field::symbol value)
   (let* ((k (object-class obj))
	  (f (find-class-field k field)))
      (if (class-field? f)
	  ((class-field-mutator f) obj value)
	  (error "phone-set!" "cannot find field" field))))

;*---------------------------------------------------------------------*/
;*    hopdroid/simulator/emit ...                                      */
;*---------------------------------------------------------------------*/
(define-service (hopdroid/simulator/emit evt val)
   (when phone-simulated
      (emit evt val)))

;*---------------------------------------------------------------------*/
;*    Module value                                                     */
;*---------------------------------------------------------------------*/
hopscript
