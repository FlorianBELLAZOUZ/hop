/*=====================================================================*/
/*    .../prgm/project/hop/3.0.x/node_modules/hopdoc/lib/hopdoc.js     */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Jun 26 08:21:30 2014                          */
/*    Last change :  Thu Jul 30 08:49:41 2015 (serrano)                */
/*    Copyright   :  2014-15 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    HOPDOC, tool kit for generating the hop.js documentation         */
/*=====================================================================*/
"use hopscript"

const hop = require( "hop" );
const md = require( "markdown" );
const fontifier = require( "fontifier" );
const doc = require( "./_hopdoc.hop" );

/*---------------------------------------------------------------------*/
/*    Global constants ...                                             */
/*---------------------------------------------------------------------*/
const compilers = {
   markdown: "toMarkdown"
};

/*---------------------------------------------------------------------*/
/*    compileFile ...                                                  */
/*---------------------------------------------------------------------*/
function compileFile( path, format ) {
   const xml = md.parseFile( path, hop.locale, GLOBAL );
   const comp = format ? compilers[ format ] : "toMarkdown";

   if( comp in xml ) {
      return xml[ comp ]();
   } else {
      throw "illegal compilation format " + format + "";
   }
}

/*---------------------------------------------------------------------*/
/*    includeCode ...                                                  */
/*---------------------------------------------------------------------*/
function includeCode( path, lang, beg, end ) {
   const ip = #:open-input-file( #:js-tostring( path, #:%this ) );
   
   if( !ip ) {
      throw new Error( 'Cannot find file "' + path + '"' );
   }

   if( lang == undefined ) {
      lang = fontifier.hopscript;
   }

   try {
      return <md.PRE> {
	 <md.CODE> {
	    class: "fontifier-prog",
	    lang( ip, beg, end )
	 }
      }
   } finally {
      #:close-input-port( ip );
   }
}

/*---------------------------------------------------------------------*/
/*    exports                                                          */
/*---------------------------------------------------------------------*/
exports.css = fontifier.css;
exports.compileFile = compileFile;
exports.includeCode = includeCode;
exports.include = function( file, beg, end ) {
   console.log( "hopdoc.js include file=", file, " beg=", beg, " end=", end );
   return doc.include( file, beg, end );
}

exports.seeAlso = function( keywords ) {
   return ""
};

exports.parseFile = function( file ) {
   return md.parseFile( file, hop.locale, fontifier )
};
