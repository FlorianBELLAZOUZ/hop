/*=====================================================================*/
/*    .../prgm/project/hop/3.0.x/node_modules/hopdoc/lib/hopdoc.js     */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Jun 26 08:21:30 2014                          */
/*    Last change :  Sat Oct 10 16:10:56 2015 (serrano)                */
/*    Copyright   :  2014-15 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    HOPDOC, tool kit for generating the hop.js documentation         */
/*=====================================================================*/
"use hopscript"

const hop = require( "hop" );
const md = require( hop.markdown );
const fontifier = require( hop.fontifier );
const doc = require( "./_hopdoc.hop" );
const fs = require( "fs" );
const path = require( "path" );

/*---------------------------------------------------------------------*/
/*    Global constants ...                                             */
/*---------------------------------------------------------------------*/
const compilers = {
   markdown: "toMarkdown"
};

/*---------------------------------------------------------------------*/
/*    compileFile ...                                                  */
/*---------------------------------------------------------------------*/
function compileFile( path, format = undefined ) {
   const xml = md.load( path, hop.locale, GLOBAL );
   const comp = format ? compilers[ format ] : "toMarkdown";

   if( comp in xml ) {
      return xml[ comp ]();
   } else {
      throw "illegal compilation format " + format + "";
   }
}

/*---------------------------------------------------------------------*/
/*    includeCode ...                                                  */
/*---------------------------------------------------------------------*/
function includeCode( path, lang = undefined, beg = undefined, end = undefined ) {
   const ip = #:open-input-file( #:js-tostring( path, #:%this ) );
   
   if( !ip ) {
      throw new Error( 'Cannot find file "' + path + '"' );
   }

   if( lang == undefined ) {
      lang = fontifier.hopscript;
   }

   try {
      return <md.PRE> {
	 <md.CODE> {
	    class: "fontifier-prog",
	    lang( ip, beg, end )
	 }
      }
   } finally {
      #:close-input-port( ip );
   }
}

/*---------------------------------------------------------------------*/
/*    toc ...                                                          */
/*---------------------------------------------------------------------*/
function toc( doc, clazz = "toc" ) {
   
   function getTags( el ) {
      if( el instanceof Array ) {
	 return Array.prototype.concat.apply( [], el.map( getTags ) );
      }
      
      if( typeof( el ) == "pair" ) {
	 return Array.prototype.concat.apply( [], el.map( getTags ).toArray() );
      }

      if( typeof( el ) == "xml-element" || typeof( el ) == "xml-html" ) {
	 return el.getElementsByClassName( clazz );
      }
      return [];
   }

   return getTags( doc.XML );
}

/*---------------------------------------------------------------------*/
/*    index ...                                                        */
/*---------------------------------------------------------------------*/
function index( doc, tags=["h3"], classes=["parameter", "function", "tag"] ) {
   var res = [];

   for( var i = 0; i < classes.length; i++ ) {
      res = res.concat( toc( doc, classes[ i ] ) );
   }

   return res
      .filter( function( el, idx = undefined, arr = undefined ) {
	 return tags.indexOf( el.tagName ) >= 0; } )
      .map( function( el, idx = undefined, arr = undefined ) {
	 var proto = el.innerHTML.trim();
	 var i = proto.indexOf( "." );
	 var key = i >= 0 ? proto.substring( i + 1 ) : proto;

	 key = key.toLowerCase();

	 key = key.replace( /&[lg]t;/g, "" );
	 key = key.replace( /^new /, "" );
	 var m = key.match( /([^ [(]+)/ );
	 if( m ) key = m[ 1 ];
	 
	 return { key: key, proto: proto, id: el.id };
      } );
}

/*---------------------------------------------------------------------*/
/*    includeDir ...                                                   */
/*---------------------------------------------------------------------*/
function includeDir( dir ) {
   return fs.readdirSync( dir )
      .filter( function( e, idx = undefined, arr = undefined ) {
	 return e.match( /[.]md$/ ) && (e != "index.md");
      } )
      .sort( function( path1, path2 ) {
	 return path1.naturalCompare( path2 );
      } )
      .map( function( file ) {
	 var fp = path.join( dir, file );
	 return md.load( fp, hop.locale, fontifier ).XML;
      } );
}

/*---------------------------------------------------------------------*/
/*    DIR ...                                                          */
/*---------------------------------------------------------------------*/
var DIR = path.dirname( module.filename );

/*---------------------------------------------------------------------*/
/*    P ...                                                            */
/*---------------------------------------------------------------------*/
function P( file ) {
   return path.normalize( path.join( DIR, file ) );
}
   
/*---------------------------------------------------------------------*/
/*    exports                                                          */
/*---------------------------------------------------------------------*/
exports.css = P( "../hss/hopdoc.hss" ), fontifier.css;
exports.jscript = [];

exports.compileFile = compileFile;
exports.includeCode = includeCode;
exports.include = function( file, beg = undefined, end = undefined ) {
   return doc.include( file, beg, end );
}

exports.ROOT = P( "../../.." );
exports.EXAMPLES_DIR = path.join( exports.ROOT, "examples" );

exports.toc = toc;
exports.index = index;

exports.seeAlso = function( keywords ) {
   return ""
};

exports.load = function( file ) {
   return md.load( file, hop.locale, fontifier )
};

exports.eval = function( obj ) {
   return md.eval( obj, hop.locale, fontifier )
};

exports.includeDir = includeDir;
