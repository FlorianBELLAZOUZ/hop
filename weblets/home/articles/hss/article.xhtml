<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd" [<!ENTITY nbsp "&#160;">]>
<html xmlns='http://www.w3.org/1999/xhtml' xmlns:svg='http://www.w3.org/2000/svg'>
<head><meta http-equiv='Content-Type' content="application/xhtml+xml; charset=UTF-8"/>
<script type='text/javascript'>
<![CDATA[

function hop_etc_directory() { return "/usr/local/etc"; }
function hop_bin_directory() { return "/usr/local/bin"; }
function hop_lib_directory() { return "/usr/local/lib"; }
function hop_share_directory() { return "/usr/local/share/hop"; }
function hop_var_directory() { return "/users/serrano/.config/hop"; }
function hop_contribs_directory() { return "/usr/local/share/hop/contribs"; }
function hop_weblets_directory() { return "/usr/local/lib/hop/2.2.0/weblets"; }
function hop_debug() { return 2; }
function hop_session() { return 216356091; }
function hop_realm() { return "hop"; }
]]>
</script>
<style type='text/css'>
<![CDATA[

div.foot-buttons {
  margin-top: 1ex;
}

a.foot-button {
  opacity: 0.3;
  background-color: inherit;
  color: inherit;
  text-decoration: none;
}

a.foot-button:hover {
  opacity: 1;
}

a.foot-button img {
  border-width: 0;
  background: transparent;
  padding-left: 5px;
  padding-right: 5px;
}

mi {
  font-family: cmmi10;
}

mo {
  font-family: cmr10;
}

div[hssclass=hop-error] {
  top: 0;
  left: 0;
  right: 0;
  position: absolute;
  overflow: hidden;
  min-height: 60ex;
  max-height: 60ex;
}

body[hssclass=hop-error] div[hssclass=hop-error] {
  top: 3ex;
  left: 4em;
  right: 4em;
  background: white;
  border: 4px dashed;
  position: absolute;
  overflow: hidden;
  border-color: red;
}

div[hssclass=hop-error].warning {
  border-color: darkorange;
}

div[hssclass=hop-error].notfound {
  border-color: blue;
}

div[hssclass=hop-error].security {
  border-color: #f00;
}

div[hssclass=hop-error].remote {
  border-color: orange;
}

div[hssclass=hop-error] > img {
  position: absolute;
  left: 24px;
  top: 20px;
}

div[hssclass=hop-error] > div {
  position: absolute;
  left: 96px;
  top: 20px;
  right: 1em;
  bottom: 1ex;
}

div[hssclass=hop-error-title] {
  font-size: x-large;
  font-weight: bold;
  border-bottom: 1px solid #bbb;
  color: red;
}

div[hssclass=hop-error-msg] {
  margin-bottom: 20px;
  margin-top: 20px;
  padding-bottom: 20px;
  padding-top: 20px;
  font-family: sans-serif;
  font-weight: bold;
}

div[hssclass=hop-error-msg] tt {
  font-weight: 200;
  font-size: large;
}

div[hssclass=hop-error] pre {
  overflow: auto;
  min-height: 80ex;
  max-height: 80ex;
  border: 1px dashed #bbb;
  background-color: #ffe;
  font-size: 8pt;
  color: #333;
  font-weight: 200;
  padding-bottom: 5ex;
  padding: 2px;
}

div[hssclass=hop-error] tt.notfound {
  color: blue;
}


]]>
</style>
<script type='text/javascript'>
<![CDATA[

/* Automatically generated file (don't edit) */
/* Copyright Manuel Serrano, see Hop's LICENSE file */
/* 
Thu Nov 18 17:30:26 CET 2010
 */
/* Automatically generated file (don't edit) */
/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/etc/hop-autoconf.js.in            */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu May 18 05:26:40 2006                          */
/*    Last change :  Fri Aug  6 14:01:14 2010 (serrano)                */
/*    Copyright   :  2006-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    All non portable components of the HOP runtime system. All other */
/*    HOP script libraries are supposed *not* to check features        */
/*    availabilities.                                                  */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    undefined value                                                  */
/*---------------------------------------------------------------------*/
var undefined;

/*---------------------------------------------------------------------*/
/*    Name and version                                                 */
/*---------------------------------------------------------------------*/
/*** META ((export hop-name) (arity #t)) */
function hop_name() {
   return "Hop";
}

/*** META ((export hop-version) (arity #t)) */
function hop_version() {
   return "2.2.0";
}

/*** META ((export hop-backend) (arity #t)) */
function hop_backend() {
   return "native";
}

/*** META ((export hop-url) (arity #t)) */
function hop_url() {
   return "http://hop.inria.fr/";
}

/*---------------------------------------------------------------------*/
/*    Hop configuration                                                */
/*---------------------------------------------------------------------*/
var hop_enable_location_event = true;

/*---------------------------------------------------------------------*/
/*    hop-service-base                                                 */
/*    -------------------------------------------------------------    */
/*    The prefix of all HOP weblets.                                   */
/*---------------------------------------------------------------------*/
/*** META ((export hop-service-base) (arity #t)) */
function hop_service_base() {
   return "/hop";
}

/*---------------------------------------------------------------------*/
/*    hop_get_flash_version ...                                        */
/*---------------------------------------------------------------------*/
function hop_get_flash_version() {
   if( navigator.mimeTypes
       && navigator.mimeTypes[ "application/x-shockwave-flash" ] ) {
      var p = navigator.mimeTypes[ "application/x-shockwave-flash" ].enabledPlugin;
   
      if( p && p.description ) {
	 var d = p.description;

	 if( (typeof d == "string") && (d.indexOf( "Shockwave Flash " ) == 0) ) {
	    return parseFloat( d.substring( 16, d.indexOf( " ", 16 ) ) );
	 }
      }
   } else {
      try {
	 axo = new ActiveXObject( "ShockwaveFlash.ShockwaveFlash.7" );
	 var m = axo.GetVariable( "$version" ).match( /.+ ([0-9]+),/ );
	 if( m != null ) {
	    return m[ 1 ];
	 }
      } catch (e) {
      }
   }

   return 0;
}

/*---------------------------------------------------------------------*/
/*    hop_Config ...                                                   */
/*    -------------------------------------------------------------    */
/*    This mostly contains external information that cannot be         */
/*    deduced by introspection.                                        */
/*---------------------------------------------------------------------*/
function hop_Config() {
  /* cpu speed */
  this.cpu_speed = 100;
  if( navigator.platform.indexOf( "armv6" ) >= 0 ) this.cpu_speed = 40;
  if( navigator.platform.indexOf( "armv5" ) >= 0 ) this.cpu_speed = 30;
  if( navigator.platform.indexOf( "WinCE" ) >= 0 ) this.cpu_speed = 30;

  /* gpu speed */
  this.gpu_speed = 100;
  if( navigator.platform.indexOf( "armv6" ) >= 0 ) this.gpu_speed = 30;

  /* js speed */
  this.js_speed = 50;

  /* pointing device */
  this.is_tablet = ( navigator.userAgent.indexOf( "Tablet" ) >= 0 );

  /* html5 */
  var audio = document.createElement( "audio" );
  this.html5_video = "play" in document.createElement( "video" );

  if( !"HTMLAudioElement" in window ) {
     this.html5_audio = false;
  } else {
    this.html5_audio = 
       ("play" in audio) && (audio.constructor === window[ "HTMLAudioElement" ]);
  }

  /* flash version */
  this.flash_version = hop_get_flash_version();
  this.flash_external_interface = false;
  this.flash_audio = false;
  this.flash_markup = "embed";

  /* Geolocation */
  this.geolocation = (navigator.geolocation ? true : false);

  /* default navigator setting */
  this.mouse_left_button = 0;

  this.inline_image = false;
  this.filtered_errors = [];
  this.css = 2.1;
  this.xhr_multipart = false; // see hop_make_xml_http_request conf
  this.clone_innerHTML = false; // see hop_create_element (hop-dom.js)
  this.eval_innerHTML = true;
  this.websocket = false;

  /* navigator specific configuration */
  if( navigator.userAgent.indexOf( "MSIE" ) >= 0 ) {
     this.js_speed = 20;
     this.navigator_family = "msie";
     this.mouse_left_button = 1;
     this.flash_external_interface = true;
     this.flash_audio = false;
     this.flash_markup = "object";
     this.inline_image = false;
     this.clone_innerHTML = true;
     if( navigator.userAgent.indexOf( "MSIE 6.0" ) >= 0 ) {
	hop_enable_location_event = false;
     }
  } else if( navigator.userAgent.indexOf( "Opera" ) >= 0 ) {
     this.js_speed = 70;
     this.navigator_family = "opera";
     this.mouse_left_button = 0;
     this.flash_external_interface = false;
     this.flash_audio = false;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.clone_innerHTML = true;
  } else if( navigator.userAgent.indexOf( "Chrome" ) >= 0 ) {
     this.js_speed = 100;
     this.navigator_family = "chrome";
     this.mouse_left_button = 0;
     this.flash_external_interface = true;
     this.flash_audio = false;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.css = 3;
     this.clone_innerHTML = true;
     if( ! "Window" in window || window.Window === undefined ) {
       window.Window = window.constructor;
     }
  } else if( navigator.userAgent.indexOf( "Safari" ) >= 0 ) {
     this.js_speed = 80;
     this.navigator_family = "safari";
     this.mouse_left_button = 0;
     this.flash_external_interface = true;
     this.flash_audio = false;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.clone_innerHTML = true;
  } else if( navigator.userAgent.indexOf( "WebKit" ) >= 0 ) {
     this.navigator_family = "webkit";
     this.js_speed = 80;
     this.mouse_left_button = 0;
     this.flash_external_interface = true;
     this.flash_audio = false;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.clone_innerHTML = true;
  } else if( navigator.userAgent.indexOf( "KHTML" ) >= 0 ) {
     this.navigator_family = "khtml";
     this.mouse_left_button = 1;
     this.flash_external_interface = true;
     this.flash_audio = false;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.clone_innerHTML = true;
  } else if( navigator.userAgent.indexOf( "Mozilla" ) >= 0 ) {
     if( navigator.userAgent.match( /3.[56][^ ]*$/ ) ) {
        /* Firefox 3.5, 3.6 */
        this.js_speed = 75;	    
        this.css = 3;
     } else if( navigator.userAgent.match( /3.0[^ ]*$/ ) ) {
        /* Firefox 3.0, 3.1 */
        this.js_speed = 60;	    
     } else {
        this.js_speed = 50;
     }

     this.navigator_family = "mozilla";
     this.mouse_left_button = 0;
     this.flash_external_interface = true;
     this.flash_audio = true;
     this.flash_markup = "embed";
     this.inline_image = true;
     this.filtered_errors = ["javascript:top.location+\"__flashplugin_unique__\"", "tipElement.ownerDocument is null"];
  } else {
     alert( "Unknown navigator (" + navigator.userAgent +
	    "), using default settings..." );
  }

  /* Screen Dimensions */
  this.screen_width = screen.width;
  this.screen_height = screen.height;
  this.screen_available_width = screen.availWidth;
  this.screen_available_height = screen.availHeight;
  this.screen_color_depth = screen.colorDepth;
  
     
  this.version = hop_version();
  this.backend = hop_backend();
}

/*---------------------------------------------------------------------*/
/*    hop_config ...                                                   */
/*---------------------------------------------------------------------*/
var hop_config = new hop_Config();

/*---------------------------------------------------------------------*/
/*    hop_config_get ...                                               */
/*---------------------------------------------------------------------*/
/*** META ((export hop-config) (arity #f)) */
function hop_config_get( key ) {
   if( arguments.length == 0 ) {
      var l = null;
      
      for( var p in hop_config ) {
	 var c = new sc_Pair( sc_jsstring2symbol( p ), hop_config[ p ]);
	 l = new sc_Pair( c, l );
      }
      
      return l;
   } else if( !sc_isSymbol( key ) && !sc_isKeyword( key ) ) {
      return false;
   } else if( sc_isSymbol( key ) ) {
      return hop_config[ sc_symbol2jsstring( key ) ];
   } else {
      return hop_config[ sc_keyword2jsstring( key ) ];
   }
}

/*---------------------------------------------------------------------*/
/*    hop_flash_minversion_set ...                                     */
/*---------------------------------------------------------------------*/
function hop_flash_minversion_set( v ) {
   if( v > hop_config.flash_version ) hop_config.flash_version = v;
}

/*---------------------------------------------------------------------*/
/*    hop_flash_audio_set ...                                          */
/*---------------------------------------------------------------------*/
function hop_flash_audio_set( v ) {
   hop_config.flash_audio = v;
}

/*---------------------------------------------------------------------*/
/*    hop_innerHTML_need_evalp ...                                     */
/*    -------------------------------------------------------------    */
/*    This test sets the variable hop_innerHTML_need_eval to           */
/*    false if innerHTML evaluates the scripts contained in the        */
/*    DOM nodes it receives as argument.                               */
/*---------------------------------------------------------------------*/
var hop_innerHTML_need_evalp = true;

var tmp = document.createElement( "div" );

try {
   tmp.innerHTML = "<script type='text/javascript'>hop_config.eval_innerHTML = false;<\u002fscript>";
   tmp = tmp.cloneNode( true );
   if( ("body" in document) && (document.body != null) ) {
      document.body.appendChild( tmp );
      document.body.removeChild( tmp );
   } else {
      if( ("documentElement" in document) &&  
          (document.documentElement != null) ) {
	 document.documentElement.appendChild( tmp );
	 document.documentElement.removeChild( tmp );
      } else {
	 var body = document.getElementsByTagName( "body" )[ 0 ];
	 body.appendChild( tmp );
	 body.removeChild( tmp );
      }
   }
} catch( e ) {
     ;
}

/*---------------------------------------------------------------------*/
/*    hop_json_parse ...                                               */
/*---------------------------------------------------------------------*/
var hop_json_parse;

if( "JSON" in window ) {
   hop_json_parse = JSON.parse;
} else {
   hop_json_parse = function( o ) { return hop_unjson( eval( o ) ); };
}

/*---------------------------------------------------------------------*/
/*    hop_properties_to_string ...                                     */
/*---------------------------------------------------------------------*/
function hop_properties_to_string( obj ) {
   var res = "";
   var i = 0;
   for( var p in obj ) {
      if( i === 10 ) {
	 res += p + "\n";
	 i = 0;
      } else {
	 i++;
	 res += p + " ";
      }
   }
   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_properties_values_to_string ...                              */
/*---------------------------------------------------------------------*/
function hop_properties_values_to_string( obj ) {
   var res = "";
   var i = 0;
   for( var p in obj ) {
      if( i === 10 ) {
	 res += p + "=" + obj[ p ] + "\n";
	 i = 0;
      } else {
	 i++;
	 res += p + "=" + obj[ p ] + " ";
      }
   }
   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_is_html_element ...                                          */
/*---------------------------------------------------------------------*/
/*** META ((export html-element?) (arity 1)) */
var hop_is_html_element;

if( !("HTMLElement" in window) ) {
   hop_is_html_element = function hop_is_html_element( obj ) {
      return (obj != null)
              && (((obj instanceof Object) || (typeof obj == "object"))
	      && (typeof obj.innerHTML == "string"));
   } 
} else {
   var ifr = document.createElement( "iframe" );

   if( ifr instanceof HTMLElement ) {
      hop_is_html_element = function hop_is_html_element( obj ) {
	 return (obj != null) && (obj instanceof HTMLElement);
      }
   } else {
      /* this is (an old) konqueror */
      var ifproto = ifr.__proto__;
      hop_is_html_element = function hop_is_html_element( obj ) {
	 return (obj instanceof HTMLElement) || (obj.__proto__ == ifproto);
      }
   }
}

/*---------------------------------------------------------------------*/
/*    DOMFormElement ...                                               */
/*---------------------------------------------------------------------*/
var hop_is_dom_form_element;

try {
   if( undefined instanceof HTMLFormElement ) {
      /* this test is always false but it checks if HTMLFormElement */
      /* is a plain JavaScript class. See below the catch clause.   */
      hop_is_dom_form_element = function hop_is_dom_form_element( obj ) {
	 return false;
      };
   } else {
      hop_is_dom_form_element = function hop_is_dom_form_element( obj ) {
	 return obj instanceof HTMLFormElement;
      };
   }
} catch( e ) {
   /* on some browsers (guess how, always the same), HTMLFormElement is */
   /* an opaque object that is not implemented as a plain JavaScript    */
   /* class (i.e., a JavaScript function), hence instanceof cannot be   */
   /* used.                                                             */
   hop_is_dom_form_element = function hop_is_dom_form_element( obj ) {
      return hop_is_html_element( obj ) && (obj.tagName === "form");
   };
}
  
if( !("HTMLCollection" in window) ) {
   window.HTMLCollection = function() { return false; };
}

if( !("HTMLInputElement" in window) ) {
   window.HTMLInputElement = function() { return false; };
}

if( !("HTMLTextAreaElement" in window) ) {
   window.HTMLTextAreaElement = function() { return false; };
}

if( !("HTMLSelectElement" in window) ) {
   window.HTMLSelectElement = function() { return false; };
}

/*---------------------------------------------------------------------*/
/*    hop_make_xml_http_request ...                                    */
/*---------------------------------------------------------------------*/
/*** META ((export make-xml-http-request) (JS hop_make_xml_http_request)) */

var hop_make_xml_http_request;

if( "XMLHttpRequest" in window ) {
   var req = new XMLHttpRequest();
   
   hop_make_xml_http_request = function hop_make_xml_http_request() {
      return new XMLHttpRequest();
   }
   if( "multipart" in req ) {
      hop_config.xhr_multipart = true;
   }
} else {
   if( "ActiveXObject" in window ) {
      hop_make_xml_http_request = function hop_make_xml_http_request() {
	 function hop_make_activexobject( ax ) {
	    var o = new Object();
	    var a = new ActiveXObject( ax );

	    o.activex = a;
	    
	    o.open = function( msg, svc, sync ) {
	       a.onreadystatechange = function() {
		  o.status = a.status;
		  o.readyState = a.readyState;
		  o.responseText = a.responseText;
		  
		  o.onreadystatechange();
	       }
	       if( sync ) {
		  var r = a.open( msg, svc, sync );
		  o.status = a.status;
		  o.readyState = a.readyState;
		  o.responseText = a.responseText;
		  
		  return r;
	       } else 
		  return a.open( msg, svc, sync );
	    }
	    
	    o.send = function( v ) {
	       return a.send( v );
	    }
	    
	    o.setRequestHeader = function( v ) {
	       return a.setRequestHeader( v );
	    };
	    
	    return o;
	 }
	 try {
	    /* don't try to play with prototypes, because   */
	    /* ActiveXObject are not fullfledged JS objects */
	    return hop_make_activexobject( "Msxml2.XMLHTTP" );
	 } catch( e ) {
	    try {
	       return hop_make_activexobject( "Microsoft.XMLHTTP" );
	    } catch( e ) {
	       alert( "*** ERROR: Don't know how to create XMLHttpRequest" );
	    }
	 }
      }
   } else {
      if( "XMLHttpRequest" in window ) {
	 hop_make_xml_http_request = function hop_make_xml_http_request() {
	    return new XMLHttpRequest();
	 }
      } else {
	 hop_make_xml_http_request = function hop_make_xml_http_request() {
	    alert( "*** ERROR: Don't know how to create XMLHttpRequest" );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    web socket                                                       */
/*---------------------------------------------------------------------*/
if( "WebSocket" in window ) {
   hop_config.websocket = true;
}

/*---------------------------------------------------------------------*/
/*    hop_header_content_type ...                                      */
/*---------------------------------------------------------------------*/
var hop_header_autoconf = hop_make_xml_http_request();
var hop_header_content_type;
var hop_header_hop_serialize;

if( typeof hop_header_autoconf.getResponseHeader == "function" ) {
   hop_header_content_type = function hop_header_content_type( http ) {
      var h = http.getResponseHeader( "Content-Type" );

      if( h ) {
	 var i = h.indexOf( ";" );

	 if( i >= 0 ) {
	    return h.substring( 0, i );
	 } else {
	    return h;
	 }
      } else {
	 return "application/text";
      }
   }
   hop_header_hop_serialize = function hop_header_hop_serialize( http ) {
      var h = http.getResponseHeader( "Hop-Serialize" );

      if( h ) {
	 return h;
      } else {
	 return "javascript";
      }
   }
} else {
   hop_header_content_type = function hop_header_content_type( http ) {
      var hds = http.getAllResponseHeaders();
      var i = hds.indexOf( "Content-Type" );
      if( i < 0 ) i = hds.indexOf( "content-type" );
      if( i < 0 ) i = hds.indexOf( "Content-type" );
      
      if( i < 0 ) return "application/text";

      var j = hds.indexOf( "\n", i + 1 );
      var s = (j >= 0) ? hds.substring( i, j ) : hds.substring( i, s.length );
      var m = s.match( "[ \t:]+([^ \n;]*)" );

      if( m )
	 return m[ 1 ];
      else
	 return "application/text";
   }
   hop_header_hop_serialize = function hop_header_hop_serialize( http ) {
      var hds = http.getAllResponseHeaders();
      var i = hds.indexOf( "Hop-Serialize" );

      if( i < 0 ) return "javascript";
      
      var j = hds.indexOf( "\n", i + 1 );
      return (j >= 0) ? hds.substring( i + 15, j - 1 )
                      : hds.substring( i + 15, s.length );
   }
}

/*---------------------------------------------------------------------*/
/*    node_style_set ...                                               */
/*---------------------------------------------------------------------*/
function node_style_set_native( el, prop, value ) {
   var obj = el;
   
   if( (el instanceof String) || (typeof el === "string") )
      obj = document.getElementById( el );

   for( var i = 1; i < arguments.length; i += 2 ) {
      var p = arguments[ i ];
      var v = arguments[ i + 1 ];

      if( sc_isKeyword( p ) )
	 p = sc_keyword2jsstring( p );
   
      if( !(v instanceof String) && (typeof v !== "string") ) {
	 if( !v && (v != 0) ) {
	    sc_error( "node-style-set!", "Illegal \"" + p + "\" value: " + v, el );
	 } else {
	    v = v.toString();
	 }
      }

      if( !obj || !obj.style ) {
	 sc_error( "node-style-set!",
		   "Illegal object while setting \"" + p + ": " + v + "\"",
		   el );
      }

      try {
	 if( p in obj.style ) {
	    obj.style[ p ] =  v;
	 } else {
	    obj.style.setProperty( p, v, "" );
	 }
      } catch( e ) {
	 sc_error( "node-style-set!", "Can't set property \"" + p + "\"", el );
      }
   }
}

function node_style_set_array( el, prop, value ) {
   var obj = el;
   
   if( (el instanceof String) || (typeof el === "string") )
      obj = document.getElementById( el );

   for( var i = 1; i < arguments.length; i += 2 ) {
      var p = arguments[ i ];
      var v = arguments[ i + 1 ];
      
      if( sc_isKeyword( p ) )
	 p = sc_keyword2jsstring( p );
   
      if( !(v instanceof String) && (typeof v !== "string") ) {
	 if( !v && (v != 0) ) {
	    sc_error( "node-style-set!", "Illegal \"" + p + "\" value: "+ v, el );
	 } else {
	    v = v.toString();
	 }
      }
   
      obj.style[ p ] = v;
   }
}

/*** META ((export node-style-set!) (arity -3)) */
var node_style_set = function( el, prop, value ) {
   var obj = el;
   
   if( (el instanceof String) || (typeof el === "string") )
      obj = document.getElementById( el );

   try {
      if( "setProperty" in obj.style ) {
         node_style_set = node_style_set_native;
      	 return node_style_set_native.apply( null, arguments );
      } else {
	 node_style_set = node_style_set_array;
	 return node_style_set_array.apply( null, arguments );
      }
   } catch( e ) {
      sc_error( "node-style-set!", "Can't set property \"" + prop + "\"", el );
  }
}

/*---------------------------------------------------------------------*/
/*    hop_active_location_timeout ...                                  */
/*    -------------------------------------------------------------    */
/*    The frequency, new locations are checked. On slow CPU (e.g.,     */
/*    ARM processors), use a reduced frequency.                        */
/*---------------------------------------------------------------------*/
var hop_active_location_timeout =
   ((hop_config.cpu_speed < 66) ? 100 : 250);

/*---------------------------------------------------------------------*/
/*    setInterval ...                                                  */
/*---------------------------------------------------------------------*/
var hop_has_setInterval = true;

try {
   var i = setInterval( function() { ; }, 1000 );
   clearInterval( i );
} catch( e ) {
   var hop_has_setInterval = false;
}

/*---------------------------------------------------------------------*/
/*    Event handlers                                                   */
/*---------------------------------------------------------------------*/
var hop_add_native_event_listener = undefined;
var hop_remove_native_event_listener = undefined;
/*** META ((export stop-event-propagation) (arity -2)) */
var hop_stop_propagation = undefined;
var hop_has_event20 = false;

try {
   hop_has_event20 = document.implementation.hasFeature( "Events" , "2.0" );
} catch( e ) {
   ;
}

if( hop_has_event20 ) {
   hop_add_native_event_listener = function( obj, event, proc, capture ) {
      if( "addEventListener" in obj ) {
         var f = hop_callback( proc );
         var i = "on" + event + "hdl";

         if( !(i in obj ) ) obj[ i ] = [];
         obj[ i ][ proc ] = f;

	 return obj.addEventListener( event, f, capture );
      } else {
	 throw new Error( "add-event-listener!: cannot add `" 
			  + event + "' listener for object: "
			  + obj );
      }
   }

   hop_remove_native_event_listener = function( obj, event, proc, capture ) {
      if( "removeEventListener" in obj ) {
	var i = "on" + event + "hdl";
        var h = obj[ i ];

        if( h !== undefined ) {
	   var p = obj[ i ][ proc ];

	   if( p !== undefined ) {
	      h[ p ] = undefined;
	      return obj.removeEventListener( event, p, capture );
	   }
	}
      } else {
	 throw new Error( "remove-event-listener!: cannot remove `"
			  + event + "' listener for object: "
			  + obj );
      }
   }

   hop_stop_propagation = function( event, def ) {
      if( !def ) event.preventDefault();
      event.stopPropagation();
      event.isStopped = true;
   }
} else {
   var hop_event_counter = 0;
   
   hop_add_native_event_listener = function( obj, event, proc, capture ) {
      var f = hop_callback( proc );
      var procid = "on" + event + hop_event_counter++;
      obj[ procid ] = f;
      var p = function( e ) { return obj[ procid ]( window.event ); };
      var i = "on" + event + "hdl";

      if( obj[ i ] === undefined ) obj[ i ] = [];
      obj[ i ][ proc ] = { proc: p, id: procid };
      
      return obj.attachEvent( "on" + event, p );
   }

   hop_remove_native_event_listener = function( obj, event, proc, capture ) {
      var i = "on" + event + "hdl";

      if( i in obj ) {
	 var p = obj[ i ][ proc ];
	 
	 delete obj[ p.id ];
	 delete obj[ i ][ proc ] ;

	 if( p.proc !== undefined ) {
	    return obj.detachEvent( "on" + event, p.proc );
	 }
      }

      return false;
   }

   hop_stop_propagation = function( event, def ) {
      if( !def ) event.cancelBubble = true;
      event.returnValue = false;
      event.isStopped = true;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_deinline_image ...                                           */
/*    -------------------------------------------------------------    */
/*    This function is invoked on inline images. It gives the          */
/*    browser a chance to load the inlined image. This is particularly */
/*    important for browsers such as IE that cannot handle inline      */
/*    images.                                                          */
/*---------------------------------------------------------------------*/
function hop_deinline_image( el, src ) {
   if( !el.deinlined ) {
      el.deinlined = true;
      el.src = src;
   }
}

/*---------------------------------------------------------------------*/
/*    mouse coords ...                                                 */
/*---------------------------------------------------------------------*/
/*** META ((export event-mouse-x) (arity 1)) */
var hop_event_mouse_x = undefined;
/*** META ((export event-mouse-y) (arity 1)) */
var hop_event_mouse_y = undefined;
/*** META ((export event-mouse-button) (arity 1)) */
var hop_event_mouse_button = undefined;
/*** META ((export event-key-code) (arity 1)) */
var hop_event_key_code = undefined;
/*** META ((export event-value)
           (arity #t)
           (peephole: (postfix ".value"))) */
function hop_event_value( evt ) { return evt.value; }
/*** META ((export event-response-text)
           (arity #t)
           (peephole: (postfix ".responseText"))) */
function hop_event_response_text( evt ) { return evt.responseText; }

if( hop_has_event20  ) {
   hop_event_mouse_x = function hop_event_mouse_x( event ) {
      return event.pageX;
   }
   hop_event_mouse_y = function hop_event_mouse_y( event ) {
      return event.pageY;
   }
   hop_event_key_code = function hop_event_key_code( event ) {
      return event.which;
   }
} else {
   hop_event_mouse_x = function hop_event_mouse_x( event ) {
      if( (document.body != null) &&
	  (document.documentElement.scrollLeft != null) ) {
	 return event.clientX + document.documentElement.scrollLeft;
      } else {
	 return event.clientX + document.body.scrollLeft;
      }
   }
   hop_event_mouse_y = function hop_event_mouse_y( event ) {
      if( (document.body != null) &&
	  (document.documentElement.scrollTop != null) ) {
	 return event.clientY + document.documentElement.scrollTop;
      } else {
	 return event.clientY + document.body.scrollTop;
      }
   }
   hop_event_key_code = function hop_event_key_code( event ) {
      return event.keyCode;
   }
}

switch( hop_config.mouse_left_button ) {
   case 0:
      hop_event_mouse_button = function hop_event_mouse_button( e ) {
	 return e.button + 1;
      };
      break;
   case 1:
      hop_event_mouse_button = function hop_event_mouse_button( e ) {
	 return e.button;
      }
      break;
   default:
      hop_event_mouse_button = function hop_event_mouse_button( e ) {
	 return e.button + (1 - hop_config.mouse_left_button);
      }
}

/*---------------------------------------------------------------------*/
/*    hop_window_width/height ...                                      */
/*---------------------------------------------------------------------*/
/*** META ((export main-window-width) (arity 0)) */
var hop_main_window_width = undefined;
/*** META ((export main-window-height) (arity 0)) */
var hop_main_window_height = undefined;
/*** META ((export main-window-orientation) (arity 0)) */
var hop_main_window_orientation = undefined;

if( isNaN( window.innerWidth ) ) {
   hop_main_window_width = function hop_main_window_width() {
      return document.documentElement.clientWidth;
   }
   hop_main_window_height = function hop_main_window_height() {
      return document.documentElement.clientHeight;
   }
} else {
   hop_main_window_width = function hop_main_window_width() {
      return window.innerWidth;
   }
   hop_main_window_height = function hop_main_window_height() {
      return window.innerHeight;
   }
}

var hop_orientation = false;
hop_main_window_orientation = function hop_main_window_orientation() {
  if( !hop_orientation ) {
     hop_orientation = sc_jsstring2symbol( "landscape" );
  }
  return hop_orientation;
}

/* backward compatibility */
/*** META ((export current-window-width) (arity 0)) */
var hop_current_window_width = hop_main_window_width;
/*** META ((export current-window-height) (arity 0)) */
var hop_current_window_height = hop_main_window_height;

/*---------------------------------------------------------------------*/
/*    hop_screen_dimensions ...                                        */
/*---------------------------------------------------------------------*/
/*** META ((export screen-dimensions) (arity -1)) */
function hop_screen_dimensions( unit ) {
   if( !unit ) unit = "cm";

   var d = document.createElement( "div" );
   var h = document.getElementsByTagName( "body" )[ 0 ];

   node_style_set( d, "visibility", "hidden" );
   node_style_set( d, "border", "0" );
   d.innerHTML = ".";

   h.appendChild( d );
   
   node_style_set( d, "width", "1" + unit );
   node_style_set( d, "height", "1" + unit );

   var res =
      new sc_Pair( Math.round( hop_config.screen_width / d.offsetWidth ),
		   Math.round( hop_config.screen_height / d.offsetHeight ) );

   h.removeChild( d );

   return res;
}
   
/*---------------------------------------------------------------------*/
/*    hop_iframe_scroll_height ...                                     */
/*---------------------------------------------------------------------*/
/*** META ((export iframe-scroll-height) (arity #t)) */
function hop_iframe_scroll_height( e ) {
   if( "contentDocument" in e ) {
      return e.contentDocument.body.scrollHeight;
   } else {
      if( "document" in e ) {
	 return e.document.body.scrollHeight;
      } else {
	 return iframe.height;
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_iframe_scroll_width ...                                      */
/*---------------------------------------------------------------------*/
/*** META ((export iframe-scroll-width) (arity #t)) */
function hop_iframe_scroll_width( e ) {
   if( "contentDocument" in e ) {
      return e.contentDocument.body.scrollWidth;
   } else {
      if( "document" in e ) {
	 return e.document.body.scrollWidth;
      } else {
	 return iframe.width;
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_get_selection                                                */
/*---------------------------------------------------------------------*/
/*** META ((export get-selection) (arity 0)) */
var hop_get_selection;

if( window.getSelection ) {
   hop_get_selection = function hop_get_selection() {
      return window.getSelection().toString();
   }
} else {
   if( document.getSelection ) {
      hop_get_selection = function hop_get_selection() {
	 return document.getSelection().toString();
      }
   } else {
      hop_get_selection = function hop_get_selection() {
	 if( document.selection ) {
	    return document.selection.createRange().text;
	 } else {
	    return "";
	 }
      }
   }
}

/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/************* GENERATED FILE - DO NOT EDIT *************/
/*=====================================================================*/
/*    Author      :  Florian Loitsch                                   */
/*    Copyright   :  2007-10 Florian Loitsch, see LICENSE file         */
/*    -------------------------------------------------------------    */
/*    This file is part of Scheme2Js.                                  */
/*                                                                     */
/*   Scheme2Js is distributed in the hope that it will be useful,      */
/*   but WITHOUT ANY WARRANTY; without even the implied warranty of    */
/*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     */
/*   LICENSE file for more details.                                    */
/*=====================================================================*/

/*
 * To use write/prints/... the default-output port has to be set first.
 * Simply setting SC_DEFAULT_OUT and SC_ERROR_OUT to the desired values
 * should do the trick.
 * In the following example the std-out and error-port are redirected to
 * a DIV.
function initRuntime() {
    function escapeHTML(s) {
	var tmp = s;
	tmp = tmp.replace(/&/g, "&amp;");
	tmp = tmp.replace(/</g, "&lt;");
	tmp = tmp.replace(/>/g, "&gt;");
	tmp = tmp.replace(/ /g, "&nbsp;");
	tmp = tmp.replace(/\n/g, "<br />");
	tmp = tmp.replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp");
	return tmp;
	
    }

    document.write("<div id='stdout'></div>");
    SC_DEFAULT_OUT = new sc_GenericOutputPort(
	function(s) {
	    var stdout = document.getElementById('stdout');
	    stdout.innerHTML = stdout.innerHTML + escapeHTML(s);
	});
    SC_ERROR_OUT = SC_DEFAULT_OUT;
}
*/


function sc_print_debug() {
    sc_print.apply(null, arguments);
}
/*** META ((export *js*)) */
var sc_JS_GLOBALS = this;

var __sc_LINE=-1;
var __sc_FILE="";

/*** META ((export #t)
           (arity -1)) */
function sc_alert() {
   var len = arguments.length;
   var s = "";
   var i;

   for( i = 0; i < len; i++ ) {
       s += sc_toDisplayString(arguments[ i ]);
   }

   return alert( s );
}

/*** META ((export #t) (arity #t)) */
function sc_typeof( x ) {
   return typeof x;
}

var __sc_errorHook = false;

/*** META ((export error-hook-set!) (arity #t)) */
function sc_errorHookSet( h ) {
   __sc_errorHook = h;
}

/*** META ((export error-hook) (arity #t)) */
function sc_errorHook() {
   return __sc_errorHook;
}

/*** META ((export #t) (arity -1)) */
function sc_error() {
   var e = new Error("sc_error");

   if (arguments.length >= 1) {
      e.name = arguments[0];
      if (arguments.length >= 2) {
	 e.message = arguments[1];
	 if (arguments.length >= 3) {
	    e.scObject = arguments[2];
	 }
      }
   }

   throw __sc_errorHook ? __sc_errorHook( e, arguments ) : e;
}

function sc_arity_check(fun, nbArgs) {
   function err( args, msg, obj ) {
      var where= ("callee" in args && "caller" in args.callee ?
		  ("name" in args.callee.caller ?
		   args.callee.caller.name : args.callee.caller)
		  : "arity-check");
      sc_error(where, msg, obj);
      return undefined;
   }

   if (typeof fun !== "function") {
      return err(arguments, "not a function", fun);
   }
       
   var fun_arity = fun.sc_arity;

   if (fun_arity === undefined || fun_arity === false) return fun;
   if (fun_arity >= 0 && nbArgs == fun_arity) return fun;
   if (fun_arity < 0 && nbArgs >= -1-fun_arity) return fun;
   var errorMsg = "Wrong number of arguments: " + fun_arity + " expected, " +
      nbArgs + " provided";
   return err( arguments, errorMsg, fun);
}

/*** META ((export #t) (arity #t)) */
function sc_raise(obj) {
    throw obj;
}


/*** META ((export with-handler-lambda) (arity #t)) */
function sc_withHandlerLambda(handler, body) {
    try {
	return body();
    } catch(e) {
	if (!e._internalException)
	    return handler(e);
	else
	    throw e;
    }
}

var sc_properties = new Object();

/*** META ((export #t) (arity #t)) */
function sc_putpropBang(sym, key, val) {
    var ht = sc_properties[sym];
    if (!ht) {
	ht = new Object();
	sc_properties[sym] = ht;
    }
    ht[key] = val;
}

/*** META ((export #t) (arity #t)) */
function sc_getprop(sym, key) {
    var ht = sc_properties[sym];
    if (ht) {
	if (key in ht)
	    return ht[key];
	else
	    return false;
    } else
	return false;
}

/*** META ((export #t) (arity #t)) */
function sc_rempropBang(sym, key) {
    var ht = sc_properties[sym];
    if (ht)
	delete ht[key];
}

/*** META ((export #t) (arity #t)) */
function sc_any2String(o) {
    return sc_jsstring2string(sc_toDisplayString(o));
}    

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "==="))
           (type bool))
*/
function sc_isEqv(o1, o2) {
    return (o1 === o2);
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "==="))
           (type bool))
*/
function sc_isEq(o1, o2) {
    return (o1 === o2);
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isNumber(n) {
    return (typeof n === "number");
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isComplex(n) {
    return sc_isNumber(n);
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isReal(n) {
    return sc_isNumber(n);
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isRational(n) {
    return sc_isReal(n);
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isInteger(n) {
    return (parseInt(n) === n);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix ", false")))
*/
// we don't have exact numbers...
function sc_isExact(n) {
    return false;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix ", true"))
	   (type bool))
*/
function sc_isInexact(n) {
    return true;
}

/*** META ((export = =fx =fl)
           (type bool)
           (peephole (infix 2 2 "==="))
           (arity -3))
*/
function sc_equal(x) {
    for (var i = 1; i < arguments.length; i++)
	if (x !== arguments[i])
	    return false;
    return true;
}

/*** META ((export < <fx <fl)
           (type bool)
           (peephole (infix 2 2 "<"))
           (arity -3))
*/
function sc_less(x) {
    for (var i = 1; i < arguments.length; i++) {
	if (x >= arguments[i])
	    return false;
	x = arguments[i];
    }
    return true;
}

/*** META ((export > >fx >fl)
           (type bool)
           (peephole (infix 2 2 ">"))
           (arity -3))
*/
function sc_greater(x, y) {
    for (var i = 1; i < arguments.length; i++) {
	if (x <= arguments[i])
	    return false;
	x = arguments[i];
    }
    return true;
}

/*** META ((export <= <=fx <=fl)
           (type bool)
           (peephole (infix 2 2 "<="))
           (arity -3))
*/
function sc_lessEqual(x, y) {
    for (var i = 1; i < arguments.length; i++) {
	if (x > arguments[i])
	    return false;
	x = arguments[i];
    }
    return true;
}

/*** META ((export >= >=fl >=fx)
           (type bool)
           (peephole (infix 2 2 ">="))
           (arity -3))
*/
function sc_greaterEqual(x, y) {
    for (var i = 1; i < arguments.length; i++) {
	if (x < arguments[i])
	    return false;
	x = arguments[i];
    }
    return true;
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "=== 0")))
*/
function sc_isZero(x) {
    return (x === 0);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "> 0")))
*/
function sc_isPositive(x) {
    return (x > 0);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "< 0")))
*/
function sc_isNegative(x) {
    return (x < 0);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "%2===1")))
*/
function sc_isOdd(x) {
    return (x % 2 === 1);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "%2===0")))
*/
function sc_isEven(x) {
    return (x % 2 === 0);
}

/*** META ((export #t)
           (arity -2)) */
var sc_max = Math.max;
/*** META ((export #t)
           (arity -2)) */
var sc_min = Math.min;

/*** META ((export + +fx +fl)
           (peephole (infix 0 #f "+" "0"))
           (arity -1))
*/
function sc_plus() {
    var sum = 0;
    for (var i = 0; i < arguments.length; i++)
	sum += arguments[i];
    return sum;
}

/*** META ((export * *fx *fl)
           (peephole (infix 0 #f "*" "1"))
           (arity -1))
*/
function sc_multi() {
    var product = 1;
    for (var i = 0; i < arguments.length; i++)
	product *= arguments[i];
    return product;
}

/*** META ((export - -fx -fl)
           (peephole (minus))
           (arity -2))
*/
function sc_minus(x) {
    if (arguments.length === 1)
	return -x;
    else {
	var res = x;
	for (var i = 1; i < arguments.length; i++)
	    res -= arguments[i];
	return res;
    }
}

/*** META ((export / /fl)
           (peephole (div))
           (arity -2))
*/
function sc_div(x) {
    if (arguments.length === 1)
	return 1/x;
    else {
	var res = x;
	for (var i = 1; i < arguments.length; i++)
	    res /= arguments[i];
	return res;
    }
}

/*** META ((export #t)
           (arity 1))
*/
var sc_abs = Math.abs;

/*** META ((export quotient /fx) (arity #t)
           (peephole (hole 2 "parseInt(" x "/" y ")")))
*/
function sc_quotient(x, y) {
    return parseInt(x / y);
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "%")))
*/
function sc_remainder(x, y) {
    return x % y;
}

/*** META ((export #t) (arity #t))
*/
function sc_modulo(x, y) {
    var remainder = x % y;
    // if they don't have the same sign
    if ((remainder * y) < 0)
	return remainder + y;
    else
	return remainder;
}

function sc_euclid_gcd(a, b) {
    var temp;
    if (a === 0) return b;
    if (b === 0) return a;
    if (a < 0) {a = -a;};
    if (b < 0) {b = -b;};
    if (b > a) {temp = a; a = b; b = temp;};
    while (true) {
	a %= b;
	if(a === 0) {return b;};
	b %= a;
	if(b === 0) {return a;};
    };
    return b;
}

/*** META ((export #t)
           (arity -1))
*/
function sc_gcd() {
    var gcd = 0;
    for (var i = 0; i < arguments.length; i++)
	gcd = sc_euclid_gcd(gcd, arguments[i]);
    return gcd;
}

/*** META ((export #t)
           (arity -1))
*/
function sc_lcm() {
    var lcm = 1;
    for (var i = 0; i < arguments.length; i++) {
	var f = Math.round(arguments[i] / sc_euclid_gcd(arguments[i], lcm));
	lcm *= Math.abs(f);
    }
    return lcm;
}

// LIMITATION: numerator and denominator don't make sense in floating point world.
//var SC_MAX_DECIMALS = 1000000
//
// function sc_numerator(x) {
//     var rounded = Math.round(x * SC_MAX_DECIMALS);
//     return Math.round(rounded / sc_euclid_gcd(rounded, SC_MAX_DECIMALS));
// }

// function sc_denominator(x) {
//     var rounded = Math.round(x * SC_MAX_DECIMALS);
//     return Math.round(SC_MAX_DECIMALS / sc_euclid_gcd(rounded, SC_MAX_DECIMALS));
// }

/*** META ((export #t)
           (arity 1))
*/
var sc_floor = Math.floor;
/*** META ((export #t)
           (arity 1))
*/
var sc_ceiling = Math.ceil;
/*** META ((export #t)
           (arity 1))
*/
var sc_truncate = parseInt;
/*** META ((export #t)
           (arity 1))
*/
var sc_round = Math.round;

// LIMITATION: sc_rationalize doesn't make sense in a floating point world.

/*** META ((export #t)
           (arity 1))
*/
var sc_exp = Math.exp;
/*** META ((export #t)
           (arity 1))
*/
var sc_log = Math.log;
/*** META ((export #t)
           (arity 1))
*/
var sc_sin = Math.sin;
/*** META ((export #t)
           (arity 1))
*/
var sc_cos = Math.cos;
/*** META ((export #t)
           (arity 1))
*/
var sc_tan = Math.tan;
/*** META ((export #t)
           (arity 1))
*/
var sc_asin = Math.asin;
/*** META ((export #t)
           (arity 1))
*/
var sc_acos = Math.acos;
/*** META ((export #t)
           (arity -2))
*/
var sc_atan = Math.atan;

/*** META ((export #t)
           (arity 1))
*/
var sc_sqrt = Math.sqrt;
/*** META ((export #t)
           (arity 2))
*/
var sc_expt = Math.pow;

// LIMITATION: we don't have complex numbers.
// LIMITATION: the following functions are hence not implemented.
// LIMITATION: make-rectangular, make-polar, real-part, imag-part, magnitude, angle
// LIMITATION: 2 argument atan

/*** META ((export #t) (arity #t)
           (peephole (id)))
*/
function sc_exact2inexact(x) {
    return x;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix "<< 0")))
*/
function sc_inexact2exact(x) {
    return x << 0;
}

function sc_number2jsstring(x, radix) {
    if (radix)
	return x.toString(radix);
    else
	return x.toString();
}

function sc_jsstring2number(s, radix) {
    if (s === "") return false;

    if (radix) {
	var t = parseInt(s, radix);
	if (!t && t !== 0) return false;
	// verify that each char is in range. (parseInt ignores leading
	// white and trailing chars)
	var allowedChars = "01234567890abcdefghijklmnopqrstuvwxyz".substring(0, radix+1);
	if ((new RegExp("^["+allowedChars+"]*$", "i")).test(s))
	    return t;
	else return false;
    } else {
	var t = +s; // does not ignore trailing chars.
	if (!t && t !== 0) return false;
	// simply verify that first char is not whitespace.
	var c = s.charAt(0);
	// if +c is 0, but the char is not "0", then we have a whitespace.
	if (+c === 0 && c !== "0") return false;
	return t;
    }
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (not)))
*/
function sc_not(b) {
    return b === false;
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isBoolean(b) {
    return (b === true) || (b === false);
}

function sc_Pair(car, cdr) {
    this.car = car;
    this.cdr = cdr;
}

sc_Pair.prototype.toString = function() {
    return sc_toDisplayString(this);
};
sc_Pair.prototype.sc_toWriteOrDisplayString = function(writeOrDisplay) {
    var current = this;

    var res = "(";

    while(true) {
	res += writeOrDisplay(current.car);
	if (sc_isPair(current.cdr)) {
	    res += " ";
	    current = current.cdr;
	} else if (current.cdr !== null) {
	    res += " . " + writeOrDisplay(current.cdr);
	    break;
	} else // current.cdr == null
	    break;
    }
	
    res += ")";

    return res;
};
sc_Pair.prototype.sc_toDisplayString = function() {
    return this.sc_toWriteOrDisplayString(sc_toDisplayString);
};
sc_Pair.prototype.sc_toWriteString = function() {
    return this.sc_toWriteOrDisplayString(sc_toWriteString);
};
// sc_Pair.prototype.sc_toWriteCircleString in IO.js

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix " instanceof sc_Pair")))
*/
function sc_isPair(p) {
    return (p instanceof sc_Pair);
}

function sc_isPairEqual(p1, p2, comp) {
    return (comp(p1.car, p2.car) && comp(p1.cdr, p2.cdr));
}

/*** META ((export #t) (arity #t)
           (peephole (hole 2 "new sc_Pair(" car ", " cdr ")")))
*/
function sc_cons(car, cdr) {
    return new sc_Pair(car, cdr);
}

/*** META ((export cons*)
           (arity -2))
*/
function sc_consStar() {
    var res = arguments[arguments.length - 1];
    for (var i = arguments.length-2; i >= 0; i--)
	res = new sc_Pair(arguments[i], res);
    return res;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix ".car")))
*/
function sc_car(p) {
    return p.car;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr")))
*/
function sc_cdr(p) {
    return p.cdr;
}

/*** META ((export #t) (arity #t)
           (peephole (hole 2 p ".car = " val)))
*/
function sc_setCarBang(p, val) {
    p.car = val;
}

/*** META ((export #t) (arity #t)
           (peephole (hole 2 p ".cdr = " val)))
*/
function sc_setCdrBang(p, val) {
    p.cdr = val;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car")))
*/
function sc_caar(p) { return p.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car")))
*/
function sc_cadr(p) { return p.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr")))
*/
function sc_cdar(p) { return p.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr")))
*/
function sc_cddr(p) { return p.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.car")))
*/
function sc_caaar(p) { return p.car.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.car")))
*/
function sc_cadar(p) { return p.car.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.car")))
*/
function sc_caadr(p) { return p.cdr.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.car")))
*/
function sc_caddr(p) { return p.cdr.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.cdr")))
*/
function sc_cdaar(p) { return p.car.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.cdr")))
*/
function sc_cdadr(p) { return p.cdr.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.cdr")))
*/
function sc_cddar(p) { return p.car.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.cdr")))
*/
function sc_cdddr(p) { return p.cdr.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.car.car")))
*/
function sc_caaaar(p) { return p.car.car.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.car.car")))
*/
function sc_caadar(p) { return p.car.cdr.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.car.car")))
*/
function sc_caaadr(p) { return p.cdr.car.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.car.car")))
*/
function sc_caaddr(p) { return p.cdr.cdr.car.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.car.cdr")))
*/
function sc_cdaaar(p) { return p.car.car.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.car.cdr")))
*/
function sc_cdadar(p) { return p.car.cdr.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.car.cdr")))
*/
function sc_cdaadr(p) { return p.cdr.car.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.car.cdr")))
*/
function sc_cdaddr(p) { return p.cdr.cdr.car.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.cdr.car")))
*/
function sc_cadaar(p) { return p.car.car.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.cdr.car")))
*/
function sc_caddar(p) { return p.car.cdr.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.cdr.car")))
*/
function sc_cadadr(p) { return p.cdr.car.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.cdr.car")))
*/
function sc_cadddr(p) { return p.cdr.cdr.cdr.car; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.car.cdr.cdr")))
*/
function sc_cddaar(p) { return p.car.car.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".car.cdr.cdr.cdr")))
*/
function sc_cdddar(p) { return p.car.cdr.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.car.cdr.cdr")))
*/
function sc_cddadr(p) { return p.cdr.car.cdr.cdr; }
/*** META ((export #t) (arity #t)
           (peephole (postfix ".cdr.cdr.cdr.cdr")))
*/
function sc_cddddr(p) { return p.cdr.cdr.cdr.cdr; }

/*** META ((export #t) (arity #t)) */
function sc_lastPair(l) {
    if (!sc_isPair(l)) sc_error("sc_lastPair: pair expected");
    var res = l;
    var cdr = l.cdr;
    while (sc_isPair(cdr)) {
	res = cdr;
	cdr = res.cdr;
    }
    return res;
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix " === null")))
*/
function sc_isNull(o) {
    return (o === null);
}

/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isList(o) {
   var rabbit = o;
   var turtle = o;

   while (true) {
       if (rabbit === null ||
	   (rabbit instanceof sc_Pair && rabbit.cdr === null))
	   return true;  // end of list
       else {
	   if ((rabbit instanceof sc_Pair) &&
	       (rabbit.cdr instanceof sc_Pair)) {
	       rabbit = rabbit.cdr.cdr;
	       turtle = turtle.cdr;
	       if (rabbit === turtle) return false; // cycle
	   } else
	       return false; // not pair
       }
   }
}

/*** META ((export #t)
           (arity -1))
 */
function sc_list() {
    var res = null;
    var a = arguments;
    for (var i = a.length-1; i >= 0; i--)
	res = new sc_Pair(a[i], res);
    return res;
}

/*** META ((export #t)
           (arity -2))
*/
function sc_iota(num, init) {
   var res = null;
   if (!init) init = 0;
   for (var i = num - 1; i >= 0; i--)
      res = new sc_Pair(i + init, res);
   return res;
}

/*** META ((export #t)
           (arity -2))
*/
function sc_makeList(nbEls, fill) {
    var res = null;
    for (var i = 0; i < nbEls; i++)
	res = new sc_Pair(fill, res);
    return res;
}

/*** META ((export #t) (arity #t)) */
function sc_length(l) {
    var res = 0;
    while (l !== null) {
	res++;
	l = l.cdr;
    }
    return res;
}

/*** META ((export #t) (arity #t)) */
function sc_remq(o, l) {
    var dummy = { cdr : null };
    var tail = dummy;
    while (l !== null) {
	if (l.car !== o) {
	    tail.cdr = sc_cons(l.car, null);
	    tail = tail.cdr;
	}
	l = l.cdr;
    }
    return dummy.cdr;
}

/*** META ((export #t) (arity #t)) */
function sc_remqBang(o, l) {
    var dummy = { cdr : null };
    var tail = dummy;
    var needsAssig = true;
    while (l !== null) {
	if (l.car === o) {
	    needsAssig = true;
	} else {
	    if (needsAssig) {
		tail.cdr = l;
		needsAssig = false;
	    }
	    tail = l;
	}
	l = l.cdr;
    }
    tail.cdr = null;
    return dummy.cdr;
}

/*** META ((export #t) (arity #t)) */
function sc_delete(o, l) {
    var dummy = { cdr : null };
    var tail = dummy;
    while (l !== null) {
	if (!sc_isEqual(l.car, o)) {
	    tail.cdr = sc_cons(l.car, null);
	    tail = tail.cdr;
	}
	l = l.cdr;
    }
    return dummy.cdr;
}

/*** META ((export #t) (arity #t)) */
function sc_deleteBang(o, l) {
    var dummy = { cdr : null };
    var tail = dummy;
    var needsAssig = true;
    while (l !== null) {
	if (sc_isEqual(l.car, o)) {
	    needsAssig = true;
	} else {
	    if (needsAssig) {
		tail.cdr = l;
		needsAssig = false;
	    }
	    tail = l;
	}
	l = l.cdr;
    }
    tail.cdr = null;
    return dummy.cdr;
}

function sc_reverseAppendBang(l1, l2) {
    var res = l2;
    while (l1 !== null) {
	var tmp = res;
	res = l1;
	l1 = l1.cdr;
	res.cdr = tmp;
    }
    return res;
}
	
function sc_dualAppend(l1, l2) {
    if (l1 === null) return l2;
    if (l2 === null) return l1;
    var rev = sc_reverse(l1);
    return sc_reverseAppendBang(rev, l2);
}

/*** META ((export append eappend) ;; we want eappend for the quasiquotes.
           (arity -1))
*/
function sc_append() {
    if (arguments.length === 0)
	return null;
    var res = arguments[arguments.length - 1];
    for (var i = arguments.length - 2; i >= 0; i--)
	res = sc_dualAppend(arguments[i], res);
    return res;
}

function sc_dualAppendBang(l1, l2) {
    if (l1 === null) return l2;
    if (l2 === null) return l1;
    var tmp = l1;
    while (tmp.cdr !== null) tmp=tmp.cdr;
    tmp.cdr = l2;
    return l1;
}
    
/*** META ((export #t)
           (arity -1))
*/
function sc_appendBang() {
    var res = null;
    for (var i = 0; i < arguments.length; i++)
	res = sc_dualAppendBang(res, arguments[i]);
    return res;
}

/*** META ((export #t) (arity #t)) */
function sc_reverse(l1) {
    var res = null;
    while (l1 !== null) {
	res = sc_cons(l1.car, res);
	l1 = l1.cdr;
    }
    return res;
}

/*** META ((export #t) (arity #t)) */
function sc_reverseBang(l) {
    return sc_reverseAppendBang(l, null);
}

/*** META ((export #t) (arity #t)) */
function sc_listTail(l, k) {
    var res = l;
    for (var i = 0; i < k; i++) {
	res = res.cdr;
    }
    return res;
}

/*** META ((export #t) (arity #t)) */
function sc_listRef(l, k) {
    return sc_listTail(l, k).car;
}

/* // unoptimized generic versions
function sc_memX(o, l, comp) {
    while (l != null) {
	if (comp(l.car, o))
	    return l;
	l = l.cdr;
    }
    return false;
}
function sc_memq(o, l) { return sc_memX(o, l, sc_isEq); }
function sc_memv(o, l) { return sc_memX(o, l, sc_isEqv); }
function sc_member(o, l) { return sc_memX(o, l, sc_isEqual); }
*/

/* optimized versions */
/*** META ((export #t) (arity #t)) */
function sc_memq(o, l) {
    while (l !== null) {
	if (l.car === o)
	    return l;
	l = l.cdr;
    }
    return false;
}
/*** META ((export #t) (arity #t)) */
function sc_memv(o, l) {
    while (l !== null) {
	if (l.car === o)
	    return l;
	l = l.cdr;
    }
    return false;
}
/*** META ((export #t) (arity #t)) */
function sc_member(o, l) {
    while (l !== null) {
	if (sc_isEqual(l.car,o))
	    return l;
	l = l.cdr;
    }
    return false;
}

/* // generic unoptimized versions
function sc_assX(o, al, comp) {
    while (al != null) {
	if (comp(al.car.car, o))
	    return al.car;
	al = al.cdr;
    }
    return false;
}
function sc_assq(o, al) { return sc_assX(o, al, sc_isEq); }
function sc_assv(o, al) { return sc_assX(o, al, sc_isEqv); }
function sc_assoc(o, al) { return sc_assX(o, al, sc_isEqual); }
*/
// optimized versions
/*** META ((export #t) (arity #t)) */
function sc_assq(o, al) {
    while (al !== null) {
	if (al.car.car === o)
	    return al.car;
	al = al.cdr;
    }
    return false;
}
/*** META ((export #t) (arity #t)) */
function sc_assv(o, al) {
    while (al !== null) {
	if (al.car.car === o)
	    return al.car;
	al = al.cdr;
    }
    return false;
}
/*** META ((export #t) (arity #t)) */
function sc_assoc(o, al) {
    while (al !== null) {
	if (sc_isEqual(al.car.car, o))
	    return al.car;
	al = al.cdr;
    }
    return false;
}

/* can be used for mutable strings and characters */
function sc_isCharStringEqual(cs1, cs2) { return cs1.val === cs2.val; }
function sc_isCharStringLess(cs1, cs2) { return cs1.val < cs2.val; }
function sc_isCharStringGreater(cs1, cs2) { return cs1.val > cs2.val; }
function sc_isCharStringLessEqual(cs1, cs2) { return cs1.val <= cs2.val; }
function sc_isCharStringGreaterEqual(cs1, cs2) { return cs1.val >= cs2.val; }
function sc_isCharStringCIEqual(cs1, cs2)
    { return cs1.val.toLowerCase() === cs2.val.toLowerCase(); }
function sc_isCharStringCILess(cs1, cs2)
    { return cs1.val.toLowerCase() < cs2.val.toLowerCase(); }
function sc_isCharStringCIGreater(cs1, cs2)
    { return cs1.val.toLowerCase() > cs2.val.toLowerCase(); }
function sc_isCharStringCILessEqual(cs1, cs2)
    { return cs1.val.toLowerCase() <= cs2.val.toLowerCase(); }
function sc_isCharStringCIGreaterEqual(cs1, cs2)
    { return cs1.val.toLowerCase() >= cs2.val.toLowerCase(); }

function sc_Char(c) {
    var cached = sc_Char.lazy[c];
    if (cached)
	return cached;
    this.val = c;
    sc_Char.lazy[c] = this;
    // add return, so FF does not complain.
    return undefined;
}
sc_Char.lazy = new Object();
// thanks to Eric
sc_Char.char2readable = {
    "\000": "#\\null",
    "\007": "#\\bell",
    "\010": "#\\backspace",
    "\011": "#\\tab",
    "\012": "#\\newline",
    "\014": "#\\page",
    "\015": "#\\return",
    "\033": "#\\escape",
    "\040": "#\\space",
    "\177": "#\\delete",

  /* poeticless names */
    "\001": "#\\soh",
    "\002": "#\\stx",
    "\003": "#\\etx",
    "\004": "#\\eot",
    "\005": "#\\enq",
    "\006": "#\\ack",

    "\013": "#\\vt",
    "\016": "#\\so",
    "\017": "#\\si",

    "\020": "#\\dle",
    "\021": "#\\dc1",
    "\022": "#\\dc2",
    "\023": "#\\dc3",
    "\024": "#\\dc4",
    "\025": "#\\nak",
    "\026": "#\\syn",
    "\027": "#\\etb",

    "\030": "#\\can",
    "\031": "#\\em",
    "\032": "#\\sub",
    "\033": "#\\esc",
    "\034": "#\\fs",
    "\035": "#\\gs",
    "\036": "#\\rs",
    "\037": "#\\us"};

sc_Char.readable2char = {
    "null": "\000",
    "bell": "\007",
    "backspace": "\010",
    "tab": "\011",
    "newline": "\012",
    "page": "\014",
    "return": "\015",
    "escape": "\033",
    "space": "\040",
    "delete": "\000",
    "soh": "\001",
    "stx": "\002",
    "etx": "\003",
    "eot": "\004",
    "enq": "\005",
    "ack": "\006",
    "bel": "\007",
    "bs": "\010",
    "ht": "\011",
    "nl": "\012",
    "vt": "\013",
    "np": "\014",
    "cr": "\015",
    "so": "\016",
    "si": "\017",
    "dle": "\020",
    "dc1": "\021",
    "dc2": "\022",
    "dc3": "\023",
    "dc4": "\024",
    "nak": "\025",
    "syn": "\026",
    "etb": "\027",
    "can": "\030",
    "em": "\031",
    "sub": "\032",
    "esc": "\033",
    "fs": "\034",
    "gs": "\035",
    "rs": "\036",
    "us": "\037",
    "sp": "\040",
    "del": "\177"};
    
sc_Char.prototype.toString = function() {
    return this.val;
};
// sc_toDisplayString == toString
sc_Char.prototype.sc_toWriteString = function() {
    var entry = sc_Char.char2readable[this.val];
    if (entry)
	return entry;
    else
	return "#\\" + this.val;
};

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (postfix "instanceof sc_Char")))
*/
function sc_isChar(c) {
    return (c instanceof sc_Char);
}

/*** META ((export char=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val === " c2 ".val")))
*/
var sc_isCharEqual = sc_isCharStringEqual;
/*** META ((export char<?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val < " c2 ".val")))
*/
var sc_isCharLess = sc_isCharStringLess;
/*** META ((export char>?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val > " c2 ".val")))
*/
var sc_isCharGreater = sc_isCharStringGreater;
/*** META ((export char<=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val <= " c2 ".val")))
*/
var sc_isCharLessEqual = sc_isCharStringLessEqual;
/*** META ((export char>=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val >= " c2 ".val")))
*/
var sc_isCharGreaterEqual = sc_isCharStringGreaterEqual;
/*** META ((export char-ci=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val.toLowerCase() === " c2 ".val.toLowerCase()")))
*/
var sc_isCharCIEqual = sc_isCharStringCIEqual;
/*** META ((export char-ci<?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val.toLowerCase() < " c2 ".val.toLowerCase()")))
*/
var sc_isCharCILess = sc_isCharStringCILess;
/*** META ((export char-ci>?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val.toLowerCase() > " c2 ".val.toLowerCase()")))
*/
var sc_isCharCIGreater = sc_isCharStringCIGreater;
/*** META ((export char-ci<=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val.toLowerCase() <= " c2 ".val.toLowerCase()")))
*/
var sc_isCharCILessEqual = sc_isCharStringCILessEqual;
/*** META ((export char-ci>=?)
           (arity 2)
           (type bool)
           (peephole (hole 2 c1 ".val.toLowerCase() >= " c2 ".val.toLowerCase()")))
*/
var sc_isCharCIGreaterEqual = sc_isCharStringCIGreaterEqual;

var SC_NUMBER_CLASS = "0123456789";
var SC_WHITESPACE_CLASS = ' \r\n\t\f';
var SC_LOWER_CLASS = 'abcdefghijklmnopqrstuvwxyz';
var SC_UPPER_CLASS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

function sc_isCharOfClass(c, cl) { return (cl.indexOf(c) != -1); }
/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isCharAlphabetic(c)
    { return sc_isCharOfClass(c.val, SC_LOWER_CLASS) ||
	  sc_isCharOfClass(c.val, SC_UPPER_CLASS); }
/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (hole 1 "SC_NUMBER_CLASS.indexOf(" c ".val) != -1")))
*/
function sc_isCharNumeric(c)
    { return sc_isCharOfClass(c.val, SC_NUMBER_CLASS); }
/*** META ((export #t) (arity #t)
           (type bool))
*/
function sc_isCharWhitespace(c) {
    var tmp = c.val;
    return tmp === " " || tmp === "\r" || tmp === "\n" || tmp === "\t" || tmp === "\f";
}
/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (hole 1 "SC_UPPER_CLASS.indexOf(" c ".val) != -1")))
*/
function sc_isCharUpperCase(c)
    { return sc_isCharOfClass(c.val, SC_UPPER_CLASS); }
/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (hole 1 "SC_LOWER_CLASS.indexOf(" c ".val) != -1")))
*/
function sc_isCharLowerCase(c)
    { return sc_isCharOfClass(c.val, SC_LOWER_CLASS); }

/*** META ((export #t) (arity #t)
           (peephole (postfix ".val.charCodeAt(0)")))
*/
function sc_char2integer(c)
    { return c.val.charCodeAt(0); }
/*** META ((export #t) (arity #t)
           (peephole (hole 1 "new sc_Char(String.fromCharCode(" n "))")))
*/
function sc_integer2char(n)
    { return new sc_Char(String.fromCharCode(n)); }

/*** META ((export #t) (arity #t)
           (peephole (hole 1 "new sc_Char(" c ".val.toUpperCase())")))
*/
function sc_charUpcase(c)
    { return new sc_Char(c.val.toUpperCase()); }
/*** META ((export #t) (arity #t)
           (peephole (hole 1 "new sc_Char(" c ".val.toLowerCase())")))
*/
function sc_charDowncase(c)
    { return new sc_Char(c.val.toLowerCase()); }

function sc_makeJSStringOfLength(k, c) {
    var fill;
    if (c === undefined)
	fill = " ";
    else
	fill = c;
    var res = "";
    var len = 1;
    // every round doubles the size of fill.
    while (k >= len) {
	if (k & len)
	    res = res.concat(fill);
	fill = fill.concat(fill);
	len *= 2;
    }
    return res;
}

function sc_makejsString(k, c) {
    var fill;
    if (c)
	fill = c.val;
    else
	fill = " ";
    return sc_makeJSStringOfLength(k, fill);
}

function sc_jsstring2list(s) {
    var res = null;
    for (var i = s.length - 1; i >= 0; i--)
	res = sc_cons(new sc_Char(s.charAt(i)), res);
    return res;
}

function sc_list2jsstring(l) {
    var a = new Array();
    while(l !== null) {
	a.push(l.car.val);
	l = l.cdr;
    }
    return "".concat.apply("", a);
}

var sc_Vector = Array;

sc_Vector.prototype.sc_toWriteOrDisplayString = function(writeOrDisplay) {
    if (this.length === 0) return "#()";

    var res = "#(" + writeOrDisplay(this[0]);
    for (var i = 1; i < this.length; i++)
	res += " " + writeOrDisplay(this[i]);
    res += ")";
    return res;
};
sc_Vector.prototype.sc_toDisplayString = function() {
    return this.sc_toWriteOrDisplayString(sc_toDisplayString);
};
sc_Vector.prototype.sc_toWriteString = function() {
    return this.sc_toWriteOrDisplayString(sc_toWriteString);
};

/*** META ((export vector? array?) (arity #t)
           (type bool)
           (peephole (postfix " instanceof sc_Vector")))
*/
function sc_isVector(v) {
    return (v instanceof sc_Vector);
}

// only applies to vectors
function sc_isVectorEqual(v1, v2, comp) {
    if (v1.length !== v2.length) return false;
    for (var i = 0; i < v1.length; i++)
	if (!comp(v1[i], v2[i])) return false;
    return true;
}

/*** META ((export make-vector make-array)
           (arity -2))
*/
function sc_makeVector(size, fill) {
    var a = new sc_Vector(size);
    if (fill !== undefined)
	sc_vectorFillBang(a, fill);
    return a;
}

/*** META ((export vector array)
           (arity -1)
           (peephole (vector)))
*/
function sc_vector() {
    var a = new sc_Vector();
    for (var i = 0; i < arguments.length; i++)
	a.push(arguments[i]);
    return a;
}

/*** META ((export vector-length array-length) (arity #t)
           (peephole (postfix ".length")))
*/
function sc_vectorLength(v) {
    return v.length;
}

/*** META ((export vector-ref array-ref) (arity #t)
           (peephole (hole 2 v "[" pos "]")))
*/
function sc_vectorRef(v, pos) {
    return v[pos];
}

/*** META ((export vector-set! array-set!) (arity #t)
           (peephole (hole 3 v "[" pos "] = " val)))
*/
function sc_vectorSetBang(v, pos, val) {
    v[pos] = val;
}

/*** META ((export vector->list array->list) (arity #t)) */
function sc_vector2list(a) {
    var res = null;
    for (var i = a.length-1; i >= 0; i--)
	res = sc_cons(a[i], res);
    return res;
}

/*** META ((export list->vector list->array) (arity #t)) */
function sc_list2vector(l) {
    var a = new sc_Vector();
    while(l !== null) {
	a.push(l.car);
	l = l.cdr;
    }
    return a;
}

/*** META ((export vector-fill! array-fill!) (arity #t)) */
function sc_vectorFillBang(a, fill) {
    for (var i = 0; i < a.length; i++)
	a[i] = fill;
}


/*** META ((export #t) (arity #t)) */
function sc_copyVector(a, len) {
    if (len <= a.length)
	return a.slice(0, len);
    else {
	var tmp = a.concat();
	tmp.length = len;
	return tmp;
    }
}

/*** META ((export #t) (arity -2)
           (peephole (hole 3 a ".slice(" start "," end ")")))
*/
function sc_vectorCopy(a, start, end) {
    return a.slice(start, end);
}

/*** META ((export #t) (arity -4)) */
function sc_vectorCopyBang(target, tstart, source, sstart, send) {
    if (!sstart) sstart = 0;
    if (!send) send = source.length;

    // if target == source we don't want to overwrite not yet copied elements.
    if (tstart <= sstart) {
	for (var i = tstart, j = sstart; j < send; i++, j++) {
	    target[i] = source[j];
	}
    } else {
	var diff = send - sstart;
	for (var i = tstart + diff - 1, j = send - 1;
	     j >= sstart;
	     i--, j--) {
	    target[i] = source[j];
	}
    }
    return target;
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (hole 1 "typeof " o " === 'function'")))
*/
function sc_isProcedure(o) {
    return (typeof o === "function");
}

/*** META ((export #t) (arity -3)) */
function sc_apply(proc) {
    var args = new Array();
    // first part of arguments are not in list-form.
    for (var i = 1; i < arguments.length - 1; i++)
	args.push(arguments[i]);
    var l = arguments[arguments.length - 1];
    while (l !== null) {
	args.push(l.car);
	l = l.cdr;
    }
    return proc.apply(null, args);
}

/*** META ((export #t) (arity -2)) */
function sc_map(proc, l1) {
    if (l1 === undefined)
	return null;
    // else
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    var revres = null;
    while (l1 !== null) {
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	revres = sc_cons(proc.apply(null, applyArgs), revres);
    }
    return sc_reverseAppendBang(revres, null);
}

/*** META ((export #t) (arity -2)) */
function sc_mapBang(proc, l1) {
    if (l1 === undefined)
	return null;
    // else
    var l1_orig = l1;
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    while (l1 !== null) {
	var tmp = l1;
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	tmp.car = proc.apply(null, applyArgs);
    }
    return l1_orig;
}
     
/*** META ((export #t) (arity -2)) */
function sc_forEach(proc, l1) {
    if (l1 === undefined)
	return undefined;
    // else
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    while (l1 !== null) {
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	proc.apply(null, applyArgs);
    }
    // add return so FF does not complain.
    return undefined;
}

/*** META ((export #t) (arity #t)) */
function sc_filter(proc, l1) {
    var dummy = { cdr : null };
    var tail = dummy;
    while (l1 !== null) {
	if (proc(l1.car) !== false) {
	    tail.cdr = sc_cons(l1.car, null);
	    tail = tail.cdr;
	}
	l1 = l1.cdr;
    }
    return dummy.cdr;
}

/*** META ((export #t) (arity #t)) */
function sc_filterBang(proc, l1) {
    var head = sc_cons("dummy", l1);
    var it = head;
    var next = l1;
    while (next !== null) {
        if (proc(next.car) !== false) {
	    it.cdr = next
	    it = next;
	}
	next = next.cdr;
    }
    it.cdr = null;
    return head.cdr;
}

function sc_filterMap1(proc, l1) {
    var revres = null;
    while (l1 !== null) {
        var tmp = proc(l1.car)
        if (tmp !== false) revres = sc_cons(tmp, revres);
        l1 = l1.cdr;
    }
    return sc_reverseAppendBang(revres, null);
}
function sc_filterMap2(proc, l1, l2) {
    var revres = null;
    while (l1 !== null) {
        var tmp = proc(l1.car, l2.car);
        if(tmp !== false) revres = sc_cons(tmp, revres);
	l1 = l1.cdr;
	l2 = l2.cdr
    }
    return sc_reverseAppendBang(revres, null);
}

/*** META ((export #t) (arity -2)) */
function sc_filterMap(proc, l1, l2, l3) {
    if (l2 === undefined)
	return sc_filterMap1(proc, l1);
    else if (l3 === undefined)
	return sc_filterMap2(proc, l1, l2);
    // else
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    var revres = null;
    while (l1 !== null) {
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	var tmp = proc.apply(null, applyArgs);
	if(tmp !== false) revres = sc_cons(tmp, revres);
    }
    return sc_reverseAppendBang(revres, null);
}

function sc_any1(proc, l) {
    var revres = null;
    while (l !== null) {
        var tmp = proc(l.car);
        if(tmp !== false) return tmp;
	l = l.cdr;
    }
    return false;
}

/*** META ((export #t) (arity -2)) */
function sc_any(proc, l1, l2) {
    if (l1 === undefined)
	return false;
    if (l2 === undefined)
	return sc_any1(proc, l1);
    // else
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    while (l1 !== null) {
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	var tmp =  proc.apply(null, applyArgs);
	if (tmp !== false) return tmp;
    }
    return false;
}

/*** META ((export any?) (arity -2)
           (peephole (hole 2 "sc_any(" proc "," l ") !== false")))
*/
function sc_anyPred(proc, l) {
    return sc_any(proc, l) !== false;
}


function sc_every1(proc, l) {
    var revres = null;
    var tmp = true;
    while (l !== null) {
        tmp = proc(l.car);
        if (tmp === false) return false;
	l = l.cdr;
    }
    return tmp;
}

/*** META ((export #t) (arity -2)) */
function sc_every(proc, l1, l2) {
    if (l1 === undefined)
	return true;
    if (l2 === undefined)
	return sc_every1(proc, l1);
    // else
    var nbApplyArgs = arguments.length - 1;
    var applyArgs = new Array(nbApplyArgs);
    var tmp = true;
    while (l1 !== null) {
	for (var i = 0; i < nbApplyArgs; i++) {
	    applyArgs[i] = arguments[i + 1].car;
	    arguments[i + 1] = arguments[i + 1].cdr;
	}
	var tmp = proc.apply(null, applyArgs);
	if (tmp === false) return false;
    }
    return tmp;
}

/*** META ((export every?) (arity -2)
           (peephole (hole 2 "sc_every(" proc "," l ") !== false")))
*/
function sc_everyPred(proc, l) {
    var tmp = sc_every(proc, l);
    if (tmp !== false) return true;
    return false;
}

/*** META ((export #t) (arity #t)
           (peephole (postfix "()")))
*/
function sc_force(o) {
    return o();
}

/*** META ((export #t) (arity #t)) */
function sc_makePromise(proc) {
    var isResultReady = false;
    var result = undefined;
    return function() {
	if (!isResultReady) {
	    var tmp = proc();
	    if (!isResultReady) {
		isResultReady = true;
		result = tmp;
	    }
	}
	return result;
    };
}

function sc_Values(values) {
    this.values = values;
}

/*** META ((export #t) (arity -1)
           (peephole (values)))
*/
function sc_values() {
    if (arguments.length === 1)
	return arguments[0];
    else
	return new sc_Values(arguments);
}

/*** META ((export #t) (arity #t)) */
function sc_callWithValues(producer, consumer) {
   if( !sc_isProcedure(producer) )
      sc_error( "callWithValue", "producer not a procedure", producer );
      
    var produced = producer();
    if (produced instanceof sc_Values)
	return consumer.apply(null, produced.values);
    else
	return consumer(produced);
}

/*** META ((export #t) (arity #t)) */
function sc_dynamicWind(before, thunk, after) {
    before();
    try {
	var res = thunk();
	return res;
    } finally {
	after();
    }
}


// TODO: eval/scheme-report-environment/null-environment/interaction-environment

// LIMITATION: 'load' doesn't exist without files.
// LIMITATION: transcript-on/transcript-off doesn't exist without files.


function sc_Struct(name) {
    this.name = name;
}
sc_Struct.prototype.sc_toDisplayString = function() {
    return "#<struct" + sc_hash(this) + ">";
};
sc_Struct.prototype.sc_toWriteString = sc_Struct.prototype.sc_toDisplayString;

/*** META ((export #t) (arity #t)
           (peephole (hole 1 "new sc_Struct(" name ")")))
*/
function sc_makeStruct(name) {
    return new sc_Struct(name);
}

/*** META ((export #t) (arity 1)
           (type bool)
           (peephole (postfix " instanceof sc_Struct")))
*/
function sc_isStruct(o) {
    return (o instanceof sc_Struct);
}

/*** META ((export #t) (arity #t)
           (type bool)
           (peephole (hole 2 "(" 1 " instanceof sc_Struct) && ( " 1 ".name === " 0 ")")))
*/
function sc_isStructNamed(name, s) {
    return ((s instanceof sc_Struct) && (s.name === name));
}

/*** META ((export struct-field) (arity #t)
           (peephole (hole 3 0 "[" 2 "]")))
*/
function sc_getStructField(s, name, field) {
    return s[field];
}

/*** META ((export struct-field-set!) (arity #t)
           (peephole (hole 4 0 "[" 2 "] = " 3)))
*/
function sc_setStructFieldBang(s, name, field, val) {
    s[field] = val;
}

/*** META ((export #t) (arity #t)
           (peephole (prefix "~")))
*/
function sc_bitNot(x) {
    return ~x;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "&")))
*/
function sc_bitAnd(x, y) {
    return x & y;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "|")))
*/
function sc_bitOr(x, y) {
    return x | y;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "^")))
*/
function sc_bitXor(x, y) {
    return x ^ y;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 "<<")))
*/
function sc_bitLsh(x, y) {
    return x << y;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 ">>")))
*/
function sc_bitRsh(x, y) {
    return x >> y;
}

/*** META ((export #t) (arity #t)
           (peephole (infix 2 2 ">>>")))
*/
function sc_bitUrsh(x, y) {
    return x >>> y;
}

/*** META ((export js-field js-property) (arity #t)
           (peephole (hole 2 o "[" field "]")))
*/
function sc_jsField(o, field) {
    return o[field];
}

/*** META ((export js-field-set! js-property-set!)
           (arity #t)
           (peephole (hole 3 o "[" field "] = " val)))
*/
function sc_setJsFieldBang(o, field, val) {
    return o[field] = val;
}

/*** META ((export js-field-delete! js-property-delete!)
           (arity #t)
           (peephole (hole 2 "delete " o "[" field "]")))
*/
function sc_deleteJsFieldBang(o, field) {
    delete o[field];
}

/*** META ((export #t)
           (arity -3)
           (peephole (jsCall)))
*/
function sc_jsCall(o, fun) {
    var args = new Array();
    for (var i = 2; i < arguments.length; i++)
	args[i-2] = arguments[i];
    return fun.apply(o, args);
}

/*** META ((export #t)
           (arity -3)
           (peephole (jsMethodCall)))
*/
function sc_jsMethodCall(o, field) {
    var args = new Array();
    for (var i = 2; i < arguments.length; i++)
	args[i-2] = arguments[i];
    return o[field].apply(o, args);
}

/*** META ((export new js-new)
           (arity -2)
           (peephole (jsNew)))
*/
function sc_jsNew(c) {
    var evalStr = "new c(";
    evalStr +=arguments.length > 1? "arguments[1]": "";
    for (var i = 2; i < arguments.length; i++)
	evalStr += ", arguments[" + i + "]";
    evalStr +=")";
    return eval(evalStr);
}    

// ======================== RegExp ====================
/*** META ((export #t) (arity #t)) */
function sc_pregexp(re) {
    return new RegExp(sc_string2jsstring(re));
}

/*** META ((export #t) (arity #t)) */
function sc_pregexpMatch(re, s) {
    var reg = (re instanceof RegExp) ? re : sc_pregexp(re);
    var tmp = reg.exec(sc_string2jsstring(s));
    
    if (tmp == null) return false;
    
    var res = null;
    for (var i = tmp.length-1; i >= 0; i--) {
	if (tmp[i] !== null) {
	    res = sc_cons(sc_jsstring2string(tmp[i]), res);
	} else {
	    res = sc_cons(false, res);
	}
    }
    return res;
}
   
/*** META ((export #t) (arity #t)) */
function sc_pregexpReplace(re, s1, s2) {
   var reg;
   var jss1 = sc_string2jsstring(s1);
   var jss2 = sc_string2jsstring(s2);

   if (re instanceof RegExp) {
       if (re.global)
	   reg = re;
       else
	   reg = new RegExp(re.source);
   } else {
       reg = new RegExp(sc_string2jsstring(re));
   }

   return jss1.replace(reg, jss2);
}
   
/*** META ((export pregexp-replace*) (arity #t)) */
function sc_pregexpReplaceAll(re, s1, s2) {
   var reg;
   var jss1 = sc_string2jsstring(s1);
   var jss2 = sc_string2jsstring(s2);

   if (re instanceof RegExp) {
      if (re.global)
	  reg = re;
      else
	  reg = new RegExp(re.source, "g");
   } else {
       reg = new RegExp(sc_string2jsstring(re), "g");
   }

   return jss1.replace(reg, jss2);
}

/*** META ((export #t) (arity #t)) */
function sc_pregexpSplit(re, s) {
   var reg = ((re instanceof RegExp) ?
	      re :
	      new RegExp(sc_string2jsstring(re)));
   var jss = sc_string2jsstring(s);
   var tmp = jss.split(reg);

   if (tmp == null) return false;

   return sc_vector2list(tmp);
}
   
function sc_pregexpCreateCharsetMatcher(set) {
    if (set.length === 0 || set.length === 1) return new RegExp("[" + set + "]");
    var res = "[";
    for (var i = 0; i < set.length; i++) {
	var c = set.charAt(i);
	if (c === "]")
	    res += "\\]";
	else if (c === "^")
	    res += "\\^";
	else if (c === "\\")
	    res += "\\\\";
	else if (c === "-")
	    res += "\\-";
	else res += c;
    }
    return new RegExp(res + "]");
}

/* =========================================================================== */
/* Other library stuff */
/* =========================================================================== */

/*** META ((export #t) (arity #t)
           (peephole (hole 1 "Math.floor(Math.random()*" 'n ")")))
*/
function sc_random(n) {
    return Math.floor(Math.random()*n);
}

/*** META ((export current-date) (arity #t)
           (peephole (hole 0 "new Date()")))
*/
function sc_currentDate() {
   return new Date();
}

/*** META ((export current-seconds) (arity #t)) 
*/
function sc_currentSeconds() {
   return (new Date()).getTime() / 1000;
}

/*** META ((export current-microseconds) (arity #t)) 
*/
function sc_currentMicroseconds() {
   return (new Date()).getTime();
}

function sc_Hashtable() {
}
sc_Hashtable.prototype.toString = function() {
    return "#{%hashtable}";
};
// sc_toWriteString == sc_toDisplayString == toString

function sc_HashtableElement(key, val) {
    this.key = key;
    this.val = val;
}

// the arity of make-hashtable inside Bigloo is -1. However we don't use it
// here. So for now simply don't give the arity...
/*** META ((export #t)
           (peephole (hole 0 "new sc_Hashtable()")))
*/
function sc_makeHashtable() {
    return new sc_Hashtable();
}

/*** META ((export #t) (arity #t)
           (type bool)) */
function sc_isHashtable(o) {
    return o instanceof sc_Hashtable;
}

/*** META ((export #t) (arity #t)) */
function sc_hashtablePutBang(ht, key, val) {
    var hash = sc_hash(key);
    ht[hash] = new sc_HashtableElement(key, val);
}

/*** META ((export #t) (arity #t)) */
function sc_hashtableGet(ht, key) {
    var hash = sc_hash(key);
    if (hash in ht)
	return ht[hash].val;
    else
	return false;
}

/*** META ((export #t) (arity #t)) */
function sc_hashtableForEach(ht, f) {
    for (var v in ht) {
	if (ht[v] instanceof sc_HashtableElement)
	    f(ht[v].key, ht[v].val);
    }
}

/*** META ((export hashtable-contains?)
           (arity #t)
           (peephole (hole 2 "sc_hash(" 1 ") in " 0)))
*/
function sc_hashtableContains(ht, key) {
    var hash = sc_hash(key);
    if (hash in ht)
	return true;
    else
	return false;
}

var SC_HASH_COUNTER = 0;

function sc_hash(o) {
    if (o === null)
	return "null";
    else if (o === undefined)
	return "undefined";
    else if (o === true)
	return "true";
    else if (o === false)
	return "false";
    else if (typeof o === "number")
	return "num-" + o;
    else if (typeof o === "string")
	return "jsstr-" + o;
    else if (o.sc_getHash)
	return o.sc_getHash();
    else
	return sc_counterHash.call(o);
}
function sc_counterHash() {
    if (!this.sc_hash) {
	this.sc_hash = "hash-" + SC_HASH_COUNTER;
	SC_HASH_COUNTER++;
    }
    return this.sc_hash;
}

function sc_Trampoline() {
}

sc_Trampoline.prototype.restart = function() {
    while (true) {
	this.calls = this.MAX_TAIL_CALLs-1;
	var res = this.f.apply(this, this.args);
	if (res !== this)
	    return res;
    }
}

/*** META ((export bind-exit-lambda) (arity #t)) */
function sc_bindExitLambda(proc) {
    var escape_obj = new sc_BindExitException();
    var escape = function(res) {
	escape_obj.res = res;
	throw escape_obj;
    };
    try {
	return proc(escape);
    } catch(e) {
	if (e === escape_obj) {
	    return e.res;
	}
	throw e;
    }
}
function sc_BindExitException() {
    this._internalException = true;
}

var SC_SCM2JS_GLOBALS = new Object();

var SC_TAIL_OBJECT = new sc_Trampoline();  // (used in runtime_callcc.)
SC_SCM2JS_GLOBALS.TAIL_OBJECT = SC_TAIL_OBJECT;
/*=====================================================================*/
/*    Author      :  Florian Loitsch                                   */
/*    Copyright   :  2007-10 Florian Loitsch, see LICENSE file         */
/*    -------------------------------------------------------------    */
/*    This file is part of Scheme2Js.                                  */
/*                                                                     */
/*   Scheme2Js is distributed in the hope that it will be useful,      */
/*   but WITHOUT ANY WARRANTY; without even the implied warranty of    */
/*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     */
/*   LICENSE file for more details.                                    */
/*=====================================================================*/

// ======================== I/O =======================

/*------------------------------------------------------------------*/

function sc_EOF() {
}
var SC_EOF_OBJECT = new sc_EOF();

function sc_Port() {
}

/* --------------- Input ports -------------------------------------*/

function sc_InputPort() {
}
sc_InputPort.prototype = new sc_Port();

sc_InputPort.prototype.peekChar = function() {
    if (!("peeked" in this))
	this.peeked = this.getNextChar();
    return this.peeked;
}
sc_InputPort.prototype.readChar = function() {
    var tmp = this.peekChar();
    delete this.peeked;
    return tmp;
}
sc_InputPort.prototype.isCharReady = function() {
    return true;
}
sc_InputPort.prototype.close = function() {
    // do nothing
}

/* .............. String port ..........................*/
function sc_ErrorInputPort() {
};
sc_ErrorInputPort.prototype = new sc_InputPort();
sc_ErrorInputPort.prototype.getNextChar = function() {
    throw "can't read from error-port.";
};
sc_ErrorInputPort.prototype.isCharReady = function() {
    return false;
};
    

/* .............. String port ..........................*/

function sc_StringInputPort(jsStr) {
    // we are going to do some charAts on the str.
    // instead of recreating all the time a String-object, we
    // create one in the beginning. (not sure, if this is really an optim)
    this.str = new String(jsStr);
    this.pos = 0;
}
sc_StringInputPort.prototype = new sc_InputPort();
sc_StringInputPort.prototype.getNextChar = function() {
    if (this.pos >= this.str.length)
	return SC_EOF_OBJECT;
    return this.str.charAt(this.pos++);
};

/* ------------- Read and other lib-funs  -------------------------------*/
function sc_Token(type, val, pos) {
    this.type = type;
    this.val = val;
    this.pos = pos;
}
sc_Token.EOF = 0/*EOF*/;
sc_Token.OPEN_PAR = 1/*OPEN_PAR*/;
sc_Token.CLOSE_PAR = 2/*CLOSE_PAR*/;
sc_Token.OPEN_BRACE = 3/*OPEN_BRACE*/;
sc_Token.CLOSE_BRACE = 4/*CLOSE_BRACE*/;
sc_Token.OPEN_BRACKET = 5/*OPEN_BRACKET*/;
sc_Token.CLOSE_BRACKET = 6/*CLOSE_BRACKET*/;
sc_Token.WHITESPACE = 7/*WHITESPACE*/;
sc_Token.QUOTE = 8/*QUOTE*/;
sc_Token.ID = 9/*ID*/;
sc_Token.DOT = 10/*DOT*/;
sc_Token.STRING = 11/*STRING*/;
sc_Token.NUMBER = 12/*NUMBER*/;
sc_Token.ERROR = 13/*ERROR*/;
sc_Token.VECTOR_BEGIN = 14/*VECTOR_BEGIN*/;
sc_Token.TRUE = 15/*TRUE*/;
sc_Token.FALSE = 16/*FALSE*/;
sc_Token.UNSPECIFIED = 17/*UNSPECIFIED*/;
sc_Token.REFERENCE = 18/*REFERENCE*/;
sc_Token.STORE = 19/*STORE*/;
sc_Token.CHAR = 20/*CHAR*/;

var SC_ID_CLASS = SC_LOWER_CLASS + SC_UPPER_CLASS + "!$%*+-./:<=>?@^_~";
function sc_Tokenizer(port) {
    this.port = port;
}
sc_Tokenizer.prototype.peekToken = function() {
    if (this.peeked)
	return this.peeked;
    var newToken = this.nextToken();
    this.peeked = newToken;
    return newToken;
};
sc_Tokenizer.prototype.readToken = function() {
    var tmp = this.peekToken();
    delete this.peeked;
    return tmp;
};
sc_Tokenizer.prototype.nextToken = function() {
    var port = this.port;
    
    function isNumberChar(c) {
	return (c >= "0" && c <= "9");
    };
    function isIdOrNumberChar(c) {
	return SC_ID_CLASS.indexOf(c) != -1 || // ID-char
	    (c >= "0" && c <= "9");
    }
    function isWhitespace(c) {
	return c === " " || c === "\r" || c === "\n" || c === "\t" || c === "\f";
    };
    function isWhitespaceOrEOF(c) {
	return isWhitespace(c) || c === SC_EOF_OBJECT;
    };

    function readString() {
	res = "";
	while (true) {
	    var c = port.readChar();
	    switch (c) {
	    case '"':
		return new sc_Token(11/*STRING*/, res);
	    case "\\":
		var tmp = port.readChar();
		switch (tmp) {
		case '0': res += "\0"; break;
		case 'a': res += "\a"; break;
		case 'b': res += "\b"; break;
		case 'f': res += "\f"; break;
		case 'n': res += "\n"; break;
		case 'r': res += "\r"; break;
		case 't': res += "\t"; break;
		case 'v': res += "\v"; break;
		case '"': res += '"'; break;
		case '\\': res += '\\'; break;
		case 'x':
		    /* hexa-number */
		    var nb = 0;
		    while (true) {
			var hexC = port.peekChar();
			if (hexC >= '0' && hexC <= '9') {
			    port.readChar();
			    nb = nb * 16 + hexC.charCodeAt(0) - '0'.charCodeAt(0);
			} else if (hexC >= 'a' && hexC <= 'f') {
			    port.readChar();
			    nb = nb * 16 + hexC.charCodeAt(0) - 'a'.charCodeAt(0);
			} else if (hexC >= 'A' && hexC <= 'F') {
			    port.readChar();
			    nb = nb * 16 + hexC.charCodeAt(0) - 'A'.charCodeAt(0);
			} else {
			    // next char isn't part of hex.
			    res += String.fromCharCode(nb);
			    break;
			}
		    }
		    break;
		default:
		    if (tmp === SC_EOF_OBJECT) {
			return new sc_Token(13/*ERROR*/, "unclosed string-literal" + res);
		    }
		    res += tmp;
		}
		break;
	    default:
		if (c === SC_EOF_OBJECT) {
		    return new sc_Token(13/*ERROR*/, "unclosed string-literal" + res);
		}
		res += c;
	    }
	}
    };
    function readIdNumberOrKeyword(firstChar) {
	var res = firstChar;
	while (isIdOrNumberChar(port.peekChar()))
	    res += port.readChar();
	if (isNaN(res)) {
	    if (res.length > 1) {
		colonCode = ':'.charCodeAt(0);
		if (res.charCodeAt(0) == colonCode) {
		    if (res.charCodeAt(1) != colonCode) {
			return new sc_Token(21/*KEYWORD*/, res.substring(1, res.length));
		    }
		} else if (res.charCodeAt(res.length - 1) == colonCode &&
			   res.charCodeAt(res.length - 2) != colonCode) {
		    return new sc_Token(21/*KEYWORD*/, res.substring(0, res.length - 1));
		}
	    }
	    return new sc_Token(9/*ID*/, res);
	} else {
	    return new sc_Token(12/*NUMBER*/, res - 0);
	}
    };
    
    function skipWhitespaceAndComments() {
	var done = false;
	while (!done) {
	    done = true;
	    while (isWhitespace(port.peekChar()))
		port.readChar();
	    if (port.peekChar() === ';') {
		port.readChar();
		done = false;
		while (true) {
		    curChar = port.readChar();
		    if (curChar === SC_EOF_OBJECT ||
			curChar === '\n')
			break;
		}
	    }
	}
    };
    
    function readDot() {
	if (isWhitespace(port.peekChar()))
	    return new sc_Token(10/*DOT*/);
	else
	    return readIdNumberOrKeyword(".");
    };

    function readSharp() {
	var c = port.readChar();
	if (isWhitespace(c))
	    return new sc_Token(13/*ERROR*/, "bad #-pattern0.");

	// reference
	if (isNumberChar(c)) {
	    var nb = c - 0;
	    while (isNumberChar(port.peekChar()))
		nb = nb*10 + (port.readChar() - 0);
	    switch (port.readChar()) {
	    case '#':
		return new sc_Token(18/*REFERENCE*/, nb);
	    case '=':
		return new sc_Token(19/*STORE*/, nb);
	    default:
		return new sc_Token(13/*ERROR*/, "bad #-pattern1." + nb);
	    }
	}

	if (c === "(")
	    return new sc_Token(14/*VECTOR_BEGIN*/);
	
	if (c === "\\") { // character
	    var tmp = ""
	    while (!isWhitespaceOrEOF(port.peekChar()))
		tmp += port.readChar();
	    switch (tmp.length) {
	    case 0: // it's escaping a whitespace char:
		if (sc_isEOFObject(port.peekChar))
		    return new sc_Token(13/*ERROR*/, "bad #-pattern2.");
		else
		    return new sc_Token(20/*CHAR*/, port.readChar());
	    case 1:
		return new sc_Token(20/*CHAR*/, tmp);
	    default:
		var entry = sc_Char.readable2char[tmp.toLowerCase()];
		if (entry)
		    return new sc_Token(20/*CHAR*/, entry);
		else
		    return new sc_Token(13/*ERROR*/, "unknown character description: #\\" + tmp);
	    }
	}

	// some constants (#t, #f, #unspecified)
	var res;
	var needing;
	switch (c) {
	case 't': res = new sc_Token(15/*TRUE*/, true); needing = ""; break;
	case 'f': res = new sc_Token(16/*FALSE*/, false); needing = ""; break;
	case 'u': res = new sc_Token(17/*UNSPECIFIED*/, undefined); needing = "nspecified"; break;
	default:
	    return new sc_Token(13/*ERROR*/, "bad #-pattern3: " + c);
	}
	while(true) {
	    c = port.peekChar();
	    if ((isWhitespaceOrEOF(c) || c === ')') &&
		needing == "")
		return res;
	    else if (isWhitespace(c) || needing == "")
		return new sc_Token(13/*ERROR*/, "bad #-pattern4 " + c + " " + needing);
	    else if (needing.charAt(0) == c) {
		port.readChar(); // consume
		needing = needing.slice(1);
	    } else
		return new sc_Token(13/*ERROR*/, "bad #-pattern5");
	}
	
    };

    skipWhitespaceAndComments();
    var curChar = port.readChar();
    if (curChar === SC_EOF_OBJECT)
	return new sc_Token(0/*EOF*/, curChar);
    switch (curChar)
    {
    case " ":
    case "\n":
    case "\t":
	return readWhitespace();
    case "(":
	return new sc_Token(1/*OPEN_PAR*/);
    case ")":
	return new sc_Token(2/*CLOSE_PAR*/);
    case "{":
	return new sc_Token(3/*OPEN_BRACE*/);
    case "}":
	return new sc_Token(4/*CLOSE_BRACE*/);
    case "[":
	return new sc_Token(5/*OPEN_BRACKET*/);
    case "]":
	return new sc_Token(6/*CLOSE_BRACKET*/);
    case "'":
	return new sc_Token(8/*QUOTE*/);
    case "#":
	return readSharp();
    case ".":
	return readDot();
    case '"':
	return readString();
    default:
	if (isIdOrNumberChar(curChar))
	    return readIdNumberOrKeyword(curChar);
	throw "unexpected character: " + curChar;
    }
};

function sc_Reader(tokenizer) {
    this.tokenizer = tokenizer;
    this.backref = new Array();
}
sc_Reader.prototype.read = function() {
    function readList(listBeginType) {
	function matchesPeer(open, close) {
	    return open === 1/*OPEN_PAR*/ && close === 2/*CLOSE_PAR*/
	    	|| open === 3/*OPEN_BRACE*/ && close === 4/*CLOSE_BRACE*/
		|| open === 5/*OPEN_BRACKET*/ && close === 6/*CLOSE_BRACKET*/;
	};
	var res = null;

	while (true) {
	    var token = tokenizer.peekToken();
	    
	    switch (token.type) {
	    case 2/*CLOSE_PAR*/:
	    case 4/*CLOSE_BRACE*/:
	    case 6/*CLOSE_BRACKET*/:
		if (matchesPeer(listBeginType, token.type)) {
		    tokenizer.readToken(); // consume token
		    return sc_reverseBang(res);
		} else
		    throw "closing par doesn't match: " + listBeginType
			+ " " + listEndType;

	    case 0/*EOF*/:
		throw "unexpected end of file";

	    case 10/*DOT*/:
		tokenizer.readToken(); // consume token
		var cdr = this.read();
		var par = tokenizer.readToken();
		if (!matchesPeer(listBeginType, par.type))
		    throw "closing par doesn't match: " + listBeginType
			+ " " + par.type;
		else
		    return sc_reverseAppendBang(res, cdr);
		

	    default:
		res = sc_cons(this.read(), res);
	    }
	}
    };
    function readQuote() {
	return sc_cons("quote", sc_cons(this.read(), null));
    };
    function readVector() {
	// opening-parenthesis is already consumed
	var a = new Array();
	while (true) {
	    var token = tokenizer.peekToken();
	    switch (token.type) {
	    case 2/*CLOSE_PAR*/:
		tokenizer.readToken();
		return a;
		
	    default:
		a.push(this.read());
	    }
	}
    };

    function storeRefence(nb) {
	var tmp = this.read();
	this.backref[nb] = tmp;
	return tmp;
    };
	
    function readReference(nb) {
	if (nb in this.backref)
	    return this.backref[nb];
	else
	    throw "bad reference: " + nb;
    };
    
    var tokenizer = this.tokenizer;

    var token = tokenizer.readToken();

    // handle error
    if (token.type === 13/*ERROR*/)
	throw token.val;
    
    switch (token.type) {
    case 1/*OPEN_PAR*/:
    case 3/*OPEN_BRACE*/:
    case 5/*OPEN_BRACKET*/:
	return readList.call(this, token.type);
    case 8/*QUOTE*/:
	return readQuote.call(this);
    case 11/*STRING*/:
	return sc_jsstring2string(token.val);
    case 20/*CHAR*/:
	return new sc_Char(token.val);
    case 14/*VECTOR_BEGIN*/:
	return readVector.call(this);
    case 18/*REFERENCE*/:
	return readReference.call(this, token.val);
    case 19/*STORE*/:
	return storeRefence.call(this, token.val);
    case 9/*ID*/:
	return sc_jsstring2symbol(token.val);
    case 21/*KEYWORD*/:
	return sc_jsstring2keyword(token.val);
    case 0/*EOF*/:
    case 12/*NUMBER*/:
    case 15/*TRUE*/:
    case 16/*FALSE*/:
    case 17/*UNSPECIFIED*/:
	return token.val;
    default:
	throw "unexpected token " + token.type + " " + token.val;
    }
};

/*** META ((export #t) (arity -1)) */
function sc_read(port) {
    if (port === undefined) // we assume the port hasn't been given.
	port = SC_DEFAULT_IN; // THREAD: shared var...
    var reader = new sc_Reader(new sc_Tokenizer(port));
    return reader.read();
}
/*** META ((export #t) (arity -1)) */
function sc_readChar(port) {
    if (port === undefined) // we assume the port hasn't been given.
	port = SC_DEFAULT_IN; // THREAD: shared var...
    var t = port.readChar();
    return t === SC_EOF_OBJECT? t: new sc_Char(t);
}
/*** META ((export #t) (arity -1)) */
function sc_peekChar(port) {
    if (port === undefined) // we assume the port hasn't been given.
	port = SC_DEFAULT_IN; // THREAD: shared var...
    var t = port.peekChar();
    return t === SC_EOF_OBJECT? t: new sc_Char(t);
}    
/*** META ((export #t)
           (arity -1)
           (type bool))
*/
function sc_isCharReady(port) {
    if (port === undefined) // we assume the port hasn't been given.
	port = SC_DEFAULT_IN; // THREAD: shared var...
    return port.isCharReady();
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".close()")))
*/
function sc_closeInputPort(p) {
    return p.close();
}

/*** META ((export #t)
           (arity #t)
           (type bool)
           (peephole (postfix " instanceof sc_InputPort")))
*/
function sc_isInputPort(o) {
    return (o instanceof sc_InputPort);
}

/*** META ((export eof-object?)
           (arity #t)
           (type bool)
           (peephole (postfix " === SC_EOF_OBJECT")))
*/
function sc_isEOFObject(o) {
    return o === SC_EOF_OBJECT;
}

/*** META ((export #t)
           (arity #t)
           (peephole (hole 0 "SC_DEFAULT_IN")))
*/
function sc_currentInputPort() {
    return SC_DEFAULT_IN;
}

/* ------------ file operations are not supported -----------*/
/*** META ((export #t) (arity #t)) */
function sc_callWithInputFile(s, proc) {
    throw "can't open " + s;
}

/*** META ((export #t) (arity #t)) */
function sc_callWithOutputFile(s, proc) {
    throw "can't open " + s;
}

/*** META ((export #t) (arity #t)) */
function sc_withInputFromFile(s, thunk) {
    throw "can't open " + s;
}

/*** META ((export #t) (arity #t)) */
function sc_withOutputToFile(s, thunk) {
    throw "can't open " + s;
}

/*** META ((export #t) (arity #t)) */
function sc_openInputFile(s) {
    throw "can't open " + s;
}

/*** META ((export #t) (arity #t)) */
function sc_openOutputFile(s) {
    throw "can't open " + s;
}

/* ----------------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function sc_basename(p) {
   var i = p.lastIndexOf('/');

   if(i >= 0)
      return p.substring(i + 1, p.length);
   else
      return p;
}

/*** META ((export #t) (arity #t)) */
function sc_dirname(p) {
   var i = p.lastIndexOf('/');

   if(i >= 0)
      return p.substring(0, i);
   else
      return '';
}

/* ----------------------------------------------------------------------------*/

/*** META ((export #t) (arity #t)) */
function sc_withInputFromPort(p, thunk) {
    try {
	var tmp = SC_DEFAULT_IN; // THREAD: shared var.
	SC_DEFAULT_IN = p;
	return thunk();
    } finally {
	SC_DEFAULT_IN = tmp;
    }
}

/*** META ((export #t) (arity #t)) */
function sc_withInputFromString(s, thunk) {
    return sc_withInputFromPort(new sc_StringInputPort(sc_string2jsstring(s)), thunk);
}

/*** META ((export #t) (arity #t)) */
function sc_withOutputToPort(p, thunk) {
    try {
	var tmp = SC_DEFAULT_OUT; // THREAD: shared var.
	SC_DEFAULT_OUT = p;
	return thunk();
    } finally {
	SC_DEFAULT_OUT = tmp;
    }
}

/*** META ((export #t) (arity #t)) */
function sc_withOutputToString(thunk) {
    var p = new sc_StringOutputPort();
    sc_withOutputToPort(p, thunk);
    return p.close();
}

/*** META ((export #t) (arity #t)) */
function sc_withOutputToProcedure(proc, thunk) {
    var t = function(s) { proc(sc_jsstring2string(s)); };
    return sc_withOutputToPort(new sc_GenericOutputPort(t), thunk);
}

/*** META ((export #t)
           (arity #t)           
           (peephole (hole 0 "new sc_StringOutputPort()")))
*/
function sc_openOutputString() {
    return new sc_StringOutputPort();
}

/*** META ((export #t) (arity #t)) */
function sc_openInputString(str) {
    return new sc_StringInputPort(sc_string2jsstring(str));
}

/* ----------------------------------------------------------------------------*/

function sc_OutputPort() {
}
sc_OutputPort.prototype = new sc_Port();
sc_OutputPort.prototype.appendJSString = function(obj) {
    /* do nothing */
}
sc_OutputPort.prototype.close = function() {
    /* do nothing */
}

function sc_StringOutputPort() {
    this.res = "";
}
sc_StringOutputPort.prototype = new sc_OutputPort();
sc_StringOutputPort.prototype.appendJSString = function(s) {
    this.res += s;
}
sc_StringOutputPort.prototype.close = function() {
    return sc_jsstring2string(this.res);
}

/*** META ((export #t) (arity #t)) */
function sc_getOutputString(sp) {
    return sc_jsstring2string(sp.res);
}
    

function sc_ErrorOutputPort() {
}
sc_ErrorOutputPort.prototype = new sc_OutputPort();
sc_ErrorOutputPort.prototype.appendJSString = function(s) {
    throw "don't write on ErrorPort!";
}
sc_ErrorOutputPort.prototype.close = function() {
    /* do nothing */
}

function sc_GenericOutputPort(appendJSString, close) {
    this.appendJSString = appendJSString;
    if (close)
	this.close = close;
}
sc_GenericOutputPort.prototype = new sc_OutputPort();

/*** META ((export #t)
           (arity #t)
	   (type bool)
           (peephole (postfix " instanceof sc_OutputPort")))
*/
function sc_isOutputPort(o) {
    return (o instanceof sc_OutputPort);
}

/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".close()")))
*/
function sc_closeOutputPort(p) {
    return p.close();
}

/* ------------------ write ---------------------------------------------------*/

/*** META ((export #t) (arity -2)) */
function sc_write(o, p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString(sc_toWriteString(o));
}

function sc_toWriteString(o) {
    if (o === null)
	return "()";
    else if (o === true)
	return "#t";
    else if (o === false)
	return "#f";
    else if (o === undefined)
	return "#unspecified";
    // window is only declared inside browsers. Otherwise this.window should be undefined
    else if (o === this.window)
        return "window";
    else if (typeof o === 'function')
        return "#<procedure " + (o.name ? o.name : "anonymous") + " " + (o.location != "#f" ? o.location : "") + ":" + sc_hash(o) + ">";
    else if (o.sc_toWriteString)
	return o.sc_toWriteString();
    else
	return o.toString();
}

function sc_escapeWriteString(s) {
    var res = "";
    var j = 0;
    for (i = 0; i < s.length; i++) {
	switch (s.charAt(i)) {
	case "\0": res += s.substring(j, i) + "\\0"; j = i + 1; break;
	case "\b": res += s.substring(j, i) + "\\b"; j = i + 1; break;
	case "\f": res += s.substring(j, i) + "\\f"; j = i + 1; break;
	case "\n": res += s.substring(j, i) + "\\n"; j = i + 1; break;
	case "\r": res += s.substring(j, i) + "\\r"; j = i + 1; break;
	case "\t": res += s.substring(j, i) + "\\t"; j = i + 1; break;
	case '"': res += s.substring(j, i) + '\\"'; j = i + 1; break;
	case "\\": res += s.substring(j, i) + "\\\\"; j = i + 1; break;
	default:
	    var c = s.charAt(i);
	    if ("\a" !== "a" && c == "\a") {
		res += s.substring(j, i) + "\\a"; j = i + 1; continue;
	    }
	    if ("\v" !== "v" && c == "\v") {
		res += s.substring(j, i) + "\\v"; j = i + 1; continue;
	    }
	    //if (s.charAt(i) < ' ' || s.charCodeAt(i) > 127) {
	    // CARE: Manuel is this OK with HOP?
	    if (s.charAt(i) < ' ') {
		/* non printable character and special chars */
		res += s.substring(j, i) + "\\x" + s.charCodeAt(i).toString(16);
		j = i + 1;
	    }
	    // else just let i increase...
	}
    }
    res += s.substring(j, i);
    return res;
}

/* ------------------ display ---------------------------------------------------*/

/*** META ((export #t) (arity -2)) */
function sc_display(o, p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString(sc_toDisplayString(o));
}

function sc_toDisplayString(o) {
    if (o === null)
	return "()";
    else if (o === true)
	return "#t";
    else if (o === false)
	return "#f";
    else if (o === undefined)
	return "#unspecified";
    // window is only declared inside browsers. Otherwise this.window should be undefined
    else if (o === this.window)
        return "window";
    else if (typeof o === 'function')
        return "#<procedure " + (o.name ? o.name : "anonymous") + " " + (o.location != "#f" ? o.location : "") + ":" + sc_hash(o) + ">";
    else if (o.sc_toDisplayString)
	return o.sc_toDisplayString();
    else
	return o.toString();
}

/* ------------------ newline ---------------------------------------------------*/

/*** META ((export #t) (arity -1)) */
function sc_newline(p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString("\n");
}
    
/* ------------------ write-char ---------------------------------------------------*/

/*** META ((export #t) (arity -2)) */
function sc_writeChar(c, p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString(c.val);
}

/* ------------------ write/display-circle -----------------------------------------*/

/*** META ((export #t) (arity -2)) */
function sc_writeCircle(o, p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString(sc_toCircleString(o, sc_toWriteString));
}

/*** META ((export #t) (arity -2)) */
function sc_displayCircle(o, p) {
    if (p === undefined) // we assume not given
	p = SC_DEFAULT_OUT;
    p.appendJSString(sc_toCircleString(o, sc_toDisplayString));
}

function sc_toCircleString(o, writeOrDisplay) {
    var symb = sc_gensym("writeCircle");
    var nbPointer = new Object();
    nbPointer.nb = 0;
    sc_prepCircle(o, symb, nbPointer);
    return sc_genToCircleString(o, symb, writeOrDisplay);
}

function sc_prepCircle(o, symb, nbPointer) {
    // TODO sc_Struct
    if (o instanceof sc_Pair ||
	o instanceof sc_Vector) {
	if (o[symb] !== undefined) {
	    // not the first visit.
	    o[symb]++;
	    // unless there is already a number, assign one.
	    if (!o[symb + "nb"]) o[symb + "nb"] = nbPointer.nb++;
	    return;
	}
	o[symb] = 0;
	if (o instanceof sc_Pair) {
	    sc_prepCircle(o.car, symb, nbPointer);
	    sc_prepCircle(o.cdr, symb, nbPointer);
	} else {
	    for (var i = 0; i < o.length; i++)
		sc_prepCircle(o[i], symb, nbPointer);
	}
    }
}

function sc_genToCircleString(o, symb, writeOrDisplay) {
    if (!(o instanceof sc_Pair ||
	  o instanceof sc_Vector))
	return writeOrDisplay(o);
    return o.sc_toCircleString(symb, writeOrDisplay);
}
sc_Pair.prototype.sc_toCircleString = function(symb, writeOrDisplay, inList) {
    if (this[symb + "use"]) { // use-flag is set. Just use it.
	var nb = this[symb + "nb"];
	if (this[symb]-- === 0) { // if we are the last use. remove all fields.
	    delete this[symb];
	    delete this[symb + "nb"];
	    delete this[symb + "use"];
	}
	if (inList)
	    return '. #' + nb + '#';
	else
	    return '#' + nb + '#';
    }
    if (this[symb]-- === 0) { // if we are the last use. remove all fields.
	delete this[symb];
	delete this[symb + "nb"];
	delete this[symb + "use"];
    }

    var res = "";
    
    if (this[symb] !== undefined) { // implies > 0
	this[symb + "use"] = true;
	if (inList)
	    res += '. #' + this[symb + "nb"] + '=';
	else
	    res += '#' + this[symb + "nb"] + '=';
	inList = false;
    }

    if (!inList)
	res += "(";
    
    // print car
    res += sc_genToCircleString(this.car, symb, writeOrDisplay);
    
    if (sc_isPair(this.cdr)) {
	res += " " + this.cdr.sc_toCircleString(symb, writeOrDisplay, true);
    } else if (this.cdr !== null) {
	res += " . " + sc_genToCircleString(this.cdr, symb, writeOrDisplay);
    }
    if (!inList)
	res += ")";
    return res;
};
sc_Vector.prototype.sc_toCircleString = function(symb, writeOrDisplay) {
    if (this[symb + "use"]) { // use-flag is set. Just use it.
	var nb = this[symb + "nb"];
	if (this[symb]-- === 0) { // if we are the last use. remove all fields.
	    delete this[symb];
	    delete this[symb + "nb"];
	    delete this[symb + "use"];
	}
	return '#' + nb + '#';
    }
    if (this[symb]-- === 0) { // if we are the last use. remove all fields.
	delete this[symb];
	delete this[symb + "nb"];
	delete this[symb + "use"];
    }

    var res = "";
    if (this[symb] !== undefined) { // implies > 0
	this[symb + "use"] = true;
	res += '#' + this[symb + "nb"] + '=';
    }
    res += "#(";
    for (var i = 0; i < this.length; i++) {
	res += sc_genToCircleString(this[i], symb, writeOrDisplay);
	if (i < this.length - 1) res += " ";
    }
    res += ")";
    return res;
};


/* ------------------ print ---------------------------------------------------*/

/*** META ((export #t) (arity -1)) */
function sc_print(s) {
    if (arguments.length === 1) {
	sc_display(s);
	sc_newline();
    }
    else {
	for (var i = 0; i < arguments.length; i++)
	    sc_display(arguments[i]);
	sc_newline();
    }
}

/* ------------------ format ---------------------------------------------------*/
/*** META ((export #t) (arity -2)) */
function sc_format(s) {
   var len = s.length;
   var p = new sc_StringOutputPort();
   var i = 0, j = 1;

   while( i < len ) {
      var i2 = s.indexOf("~", i);

      if (i2 == -1) {
	  p.appendJSString( s.substring( i, len ) );
	  return p.close();
      } else if (i2 == (len - 1)) {
	  p.appendJSString(s.substring(i, len));
	  return p.close();
      } else if (i2 == (len - 2) && s.charAt(i2 + 1) == ":") {
	  p.appendJSString(s.substring(i, len));
	  return p.close();
      } else {
	  if (i2 > i) p.appendJSString(s.substring(i, i2));

	  var alternativeForm = (s.charAt(i2 + 1) == ":");
	  if (alternativeForm) i2++;

	  // already advance before evalualating escape sequences.
	  // this way it is easier to see.
	  // no escape sequence requires 'i'.
	  i = i2 + 2;

	  switch(s.charCodeAt(i2 + 1)) {
	  case 65:
	  case 97:
	      // a
	      if (alternativeForm)
		  sc_displayCircle(arguments[j], p);
	      else
		  sc_display(arguments[j], p);
	      j++;
	      break;

	  case 83:
	  case 115:
	      // s
	      if (alternativeForm)
		  sc_writeCircle(arguments[j], p);
	      else
		  sc_write(arguments[j], p);
	      j++;
	      break;

	  case 86:
	  case 118:
	      // v
	      if (alternativeForm)
		  sc_displayCircle(arguments[j], p);
	      else
		  sc_display(arguments[j], p);
	      p.appendJSString("\n");
	      j++;
	      break;

	  case 67:
	  case 99:
	      // c
	      p.appendJSString(String.fromCharCode(arguments[j]));
	      j++;
	      break;

	  case 88:
	  case 120:
	      // x
	      p.appendJSString(arguments[j].toString(16));
	      j++;
	      break;

	  case 79:
	  case 111:
	      // o
	      p.appendJSString(arguments[j].toString(8));
	      j++;
	      break;

	  case 66:
	  case 98:
	      // b
	      p.appendJSString(arguments[j].toString(2));
	      j++;
	      break;
	       
	  case 37:
	  case 110:
	      // %, n
	      p.appendJSString("\n");
	      break;

	  case 114:
	      // r
	      p.appendJSString("\r");
	      break;

	  case 126:
	      // ~
	      p.appendJSString("~");
	      break;

	  default:
	      sc_error( "format: illegal ~"
			+ String.fromCharCode(s.charCodeAt(i2 + 1))
			+ " sequence" );
	      return "";
	  }
      }
   }

   return p.close();
}

/* ------------------ global ports ---------------------------------------------------*/

var SC_DEFAULT_IN = new sc_ErrorInputPort();
var SC_DEFAULT_OUT = new sc_ErrorOutputPort();
var SC_ERROR_OUT = new sc_ErrorOutputPort();

/*=====================================================================*/
/*    Author      :  Florian Loitsch                                   */
/*    Copyright   :  2007-10 Florian Loitsch, see LICENSE file         */
/*    -------------------------------------------------------------    */
/*    This file is part of Scheme2Js.                                  */
/*                                                                     */
/*   Scheme2Js is distributed in the hope that it will be useful,      */
/*   but WITHOUT ANY WARRANTY; without even the implied warranty of    */
/*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     */
/*   LICENSE file for more details.                                    */
/*=====================================================================*/

var sc_SYMBOL_PREFIX = "\uEBAC";
var sc_KEYWORD_PREFIX = "\uEBAD";

/*** META ((export #t) (arity #t)
           (peephole (id))) */
function sc_jsstring2string(s) {
    return s;
}

/*** META ((export #t) (arity #t)
           (peephole (prefix "'\\uEBAC' +")))
*/
function sc_jsstring2symbol(s) {
    return sc_SYMBOL_PREFIX + s;
}

/*** META ((export #t) (arity #t)
           (peephole (id)))
*/
function sc_string2jsstring(s) {
    return s;
}

/*** META ((export #t) (arity #t)
           (peephole (symbol2jsstring_immutable)))
*/
function sc_symbol2jsstring(s) {
    return s.slice(1);
}

/*** META ((export #t) (arity #t)
           (peephole (postfix ".slice(1)")))
*/
function sc_keyword2jsstring(k) {
    return k.slice(1);
}

/*** META ((export #t) (arity #t)
           (peephole (prefix "'\\uEBAD' +")))
*/
function sc_jsstring2keyword(s) {
    return sc_KEYWORD_PREFIX + s;
}

/*** META ((export #t)
           (arity #t)
           (type bool))
*/
function sc_isKeyword(s) {
    return (typeof s === "string") &&
	(s.charAt(0) === sc_KEYWORD_PREFIX);
}


/*** META ((export #t) (arity -1)) */
var sc_gensym = function() {
    var counter = 1000;
    return function(sym) {
	counter++;
	if (!sym) sym = sc_SYMBOL_PREFIX;
	return sym + "s" + counter + "~" + "^sC-GeNsYm ";
    };
}();


/*** META ((export #t)
           (arity #t)
           (type bool))
*/
function sc_isEqual(o1, o2) {
    return ((o1 === o2) ||
	    (sc_isPair(o1) && sc_isPair(o2)
	     && sc_isPairEqual(o1, o2, sc_isEqual)) ||
	    (sc_isVector(o1) && sc_isVector(o2)
	     && sc_isVectorEqual(o1, o2, sc_isEqual)));
}

/*** META ((export number->symbol integer->symbol) (arity -2)) */
function sc_number2symbol(x, radix) {
    return sc_SYMBOL_PREFIX + sc_number2jsstring(x, radix);
}
    
/*** META ((export number->string integer->string) (arity -2)) */
var sc_number2string = sc_number2jsstring;

/*** META ((export #t) (arity -2)) */
function sc_symbol2number(s, radix) {
    return sc_jsstring2number(s.slice(1), radix);
}

/*** META ((export #t) (arity -2)) */
var sc_string2number = sc_jsstring2number;

/*** META ((export #t)
           (arity -2)
           (peephole (prefix "+")))
           ;; peephole will only apply if no radix is given.
*/
function sc_string2integer(s, radix) {
    if (!radix) return +s;
    return parseInt(s, radix);
}

/*** META ((export #t)
           (arity #t)
           (peephole (prefix "+")))
*/
function sc_string2real(s) {
    return +s;
}


/*** META ((export #t)
           (arity #t)
           (type bool))
*/
function sc_isSymbol(s) {
    return (typeof s === "string") &&
	(s.charAt(0) === sc_SYMBOL_PREFIX);
}

/*** META ((export #t)
           (arity #t)
           (peephole (symbol2string_immutable)))
*/
function sc_symbol2string(s) {
    return s.slice(1);
}

/*** META ((export #t)
           (arity #t)
           (peephole (prefix "'\\uEBAC' +")))
*/
function sc_string2symbol(s) {
    return sc_SYMBOL_PREFIX + s;
}

/*** META ((export symbol-append)
           (arity -1)
           (peephole (symbolAppend_immutable)))
*/
function sc_symbolAppend() {
    var res = sc_SYMBOL_PREFIX;
    for (var i = 0; i < arguments.length; i++)
	res += arguments[i].slice(1);
    return res;
}

/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".val")))
*/
function sc_char2string(c) { return c.val; }

/*** META ((export #t)
           (arity #t)
           (peephole (hole 1 "'\\uEBAC' + " c ".val")))
*/
function sc_char2symbol(c) { return sc_SYMBOL_PREFIX + c.val; }

/*** META ((export #t)
           (arity #t)
           (type bool))
*/
function sc_isString(s) {
    return (typeof s === "string") &&
	(s.charAt(0) !== sc_SYMBOL_PREFIX);
}

/*** META ((export #t) (arity -2)) */
var sc_makeString = sc_makejsString;


/*** META ((export #t) (arity -1)) */
function sc_string() {
    for (var i = 0; i < arguments.length; i++)
	arguments[i] = arguments[i].val;
    return "".concat.apply("", arguments);
}

/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".length")))
*/
function sc_stringLength(s) { return s.length; }

/*** META ((export #t) (arity #t)) */
function sc_stringRef(s, k) {
    return new sc_Char(s.charAt(k));
}

/* there's no stringSet in the immutable version
function sc_stringSet(s, k, c)
*/


/*** META ((export string=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 " === " str2)))
*/
function sc_isStringEqual(s1, s2) {
    return s1 === s2;
}
/*** META ((export string<?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 " < " str2)))
*/
function sc_isStringLess(s1, s2) {
    return s1 < s2;
}
/*** META ((export string>?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 " > " str2)))
*/
function sc_isStringGreater(s1, s2) {
    return s1 > s2;
}
/*** META ((export string<=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 " <= " str2)))
*/
function sc_isStringLessEqual(s1, s2) {
    return s1 <= s2;
}
/*** META ((export string>=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 " >= " str2)))
*/
function sc_isStringGreaterEqual(s1, s2) {
    return s1 >= s2;
}
/*** META ((export string-ci=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 ".toLowerCase() === " str2 ".toLowerCase()")))
*/
function sc_isStringCIEqual(s1, s2) {
    return s1.toLowerCase() === s2.toLowerCase();
}
/*** META ((export string-ci<?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 ".toLowerCase() < " str2 ".toLowerCase()")))
*/
function sc_isStringCILess(s1, s2) {
    return s1.toLowerCase() < s2.toLowerCase();
}
/*** META ((export string-ci>?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 ".toLowerCase() > " str2 ".toLowerCase()")))
*/
function sc_isStringCIGreater(s1, s2) {
    return s1.toLowerCase() > s2.toLowerCase();
}
/*** META ((export string-ci<=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 ".toLowerCase() <= " str2 ".toLowerCase()")))
*/
function sc_isStringCILessEqual(s1, s2) {
    return s1.toLowerCase() <= s2.toLowerCase();
}
/*** META ((export string-ci>=?)
           (arity #t)
	   (type bool)
           (peephole (hole 2 str1 ".toLowerCase() >= " str2 ".toLowerCase()")))
*/
function sc_isStringCIGreaterEqual(s1, s2) {
    return s1.toLowerCase() >= s2.toLowerCase();
}

/*** META ((export string-contains)
           (arity -3)
	   (type bool))
*/
function sc_stringContains(s1,s2,start) {
   return s1.indexOf(s2,start ? start : 0) >= 0;
}

/*** META ((export string-contains-ci)
           (arity -3)
	   (type bool))
*/
function sc_stringCIContains(s1,s2,start) {
   return s1.toLowerCase.indexOf(s2.toLowerCase,start ? start : 0) >= 0;
}

/*** META ((export #t)
           (arity #t)
           (peephole (hole 3 s ".substring(" start ", " end ")")))
*/
function sc_substring(s, start, end) {
   return s.substring(start, end < 0 ? s.length : end);
}

/*** META ((export #t) (arity -4))
*/
function sc_isSubstring_at(str1, str2, i, len) {
    if (!len) len = str2.length;
    else if (str2.length < len) return false;
    if (str1.length < len + i) return false;
    return str2.substring(0, len) == str1.substring(i, i+len);
    return s2 == s1.substring(i, i+ s2.length);
}

/*** META ((export substring=?) (arity #t))
*/
function sc_isSubstring(s1, s2, len) {
    if (s1.length < len) return false;
    if (s2.length < len) return false;
    return s2.substring(0, len) == s1.substring(0, len);
}

/*** META ((export #t)
           (arity -1)
           (peephole (infix 0 #f "+" "''")))
*/
function sc_stringAppend() {
    return "".concat.apply("", arguments);
}

/*** META ((export #t) (arity 1)) */
var sc_string2list = sc_jsstring2list;

/*** META ((export #t) (arity 1)) */
var sc_list2string = sc_list2jsstring;

/*** META ((export #t)
           (arity #t)
           (peephole (id)))
*/
function sc_stringCopy(s) {
    return s;
}

/* there's no string-fill in the immutable version
function sc_stringFill(s, c)
*/

/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".slice(1)")))
*/
function sc_keyword2string(o) {
    return o.slice(1);
}

/*** META ((export #t)
           (arity #t)
           (peephole (prefix "'\\uEBAD' +")))
*/
function sc_string2keyword(o) {
    return sc_KEYWORD_PREFIX + o;
}

String.prototype.sc_toDisplayString = function() {
    if (this.charAt(0) === sc_SYMBOL_PREFIX)
	// TODO: care for symbols with spaces (escape-chars symbols).
	return this.slice(1);
    else if (this.charAt(0) === sc_KEYWORD_PREFIX)
	return ":" + this.slice(1);
    else
	return this.toString();
};

String.prototype.sc_toWriteString = function() {
    if (this.charAt(0) === sc_SYMBOL_PREFIX)
	// TODO: care for symbols with spaces (escape-chars symbols).
	return this.slice(1);
    else if (this.charAt(0) === sc_KEYWORD_PREFIX)
	return ":" + this.slice(1);
    else
	return '"' + sc_escapeWriteString(this) + '"';
};

/*** META ((export #t)
           (arity #t)
           (peephole (hole 2 1 ".indexOf(" 0 ") === 0")))
*/
function sc_isStringPrefix(cs1, cs2) {
    return cs2.indexOf(cs1) === 0;
}

/*** META ((export #t) (arity #t)) */
function sc_isStringSuffix(cs1, cs2) {
    var tmp = cs2.lastIndexOf(cs1);
    return tmp !== false && tmp >= 0 && tmp === cs2.length - cs1.length;
}

/*** META ((export #t) (arity #t)) */
function sc_stringSplit(s, sep) {
    if (sep.length === 1)
	return sc_vector2list(s.split(sep));
    return sc_vector2list(s.split(sc_pregexpCreateCharsetMatcher(sep)));
}

/*** META ((export #t) (arity -3)) */
function sc_stringIndex(s, cset, start) {
   var res;
   if (!start) start = 0;

   if (cset instanceof sc_Char) {
      res = s.indexOf(sc_char2string(cset), start);
      return res >= 0 ? res : false;
   }
   if (cset.length == 1) {
      res = s.indexOf(cset, start);
      return res >= 0 ? res : false;
   } else {
      for (var i = start; i < s.length; i++ ) {
	 if (cset.indexOf(s.charAt(i)))
	    return i;
      }

      return false;
   }
}

/*** META ((export #t) (arity -3)) */
function sc_stringIndexRight(s, cset, start) {
   var res;
   if (!start) start = s.length - 1;
   
   if (cset instanceof sc_Char) {
      res = s.lastIndexof(sc_char2string(cset), start);
      return res >= 0 ? res : false;
   }
   if (cset.length == 1) {
      res = s.lastIndexOf(cset, start);
      return res >= 0 ? res : false;
   } else {
      for (var i = start; i >= 0; i-- ) {
	 if (cset.indexOf(s.charAt(i)))
	    return i;
      }

      return false;
   }
}

/*** META ((export #t) (arity 1)) */
function sc_string_downcase(s) {
   return s.toLowerCase();
}

/*** META ((export #t) (arity 1)) */
function sc_string_upcase(s) {
   return s.toUpperCase();
}

/*** META ((export #t) (arity 1)) */
function sc_string_capitalize(s) {
   return s.replace(/\w+/g, function (w) {
	 return w.charAt(0).toUpperCase() + w.substr(1).toLowerCase();
      });
}
// generated by ~/prgm/project/hop/2.0.x/bin/hopc -j dsssl.scm -o dsssl.js

/*** META ((export dsssl-get-key-arg)
           (arity 3)
	   (JS "BGl_dssslzd2getzd2keyzd2argzd2zzdssslz00")) */
/*** META ((export dsssl-get-key-rest-arg)
           (arity 1)
	   (JS "BGl_dssslzd2getzd2keyzd2restzd2argz00zzdssslz00")) */
/*** META ((export dsssl-check-key-args!)
           (arity 2)
	   (JS "BGl_dssslzd2checkzd2keyzd2argsz12zc0zzdssslz00")) */

var BGl_dssslzd2getzd2keyzd2argzd2zzdssslz00;
var BGl_dssslzd2getzd2keyzd2restzd2argz00zzdssslz00;
var BGl_dssslzd2checkzd2keyzd2argsz12zc0zzdssslz00;
var const_dsssl;
var BgL_sc_const_1z00_dsssl;
var BgL_sc_const_2z00_dsssl;
const_dsssl = "dsssl formal parsing";
BgL_sc_const_1z00_dsssl = "Unexpected #!keys parameters";
BgL_sc_const_2z00_dsssl = "keyword argument misses value";

sc_tmp = BGl_dssslzd2checkzd2keyzd2argsz12zc0zzdssslz00 = function(dsssl_args, key_list) {
      var stmp;
      var stmp_1;
      var tmp1308;
      var tmp1307;
      var tmp1306;
      var args;
      var armed;
      var opts;
      var tmp1304;
      var tmp1303;
      var args_2;
      var g1305;
      if (key_list === null) {
        args_2 = dsssl_args;
        while (!(args_2 === null)) {
          tmp1303 = !(args_2 instanceof sc_Pair);
          if (tmp1303 !== false) {
            stmp_1 = tmp1303;
          } else {
            tmp1304 = args_2.cdr === null;
            if (tmp1304 !== false) {
              stmp_1 = tmp1304;
            } else {
              stmp_1 = !sc_arity_check(sc_isKeyword, 1)(args_2.car);
            }
          }
          if (stmp_1 !== false) {
            return sc_arity_check(sc_error, 3)(const_dsssl, BgL_sc_const_1z00_dsssl, args_2);
          } else {
            args_2 = args_2.cdr.cdr;
          }
        }
        return dsssl_args;
      } else {
        g1305 = null;
        args = dsssl_args;
        armed = false;
        opts = g1305;
        while (!(args === null)) {
          tmp1306 = !(args instanceof sc_Pair);
          if (tmp1306 !== false) {
            stmp = tmp1306;
          } else {
            tmp1307 = args.cdr === null;
            if (tmp1307 !== false) {
              stmp = tmp1307;
            } else {
              tmp1308 = !sc_arity_check(sc_isKeyword, 1)(args.car);
              if (tmp1308 !== false) {
                stmp = tmp1308;
              } else {
                stmp = sc_arity_check(sc_memq, 2)(args.car, key_list) === false;
              }
            }
          }
          if (stmp !== false) {
            if (armed === false) {
              args = args.cdr;
            } else {
              armed = false;
              opts = new sc_Pair(args.car, opts);
              args = args.cdr;
            }
          } else {
            args = args.cdr.cdr;
            armed = true;
          }
        }
        return sc_arity_check(sc_reverseBang, 1)(opts);
      }
    }, sc_tmp.name = "dsssl-check-key-args!", sc_tmp.location = "(at dsssl.scm 144)", sc_tmp.sc_arity = 2, sc_tmp;
sc_tmp = BGl_dssslzd2getzd2keyzd2argzd2zzdssslz00 = function(dsssl_args, keyword, initializer) {
      var args;
      args = dsssl_args;
      while (!(args === null)) {
        if (!sc_arity_check(sc_isKeyword, 1)(args.car)) {
          args = args.cdr;
        } else {
          if (args.car === keyword) {
            if (!(args.cdr instanceof sc_Pair)) {
              return sc_arity_check(sc_error, 3)("\uEBACdsssl-get-key-arg", BgL_sc_const_2z00_dsssl, args.car);
            } else {
              return args.cdr.car;
            }
          } else {
            if (!(args.cdr instanceof sc_Pair)) {
              return sc_arity_check(sc_error, 3)("\uEBACdsssl-get-key-arg", BgL_sc_const_2z00_dsssl, args.car);
            } else {
              args = args.cdr.cdr;
            }
          }
        }
      }
      return initializer;
    }, sc_tmp.name = "dsssl-get-key-arg", sc_tmp.location = "(at dsssl.scm 1375)", sc_tmp.sc_arity = 3, sc_tmp;
sc_tmp = BGl_dssslzd2getzd2keyzd2restzd2argz00zzdssslz00 = function(dsssl_args) {
      var tmp1309;
      var args;
      args = dsssl_args;
      while (!(args === null)) {
        tmp1309 = !sc_arity_check(sc_isKeyword, 1)(args.car);
        if ((tmp1309 !== false? tmp1309: args.cdr === null) !== false) {
          return args;
        } else {
          args = args.cdr.cdr;
        }
      }
      return null;
    }, sc_tmp.name = "dsssl-get-key-rest-arg", sc_tmp.location = "(at dsssl.scm 2124)", sc_tmp.sc_arity = 1, sc_tmp;
var hop_onerror_handler_hop_exception;
var hop_last_exception_hop_exception;
var BgL_sc_objzd2ze3string_1z31_hop_exception;
var in_exception_report_hop_exception;
var const_hop_exception;
var BgL_sc_const_2z00_hop_exception;
var BgL_sc_const_3z00_hop_exception;
var BgL_sc_const_4z00_hop_exception;
var BgL_sc_const_5z00_hop_exception;
var BgL_sc_const_6z00_hop_exception;
var BgL_sc_const_7z00_hop_exception;
var BgL_sc_const_8z00_hop_exception;
var BgL_sc_const_9z00_hop_exception;
var BgL_sc_const_10z00_hop_exception;
var BgL_sc_const_11z00_hop_exception;
var BgL_sc_const_12z00_hop_exception;
var BgL_sc_const_13z00_hop_exception;
var BgL_sc_const_14z00_hop_exception;
var BgL_sc_const_15z00_hop_exception;
var BgL_sc_const_16z00_hop_exception;
var BgL_sc_const_17z00_hop_exception;
var BgL_sc_const_18z00_hop_exception;
var BgL_sc_const_19z00_hop_exception;
var BgL_sc_const_20z00_hop_exception;
var BgL_sc_const_21z00_hop_exception;
var BgL_sc_const_22z00_hop_exception;
var BgL_sc_const_23z00_hop_exception;
var BgL_sc_const_24z00_hop_exception;
var hop_get_stack;
var hop_report_exception;
var hop_mangledp;
var hop_demangle;
var hop_make_exception_stack;
var hop_make_exception_frame;
const_hop_exception = "position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    opacity: 0.8;\n    background: #242222;\n    z-index: 1000000";
BgL_sc_const_2z00_hop_exception = "font-family: arial; font-size: 10pt; overflow: visible";
BgL_sc_const_3z00_hop_exception = "font-family: monospace; color: #777";
BgL_sc_const_4z00_hop_exception = "at ([^ ]+) [(]([^ ]+)(:[0-9]+:[0-9]+)[)]";
BgL_sc_const_5z00_hop_exception = "font-size: 9pt; padding-left: 1em";
BgL_sc_const_6z00_hop_exception = "data:image\u002fpng;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A\u002fwD\u002foL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kGBA8VBixNgawAAAsWSURBVGje7Zp5cF3Vfcc\u002fd3mbnlZbq2VJlrUvXrRhG8dyhKG2jI1jEuMQwDZ2CyYQoCYdSGmBYJrJZDqdadKmSUM7nZBJZrJM2sKUUuI07bBMp9OEmJIGgsHxgm1ZSA9J795379n6x32WZSy3BmxwJtyZ39zfO+fe3znf3+\u002f3Ped37jzLGMNv8mXzG359COCDvtxTyvcs60LajQF3a7jRQMKBxxV8wcD4hRrg+jx33YvkmC9q2FNSXooTizF27GSbgS7g44B\u002fqafQKgV75i\u002ftYOjrX2Ho0b+ibfijSBjWsN0AF0IuFoC4hr1x16Z713YSy4dwuwZov+kmCkvSSHhAwTwFvFe5WAC2aFjdcPkAJauuhMksZMZJNnXStvYKNNRouE0D71UuBoACDfcVlRbSuWsHFJSAl4VcDpSh9ZqPUbVgPiHcrqD9UozA7xvobtu4jlTvCvA9CMNIPB+3opbF1wzjOnaZgocvNQ40SLi7vKGGxi1bwIqB758GEAYQhNT2L6ehuw0BmxWsvZRS6PMGyps3DOMu7IhSR4gZAELwfaxEIe0fHSRmW66ChzXYlwKAHgFbazuaqFu\u002fEUIZ5X0QRFHwvOh3GILnUdPSQfuyHgRcpmDLBePAu8xFV8Ejrmsnu2\u002fYilNTD9lsNNkgICwtJaysxCgVgcjlsHBZPLiK0pIiBHxRQcUHCWCDhPXNq1cw9yNDkIsmjucRVlXhL12K199P0NFxRlRKyqpYsnIAAws07PqgUsjWsCeVStCyeTOkiqOVJwgwjoNqbCTmusQtC9XSgi4ujtIpDCEnaGnvYk55GQI+raHyPQN4F97fLmHVwtUrKFrUA54\u002f7X1VW4tTWkoiHicZjxMrLET19kbEzuUg8CmIpVjSvxQsq07DH7\u002ffESiTcH9peSntH782WjZzPvg+Jp2G1lbitk0YBGSzWeKA3dmJbmzMc0SA59O+YCF1dTWEcLOGpe8nBx5W0NS2\u002fipSLd2QjVKHMISuLtxUCiEEruuSTCYRQmDbNta6dZBIRKkU5EgI6OnqxLGttII\u002fM2C9HynULODmqvoaFly1FqSGIBd5tqoKq76e2c7ZmUwGq6IC+vpgcjIfBY+FZXNobWkkhCENV130FDLwOQvSXZuuJl5dl\u002fdmAEpBe\u002fs533NOHZgGB6GoaJrQbjagf2EjBckEEr6go5rqokVgpYAdDT2d1A4OQaiiyWez0NAANTUAWLOc7hLJZKRUVMDwMExNTe\u002fQtbgsaWtCQp+GGy9WMZfW8KVEImZ3fewa7MKyqGTwfYjHYcmSWaLlY\u002fIHMNueMdSaNdDaGqWSEFgTU\u002fSWlVFWlEbAQwYWvONi7jy8\u002fykBly9c3sfcxX3gzSgXFi2CkpLIjon8Y5QGEwcTj\u002fQzCu8CuPFGkHJ6h56bzdHXWI+xrBoFd17QFALSEu4qLimkc+PVEC+MKkzfh3Qa09aWt6LRhCidw3JsLMuJxLFxYhZGzxi6pwcWL4aJiQjIRJaegjS15WWEsEND2wUjsYE9Brrahlbijh8leO7JaNdVBtXVhUkk8iuPhWOlcGzYv\u002f9n3Hfv\u002fTz40F5eO\u002fQrbBRYFqcWKGPb6J07IRYH3yfjZXhTZulrbiTu2GUSHjkfDpzPV4lKAXdUNtSyYGkn\u002fk++j\u002fz1YdzaJgqu3YnT3Y2DzhM3Iu+TTz3PjhtuYuTNLJZl8Xd\u002f\u002fXX+5pvfZt3wGoQICW1JgROHvj6mhj7CoUe\u002fxsm4wH4jQ11HL83Vlfz86PFNMegFfnpeXyXOlT4a7jRQ2bzyMqw3XkUdPYx2wT9wAH9+JZMhGJUDLDSC\u002f37xCW79vc8wMn4cmyy2meDY2Bi7dt3KCz\u002f7AaOZgE9ccR3PPPNztDH4n9zKSIGFlhB6OcaPHaGrtoakY8ckfF6B81524n4Bn21Y1M68+gpy\u002f\u002fVvKED74Kwfxrn6WgpcjdBgjMfBIyN8YsuDHD78EpaxMZaFtgAtOXbsAJs23cuj33iMw2Nj3HLLTvY9\u002fQxFl62k+ra7kX6U26PHjlCEpLe+FgkbDHzyXa1CgKNhb8x1Eu2rV6BffwmZmcBoMOk4uevvATeN9gNs4\u002fLCi6+z8Xc2cPD1X1JeXIaFBkTeWgxwOHb4dR584C7K0i7f+c73aagrIsjmKN++m0RrHToAKTWjJ96gvWIuJfEYAvZqqHjHJDawUcC6+d1tlKRdwpdfwFigc8DWbTw3Kblr932ENjz4yJ\u002fS37OEBQ3d\u002fPLVgzy+71lq5zdgTBzbaJLJFHPnVqGw6O9dwRP\u002fso\u002fWtmpq6xeihIdTU0vlZ\u002f4ArSO4mfFxyHksrq5EQaOa5czw\u002fwGwFOxJFaToHFyOfOk\u002fkBNZjAJdUYLefCtXDA5QkjI01czjR0\u002f+I0\u002f964v88B\u002fuZ35NGQM9Dfzq0Mts+9RNKOLs3rWdv\u002fzqV9i0cStPPfsjUgmNpR20EhgtEVOTFK29hkR3G8qPonD82FE655RSnUoSRmeGinfCgd0KVrWvHKDQFuQO\u002fAJjgxIgNu9AVtcjPY\u002fPPXAvr\u002fz6IE8\u002f\u002fc8s65mPlPX4chRj4mhvnK89+mWWLh2gf3ANRw+d5M\u002f\u002f9ssk5AlEGBLIKZS0UBJkEKAL0sy57W5M3AEDE1NZ\u002fKkJltVU4lpWnYw+ApzXRlYt4I\u002fKa6po7ltEbv9zqJzEBCBbWwiu\u002fV2Un0VJiZAKKSVSBgQiIBQelknj+5NokwIm+PQd9\u002fDTZx\u002fn1tvXU5FOYFOOUgotDEqpaRFTkxRcOUz6yjXThD46coK6ZJzmokLCKI1W\u002fp8RyN8f0DCveXkv9uhhwkMHIu+7LlNbbkEkU8hcDiElSiqEEIShQkuJUmAkeH4OISRh6NDSVsd3v\u002fsE33vieY4cHWMyN4mQkkAowjBECIEQApmX4p27cSpLMRKyuZDRzDhLykqIWVZMwZ8YsM\u002f5YctAk4Bt1fW1zF8wD3\u002f\u002fcygdTUpWVRAODCGzWYSUSCmjgaVEa41SBplT5IIcqVSSkZERTpwYYc6cOHfc8xA\u002f\u002fvvn2Xr9Njo7utl23Q1k3vJR6lQEIwk9D6eplVhnB0pETj06Nk6ZBYuKCwlgtYYrz7kTa\u002fhD27LSXatXwPHXECOjGBeMBsYzOK+8iBxYjcCA62JcF2IuxnExjoPjOBhL4NtJalqbyPkCoRS3f7YZ37cxegKt04yO+hSWOCglUUKilUIJAYB89RWCQ4cxdgQgJzQjb71FX3Eh\u002fzOVZVLpvQ48A3hnADAwKGFHy+IOKqtKmfrxPrQF2hAZ83xSX7qHcPUGdLIArQ3StlG2DZYdlRKWBcbC2JGK5WA0jBgFGrS20EZjDExpjdYGpTVKaZQxGKWZ\u002fMk+goNHMG40tgUcn5pibjLFsqJCnspMXGbDDcA3zgCgYE8ylbTbL+8j+MV\u002fIt8cRzuR97Uh0k+O4T72TXS+TRlQp\u002frN6TZtQOOglYqcoMC4IMPp8mRazvptgYmdtmeAQBpeG8\u002fQXlLMftflhJQ3zwago6h8Dinp4R18GePakTEzQ2IRkGiCUdvp5SsazTrFMqPzs4n6tQanIO\u002fVGaLftn7r\u002fFgzmelgkQkEXi6gOubwhpS1Z3HAggMTY5nWyQmP4mVrUUpj9CmJwjut67fps\u002fUpjTGn+\u002fUZ70Vhi57J96nT7Xqmjfx7aE2gNceFxIGR2Uj8F17WG\u002f73p59n7rzqaPAZoqd1ztE+Sz\u002f5fm3e1sZZ9iNbZ9s+FX4Lw0mhGJEKB751FgAD\u002f2TBdWNjmTtHxjKNGhyTX4BmlNZn3M3bcnm2Z871zrnuM\u002fVZav\u002fjLjwGfHU6cz78r8SHAH7LAfwv3UC6JoGBIwEAAAAASUVORK5CYII=";
BgL_sc_const_7z00_hop_exception = "font-weight: bold";
BgL_sc_const_8z00_hop_exception = "color: red; font-weight: bold";
BgL_sc_const_9z00_hop_exception = "border-top: 1px dashed #ccc; margin-top: 2ex";
BgL_sc_const_10z00_hop_exception = "font-weight: bold; margin-bttom: 1ex;";
BgL_sc_const_11z00_hop_exception = "font-size: 9pt; padding-left: 1em;";
BgL_sc_const_12z00_hop_exception = "[(]at ([^ ]+) ([^ ]+)[)]";
BgL_sc_const_13z00_hop_exception = "width: 100%; font-size: 9pt; overflow: visible; padding-left: 1em";
BgL_sc_const_14z00_hop_exception = "margin:0; padding: 0";
BgL_sc_const_15z00_hop_exception = "font-size: 20pt; padding-bottom: 4px";
BgL_sc_const_16z00_hop_exception = "JavaScript stack:";
BgL_sc_const_17z00_hop_exception = "Hop client stack:";
BgL_sc_const_18z00_hop_exception = "width: 100%; font-family: arial; font-size: 10pt; background: #FFFFF7; border-bottom: 1px solid #ccc; overflow: visible";
BgL_sc_const_19z00_hop_exception = "font-family: monospace; font-size: 10pt";
BgL_sc_const_20z00_hop_exception = "height: 64px; vertical-align: top; padding-top: 10px; text-align: center";
BgL_sc_const_21z00_hop_exception = "font-family: arial; font-size: 10pt; padding: 5px";
BgL_sc_const_22z00_hop_exception = "color: #777; font-weight: bold";
BgL_sc_const_23z00_hop_exception = "position: fixed;\n    top: 60px;\n    bottom: 60px;\n    left: 150px;\n    right: 150px;\n    min-width: 20em;\n    max-width: 100em;\n    opacity: 0.97;\n    background: white;\n    z-index: 10000001;\n    text-align: left;\n    border: 3px dashed red; padding: 4px;\n    color: black;\n    overflow: hidden;\n    overflow-y: auto;";
BgL_sc_const_24z00_hop_exception = "HopClientSideError";
sc_tmp = hop_mangledp = function(string) {
      var tmp1351;
      var tmp1350;
      var tmp1349;
      var len;
      len = string.length;
      if (len > 7) {
        tmp1349 = sc_arity_check(sc_isSubstring, 3)(string, "BgL_", 4);
        if ((tmp1349 !== false? tmp1349: sc_arity_check(sc_isSubstring, 3)(string, "BGl_", 4)) !== false) {
          if (sc_arity_check(sc_stringRef, 2)(string, len - 3).val === new sc_Char("z").val) {
            tmp1350 = sc_arity_check(sc_isCharAlphabetic, 1)(sc_arity_check(sc_stringRef, 2)(string, len - 2));
            if ((tmp1350 !== false? tmp1350: SC_NUMBER_CLASS.indexOf(sc_arity_check(sc_stringRef, 2)(string, len - 2).val) != -1) !== false) {
              tmp1351 = sc_arity_check(sc_isCharAlphabetic, 1)(sc_arity_check(sc_stringRef, 2)(string, len - 1));
              if (tmp1351 !== false) {
                return tmp1351;
              } else {
                return SC_NUMBER_CLASS.indexOf(sc_arity_check(sc_stringRef, 2)(string, len - 1).val) != -1;
              }
            } else {
              return false;
            }
          } else {
            return false;
          }
        } else {
          return false;
        }
      } else {
        return false;
      }
    }, sc_tmp.name = "bigloo-mangled?", sc_tmp.location = "(at hop-exception.scm 6903)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_demangle = function(string) {
      var get_8bits_integer;
      var subvector;
      var bigloo_demangle_at;
      var clen;
      var len;
      len = string.length;
      clen = len - 3;
      sc_tmp = get_8bits_integer = function(r) {
            var i2;
            var i1;
            var c2;
            var c1;
            c1 = sc_arity_check(sc_stringRef, 2)(string, r + 1);
            c2 = sc_arity_check(sc_stringRef, 2)(string, r + 2);
            if (SC_NUMBER_CLASS.indexOf(c1.val) != -1) {
              i1 = c1.val.charCodeAt(0) - new sc_Char("0").val.charCodeAt(0);
            } else {
              i1 = 10 + (c1.val.charCodeAt(0) - new sc_Char("a").val.charCodeAt(0));
            }
            if (SC_NUMBER_CLASS.indexOf(c2.val) != -1) {
              i2 = c2.val.charCodeAt(0) - new sc_Char("0").val.charCodeAt(0);
            } else {
              i2 = 10 + (c2.val.charCodeAt(0) - new sc_Char("a").val.charCodeAt(0));
            }
            return i1 + (i2 << 4);
          }, sc_tmp.name = "get-8bits-integer", sc_tmp.location = "(at hop-exception.scm 7848)", sc_tmp.sc_arity = 1, sc_tmp;
      sc_tmp = subvector = function(vec, len) {
            var i;
            var l;
            var g1353;
            var g1352;
            g1352 = len - 1;
            g1353 = null;
            i = g1352;
            l = g1353;
            while (!(i === -1)) {
              l = new sc_Pair(vec[i], l);
              --i;
            }
            return sc_arity_check(sc_list2string, 1)(l);
          }, sc_tmp.name = "subvector", sc_tmp.location = "(at hop-exception.scm 8045)", sc_tmp.sc_arity = 2, sc_tmp;
      sc_tmp = bigloo_demangle_at = function(offset) {
            var nc;
            var i;
            var c;
            var r;
            var w;
            var checksum;
            var new_1;
            new_1 = sc_arity_check(sc_makeVector, 1)(clen);
            r = offset;
            w = 0;
            checksum = 0;
            while (!(r === clen)) {
              c = sc_arity_check(sc_stringRef, 2)(string, r);
              if (c.val === new sc_Char("z").val) {
                if (sc_arity_check(sc_stringRef, 2)(string, r + 1).val === new sc_Char("z").val) {
                  return new sc_Values([sc_arity_check(subvector, 2)(new_1, w - 1), r + 2]);
                } else {
                  i = sc_arity_check(get_8bits_integer, 1)(r);
                  nc = new sc_Char(String.fromCharCode(i));
                  new_1[w] = nc;
                  r += 3;
                  ++w;
                  checksum ^= i;
                }
              } else {
                new_1[w] = c;
                ++r;
                ++w;
              }
            }
            if (checksum === sc_arity_check(get_8bits_integer, 1)(r)) {
              return new sc_Values([sc_arity_check(subvector, 2)(new_1, w), r + 3]);
            } else {
              return new sc_Values([string, r + 3]);
            }
          }, sc_tmp.name = "bigloo-demangle-at", sc_tmp.location = "(at hop-exception.scm 8206)", sc_tmp.sc_arity = 1, sc_tmp;
      if (sc_arity_check(hop_mangledp, 1)(string) === false) {
        return string;
      } else {
        if (sc_arity_check(sc_isSubstring, 3)(string, "BgL_", 4) !== false) {
          return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                      return sc_arity_check(bigloo_demangle_at, 1)(4);
                    }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(str, offset) {
                      return str;
                    }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
        } else {
          if (sc_arity_check(sc_isSubstring, 3)(string, "BGl_", 4) !== false) {
            return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                        return sc_arity_check(bigloo_demangle_at, 1)(4);
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(id, offset) {
                        return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                                    return sc_arity_check(bigloo_demangle_at, 1)(offset);
                                  }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(module, offset) {
                                    return id + "@" + module;
                                  }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
          } else {
            return string;
          }
        }
      }
    }, sc_tmp.name = "bigloo-demangle", sc_tmp.location = "(at hop-exception.scm 7582)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_get_stack = function(offset) {
      var depth = null;
      for (var sc_tmp = arguments.length - 1; sc_tmp >= 1; --sc_tmp) {
        depth = sc_cons(arguments[sc_tmp], depth);
      }
      var frame;
      var caller;
      var n;
      var stack;
      var g1356;
      var g1355;
      var proc;
      var offset_2;
      var g1354;
      g1354 = arguments.callee;
      proc = g1354;
      offset_2 = offset;
      while (!(offset_2 === 0)) {
        if (proc !== false) {
          proc = proc.caller;
          --offset_2;
        } else {
          return null;
        }
      }
      if (depth instanceof sc_Pair) {
        g1355 = depth.car;
      } else {
        g1355 = 10;
      }
      g1356 = null;
      caller = proc;
      n = g1355;
      stack = g1356;
      while (caller && n > 0) {
        frame = new sc_Pair(caller, sc_arity_check(sc_vector2list, 1)(caller.arguments));
        caller = caller.caller;
        --n;
        stack = new sc_Pair(frame, stack);
      }
      return sc_arity_check(sc_reverseBang, 1)(stack);
    }, sc_tmp.name = "hop-get-stack", sc_tmp.location = "(at hop-exception.scm 9757)", sc_tmp.sc_arity = -2, sc_tmp;
in_exception_report_hop_exception = "\uEBACno";
sc_tmp = hop_make_exception_frame = function() {
      var args = null;
      for (var sc_tmp = arguments.length - 1; sc_tmp >= 0; --sc_tmp) {
        args = sc_cons(arguments[sc_tmp], args);
      }
      var stmp;
      var g1361;
      var g1364;
      var g1362;
      var g1363;
      var mask;
      g1361 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", const_hop_exception, "");
      mask = g1361;
      g1363 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", "overflow: auto", args);
      stmp = g1363;
      g1362 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_23z00_hop_exception, stmp);
      g1364 = sc_arity_check(dom_create, 3)("div", mask, g1362);
      sc_arity_check(hop_add_event_listener, 3)(g1364, "click", (sc_tmp = function(event) {
            var g1365;
            in_exception_report_hop_exception = "\uEBACno";
            g1365 = this.parentNode.removeChild(this);
            if (g1365 !== false) {
              false;
            } else {
              sc_arity_check(hop_stop_propagation, 2)(event, false);
            }
            return g1365;
          }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
      return g1364;
    }, sc_tmp.name = "<EXCEPTION-FRAME>", sc_tmp.location = "(at hop-exception.scm 10996)", sc_tmp.sc_arity = -1, sc_tmp;
sc_tmp = BgL_sc_objzd2ze3string_1z31_hop_exception = function(o, longp) {
      var stmp;
      var g1369;
      var g1371;
      var m;
      var name;
      var g1367;
      if (typeof o === 'function') {
        if (!sc_arity_check(sc_isString, 1)(o.name)) {
          name = sc_arity_check(sc_withOutputToString, 1)((sc_tmp = function() {
                  return sc_arity_check(sc_write, 1)(o);
                }, sc_tmp.name = "", sc_tmp.location = "(at hop-exception.scm 11706)", sc_tmp.sc_arity = 0, sc_tmp));
        } else {
          if (o.name.length > 0) {
            name = o.name;
          } else {
            g1367 = sc_arity_check(dom_create, 2)("i", "anonymous");
            name = g1367;
          }
        }
        if (longp && sc_arity_check(sc_isString, 1)(o.location)) {
          m = sc_arity_check(sc_pregexpMatch, 2)(BgL_sc_const_12z00_hop_exception, o.location);
          if (m !== false) {
            g1371 = sc_arity_check(dom_create, 8)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", m.cdr.car, m.cdr.car, "!", m.cdr.cdr.car);
            stmp = g1371;
            g1369 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp, ", ");
            return sc_arity_check(sc_list, 4)(g1369, "(", name, " ...)");
          } else {
            return sc_arity_check(sc_list, 3)("(", name, " ...)");
          }
        } else {
          if (longp !== false) {
            return sc_arity_check(sc_list, 3)("(", name, " ...)");
          } else {
            return name;
          }
        }
      } else {
        if (sc_arity_check(sc_isString, 1)(o)) {
          return o;
        } else {
          return sc_arity_check(sc_withOutputToString, 1)((sc_tmp = function() {
                      return sc_arity_check(sc_write, 1)(o);
                    }, sc_tmp.name = "", sc_tmp.location = "(at hop-exception.scm 12279)", sc_tmp.sc_arity = 0, sc_tmp));
        }
      }
    }, sc_tmp.name = "obj->string", sc_tmp.location = "(at hop-exception.scm 11544)", sc_tmp.sc_arity = 2, sc_tmp;
sc_tmp = hop_make_exception_stack = function(stack) {
      var stmp;
      var stmp_3;
      var stmp_4;
      var stmp_5;
      var frame;
      var tail1432;
      var L1428;
      var falseHead1431;
      var g1375;
      var g1373;
      var g1372;
      falseHead1431 = new sc_Pair(null, null);
      tail1432 = falseHead1431;
      L1428 = stack;
      while (!(L1428 === null)) {
        frame = L1428.car;
        stmp_4 = new sc_Pair(sc_arity_check(sc_list, 2)(sc_arity_check(BgL_sc_objzd2ze3string_1z31_hop_exception, 2)(frame.car, true), "\n"), null);
        tail1432.cdr = stmp_4;
        tail1432 = tail1432.cdr;
        L1428 = L1428.cdr;
      }
      stmp_3 = falseHead1431.cdr;
      g1375 = sc_arity_check(dom_create, 4)("pre", "\uEBADstyle", BgL_sc_const_11z00_hop_exception, stmp_3);
      sc_arity_check(hop_add_event_listener, 3)(g1375, "click", (sc_tmp = function(event) {
            var g1376;
            g1376 = sc_arity_check(hop_stop_propagation, 1)(event);
            if (g1376 !== false) {
              false;
            } else {
              sc_arity_check(hop_stop_propagation, 2)(event, false);
            }
            return g1376;
          }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
      stmp = g1375;
      g1373 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_10z00_hop_exception, BgL_sc_const_17z00_hop_exception);
      stmp_5 = g1373;
      g1372 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_21z00_hop_exception, stmp_5, stmp);
      return g1372;
    }, sc_tmp.name = "<EXCEPTION-STACK>", sc_tmp.location = "(at hop-exception.scm 12516)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_report_exception = function(exc) {
      var stmp;
      var stmp_6;
      var stmp_7;
      var stmp_8;
      var stmp_9;
      var stmp_10;
      var stmp_11;
      var stmp_12;
      var stmp_13;
      var stmp_14;
      var stmp_15;
      var stmp_16;
      var stmp_17;
      var stmp_18;
      var stmp_19;
      var stmp_20;
      var stmp_21;
      var stmp_22;
      var stmp_23;
      var stmp_24;
      var stmp_25;
      var stmp_26;
      var stmp_27;
      var stmp_28;
      var stmp_29;
      var stmp_30;
      var stmp_31;
      var stmp_32;
      var stmp_33;
      var stmp_34;
      var stmp_35;
      var stmp_36;
      var stmp_37;
      var stmp_38;
      var stmp_39;
      var stmp_40;
      var stmp_41;
      var stmp_42;
      var stmp_43;
      var stmp_44;
      var stmp_45;
      var g1379;
      var g1380;
      var m;
      var g1377;
      var g1378;
      var href;
      var l;
      var i;
      var f;
      var tail1437;
      var L1433;
      var falseHead1436;
      var g1384;
      var g1383;
      var g1382;
      var l_46;
      var s;
      var s_47;
      var tail1447;
      var L1443;
      var s_48;
      var tail1442;
      var L1438;
      var g1415;
      var g1422;
      var g1381;
      var stack;
      var tmp1423;
      var g1421;
      var g1416;
      var g1418;
      var g1419;
      var g1420;
      var g1417;
      var g1392;
      var g1398;
      var g1403;
      var g1404;
      var g1413;
      var g1414;
      var g1411;
      var g1412;
      var g1408;
      var g1409;
      var g1410;
      var g1405;
      var g1406;
      var g1407;
      var g1400;
      var g1402;
      var g1394;
      var g1396;
      var src;
      var g1390;
      var g1389;
      var g1388;
      var location;
      var url;
      var name;
      var msg;
      var g1387;
      var message;
      var L1443_49;
      var falseHead1446;
      var L1438_50;
      var falseHead1441;
      var e;
      var e_51;
      var e_52;
      var tmp1424;
      if (in_exception_report_hop_exception === "\uEBACyes") {
        return sc_arity_check(sc_raise, 1)(exc);
      } else {
        if (document.body && !(document.body === null)) {
          in_exception_report_hop_exception = "\uEBACyes";
          tmp1424 = exc === false;
          if ((tmp1424 !== false? tmp1424: exc === undefined) !== false) {
            e_52 = new Error();
            e_52.message = "unknown error";
            e = e_52;
          } else {
            if (sc_arity_check(sc_isString, 1)(exc)) {
              e_51 = new Error();
              e_51.message = exc;
              e = e_51;
            } else {
              e = exc;
            }
          }
          if (!("message" in e)) {
            message = "unknwown error";
          } else {
            if (sc_arity_check(sc_isString, 1)(e.message)) {
              falseHead1441 = new sc_Pair(null, null);
              L1438_50 = sc_arity_check(sc_stringSplit, 2)(e.message, "\n ");
              tail1442 = falseHead1441;
              L1438 = L1438_50;
              while (!(L1438 === null)) {
                s_48 = L1438.car;
                stmp_45 = new sc_Pair(sc_arity_check(hop_demangle, 1)(s_48) + " ", null);
                tail1442.cdr = stmp_45;
                tail1442 = tail1442.cdr;
                L1438 = L1438.cdr;
              }
              stmp_44 = falseHead1441.cdr;
              message = sc_arity_check(sc_apply, 2)(sc_stringAppend, stmp_44);
            } else {
              if (sc_arity_check(sc_isSymbol, 1)(e.message)) {
                message = e.message.slice(1);
              } else {
                if (sc_arity_check(sc_isKeyword, 1)(e.message)) {
                  message = e.message.slice(1);
                } else {
                  if (sc_arity_check(sc_isNumber, 1)(e.message)) {
                    message = e.message;
                  } else {
                    if (!(e.message === undefined)) {
                      message = sc_arity_check(BgL_sc_objzd2ze3string_1z31_hop_exception, 2)(e.message, false);
                    } else {
                      if (sc_arity_check(sc_isString, 1)(e.description)) {
                        falseHead1446 = new sc_Pair(null, null);
                        L1443_49 = sc_arity_check(sc_stringSplit, 2)(e.description, "\n ");
                        tail1447 = falseHead1446;
                        L1443 = L1443_49;
                        while (!(L1443 === null)) {
                          s_47 = L1443.car;
                          stmp_43 = new sc_Pair(sc_arity_check(hop_demangle, 1)(s_47) + " ", null);
                          tail1447.cdr = stmp_43;
                          tail1447 = tail1447.cdr;
                          L1443 = L1443.cdr;
                        }
                        stmp_42 = falseHead1446.cdr;
                        message = sc_arity_check(sc_apply, 2)(sc_stringAppend, stmp_42);
                      } else {
                        message = "unknwown error";
                      }
                    }
                  }
                }
              }
            }
          }
          if (e && "scObject" in e) {
            g1387 = sc_arity_check(dom_create, 2)("tt", sc_arity_check(BgL_sc_objzd2ze3string_1z31_hop_exception, 2)(e.scObject, false));
            stmp_41 = g1387;
            msg = sc_arity_check(sc_list, 3)(message, " -- ", stmp_41);
          } else {
            msg = message;
          }
          if (sc_arity_check(sc_isString, 1)(e.name)) {
            name = e.name;
          } else {
            if (e.name === undefined) {
              name = BgL_sc_const_24z00_hop_exception;
            } else {
              name = sc_arity_check(BgL_sc_objzd2ze3string_1z31_hop_exception, 2)(e.name, false);
            }
          }
          if (sc_arity_check(sc_isString, 1)(e.fileName)) {
            url = e.fileName;
          } else {
            url = document.location.href;
          }
          if (sc_arity_check(sc_isString, 1)(e.hopLocation)) {
            location = e.hopLocation;
          } else {
            location = "Client Error";
          }
          if (e.lineNumber && !(e.lineNumber === undefined)) {
            g1388 = sc_arity_check(dom_create, 4)("a", "\uEBADhref", url, url);
            src = sc_arity_check(sc_list, 3)(g1388, ", line ", e.lineNumber);
          } else {
            if (e.line && !(e.line === undefined)) {
              g1389 = sc_arity_check(dom_create, 4)("a", "\uEBADhref", url, url);
              src = sc_arity_check(sc_list, 3)(g1389, ", line ", e.line);
            } else {
              g1390 = sc_arity_check(dom_create, 3)("a", "\uEBADhref", url);
              src = g1390;
            }
          }
          if (sc_arity_check(sc_isString, 1)(e.stack)) {
            stack = e.stack;
            g1381 = sc_arity_check(sc_stringSplit, 2)(stack, "\n");
            BgL_whilezd2break1495zd2: {
              l_46 = g1381;
              s = 2;
              while (!(l_46 === null)) {
                if (s === 0) {
                  falseHead1436 = new sc_Pair(null, null);
                  tail1437 = falseHead1436;
                  L1433 = l_46;
                  while (!(L1433 === null)) {
                    f = L1433.car;
                    i = sc_arity_check(sc_stringIndex, 2)(f, new sc_Char("@"));
                    l = f.length;
                    if (i !== false) {
                      href = f.substring(i + 1, l);
                      g1378 = sc_arity_check(dom_create, 6)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", href, href);
                      stmp_14 = g1378;
                      g1377 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp_14, ", ");
                      stmp_12 = sc_arity_check(sc_list, 3)(g1377, f.substring(0, i), "\n");
                    } else {
                      m = sc_arity_check(sc_pregexpMatch, 2)(BgL_sc_const_4z00_hop_exception, f);
                      if (m !== false) {
                        g1380 = sc_arity_check(dom_create, 9)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", m.cdr.cdr.car, m.cdr.car, "!", m.cdr.cdr.car, m.cdr.cdr.cdr.car);
                        stmp_13 = g1380;
                        g1379 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp_13, ", ");
                        stmp_12 = sc_arity_check(sc_list, 4)(g1379, "(", m.cdr.car, " ...)\n");
                      } else {
                        stmp_12 = sc_arity_check(sc_list, 2)(f, "\n");
                      }
                    }
                    stmp_11 = new sc_Pair(stmp_12, null);
                    tail1437.cdr = stmp_11;
                    tail1437 = tail1437.cdr;
                    L1433 = L1433.cdr;
                  }
                  stmp_10 = falseHead1436.cdr;
                  g1384 = sc_arity_check(dom_create, 4)("pre", "\uEBADstyle", BgL_sc_const_5z00_hop_exception, stmp_10);
                  sc_arity_check(hop_add_event_listener, 3)(g1384, "click", (sc_tmp = function(event) {
                        var g1385;
                        g1385 = sc_arity_check(hop_stop_propagation, 1)(event);
                        if (g1385 !== false) {
                          false;
                        } else {
                          sc_arity_check(hop_stop_propagation, 2)(event, false);
                        }
                        return g1385;
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
                  stmp_9 = g1384;
                  g1383 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_7z00_hop_exception, BgL_sc_const_16z00_hop_exception);
                  stmp_15 = g1383;
                  g1382 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_21z00_hop_exception, stmp_15, stmp_9);
                  {
                    stmp_8 = g1382;
                    break BgL_whilezd2break1495zd2;
                  }
                } else {
                  l_46 = l_46.cdr;
                  --s;
                }
              }
              stmp_8 = "";
            }
            if (e.hopService !== false) {
              tmp1423 = !(e.hopService === undefined);
            } else {
              tmp1423 = false;
            }
            if ((tmp1423 !== false? tmp1423: e.hopStack instanceof sc_Pair) !== false) {
              stmp_16 = BgL_sc_const_9z00_hop_exception;
            } else {
              stmp_16 = "margin-top: 2ex";
            }
            g1422 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", stmp_16, stmp_8);
            stmp_7 = g1422;
          } else {
            stmp_7 = false;
          }
          if (e.hopStack instanceof sc_Pair) {
            g1421 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", e.hopService && !(e.hopService === undefined)? BgL_sc_const_9z00_hop_exception: "margin-top: 2ex", sc_arity_check(hop_make_exception_stack, 1)(e.hopStack));
            stmp_18 = g1421;
          } else {
            stmp_18 = false;
          }
          if (e.hopService && !(e.hopService === undefined)) {
            g1420 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", "font-size: 10pt", sc_arity_check(BgL_sc_objzd2ze3string_1z31_hop_exception, 2)(e.hopService, false));
            stmp_22 = g1420;
            g1419 = sc_arity_check(dom_create, 2)("tr", stmp_22);
            stmp_21 = g1419;
            g1418 = sc_arity_check(dom_create, 4)("table", "\uEBADstyle", BgL_sc_const_13z00_hop_exception, stmp_21);
            stmp_20 = g1418;
            g1417 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_7z00_hop_exception, "Service:");
            stmp_23 = g1417;
            g1416 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_21z00_hop_exception, stmp_23, stmp_20);
            stmp_19 = g1416;
          } else {
            stmp_19 = false;
          }
          g1415 = sc_arity_check(dom_create, 6)("div", "\uEBADstyle", BgL_sc_const_2z00_hop_exception, stmp_19, stmp_18, stmp_7);
          stmp_6 = g1415;
          g1414 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_3z00_hop_exception, sc_arity_check(hop_properties_to_string, 1)(e));
          stmp_28 = g1414;
          g1413 = sc_arity_check(dom_create, 2)("tr", stmp_28);
          stmp_27 = g1413;
          g1412 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_19z00_hop_exception, src);
          stmp_30 = g1412;
          g1411 = sc_arity_check(dom_create, 2)("tr", stmp_30);
          stmp_29 = g1411;
          g1410 = sc_arity_check(dom_create, 4)("span", "\uEBADstyle", BgL_sc_const_22z00_hop_exception, name);
          stmp_33 = g1410;
          g1409 = sc_arity_check(dom_create, 6)("td", "\uEBADstyle", "font-size: 11pt", stmp_33, ": ", msg);
          stmp_32 = g1409;
          g1408 = sc_arity_check(dom_create, 2)("tr", stmp_32);
          stmp_31 = g1408;
          g1407 = sc_arity_check(dom_create, 4)("span", "\uEBADstyle", BgL_sc_const_8z00_hop_exception, location);
          stmp_36 = g1407;
          g1406 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_15z00_hop_exception, stmp_36);
          stmp_35 = g1406;
          g1405 = sc_arity_check(dom_create, 2)("tr", stmp_35);
          stmp_34 = g1405;
          g1404 = sc_arity_check(dom_create, 7)("table", "\uEBADstyle", "width: 100%", stmp_34, stmp_31, stmp_29, stmp_27);
          stmp_26 = g1404;
          g1403 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_14z00_hop_exception, stmp_26);
          stmp_25 = g1403;
          g1402 = sc_arity_check(dom_create, 5)("img", "\uEBADsrc", BgL_sc_const_6z00_hop_exception, "\uEBADalt", "Error");
          stmp_38 = g1402;
          g1400 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_20z00_hop_exception, stmp_38);
          stmp_37 = g1400;
          g1398 = sc_arity_check(dom_create, 3)("tr", stmp_37, stmp_25);
          stmp_24 = g1398;
          g1396 = sc_arity_check(dom_create, 3)("col", "\uEBADwidth", "64px");
          stmp_40 = g1396;
          g1394 = sc_arity_check(dom_create, 2)("colgroup", stmp_40);
          stmp_39 = g1394;
          g1392 = sc_arity_check(dom_create, 5)("table", "\uEBADstyle", BgL_sc_const_18z00_hop_exception, stmp_39, stmp_24);
          stmp = sc_arity_check(hop_make_exception_frame, 2)(g1392, stmp_6);
          return sc_arity_check(dom_append_child, 2)(document.body, stmp);
        } else {
          return sc_arity_check(hop_add_event_listener, 3)(window, "load", (sc_tmp = function(e) {
                      return sc_arity_check(hop_report_exception, 1)(exc);
                    }, sc_tmp.name = "", sc_tmp.location = "(at hop-exception.scm 18933)", sc_tmp.sc_arity = 1, sc_tmp));
        }
      }
    }, sc_tmp.name = "hop-report-exception", sc_tmp.location = "(at hop-exception.scm 18188)", sc_tmp.sc_arity = 1, sc_tmp;
hop_last_exception_hop_exception = false;
sc_tmp = hop_onerror_handler_hop_exception = function(msg, url, line) {
      var tmp1427;
      var i;
      var g1426;
      var exc;
      var exc_53;
      var tmp1425;
      g1426 = hop_config.filtered_errors.length - 1;
      BgL_whilezd2break1496zd2: {
        i = g1426;
        while (i >= 0) {
          tmp1427 = url === hop_config.filtered_errors[i];
          if (tmp1427 !== false) {
            {
              tmp1425 = tmp1427;
              break BgL_whilezd2break1496zd2;
            }
          } else {
            --i;
          }
        }
        tmp1425 = false;
      }
      if (tmp1425 !== false) {
        return tmp1425;
      } else {
        if (hop_last_exception_hop_exception && hop_last_exception_hop_exception.message === msg) {
          exc = hop_last_exception_hop_exception;
        } else {
          exc_53 = new Error();
          exc_53.message = msg;
          exc_53.fileName = url;
          exc_53.lineNumber = line;
          exc_53.hopStack = sc_arity_check(hop_get_stack, 1)(2);
          exc = exc_53;
        }
        sc_arity_check(hop_report_exception, 1)(exc);
        return sc_arity_check(hop_debug, 0)() < 2;
      }
    }, sc_tmp.name = "hop-onerror-handler", sc_tmp.location = "(at hop-exception.scm 19954)", sc_tmp.sc_arity = 3, sc_tmp;
if (sc_arity_check(hop_debug, 0)() > 0) {
  sc_arity_check(sc_errorHookSet, 1)((sc_tmp = function(exc, _) {
        hop_last_exception_hop_exception = exc;
        exc.hopStack = sc_arity_check(hop_get_stack, 1)(3);
        return exc;
      }, sc_tmp.name = "", sc_tmp.location = "(at hop-exception.scm 20796)", sc_tmp.sc_arity = 2, sc_tmp));
  window.onerror = hop_onerror_handler_hop_exception;
}
/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/share/hop-dom.js                  */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Sat May  6 14:10:27 2006                          */
/*    Last change :  Tue Jul  6 11:27:59 2010 (serrano)                */
/*    Copyright   :  2006-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    The DOM component of the HOP runtime library.                    */
/*    -------------------------------------------------------------    */
/*    This assumes that hop-autoconf is already loaded.                */
/*=====================================================================*/

/*** META ((export document) (JS document)) */
/*** META ((export window) (JS window)) */
/*** META ((export hop_create_lframe) (JS hop_create_lframe)) */
/*** META ((export hop_create_lflabel) (JS hop_create_lflabel)) */
/*** META ((export Image) (JS Image)) */

/*---------------------------------------------------------------------*/
/*    dom_add_child ...                                                */
/*---------------------------------------------------------------------*/
function dom_add_child( node, e ) {
   if( hop_is_html_element( e ) ) {
      /* we no longer need to clone a node, even if it is already  */
      /* in the document because the server side implementation    */
      /* of dom-add-child checks if the node is already in the     */
      /* same tree and if it is, it removes it removes it first    */
      node.appendChild( e );
   } else {
      if( (e instanceof String) ||
	  (typeof e == "string") ||
	  (typeof e == "number") ) {
	 node.appendChild( document.createTextNode( e ) );
      } else {
	 if( sc_isPair( e ) ) {
	    dom_add_child( node, e.car );
	    dom_add_child( node, e.cdr );
	 } else {
	    if( e ) {
	       sc_error( "dom_add_child", "illegal child node", e );
	    }
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    dom_set_child_node ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export dom-set-child-node!) (arity #t)) */
function dom_set_child_node( parent, node ) {
   var childs = parent.childNodes;

   for( var nc = childs.length - 1; nc >= 0; nc-- )
      parent.removeChild( childs[ nc ] );

   dom_add_child( parent, node );
   return node;
}

/*---------------------------------------------------------------------*/
/*    dom_node_elementp ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-element?)
           (peephole (postfix ".nodeType == 1"))
           (arity #t))
*/
function dom_node_elementp( node ) {
   return node.nodeType == 1;
}

/*---------------------------------------------------------------------*/
/*    dom_node_textp ...                                               */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-text?)
           (peephole (postfix ".nodeType == 3"))
           (arity #t))
*/
function dom_node_textp( node ) {
   return node.nodeType == 3;
}

/*---------------------------------------------------------------------*/
/*    dom_node_documentp ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-document?)
           (peephole (postfix ".nodeType == 9"))
           (arity #t))
*/
function dom_node_documentp( node ) {
   return node.nodeType == 9;
}

/*---------------------------------------------------------------------*/
/*    dom_node_commentp ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-comment?)
           (peephole (postfix ".nodeType == 8"))
           (arity #t))
*/
function dom_node_commentp( node ) {
   return node.nodeType == 8;
}

/*---------------------------------------------------------------------*/
/*    dom_node_document_fragmentp ...                                  */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-document-fragment?)
           (peephole (postfix ".nodeType == 11"))
           (arity #t))
*/
function dom_node_document_fragmentp( node ) {
   return node.nodeType == 11;
}

/*---------------------------------------------------------------------*/
/*    dom_node_document_attrp ...                                      */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-attr?)
           (peephole (postfix ".nodeType == 2"))
           (arity #t))
*/
function dom_node_document_attrp( node ) {
   return node.nodeType == 2;
}

/*---------------------------------------------------------------------*/
/*    dom_create ...                                                   */
/*---------------------------------------------------------------------*/
function dom_create( tag, _ ) {
   var el = document.createElement( tag );
   var l = arguments.length;
   var i = 1;

   while( i < l ) {
      var k = arguments[ i ];

      if( sc_isKeyword( k ) ) {
	 if( i < (l - 1) ) {
	    var at = arguments[ i + 1 ];
	    var prop = sc_keyword2jsstring( k );

	    if( prop === "class" ) {
	       el.className = at;
	    } else if( prop === "style" ) {
	       if( hop_config.navigator_family === "msie" ) {
		  el.style.setAttribute( "cssText", at );
	       } else {
		  el.setAttribute( prop, at );
	       }
	    } else {
	       if( (at instanceof String) || (typeof at == "string") ) {
		  if( sc_isSymbol( at ) ) {
		     el.setAttribute( prop, sc_symbol2jsstring( at ) );
		  } else {
		     el.setAttribute( prop, at );
		  }
	       } else {
		  el.setAttribute( prop, at + "" );
		  try {
		     el[ prop ] = at;
		  } catch( _ ) { ; }
	       }
	    }
	    i += 2;
	 } else {
	    var prop = sc_keyword2jsstring( k );
	    el.setAttribute( prop, prop );
	    i++;
	 }
      } else {
	 dom_add_child( el, k );
	 i++;
      }
   }

   return el;
}

/*---------------------------------------------------------------------*/
/*    hop_dom_create_msie_radio ...                                    */
/*    -------------------------------------------------------------    */
/*    MSIE input names are immutable! That is, they cannot be set      */
/*    as other attributes.                                             */
/*---------------------------------------------------------------------*/
function hop_dom_create_msie_radio( name, _ ) {
   arguments[ 0 ] = "<INPUT name='" + name + "'>";
   return dom_create.apply( null, arguments );
}

/*---------------------------------------------------------------------*/
/*    hop_dom_create_custom                                            */
/*---------------------------------------------------------------------*/
/*** META (define-macro (hop_dom_create_custom kons . args)
	     (let loop ((args args)
			(attrs '())
			(body '())
			(listeners '()))
		(cond
		   ((null? args)
		    (let ((v (gensym)))
		       `(let ((,v (,kons (list ,@(reverse! attrs))
		                         (list ,@(reverse! body)))))
			   ,@(map (lambda (listener)
				     `(add-event-listener! ,v ,@listener))
				  listeners)
			   ,v)))
		   ((or (null? (cdr args)) (not (keyword? (car args))))
		    (loop (cdr args) attrs (cons (car args) body) listeners))
		   ((string-prefix? "on" (keyword->string (car args)))
		    (let ((s (keyword->string (car args)))
		          (tmp (gensym)))
		       (loop (cddr args)
			     attrs
			     body
			     (cons (list (substring s 2 (string-length s))
					 `(lambda (event)
					     (let ((,tmp ,(cadr args)))
					        (unless ,tmp
						   (stop-event-propagation event #f))
					       ,tmp)))
				   listeners))))
		   (else
		    (loop (cddr args)
			  (cons* (cadr args) (car args) attrs)
			  body
			  listeners))))) */

/*---------------------------------------------------------------------*/
/*    hop_dom_create                                                   */
/*---------------------------------------------------------------------*/
/*** META (define-macro (hop_dom_create tag . args)
	     (let loop ((args args)
			(attrs '())
			(listeners '()))
		(cond
		   ((null? args)
		    (let ((v (gensym)))
		       `(let ((,v ((@ dom_create _) ,tag ,@(reverse! attrs))))
			   ,@(map (lambda (listener)
				     `(add-event-listener! ,v ,@listener))
				  listeners)
			   ,v)))
		   ((or (null? (cdr args)) (not (keyword? (car args))))
		    (loop (cdr args) (cons (car args) attrs) listeners))
		   ((string-prefix? "on" (keyword->string (car args)))
		    (let ((s (keyword->string (car args)))
   		          (tmp (gensym)))
		       (loop (cddr args)
			     attrs
			     (cons (list (substring s 2 (string-length s))
					 `(lambda (event)
					    (let ((,tmp ,(cadr args)))
					        (unless ,tmp
						   (stop-event-propagation event #f))
						   ,tmp)))
				   listeners))))
		   (else
		    (loop (cddr args)
			  (cons* (cadr args) (car args) attrs)
			  listeners))))) */

/*---------------------------------------------------------------------*/
/*    dom_add_head_script ...                                          */
/*---------------------------------------------------------------------*/
function dom_add_head_script( pathname, id ) {
   var head = document.getElementsByTagName( "head" )[ 0 ];
   var script = document.createElement( 'script' );

   script.type = 'text/javascript';
   script.src = pathname;
   
   if( id != undefined ) script.id = id;
   
   head.appendChild( script );
}

/*---------------------------------------------------------------------*/
/*    hop_create_lframe ...                                            */
/*---------------------------------------------------------------------*/
function hop_create_lframe( attrs, body ) {
   var hc = sc_jsstring2keyword( "hssclass" );
   var bd = dom_create( "div", hc, "hop-lfborder", body );
   return dom_create( "div", hc, "hop-lframe", bd );
}

/*---------------------------------------------------------------------*/
/*    hop_create_lflabel ...                                           */
/*---------------------------------------------------------------------*/
function hop_create_lflabel( attrs, body ) {
   var hc = sc_jsstring2keyword( "hssclass" );
   var ct = dom_create( "span", body );
   return dom_create( "div", hc, "hop-lflabel", ct );
}

/*---------------------------------------------------------------------*/
/*    DOM creator interface ...                                        */
/*---------------------------------------------------------------------*/
/*** META (define-macro (<A> . args)
     `(hop_dom_create "a" ,@args)) */

/*** META (define-macro (<ABBR> . args)
     `(hop_dom_create "abbr" ,@args)) */

/*** META (define-macro (<ACRONYM> . args)
     `(hop_dom_create "acronym" ,@args)) */

/*** META (define-macro (<APPLET> . args)
     `(hop_dom_create "applet" ,@args)) */

/*** META (define-macro (<AREA> . args)
     `(hop_dom_create "area" ,@args)) */

/*** META (define-macro (<B> . args)
     `(hop_dom_create "b" ,@args)) */

/*** META (define-macro (<BASE> . args)
     `(hop_dom_create "base" ,@args)) */

/*** META (define-macro (<BASEFONT> . args)
     `(hop_dom_create "basefont" ,@args)) */

/*** META (define-macro (<BDO> . args)
     `(hop_dom_create "bdo" ,@args)) */

/*** META (define-macro (<BIG> . args)
     `(hop_dom_create "big" ,@args)) */

/*** META (define-macro (<BLOCKQUOTE> . args)
     `(hop_dom_create "blockquote" ,@args)) */

/*** META (define-macro (<BODY> . args)
     `(hop_dom_create "body" ,@args)) */

/*** META (define-macro (<BR> . args)
     `(hop_dom_create "br" ,@args)) */

/*** META (define-macro (<BUTTON> . args)
     `(hop_dom_create "button" ,@args)) */

/*** META (define-macro (<CANVAS> . args)
     `(hop_dom_create "canvas" ,@args)) */

/*** META (define-macro (<CAPTION> . args)
     `(hop_dom_create "caption" ,@args)) */

/*** META (define-macro (<CENTER> . args)
     `(hop_dom_create "center" ,@args)) */

/*** META (define-macro (<CITE> . args)
     `(hop_dom_create "cite" ,@args)) */

/*** META (define-macro (<CODE> . args)
     `(hop_dom_create "code" ,@args)) */

/*** META (define-macro (<COL> . args)
     `(hop_dom_create "col" ,@args)) */

/*** META (define-macro (<COLGROUP> . args)
     `(hop_dom_create "colgroup" ,@args)) */

/*** META (define-macro (<DD> . args)
     `(hop_dom_create "dd" ,@args)) */

/*** META (define-macro (<DEL> . args)
     `(hop_dom_create "del" ,@args)) */

/*** META (define-macro (<DFN> . args)
     `(hop_dom_create "dfn" ,@args)) */

/*** META (define-macro (<DIR> . args)
     `(hop_dom_create "dir" ,@args)) */

/*** META (define-macro (<DIV> . args)
     `(hop_dom_create "div" ,@args)) */

/*** META (define-macro (<DL> . args)
     `(hop_dom_create "dl" ,@args)) */

/*** META (define-macro (<DT> . args)
     `(hop_dom_create "dt" ,@args)) */

/*** META (define-macro (<EM> . args)
     `(hop_dom_create "em" ,@args)) */

/*** META (define-macro (<FIELDSET> . args)
     `(hop_dom_create "fieldset" ,@args)) */

/*** META (define-macro (<FONT> . args)
     `(hop_dom_create "font" ,@args)) */

/*** META (define-macro (<FORM> . args)
     `(hop_dom_create "form" ,@args)) */

/*** META (define-macro (<FRAME> . args)
     `(hop_dom_create "frame" ,@args)) */

/*** META (define-macro (<FRAMESET> . args)
     `(hop_dom_create "frameset" ,@args)) */

/*** META (define-macro (<H1> . args)
     `(hop_dom_create "h1" ,@args)) */

/*** META (define-macro (<H2> . args)
     `(hop_dom_create "h2" ,@args)) */

/*** META (define-macro (<H3> . args)
     `(hop_dom_create "h3" ,@args)) */

/*** META (define-macro (<H4> . args)
     `(hop_dom_create "h4" ,@args)) */

/*** META (define-macro (<H5> . args)
     `(hop_dom_create "h5" ,@args)) */

/*** META (define-macro (<H6> . args)
     `(hop_dom_create "h6" ,@args)) */

/*** META (define-macro (<HR> . args)
     `(hop_dom_create "hr" ,@args)) */

/*** META (define-macro (<HTML> . args)
     `(hop_dom_create "html" ,@args)) */

/*** META (define-macro (<I> . args)
     `(hop_dom_create "i" ,@args)) */

/*** META (define-macro (<IFRAME> . args)
     `(hop_dom_create "iframe" ,@args)) */

/*** META (define-macro (<INPUT> . args)
     (let ((k (memq :type args)))
         (if (and (pair? k) (pair? (cdr k)))
	     (cond
	        ((or (equal? (cadr k) '(quote url)) (equal? (cadr k) "url"))
	         `(hop_dom_create "input" :onkeydown (hop_inputurl_keydown this event)
      		                  ,@args))
	        ((or (equal? (cadr k) '(quote radio)) (equal? (cadr k) "radio"))
		 (let ((n (memq :name args)))
		    (if (and (pair? n) (pair? (cdr n)))
			`(if (string=? hop_config.navigator_family "msie")
			     (hop_dom_create_msie_radio ,(cadr n) ,@args)
			     (hop_dom_create "input" ,@args))
			`(hop_dom_create "input" ,@args))))
		(else
		 `(hop_dom_create "input" ,@args)))
	     `(hop_dom_create "input" ,@args)))) )*/

/*** META (define-macro (<INS> . args)
     `(hop_dom_create "ins" ,@args)) */

/*** META (define-macro (<ISINDEX> . args)
     `(hop_dom_create "isindex" ,@args)) */

/*** META (define-macro (<KBD> . args)
     `(hop_dom_create "kbd" ,@args)) */

/*** META (define-macro (<LABEL> . args)
     `(hop_dom_create "label" ,@args)) */

/*** META (define-macro (<LEGEND> . args)
     `(hop_dom_create "legend" ,@args)) */

/*** META (define-macro (<LI> . args)
     `(hop_dom_create "li" ,@args)) */

/*** META (define-macro (<LINK> . args)
     `(hop_dom_create "link" ,@args)) */

/*** META (define-macro (<MAP> . args)
     `(hop_dom_create "map" ,@args)) */

/*** META (define-macro (<MARQUEE> . args)
     `(hop_dom_create "marquee" ,@args)) */

/*** META (define-macro (<MENU> . args)
     `(hop_dom_create "menu" ,@args)) */

/*** META (define-macro (<META> . args)
     `(hop_dom_create "meta" ,@args)) */

/*** META (define-macro (<NOFRAMES> . args)
     `(hop_dom_create "noframes" ,@args)) */

/*** META (define-macro (<NOSCRIPT> . args)
     `(hop_dom_create "noscript" ,@args)) */

/*** META (define-macro (<OBJECT> . args)
     `(hop_dom_create "object" ,@args)) */

/*** META (define-macro (<OL> . args)
     `(hop_dom_create "ol" ,@args)) */

/*** META (define-macro (<OPTGROUP> . args)
     `(hop_dom_create "optgroup" ,@args)) */

/*** META (define-macro (<OPTION> . args)
     `(hop_dom_create "option" ,@args)) */

/*** META (define-macro (<P> . args)
     `(hop_dom_create "p" ,@args)) */

/*** META (define-macro (<PARAM> . args)
     `(hop_dom_create "param" ,@args)) */

/*** META (define-macro (<PRE> . args)
     `(hop_dom_create "pre" ,@args)) */

/*** META (define-macro (<Q> . args)
     `(hop_dom_create "q" ,@args)) */

/*** META (define-macro (<S> . args)
     `(hop_dom_create "s" ,@args)) */

/*** META (define-macro (<SAMP> . args)
     `(hop_dom_create "samp" ,@args)) */

/*** META (define-macro (<SCRIPT> . args)
     `(hop_dom_create "script" ,@args)) */

/*** META (define-macro (<SELECT> . args)
     `(hop_dom_create "select" ,@args)) */

/*** META (define-macro (<SMALL> . args)
     `(hop_dom_create "small" ,@args)) */

/*** META (define-macro (<SPAN> . args)
     `(hop_dom_create "span" ,@args)) */

/*** META (define-macro (<STRIKE> . args)
     `(hop_dom_create "strike" ,@args)) */

/*** META (define-macro (<STRONG> . args)
     `(hop_dom_create "strong" ,@args)) */

/*** META (define-macro (<STYLE> . args)
     `(hop_dom_create "style" ,@args)) */

/*** META (define-macro (<SUB> . args)
     `(hop_dom_create "sub" ,@args)) */

/*** META (define-macro (<SUP> . args)
     `(hop_dom_create "sup" ,@args)) */

/*** META (define-macro (<TABLE> . args)
     `(hop_dom_create "table" ,@args)) */

/*** META (define-macro (<TBODY> . args)
     `(hop_dom_create "tbody" ,@args)) */

/*** META (define-macro (<TD> . args)
     `(hop_dom_create "td" ,@args)) */

/*** META (define-macro (<TEXTAREA> . args)
     `(hop_dom_create "textarea" ,@args)) */

/*** META (define-macro (<TFOOT> . args)
     `(hop_dom_create "tfoot" ,@args)) */

/*** META (define-macro (<TH> . args)
     `(hop_dom_create "th" ,@args)) */

/*** META (define-macro (<THEAD> . args)
     `(hop_dom_create "thead" ,@args)) */

/*** META (define-macro (<TITLE> . args)
     `(hop_dom_create "title" ,@args)) */

/*** META (define-macro (<TR> . args)
     `(hop_dom_create "tr" ,@args)) */

/*** META (define-macro (<TT> . args)
     `(hop_dom_create "tt" ,@args)) */

/*** META (define-macro (<U> . args)
     `(hop_dom_create "u" ,@args)) */

/*** META (define-macro (<UL> . args)
     `(hop_dom_create "ul" ,@args)) */

/*** META (define-macro (<VAR> . args)
     `(hop_dom_create "var" ,@args)) */

/*** META (define-macro (<IMG> . args)
     `(hop_dom_create "img" ,@args)) */

/*** META (define-macro (<HEAD> . args)
     `(hop_dom_create "head" ,@args)) */

/*** META (define-macro (<LFRAME> . args)
     `(hop_dom_create_custom hop_create_lframe ,@args)) */

/*** META (define-macro (<LFLABEL> . args)
     `(hop_dom_create_custom hop_create_lflabel ,@args)) */

/*** META (define-macro (<SPINBUTTON> . args)
     `(hop_dom_create_custom hop_create_spinbutton ,@args)) */

/*** META (define-macro (<GAUGE> . args)
     `(hop_dom_create_custom hop_create_gauge ,@args)) */

/*---------------------------------------------------------------------*/
/*    Server side constructors                                         */
/* --------------------------------------------------------------------*}
/*** META ((export <DELAY>)) */
function dom_create_delay() {
   return ( "*** Hop Error, `delay' can only be created on server" );
}
/*** META ((export <INLINE>)) */
function dom_create_inline() {
   return ( "*** Hop Error, `inline' can only be created on server" );
}
/*** META ((export <NOTEPAD>)) */
function dom_create_notepad() {
   return ( "*** Hop Error, `notepad' can only be created on server" );
}
/*** META ((export <NPHEAD>)) */
function dom_create_nphead() {
   return ( "*** Hop Error, `nphead' can only be created on server" );
}
/*** META ((export <NPTAB>)) */
function dom_create_nptab() {
   return ( "*** Hop Error, `nptab' can only be created on server" );
}
/*** META ((export <NPTABHEAD>)) */
function dom_create_nptabhead() {
   return ( "*** Hop Error, `nptabhead' can only be created on server" );
}
/*** META ((export <PAN>)) */
function dom_create_pan() {
   return ( "*** Hop Error, `pan' can only be created on server" );
}
/*** META ((export <PANED>)) */
function dom_create_paned() {
   return ( "*** Hop Error, `paned' can only be created on server" );
}
/*** META ((export <SLIDER>)) */
function dom_create_slider() {
   return ( "*** Hop Error, `slider' can only be created on server" );
}
/*** META ((export <SORTTABLE>)) */
function dom_create_sorttable() {
   return ( "*** Hop Error, `sorttable' can only be created on server" );
}

/*---------------------------------------------------------------------*/
/*    DOM functional interface ...                                     */
/*---------------------------------------------------------------------*/
/*** META ((export dom-has-attributes?)
           (arity #t)
           (type bool)
           (peephole (postfix ".hasAttributes()")))
*/
function dom_has_attributes( node ) {
   return node.hasAttributes();
}
/*** META ((export #t)
           (arity #t)
           (peephole (hole 1 "sc_vector2list(" node ".getAttributes())")))
*/
function dom_get_attributes( node ) {
   return sc_vector2list( node.getAttributes() );
}
/*** META ((export dom-has-attribute?)
           (arity #t)
           (type bool)
           (peephole (hole 2 node ".hasAttribute(" string ")")))
*/
function dom_has_attribute( node, string ) {
   return node.hasAttribute( string );
}
/*** META ((export #t)
           (arity #t)
           (peephole (hole 2 node ".getAttribute(" string ")")))
*/
function dom_get_attribute( node, string ) {
   return node.getAttribute( string );
}
/*** META ((export dom-remove-attribute!)
           (arity #t)
           (peephole (hole 2 node ".removeAttribute(" string ")")))
*/
function dom_remove_attribute( node, string ) {
   return node.removeAttribute( string );
}
/*** META ((export dom-set-attribute! dom-attribute-set!)
           (arity #t)
           (peephole (hole 3 node ".setAttribute(" string ", " value ")")))
*/
function dom_set_attribute( node, string, value ) {
   return node.setAttribute( string, value );
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".ownerDocument()")))
*/
function dom_owner_document( node ) {
   return node.ownerDocument();
}
/*** META ((export dom-has-child-nodes?)
           (arity #t)
           (type bool)
           (peephole (postfix ".hasChildNodes()")))
*/
function dom_has_child_nodes( node ) {
   return node.hasChildNodes();
}
/*** META ((export #t)
           (arity #t)
           (peephole (hole 1 "sc_vector2list(" node ".childNodes)")))
*/
function dom_child_nodes( node ) {
   return sc_vector2list( node.childNodes );
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".firstChild")))
*/
function dom_first_child( node ) {
   return node.firstChild;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".lastChild")))
*/
function dom_last_child( node ) {
   return node.lastChild;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".nextSibling")))
*/
function dom_next_sibling( node ) {
   return node.nextSibling;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".previousSibling")))
*/
function dom_previous_sibling( node ) {
   return node.previousSibling;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".nodeName")))
*/
function dom_node_name( node ) {
   return node.nodeName;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".nodeType")))
*/
function dom_node_type( node ) {
   return node.nodeType;
}
/*** META ((export #t)
           (arity #t)
           (peephole (postfix ".parentNode")))
*/
function dom_parent_node( node ) {
   return node.parentNode;
}
/*** META ((export dom-append-child!) (arity #t)) */
function dom_append_child( node, n ) {
   if( (n instanceof String) ||
       (typeof n == "string") ||
       (typeof n == "number") ) {
      return node.appendChild( document.createTextNode( n ) );
   } else {
      return node.appendChild( n );
   }
}
/*** META ((export dom-remove-child!)
           (arity #t)
           (peephole (hole 2 node ".removeChild(" n ")")))
*/
function dom_remove_child( node, n ) {
   return node.removeChild( n );
}
/*** META ((export #t)
           (arity #t)
           (peephole (hole 2 node ".cloneNode(" b ")")))
*/
function dom_clone_node( node, b ) {
   return node.cloneNode( b );
}
/*** META ((export dom-insert-before!)
           (arity #t)
           (peephole (hole 3 node ".insertBefore(" n ", " r ")")))
*/
function dom_insert_before( node, n, r ) {
   return node.insertBefore( n, r );
}
/*** META ((export dom-replace-child!)
           (arity #t)
           (peephole (hole 3 node ".replaceChild(" n ", " r ")")))
*/
function dom_replace_child( node, n, r ) {
   return node.replaceChild( n, r );
}
/*** META ((export #t) (arity -2)) */
function dom_get_element_by_id( doc, id ) {
   if( (doc instanceof String) || (typeof doc === "string") ) {
      var res = document.getElementById( doc );
      if( res == null ) {
	 return false;
      }
      else
	 return res;
   } else {
      var res = doc.getElementById( id );
      if( res == null )
	 return false;
      else
	 return res;
   }
}
/*** META ((export #t) (arity -2)) */
function dom_get_elements_by_tag_name( doc, name ) {
   if( (doc instanceof String) || (typeof doc === "string") ) {
      return sc_vector2list( document.getElementsByTagName( doc ) );
   } else {
      return sc_vector2list( doc.getElementsByTagName( name ) );
   }
}

/*** META ((export #t) (arity -2)) */
function dom_get_elements_by_name( doc, name ) {
   if( (doc instanceof String) || (typeof doc === "string") ) {
      return sc_vector2list( document.getElementsByName( doc ) );
   } else {
      return sc_vector2list( doc.getElementsByName( name ) );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_css_add_style_sheet ...                                      */
/*---------------------------------------------------------------------*/
/*** META ((export css-add-style-sheet!) (arity #t)) */
function hop_css_add_style_sheet( document, rules ) {
   try {
      var els = document.getElementsByTagName( "head" );
      if( (els != null) && (els[ 0 ].appendChild != undefined) ) {
	 var st = document.createElement( "style" );

	 st.appendChild( document.createTextNode( rules ) );
	 els[ 0 ].appendChild( st );
      }
   } catch( e ) {
      ;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_load_css ...                                                 */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function hop_load_css( url ) {
   try {
      var els = document.getElementsByTagName( "head" );
      if( (els != null) && (els[ 0 ].appendChild != undefined) ) {
	 var st = document.createElement( "link" );

	 if( url.lastIndexOf( ".hss" ) === url.length ) {
	    st.href = url + "?hss";
	 } else {
	    st.href = url;
	 }
	 
	 st.rel = "stylsheet";
	 st.type = "text/css";
	 
	 els[ 0 ].appendChild( st );
      }
   } catch( e ) {
      ;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_load_jscript ...                                             */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function hop_load_jscript( url ) {
   try {
      var els = document.getElementsByTagName( "head" );
      if( (els != null) && (els[ 0 ].appendChild != undefined) ) {
	 var sc = document.createElement( "script" );
	 sc.src = url;
	 sc.type = "text/javascript";
	 
	 els[ 0 ].appendChild( sc );
      }
   } catch( e ) {
      ;
   }
}

/*---------------------------------------------------------------------*/
/*    dom_get_element_by_class ...                                     */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity -2)) */
function dom_get_elements_by_class( doc, name ) {
   var res = new Array();
   var n = 0;
   var all, re;
   
   if( (doc instanceof String) || (typeof doc == "string") ) {
      all = document.getElementsByTagName( "*" );
      re = new RegExp( doc + " |" + doc + "$", "g" );
   } else {
      all = doc.getElementsByTagName( "*" );
      re = new RegExp( name + " |" + name + "$", "g" );
   }

   for( var i = 0; i < all.length; i++ ) {
      if( re.exec( all[ i ].className ) ) {
	 res[ n++ ] = all[ i ];
      }
   }
   
   return sc_vector2list( res );
}

document.getElementsByClass = function( className ) {
   var all = document.getElementsByTagName( "*" );
   var res = new Array();
   var n = 0;
   var re = new RegExp( name + " |" + name + "$", "g" );
    
   for( var i = 0; i < all.length; i++ ) {
      if( re.exec( all[ i ].className ) ) {
	 res[ n++ ] = all[ i ];
      }
   }
   
   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_node_eval ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export dom-node-eval) (arity #t)) */
function hop_node_eval( node, text ) {
   var res;

   function hop_node_eval_from_text( text ) {
      var res;
      var start_re = /<script[^>]*>/ig;
      var end_re = /<\/script>/i;
      var script;

      while( (script=start_re.exec( text )) != null ) {
	 /* I don't understand why yet, IE 7 does not include */
	 /* SCRIPT nodes in the resulting node!               */
	 var start = script.index + script[0].length;
	 var end = text.indexOf( "<\u002fscript>", start );
	 if( end == -1 ) end = text.indexOf( "<\u002fSCRIPT>", start );
	 if( (end > start) ) {
	    res = eval( text.substr( start, end - start ) );
	 }
      }

      return res;
   }

   /* some browsers (guess who) are supporting getElementsByTagName */
   /* only for the entire document and not for individual nodes.    */
   if( "getElementsByTagName" in node ) {
      var scripts = node.getElementsByTagName( "script" );

      if( scripts && scripts.length > 0 ) {
	 for ( var j = 0; j < scripts.length; j++ ) {
	    if( false && scripts[ j ].childNodes.length > 0 ) {
	       res = eval( scripts[ j ].childNodes[ 0 ].nodeValue );
	    } else {
	       /* this is a buggy browser (Opera 8?) that does not */
	       /* correctly implement script nodes                 */
	       res = eval( scripts[ j ].innerHTML );
	    }
	 }
      } else {
	 return hop_node_eval_from_text( text );
      }
   } else {
      return hop_node_eval_from_text( text );
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    node_style_get ...                                               */
/*---------------------------------------------------------------------*/
/*** META ((export node-style-get node-style) (arity #t)) */
function node_style_get( obj, prop ) {
   if( (obj instanceof String) || (typeof obj === "string") )
      obj = document.getElementById( obj );
   else {
      if( sc_isKeyword( prop ) )
	 prop = sc_keyword2jsstring( prop );
   }
   
   return obj.style[ prop ];
}

/*---------------------------------------------------------------------*/
/*    node_computed_style_get ...                                      */
/*---------------------------------------------------------------------*/
/*** META ((export node-computed-style-get node-computed-style)
           (arity #t))
*/
function node_computed_style_get( obj, prop ) {
   if( (obj instanceof String) || (typeof obj === "string") )
      obj = document.getElementById( obj );
   else {
      if( sc_isKeyword( prop ) )
	 prop = sc_keyword2jsstring( prop );
   }
   
   return window.getComputedStyle( obj, null )[ prop ];
}

/*---------------------------------------------------------------------*/
/*    hop_start_tag ...                                                */
/*---------------------------------------------------------------------*/
var hop_start_tag = new RegExp( "^<([a-zA-Z]+)" );
var hop_tags_parent = {
   'tr' : 'tbody',
   'td' : 'tr',
   'th' : 'tr',
   'li' : 'ul'
};

/*---------------------------------------------------------------------*/
/*    cloneScriptNode ...                                              */
/*---------------------------------------------------------------------*/
function cloneScriptNode( node ) {
   if( node.nodeType != 1 ) {
      return node;
   }

   if( (node.tagName !== "SCRIPT") && (node.tagName !== "script") ) {
      var childs = node.childNodes;

      for( var i = childs.length - 1; i >= 0; i-- ) {
	 var n = cloneScriptNode( childs[ i ] );
	 if( n != childs[ i ] ) {
	    node.replaceChild( n, childs[ i ] );
	 }
      }

      return node;
   } else {
      var t = document.createTextNode( node.innerHTML );
      var s = document.createElement( "SCRIPT" );

      if( "text" in s ) 
	 s.text = node.innerHTML;
      else
	 s.appendChild( t );

      return s;
   }
}
/*---------------------------------------------------------------------*/
/*    hop_create_element ...                                           */
/*---------------------------------------------------------------------*/
function hop_create_element( html ) {
   var m = html.match( hop_start_tag );
   var tag;
   
   if( m ) {
      var t = m[ 1 ];
      tag = ( t in hop_tags_parent ) ? hop_tags_parent[ t ] : "div";
   } else {
      tag = "div";
   }

   var el = document.createElement( tag );
   el.innerHTML = html;

   if( hop_config.clone_innerHTML ) {
      // As of Feb 2010, webkit based browsers (Feb 2010) requires a deep
      // clone. Otherwise, embedded scripts are not evaluated when the
      // resulting is inserted in the DOM!
      if( html.search( /<script[ >]/i ) >= 0 )
	 return cloneScriptNode( el.childNodes[ 0 ] );
      else
	 // Remove the node otherwise it has a parentNode set to non-null
	 // which confused functions such as dom_add_child
	 return el.removeChild( el.childNodes[ 0 ] );
   } else {
      // See the remark above for removeChild
      return el.removeChild( el.childNodes[ 0 ] );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_create_encoded_element ...                                   */
/*---------------------------------------------------------------------*/
function hop_create_encoded_element( html ) {
   return hop_create_element( decodeURIComponent( html ) );
}

/*---------------------------------------------------------------------*/
/*    hop_innerHTML_set ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export innerHTML-set!) (arity #t)) */
function hop_innerHTML_set( nid, html ) {
   var el;

   if( (nid instanceof String) || (typeof nid == "string") ) {
      el = document.getElementById( nid );

      if( el == undefined ) {
	 sc_error( "innerHTML-set!", "Cannot find element", nid );
      }
   } else {
      if( !nid ) {
	 sc_error( "innerHTML-set!", "illegal element", nid );
	 return;
      }
      el = nid;
   }

   if( (html instanceof String) || (typeof html == "string") ) {
      el.innerHTML = html;
      hop_node_eval( el, html );
   } else if( hop_is_html_element( html ) || sc_isPair( html ) ) {
      dom_set_child_node( el, html );
      if( hop_config.eval_innerHTML ) hop_node_eval( el, html );
   } else {
      el.innerHTML = html;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_style_attribute_set ...                                      */
/*---------------------------------------------------------------------*/
function hop_style_attribute_set( obj, val ) {
   var expr;
   if( (val instanceof String) || (typeof val == "string") )
      expr = eval( val );
   
   for( var p in expr ) {
      node_style_set( obj, p, expr[ p ] );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_element_x ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export node-bounding-box-x) (arity 1)) */
function hop_element_x( obj ) {
   var res = 0;

   while( obj != null ) {
      if( typeof obj.offsetLeft == "number" ) 
	 res += obj.offsetLeft;
      else {
	 break;
      }
      obj = obj.offsetParent;
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_element_y ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export node-bounding-box-y) (arity 1)) */
function hop_element_y( obj ) {
   var res = 0;

   while( obj != null ) {
      if( typeof obj.offsetTop == "number" ) 
	 res += obj.offsetTop;
      else {
	 break;
      }
      obj = obj.offsetParent;
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_bounding_box ...                                             */
/*---------------------------------------------------------------------*/
/*** META ((export node-bounding-box) (arity -2)) */
function hop_bounding_box( e, m ) {
   var n;
   
   if( (e instanceof String) || (typeof e == "string") ) {
      n = document.getElementById( e );
   } else {
      n = e;
   }

   if( n == undefined ) sc_error( "bounding-box", "illegal node", e );
   if( !m ) m = 0;

   return [ hop_element_x( n ) - m, hop_element_y( n ) - m,
	    n.offsetWidth + (2*m), n.offsetHeight + (2*m) ];
}

/*---------------------------------------------------------------------*/
/*    hop_bounding_box_to_list ...                                     */
/*---------------------------------------------------------------------*/
/*** META ((export bounding-box->list) (arity #t)) */
function hop_bounding_box_to_list( bbox ) {
   return sc_vector2list( bbox );
}

/*---------------------------------------------------------------------*/
/*    hop_bounding_box_x ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export bounding-box-x) (arity -2)) */
function hop_bounding_box_x( bbox, loc ) {
   if( arguments.length == 1 )
      return bbox[ 0 ];
   if( (loc == "w") || (loc == "nw") || (loc == "sw") )
      return bbox[ 0 ];
   if( (loc == "n") || (loc == "s"))
      return bbox[ 0 ] + (bbox[ 2 ]/2);
   if( (loc == "ne") || (loc == "e") || (loc == "se") )
      return bbox[ 0 ] + bbox[ 2 ];
   return 0;
}

/*---------------------------------------------------------------------*/
/*    hop_bounding_box_y ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export bounding-box-y) (arity -2)) */
function hop_bounding_box_y( bbox, loc ) {
   if( arguments.length == 1 )
      return bbox[ 1 ];
   if( (loc == "nw") || (loc == "n") || (loc == "ne") )
      return bbox[ 1 ];
   if( (loc == "e") || (loc == "w"))
      return bbox[ 1 ] + (bbox[ 3 ]/2);
   if( (loc == "se") || (loc == "s") || (loc == "sw") )
      return bbox[ 1 ] + bbox[ 3 ];
   return 0;
}
/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/share/hop-event.js                */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Sep 20 07:19:56 2007                          */
/*    Last change :  Fri Nov  5 11:11:37 2010 (serrano)                */
/*    Copyright   :  2007-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    Hop event machinery.                                             */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    window event listener ...                                        */
/*---------------------------------------------------------------------*/
var hop_is_ready = false;

hop_add_native_event_listener( window, "load", function() { hop_is_ready = true; } );

/*---------------------------------------------------------------------*/
/*    HopEvent ...                                                     */
/*---------------------------------------------------------------------*/
function HopEvent( n, v ) {
   this.isStopped = false;
   this.preventDefault = function() { ; };
   this.stopPropagation = this.preventDefault;
   this.name = n;
   this.value = v;
   return this;
}

/*---------------------------------------------------------------------*/
/*    hop_event_stoppedp ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export event-stopped?) (arity 1))) */
function hop_event_stoppedp( e ) {
   return e.isStopped == true;
}

/*---------------------------------------------------------------------*/
/*    hop_add_event_listener ...                                       */
/*---------------------------------------------------------------------*/
/*** META ((export add-event-listener!) (arity -4))) */
function hop_add_event_listener( obj, event, proc, capture ) {
   if( event === "location" )
      return hop_add_active_location_listener( obj, proc );

   if( event === "server" )
      return hop_add_server_listener( obj, proc, capture );

   if( event === "serverready" )
      return hop_add_serverready_listener( obj, proc );

   if( event === "serverclose" )
      return hop_add_serverclose_listener( obj, proc );

   if( event === "timeout" )
      return hop_add_timeout_listener( obj, proc );

   if( ("hop_add_event_listener" in obj) &&
       (obj.hop_add_event_listener != hop_add_event_listener) )
      return obj.hop_add_event_listener( event, proc, capture );

   if( event === "ready" ) {
      if( hop_is_ready ) {
	 return proc( new function() { this.name = 'ready' } );
      } else {
	 return hop_add_native_event_listener( window, "load", proc, capture );
      }
   }
   
   return hop_add_native_event_listener( obj, event, proc, capture );
}

/*---------------------------------------------------------------------*/
/*    hop_remove_event_listener ...                                    */
/*---------------------------------------------------------------------*/
/*** META ((export remove-event-listener!) (arity -4)) */
function hop_remove_event_listener( obj, event, proc, capture ) {
   if( event === "location" )
      return hop_remove_active_location_listener( obj, proc );

   if( event === "server" )
      return hop_remove_server_listener( obj, proc );

   if( event === "serverready" )
      return hop_remove_serverready_listener( obj, proc );

   if( event === "serverclose" )
      return hop_remove_serverclose_listener( obj, proc );

   if( event === "timeout" )
      return hop_remove_timeout_listener( proc );

   if( (obj.hop_remove_event_listener != undefined) &&
      (obj.hop_remove_event_listener != hop_remove_event_listener) )
      return obj.hop_remove_event_listener( event, proc, capture );

   return hop_remove_native_event_listener( obj, event, proc, capture );
} 

/*---------------------------------------------------------------------*/
/*    hop_add_active_location_listener ...                             */
/*---------------------------------------------------------------------*/
function hop_add_active_location_listener( obj, proc ) {
   obj.hop_active_location_proc = proc;
   var i = window.location.href.indexOf( "#" );
   
   if( i === -1 ) {
      obj.hop_active_location_href = window.location.href;
   } else {
      obj.hop_active_location_href = window.location.href.substring( 0, i-1 );
   }

   if( obj.hop_active_location_interval === undefined ) {
      var check = function() {
	 if( obj.hop_active_location_href !== window.location.href ) {
	    if( obj.hop_active_location_href != window.location.href ) {
	       obj.hop_active_location_href = window.location.href;
	       obj.hop_active_location_proc( window.location );
	    }
	 }
	 return true;
      }

      obj.hop_active_location_interval =
	 setInterval( check, hop_active_location_timeout );
   }
   return false;
}

/*---------------------------------------------------------------------*/
/*    hop_remove_active_location_listener ...                          */
/*---------------------------------------------------------------------*/
function hop_remove_active_location_listener( obj, proc ) {
   if( obj.hop_active_location_interval != undefined ) {
      clearInterval( obj.hop_active_location_interval );
      obj.hop_active_location_interval = undefined;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_active_location_set ...                                      */
/*---------------------------------------------------------------------*/
function hop_active_location_set( obj, href ) {
   window.location.href = href;
   obj.hop_active_location_href = window.location.href;
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_id ...                                               */
/*---------------------------------------------------------------------*/
var hop_servevt_id = "__hop_serevt_proxy";
var hop_server_event_count = 0;
var re = new RegExp( "<[\/]?event[^>]*>", "g" );

/*---------------------------------------------------------------------*/
/*    HopServerEvent ...                                               */
/*---------------------------------------------------------------------*/
function HopServerEvent( n, text, val ) {
   this.isStopped = false;
   this.name = n;
   this.value = val;
   this.id = hop_server_event_count++;
   this.preventDefault = function() { ; };
   this.stopPropagation = this.preventDefault;
   
   if( typeof text == "string" ) {
      this.responseText = text.replace( re, "" );
   } else {
      this.responseText = "";
   }
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_proxy ...                                            */
/*---------------------------------------------------------------------*/
var hop_servevt_proxy = false;

/*---------------------------------------------------------------------*/
/*    hop_servevt_table ...                                            */
/*---------------------------------------------------------------------*/
var hop_servevt_table = {};
var hop_servevt_ctable = {};
var hop_servevt_dlist = null;

var hop_servevt_enveloppe_re =
   new RegExp( "^<([rsxifj]) name='([^']+)'>((?:.|[\n])*)</[rsxifj]>$" );
var hop_servevt_enveloppe_cdata_re =
   new RegExp( "^<!\\[CDATA\\[((?:.|[\n])*)\\]\\]>$" );

/*---------------------------------------------------------------------*/
/*    hop_servevt_enveloppe_parse ...                                  */
/*---------------------------------------------------------------------*/
function hop_servevt_enveloppe_parse( val, xhr, server_ready ) {
   var m = val.match( hop_servevt_enveloppe_re );

   if( m != null ) {
      var k = m [ 1 ];
      var id = m[ 2 ];
      var text = m[ 3 ];

      if( k === "i" ) {
	 hop_trigger_servevt( id, text, parseInt( text ), false );
      } else if( k == "f" ) {
	 hop_trigger_servevt( id, text, parseFloat( text ), false );
      } else if( k == "s" ) {
	 hop_trigger_servevt( id, text, text, false );
      } else if( k == "x" ) {
	 hop_trigger_servevt( id, text, hop_create_element( text ), false );
      } else if( k == "j" ) {
	 var t = text.match( hop_servevt_enveloppe_cdata_re );
	 if( t ) {
	    hop_trigger_servevt( id, t[ 1 ], t[ 1 ], true );
	 }
      } else if( k == "r" ) {
	 // register, first event listener added to the server
	 if( !server_ready ) {
	    hop_trigger_serverready_event( new HopServerReadyEvent() );
	 }
	 return true;
      } else {
	 hop_servevt_enveloppe_parse_error( xhr );
      }
   } else {
      hop_servevt_enveloppe_parse_error( xhr );
   }
   return server_ready;
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_enveloppe_parse_error ...                            */
/*---------------------------------------------------------------------*/
function hop_servevt_enveloppe_parse_error( xhr ) {
   exc = new Error( "bad server event enveloppe" );
   
   exc.hopStack = false;
   exc.name = "HopServevtError";
   exc.scObject = false;
   exc.message = xhr.responseText === "" ? "Empty enveloppe" : xhr.responseText;
   
   hop_report_exception( exc );
}

/*---------------------------------------------------------------------*/
/*    start_servevt_websocket_proxy ...                                */
/*---------------------------------------------------------------------*/
function start_servevt_websocket_proxy( key, host, port ) {
   if( !hop_servevt_proxy.websocket ) {
      var url = "ws://" + host + ":" + port +
	 hop_service_base() + "/server-event/websocket?key=" + key;
/*       var url = "ws://" + host + ":" + 8788 + "/echo";              */
      var ws = new WebSocket( url );

      var register = function( id ) {
	 var svc = hop_service_base() +
	 "/server-event/register?event=" + id +
	 "&key=" + key  + "&mode=websocket";

	 hop_send_request( svc, false,
			   function() { ; }, false,
			   false, [] );
      }

      var unregister = function( id ) {
	 hop_servevt_proxy.httpreq.abort();

	 var svc = hop_service_base() +
	 "/server-event/unregister?event=" + id +
	 "&key=" + key;
	 
	 hop_send_request( svc, false,
			   function() { ; }, false,
			   false, [] );
      };

      ws.onopen = function() {
	 // we are ready to register now
	 hop_servevt_proxy.register = register;
	 hop_servevt_proxy.unregister = unregister;

	 // register the unitialized events
	 for( var p in hop_servevt_table ) {
	    if( hop_servevt_table[ p ].hop_servevt ) {
	       register( p );
	    }
	 }
	 hop_trigger_serverready_event( new HopServerReadyEvent() );
      }
      ws.onclose = function() {
	 hop_servevt_onclose();
      }
      ws.onmessage = function ( e ) {
	 e.responseText = e.data;
	 hop_servevt_enveloppe_parse( e.data, e, true );
      }
      
      // complete the proxy definition
      hop_servevt_proxy.websocket = ws;
   }
}

/*---------------------------------------------------------------------*/
/*    start_servevt_xhr_multipart_proxy ...                            */
/*---------------------------------------------------------------------*/
function start_servevt_xhr_multipart_proxy( key ) {
   if( !hop_servevt_proxy.httpreq ) {
      var server_ready = false;
      
      var register = function( id ) {
	 var svc = hop_service_base() +
	    "/server-event/register?event=" + id +
	    "&key=" + key  + "&mode=xhr-multipart";

	 var success = function( val, xhr ) {
	    server_ready = hop_servevt_enveloppe_parse( val, xhr, server_ready );
	 }

	 var failure = function( xhr ) {
	    if( xhr.exception ) {
	       if( typeof hop_report_exception === "function" ) {
		  hop_report_exception( xhr.exception );
	       }
	    }
	    
	    if( "hop_servevt_onclose" in window ) hop_servevt_onclose();
	 }

	 var req = hop_make_xml_http_request();
	 req.multipart = true;

	 hop_servevt_proxy.httpreq = hop_send_request( svc,
						       // asynchronous call
						       false,
						       // success callback
						       success,
						       // failure callback
						       failure,
						       // no anim
						       false,
						       // no environment
						       [],
						       // no authentication
						       false,
						       // no timeout
						       false,
						       // xhr request
	                                               req );

      }

      var unregister = function( id ) {
	 hop_servevt_proxy.httpreq.abort();

	 var svc = hop_service_base() +
	    "/server-event/unregister?event=" + id +
   	    "&key=" + hop_servevt_proxy.key;
	 
	 hop_servevt_proxy.httpreq = hop_send_request( svc, false,
						       function() { ; }, false,
						       false, [] );
      };

      // complete the proxy definition
      hop_servevt_proxy.register = register;
      hop_servevt_proxy.unregister = unregister;

      // register the unitialized events
      for( var p in hop_servevt_table ) {
	 if( hop_servevt_table[ p ].hop_servevt ) {
	    register( p );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    start_servevt_ajax_proxy ...                                     */
/*---------------------------------------------------------------------*/
function start_servevt_ajax_proxy( key ) {
   if( !hop_servevt_proxy.httpreq ) {
      var xhr_error_ttl = 6 * 3;
      var server_ready = false;
      
      var register = function( id ) {
	 var svc = hop_service_base() +
	    "/server-event/register?event=" + id +
	    "&key=" + key  + "&mode=ajax";

	 var success = function( val, xhr ) {
	    if( !server_ready ) {
	       server_ready = true;
	       hop_trigger_serverready_event( new HopServerReadyEvent() );
	    }
	    
	    // null is used as a marker for an abandonned connection
	    if( val != null ) {
	       // erase previous errors
	       xhr_error_ttl = 6 * 3;
	       // re-register the event as soon as possible
	       register( "" );
	       // invoke all the user handlers (we have received a list of
	       // values corresponding to server buffer).
	       while( sc_isPair( val ) ) {
		  var v = val.car;
		  var id = v.car;
		  var vals = v.cdr;

		  while( vals != null ) {
		     hop_trigger_servevt( id, vals.car, vals.car, false );
		     vals = vals.cdr;
		  }

		  val = val.cdr;
	       }
	    }
	 }

	 var failure = function( xhr ) {
	    if( !xhr.status &&
		(xhr_error_ttl > 0) &&
		!xhr.getAllResponseHeaders() ) {
	       // mark the connection timeout error in order to avoid
	       // falling into an infinit loop when the server has crashed.
	       xhr_error_ttl--;
	       // we have reached a timeout, we just re-register
	       register( id );
	    } else {
	       hop_servevt_onclose();
	    }
	 }

	 hop_servevt_proxy.httpreq = hop_send_request( svc,
						       // asynchronous call
						       false,
						       // success callback
						       success,
						       // failure callback
						       failure,
						       // no anim
						       false,
						       // no environment
						       [] );

      }

      var unregister = function( id ) {
	 hop_servevt_proxy.httpreq.abort();

	 var svc = hop_service_base() +
	    "/server-event/unregister?event=" + id +
   	    "&key=" + hop_servevt_proxy.key;
	 
	 hop_servevt_proxy.httpreq = hop_send_request( svc, false,
						       function() { ; }, false,
						       false, [] );
      };

      // complete the proxy definition
      hop_servevt_proxy.register = register;
      hop_servevt_proxy.unregister = unregister;

      // register the unitialized events
      for( var p in hop_servevt_table ) {
	 if( hop_servevt_table[ p ].hop_servevt ) {
	    register( p );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    start_servevt_flash_proxy ...                                    */
/*---------------------------------------------------------------------*/
function start_servevt_flash_proxy( key, host, port ) {
   var object_proxy = function() {
      return "<object id='" + hop_servevt_id + "' class='hop-servevt-proxy'" +
      " style='visibility: visible; position: fixed; top: 0; right: 0'" +
      " type='application/x-shockwave-flash'" +
      " codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,22,0'" +
      " width='1px' height='1px' title='hop-servevt' classId='HopServevt.swf'>" +
      "<param name='movie' value='" + hop_share_directory() + "/flash/HopServevt.swf'/>" +
      "<param name='allowScriptAccess' value='always'/>" +
      "<param name='FlashVars' value='init=hop_servevt_proxy_flash_init" +
      "&host=" + host + "&port=" + port + "&key=" + key +
      "&onevent=hop_trigger_servevt&onclose=hop_servevt_onclose" +
      "&onerror=hop_servevt_onerror'/>" +
      "</object>";
   }
   
   var embed_proxy = function() {
      /* EMBED is not a legal XHTML markup, hence we cannot add the */
      /* using a "innerHTML = xxx" expression. As a workaround we   */
      /* use DOM constructor and methods.                           */
      var embed = document.createElement( "embed" );
      
      embed.id = hop_servevt_id;
      embed.className = "hop-servevt-proxy";
      embed.setAttribute( "width", "1px" );
      embed.setAttribute( "height", "1px" );
      embed.setAttribute( "src", hop_share_directory() + "/flash/HopServevt.swf" );
      embed.setAttribute( "type", "application/x-shockwave-flash" );
      embed.setAttribute( "name", "__hop_servevt_proxy" );
      embed.setAttribute( "swliveconnect", "true" );
      embed.setAttribute( "allowScriptAccess", "always" );
      embed.setAttribute( "FlashVars", "init=hop_servevt_proxy_flash_init" +
			  "&host=" + host + "&port=" + port + "&key=" + key +
			  "&onevent=hop_trigger_servevt" +
			  "&onclose=hop_servevt_onclose" +
			  "&onerror=hop_servevt_onerror" );
      
      return embed;
   }

   var proxy = document.createElement( "div" );
/*    node_style_set( proxy, "visibility", "hidden" );                 */
   node_style_set( proxy, "position", "fixed" );
   node_style_set( proxy, "top", "0" );
   node_style_set( proxy, "right", "0" );
   node_style_set( proxy, "background", "transparent" );

   if( hop_config.flash_markup === "embed" ) {
      proxy.appendChild( embed_proxy() );
   } else {
      proxy.innerHTML = object_proxy();
   }

   document.body.appendChild( proxy );
   document.getElementById( hop_servevt_id ).key = key;

   return proxy;
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_onerror ...                                          */
/*---------------------------------------------------------------------*/
function hop_servevt_onerror( msg ) {
   sc_error( "servevt", msg, "internal server event error" );
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_proxy_flash_init ...                                 */
/*    -------------------------------------------------------------    */
/*    This function is called by Flash when the ActionScript           */
/*    installation completes.                                          */
/*    -------------------------------------------------------------    */
/*    When the flash init completes, we ask the Hop server its         */
/*    current server-event port number. When we get this number,       */
/*    we open the flash socket. Then, events are ready to be           */
/*    received.                                                        */
/*---------------------------------------------------------------------*/
function hop_servevt_proxy_flash_init() {
   /* if we are here, we are sure that Flash v8 or better is running */
   hop_flash_minversion_set( 8 );

   var pending_events = 0;

   hop_servevt_proxy = document.getElementById( hop_servevt_id );

   var abort = function( id ) {
      var svc = hop_service_base() +
         "/server-event/unregister?event=" + id
         + "&key=" + hop_servevt_proxy.key;
      hop_servevt_proxy.httpreq = hop_send_request( svc, false,
						    function() {;}, false,
						    false, [] );
   }
      
   var failure = function( e ) {
      hop_servevt_onclose();
      
      for( var p in hop_servevt_table ) {
	 if( hop_servevt_table[ p ].hop_servevt ) {
	    abort( p );
	 }
      }

      hop_send_request( hop_service_base() +
			"/server-event/close?key=" + hop_servevt_proxy.key,
			false,
			function() {;}, false,
			false, [] );
   }

   var register = function( id ) {
      var svc = hop_service_base() + "/server-event/register?event=" + id
         + "&key=" + hop_servevt_proxy.key + "&mode=flash";
      
      var success = function( e ) {
	 if( pending_events > 0 ) {
	    if( pending_events == 1 ) {
	       hop_trigger_serverready_event( new HopServerReadyEvent() );
	    }
	    pending_events--;
	 }
      }

      hop_servevt_proxy.httpreq = hop_send_request( svc,
						    // asynchronous call
						    false,
						    // success callback
						    success,
						    // failure callback
						    failure,
						    // no anim
						    false,
						    // no environment
						    [] );
   }

   hop_servevt_proxy.register = register;
   hop_servevt_proxy.unregister = function( id ) {
      // This function does not close the socket, otherwise, no event
      // could take place because they all share the same socket.
      abort( id );
   }

   // register the event event deregistration
   hop_add_event_listener( window, "unload", failure );

   // count the number of pre-registered events
   for( var p in hop_servevt_table ) {
      if( hop_servevt_table[ p ].hop_servevt ) {
	 pending_events++;
      }
   }

   if( pending_events > 0 ) {
      // regsiter them
      for( var p in hop_servevt_table ) {
	 if( hop_servevt_table[ p ].hop_servevt ) {
	    register( p );
	 }
      }
   } else {
      hop_trigger_serverready_event( new HopServerReadyEvent() );
   }
}

/*---------------------------------------------------------------------*/
/*    servevt_websocketp ...                                           */
/*---------------------------------------------------------------------*/
function servevt_websocketp() {
   return hop_config.websocket;
}

/*---------------------------------------------------------------------*/
/*    servevt_xhr_multipartp ...                                       */
/*---------------------------------------------------------------------*/
function servevt_xhr_multipartp() {
   return hop_config.xhr_multipart;
}
      
/*---------------------------------------------------------------------*/
/*    servevt_flashp ...                                               */
/*---------------------------------------------------------------------*/
function servevt_flashp( port ) {
   return port &&
      (hop_config.flash_version >= 8) &&
      (hop_config.flash_external_interface) &&
      (hop_config.navigator_family != "msie");
}
      
/*---------------------------------------------------------------------*/
/*    hop_start_servevt_proxy ...                                      */
/*    -------------------------------------------------------------    */
/*    http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol      */
/*    for details on the Web protocol.                                 */
/*---------------------------------------------------------------------*/
function hop_start_servevt_proxy() {
   hop_servevt_proxy = new Object();
   hop_servevt_proxy.websocket = false;
   hop_servevt_proxy.register = function( x ) {};

   hop_send_request( hop_service_base() + "/server-event/info",
		     // asynchronous call
		     false,
		     // success callback
		     function( v ) {
			var host = v[ 0 ];
			var port = v[ 1 ];
			var key = v[ 2 ];

			if( servevt_websocketp() ) {
			   // websocket backend
			   start_servevt_websocket_proxy( key, host, port );
			} else if( servevt_xhr_multipartp() ) {
			   // xhr_multipart backend
			   start_servevt_xhr_multipart_proxy( key );
			} else if( servevt_flashp( port ) ) {
			   // flash backend
			   try {
			      start_servevt_flash_proxy( key, host, port );
			   } catch( e ) {
			      e.scObject = ("port=" + port);
			      throw( e );
			   }
			} else {
			   // fallback xhr backend
			   start_servevt_ajax_proxy( key );
			}
		     },

		     // failure callback
		     function( v ) {
			throw new Error( "No event server acknowledge" );
		     },
		     // run the anim during the call
		     true,
		     // no environment
		     [] );
}

/*---------------------------------------------------------------------*/
/*    hop_trigger_servevt ...                                          */
/*    -------------------------------------------------------------    */
/*    This function is invoked by Flash and Ajax on event reception.   */
/*---------------------------------------------------------------------*/
function hop_trigger_servevt( id, text, value, json ) {
   try {
      var v = (json ? eval( value ) : value);
      var evt = new HopServerEvent( id, text, v );
      var p2 = hop_servevt_table[ id ];

      if( sc_isPair( hop_servevt_dlist ) &&
	  sc_isPair( hop_servevt_ctable[ id ] ) ) {
	 // the event is captured and we have document listener bound
	 var p1 = hop_servevt_dlist;

	 while( sc_isPair( p1 ) ) {
	    p1.car( evt );
	    p1 = p1.cdr;
	 }
      }

      evt.isStopped = false;

      while( sc_isPair( p2 ) ) {
	 try {
	    p2.car( evt );
	 } catch( exc ) {
	    exc.scObject = ("event=" + id + ", val=" + p2.car );
	    throw exc;
	 }
	 
	 if( evt.isStopped ) break;
	 p2 = p2.cdr;
      }
   } catch( exc ) {
      exc.scObject = ("event=" + id + ", val=" + value );
      throw exc;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_serverclose_list ...                                         */
/*---------------------------------------------------------------------*/
var hop_serverclose_list = null;
var hop_serverclose_triggered = false;

/*---------------------------------------------------------------------*/
/*    hop_add_serverclose_listener ...                                 */
/*---------------------------------------------------------------------*/
function hop_add_serverclose_listener( obj, proc ) {
   if( obj === document ) {
      if( hop_serverclose_triggered ) {
	 // the server is close
	 var evt = new HopServerEvent( "serverclose", false, false );
	 proc( evt );
      } else {
	 // the server is not close yet, we register the callback
	 hop_serverclose_list = sc_cons( proc, hop_serverclose_list );
      }
   } else {
      throw new Error( "add-event-listener!: Illegal `serverclose' recipient"
		       + obj );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_remove_serverclose_listener ...                              */
/*---------------------------------------------------------------------*/
function hop_remove_serverclose_listener( obj, proc ) {
   if( obj === document ) {
      hop_serverclose_list = sc_remqBang( proc, hop_serverclose_list );
      return true;
   } else {
      throw new Error( "remove-event-listener!: Illegal `serverclose' recipient"
		       + obj );
      return false;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_servevt_onclose ...                                          */
/*    -------------------------------------------------------------    */
/*    This function is invoked by Flash and Ajax on connection close.  */
/*---------------------------------------------------------------------*/
function hop_servevt_onclose() {
   // allocate a new event in order to hide handler side effects
   var evt = new HopServerEvent( "serverclose", false, false );
   var p = hop_serverclose_list;

   while( sc_isPair( p ) ) {
      p.car( evt );
      if( evt.isStopped ) break;
      p = p.cdr;
   }

   hop_serverclose_triggered = true;
}

/*---------------------------------------------------------------------*/
/*    hop_add_server_listener ...                                      */
/*---------------------------------------------------------------------*/
function hop_add_server_listener( obj, proc, capture ) {
   if( typeof proc != "function" ) {
      throw new Error( "Illegal procedure: " + proc );
   }

   if( obj === document ) {
      hop_servevt_dlist = sc_cons( proc, hop_servevt_dlist );
   } else {
      if( !document.body ) {
	 // delay until the document is fully built
	 hop_add_event_listener(
	    window, "ready", 
	    function( e ) {
	       hop_add_server_listener( obj, proc, capture );
	    } );
      } else {
	 var o = hop_servevt_table[ obj ];
      
	 hop_servevt_table[ obj ] = sc_cons( proc, sc_isPair( o ) ? o : null );
	 hop_servevt_table[ obj ].hop_servevt = true;

	 if( capture ) {
	    var o = hop_servevt_ctable[ obj ];
	    hop_servevt_ctable[ obj ] = sc_cons( proc, sc_isPair( o ) ? o : null );
	 }

	 if( !hop_servevt_proxy ) {
	    hop_start_servevt_proxy();
	 } else {
	    hop_servevt_proxy.register( obj );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_remove_server_listener ...                                   */
/*---------------------------------------------------------------------*/
function hop_remove_server_listener( obj, proc ) {
   if( obj === document ) {
      hop_servevt_dlist = sc_remqBang( proc, hop_servevt_dlist );
   } else {
      // unregister the event listener
      if( sc_isPair( hop_servevt_table[ obj ] ) )
	 hop_servevt_table[ obj ] =
	    sc_remqBang( proc, hop_servevt_table[ obj ] );
      if( sc_isPair( hop_servevt_ctable[ obj ] ) )
	 hop_servevt_ctable[ obj ] =
	    sc_remqBang( proc,hop_servevt_ctable[ obj ] );

      // try to close the socket
      for( id in hop_servevt_table ) {
	 if( sc_isPair( hop_servevt_table[ obj ] ) )
	    return;
      }

      // no event is still expected, close the connection
      hop_servevt_proxy.unregister( obj );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_serverready_list ...                                         */
/*---------------------------------------------------------------------*/
var hop_serverready_list = null;
var hop_serverready_triggered = false;

/*---------------------------------------------------------------------*/
/*    HopServerReadyEvent ...                                          */
/*---------------------------------------------------------------------*/
function HopServerReadyEvent() {
   var o = new Object();
   o.isStopped = false;
   
   return o;
}

/*---------------------------------------------------------------------*/
/*    hop_trigger_serverready_event ...                                */
/*---------------------------------------------------------------------*/
function hop_trigger_serverready_event( evt ) {
   while( sc_isPair( hop_serverready_list ) ) {
      hop_serverready_list.car( evt );
      if( evt.isStopped ) break;
      hop_serverready_list = hop_serverready_list.cdr;
   }

   hop_serverready_triggered = true;
}

/*---------------------------------------------------------------------*/
/*    hop_add_serverready_listener ...                                 */
/*---------------------------------------------------------------------*/
function hop_add_serverready_listener( obj, proc ) {
   if( obj === document ) {
      if( hop_serverready_triggered ) {
	 // the server is ready
	 proc();
      } else {
	 // the server is not ready yet, we register the callback
	 hop_serverready_list = sc_cons( proc, hop_serverready_list );
      }
   } else {
      throw new Error( "add-event-listener!: Illegal `serverready' recipient"
		       + obj );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_remove_serverready_listener ...                              */
/*---------------------------------------------------------------------*/
function hop_remove_serverready_listener( obj, proc ) {
   if( obj === document ) {
      hop_serverready_list = sc_remqBang( proc, hop_serverready_list );
      return true;
   } else {
      throw new Error( "remove-event-listener!: Illegal `serverready' recipient"
		       + obj );
      return false;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_timeout_listeners ...                                        */
/*---------------------------------------------------------------------*/
var hop_timeout_listeners = null;

/*---------------------------------------------------------------------*/
/*    hop_add_timeout_listener ...                                     */
/*---------------------------------------------------------------------*/
function hop_add_timeout_listener( obj, proc ) {
   hop_timeout_listeners = sc_cons( sc_cons( proc, setInterval( proc, obj ) ),
				    hop_timeout_listeners );
}

/*---------------------------------------------------------------------*/
/*    hop_remove_timeout_listener ...                                  */
/*---------------------------------------------------------------------*/
function hop_remove_timeout_listener( proc ) {
   var p = hop_timeout_listeners;
   
   if( sc_isPair( p ) ) {
      if( p.car.car === proc ) {
	 clearInterval( p.car.cdr );
	 hop_timeout = p.cdr;
      } else {
	 while( sc_isPair( p.cdr ) ) {
	    if( p.cdr.car === proc ) {
	       clearInterval( p.cdr.cdr );
	       p.cdr = p.cdr.cdr;
	       break;
	    } else {
	       p = p.cdr;
	    }
	 }
      }
   }
}
/*=====================================================================*/
/*    serrano/prgm/project/hop/2.1.x/share/hop-serialize.js            */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Sep 20 07:55:51 2007                          */
/*    Last change :  Fri Jul  2 11:52:39 2010 (serrano)                */
/*    Copyright   :  2007-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    HOP serialization (Bigloo compatible).                           */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    hop_bigloo_serialize ...                                         */
/*---------------------------------------------------------------------*/
function hop_bigloo_serialize( item ) {
   var tname = typeof item;

   if( (item instanceof String) || (tname == "string") ) {
      if( sc_isSymbol( item ) ) {
	 return "%27"
	    + hop_serialize_string( '%22', sc_symbol2jsstring( item ) );
      } else if( sc_isKeyword( item ) ) {
	 return "%3a"
	    + hop_serialize_string( '%22', sc_keyword2jsstring( item ) );
      } else {
	 return hop_serialize_string( '%22', item );
      }
   }

   if( tname == "number" )
      return hop_serialize_number( item );
      
   if( (item instanceof Boolean) || (tname == "boolean") )
      return hop_serialize_boolean( item );
      
   if( item instanceof Array )
      return hop_serialize_array( item );
   
   if( item === undefined )
      return ";";
   
   if( item === null )
      return ".";

   if( item instanceof Date )
      return hop_serialize_date( item );

   if( (item instanceof Object) &&
       ((typeof item.hop_bigloo_serialize) == "function") )
      return item.hop_bigloo_serialize();
   
   if( (HTMLCollection != undefined) && (item instanceof HTMLCollection) )
      return hop_serialize_array( item );
      
   if( (HTMLInputElement != undefined) && (item instanceof HTMLInputElement) )
      return hop_bigloo_serialize( item.value );

   if( (HTMLTextAreaElement != undefined) && (item instanceof HTMLTextAreaElement) )
      return hop_bigloo_serialize( item.value );

   if( (HTMLSelectElement != undefined) && (item instanceof HTMLSelectElement) )
      return hop_bigloo_serialize( item.value );

   if( (item.callee != undefined) && (item.length > -1) )
      return hop_serialize_array( item );

   if( hop_is_html_element( item ) )
      return hop_serialize_html( item );

   return hop_bigloo_serialize_alist( item );
}

/*---------------------------------------------------------------------*/
/*    hop_bigloo_serialize_object ...                                  */
/*---------------------------------------------------------------------*/
function hop_bigloo_serialize_object() {
   var o = this;
   var classname = hop_demangle( o.hop_classname );
   var classfields = o.hop_classfields;
   var str = "|" + "%27" + hop_serialize_string( '%22', classname );
   var args = "";
   var len = 1;

   for( var i = 0; i < classfields.length; i++ ) {
      len++;
      args += hop_bigloo_serialize( o[ classfields[ i ] ] );
   }

   str += hop_serialize_word( len );
   str += hop_serialize_boolean( false );
   str += args;
   str += hop_bigloo_serialize( o.hop_classhash );

   return str;
}

/*---------------------------------------------------------------------*/
/*    hop_size_of_word ...                                             */
/*---------------------------------------------------------------------*/
function hop_size_of_word( word ) {
   var s = 0;

   while( word > 0 ) {
      s++;
      word >>= 8;
   }

   return s;
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_word ...                                           */
/*---------------------------------------------------------------------*/
function hop_serialize_word( word ) {
   var s = hop_size_of_word( word );

   if( s == 0 ) {
      return "%00";
   } else {
      var i1 = (s >> 4);
      var i2 = (s & 0xf);
      var c1 = i1 + ((i1 < 10) ? 48 : 55);
      var c2 = i2 + ((i2 < 10) ? 48 : 55);
      var rw = String.fromCharCode( 37, c1, c2 );

      s--;
      while( s >= 0 ) {
         var c = ((word >> (s << 3)) & 0xff);

         if( (c < 127) && (c >= 46) ) {
	    rw += String.fromCharCode( c );
         } else {
            var i1 = (c >> 4);
            var i2 = (c & 0xf);
            var c1 = i1 + ((i1 < 10) ? 48 : 55);
            var c2 = i2 + ((i2 < 10) ? 48 : 55);
            
            rw += String.fromCharCode( 37, c1, c2 );
         }
         
         s--;
      }

      return rw;
   }
}

/*---------------------------------------------------------------------*/
/*    ucs2_to_utf8 ...                                                 */
/*---------------------------------------------------------------------*/
/*** META ((export ucs2-string->utf8-string) (arity #t)) */
function ucs2_to_utf8( s ) {
   var len = s.length;

   for( var i = 0; i < len; i++ ) {
      var c = s.charCodeAt( i );
      if( c >= 128 ) {
	 /* we got one non-ascii, we have to convert */
	 var utf = s.substring( 0, i );

	 for( ; i< len; i++, c = s.charCodeAt( i ) ) {
	    if( c < 128 ) {
	       utf += String.fromCharCode( c );
	    } else {
	       if( (c > 127) && (c < 2048) ) {
		  utf += String.fromCharCode((c >> 6) | 192);
		  utf += String.fromCharCode((c & 63) | 128);
	       } else {
		  utf += String.fromCharCode((c >> 12) | 224);
		  utf += String.fromCharCode(((c >> 6) & 63) | 128);
		  utf += String.fromCharCode((c & 63) | 128);
	       }
	    }
	 }

	 return utf;
      }
   }

   return s;
}

/*---------------------------------------------------------------------*/
/*    utf_length ...                                                   */
/*---------------------------------------------------------------------*/
function utf_length( s ) {
   var len = s.length;
   var res = len;

   for( var i = 0; i < len; i++ ) {
      var c = s.charCodeAt( i );
      
      if( c >= 128 ) {
	 if( (c > 127) && (c < 2048) ) {
	    res++;
	 } else {
	    res += 2;
	 }
      }
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_string ...                                         */
/*---------------------------------------------------------------------*/
function hop_serialize_string( mark, item ) {
   return mark +
      hop_serialize_word( utf_length( item ) ) +
      encodeURIComponent( item );
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_number ...                                         */
/*---------------------------------------------------------------------*/
function hop_serialize_number( item ) {
   var sitem = item + "";

   if( sitem.indexOf( "." ) == -1 ) {
      if( item < 0 ) {
	 if( item >= -536870912 ) {
	    return '-' + hop_serialize_word( -item );
	 } else if( item >= 2147483648 ) {
	    return hop_serialize_string( 'E', item + "" );
	 } else {
	    return hop_serialize_string( 'L', item + "" );
	 }
      } else {
	 if( item <= 536870911 ) {
	    return hop_serialize_word( item );
	 } else if( item <= 2147483647 ) {
	    return hop_serialize_string( 'E', item + "" );
	 } else {
	    return hop_serialize_string( 'L', item + "" );
	 }
      }
   } else {
      return 'f' + hop_serialize_word( sitem.length ) + sitem;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_boolean ...                                        */
/*---------------------------------------------------------------------*/
function hop_serialize_boolean( item ) {
   return item ? 'T' : 'F';
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_array ...                                          */
/*---------------------------------------------------------------------*/
function hop_serialize_array( item ) {
   var l = item.length;
   var ra = '[' + hop_serialize_word( l );
   var i = 0;

   for( i = 0; i < l; i++ ) {
      ra += hop_bigloo_serialize( item[ i ] );
   }

   return ra;
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_date ...                                           */
/*---------------------------------------------------------------------*/
function hop_serialize_date( item ) {
   var utc = Date.UTC( item.getUTCFullYear(),
		       item.getUTCMonth(),
		       item.getUTCDate(),
		       item.getUTCHours(),
		       item.getUTCMinutes(),
		       item.getUTCSeconds() ) + "";
   var ms = utc.substring( 0, utc.length - 3 );

   return 'd' + hop_serialize_word( ms.length ) + encodeURIComponent( ms );
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_html ...                                           */
/*---------------------------------------------------------------------*/
function hop_serialize_html( item ) {
   if( "outerHTML" in item ) {
      return hop_serialize_string( '%22', item.outHTML );
   } else {
      if( item.nodeType == 1 ) {
	 var str = "<" + item.tagName + " id='" + item.id + "' "
	    + (item.className ? ("class='" + item.className + "'") : "")
	    + ">" + item.innerHTML + "</" + item.tagName + ">";
	 return hop_serialize_string( '%22', str );
      } else {
	 if( item.nodeType == 3 ) {
	    return hop_serialize_string( '%22', item.nodeValue );
	 } else {
	    return hop_bigloo_serialize( "#<" + tname + ">" );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_serialize_alist ...                                          */
/*---------------------------------------------------------------------*/
function hop_bigloo_serialize_alist( item ) {
   var alist = null;
   
   for( p in item ) {
      var k = sc_jsstring2keyword( p );
      alist = sc_cons( sc_cons( k, sc_cons( item[ p ] ) ), alist );
   }

   return hop_bigloo_serialize( alist );
}
   
/*---------------------------------------------------------------------*/
/*    hop_obj_to_string ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export obj->string) (arity #t)) */
function hop_obj_to_string( item ) {
   return decodeURIComponent( hop_bigloo_serialize( item ) );
}

/*---------------------------------------------------------------------*/
/*    hop_bigloo_unserialize ...                                       */
/*---------------------------------------------------------------------*/
/*** META ((export string->obj) (arity #t)) */
function hop_string_to_obj( s ) {
   var pointer = 0;
   var definitions = [];
   var defining = -1;

   function read_integer( s ) {
      return read_size( s );
   }

   function read_float( s ) {
      var szf = read_size( s );
      var res = s.substring( pointer, pointer + szf );
      pointer += szf;

      return +res;
   }
   
   function read_char( s ) {
      new sc_Char(String.fromCharCode(n));
   }

   function read_word( s, sz ) {
      var acc = 0;

      for( var iw = 0; iw < sz; iw++ ) {
	 acc = (256 * acc) + s.charCodeAt( pointer++ );
      }

      return acc;
   }

   function read_long_word( s, szlw ) {
      return read_word( szlw );
   }


   function read_size( s ) {
      var szs = s.charCodeAt( pointer++ );
      return read_word( s, szs );
   }
   
   function read_string( s ) {
      var sz = read_size( s );
      var res = s.substring( pointer, pointer + sz );

      if( defining >= 0 ) {
	 definitions[ defining ] = res;
	 defining = -1;
      }
      pointer += sz;

      return res;
   }

   function read_definition() {
      defining = read_item();
      return read_item();
   }

   function read_reference() {
      return definitions[ read_item() ];
   }

   function read_symbol() {
      return sc_jsstring2symbol( read_item() );
   }

   function read_keyword() {
      return sc_jsstring2keyword( read_item() );
   }

   function read_cnst() {
      switch( read_integer( s ) ) {
	 default: alert( "read_cnst: not implemented: " + s );
      }
   }

   function read_vector( sz ) {
      var res = sc_makeVector( sz );

      if( defining >= 0 ) {
	 definitions[ defining ] = res;
	 defining = -1;
      }

      for( var iv = 0; iv < sz; iv++ ) {
	 res[ iv ] = read_item();
      }

      return res;
   }

   function read_list( sz ) {
      var res = sc_cons( null, null );
      var hd = res;

      if( defining >=0 ) {
	 definitions[ defining ] = res;
	 defining = -1;
      }

      for( var i = 0; i < (sz - 2); i++, hd = hd.cdr ) {
	 hd.car = read_item();
	 hd.cdr = sc_cons( null, null );
      }

      hd.car = read_item();
      hd.cdr = read_item();

      return res;
   }

   function read_extended_list( sz ) {
      var res = sc_cons( null, null );
      var hd = res;

      if( defining >= 0 ) {
	 definitions[ defining ] = res;
	 defining = -1;
      }

      for( var i = 0; i < (sz - 2); i++, hd = hd.cdr ) {
	 hd.car = read_item();
	 // skip the cer
	 read_item();
	 hd.cdr = sc_cons( null, null );
      }

      hd.car = read_item();
      // skip the cer
      read_item();
      hd.cdr = read_item();

      return res;
   }

   function read_item() {
      switch( s.charCodeAt( pointer++ ) ) {
	 case 0x3d /* = */: return read_definition();
	 case 0x23 /* # */: return read_reference();
	 case 0x27 /* ' */: return read_symbol();
	 case 0x3a /* : */: return read_keyword();
	 case 0x61 /* a */: return read_char( s );
	 case 0x46 /* F */: return false;
	 case 0x54 /* T */: return true;
	 case 0x3b /* ; */: return undefined;
	 case 0x2e /* . */: return null;
	 case 0x3c /* < */: return read_cnst();
	 case 0x22 /* " */: return read_string( s )
	 case 0x28 /* ( */: return read_list( read_size( s ) );
	 case 0x53 /* ^ */: return read_extended_list( read_size( s ) );
	 case 0x5b /* [ */: return read_vector( read_size( s ) );
	 case 0x66 /* f */: return read_float( s );
	 case 0x2d /* - */: return -read_integer( s );
	 default: pointer--; return read_integer( s );
      }
   }

   if( s.charAt( pointer ) == 'c' ) {
      pointer++;
      definitions = new Array( read_size( s ) );
   }

   return read_item();
}

/*---------------------------------------------------------------------*/
/*    unjson ...                                                       */
/*---------------------------------------------------------------------*/
var unjson = {
   "pair": function( o ) {
      return sc_cons( hop_unjson( o.car ), hop_unjson( o.cdr ) );
   }
}
 
/*---------------------------------------------------------------------*/
/*    hop_unjson ...                                                   */
/*---------------------------------------------------------------------*/
function hop_unjson( o ) {
   var tname = typeof o;

   if( ((o instanceof String) || (tname == "string")) ||
       ((typeof o) == "number") ||
       (o instanceof Boolean) || (tname == "boolean") ||
       (o === null) ) {
      return o;
   }

   if( o instanceof Array ) {
      for( var i = 0; i < o.length; i++ ) {
	 o[ i ] = hop_unjson( o [ i ] );
      }

      return o;
   }
   
   if( "__uuid" in o )
      return unjson[ o.__uuid ]( o );
   else
      return o;
}


/*=====================================================================*/
/*    serrano/prgm/project/hop/2.1.x/share/base64.js                   */
/*    -------------------------------------------------------------    */
/*    Author      :  Tyler Akins                                       */
/*    Creation    :  Thu Sep 21 15:34:59 2006                          */
/*    Last change :  Mon Mar  1 10:00:51 2010 (serrano)                */
/*    Copyright   :  2006-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    Simple base64 encoder/decoder                                    */
/*    -------------------------------------------------------------    */
/*    This code was written by Tyler Akins and has been placed in the  */
/*    public domain.  It would be nice if you left this header intact. */
/*    Base64 code from Tyler Akins -- http://rumkin.com                */
/*=====================================================================*/

var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

/*---------------------------------------------------------------------*/
/*    base64_encode ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function base64_encode( input ) {
   var output = "";
   var chr1, chr2, chr3;
   var enc1, enc2, enc3, enc4;
   var i = 0;

   do {
      chr1 = input.charCodeAt( i++ );
      chr2 = input.charCodeAt( i++ );
      chr3 = input.charCodeAt( i++ );

      enc1 = chr1 >> 2;
      enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
      enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
      enc4 = chr3 & 63;

      if( isNaN( chr2 ) ) {
         enc3 = enc4 = 64;
      } else if( isNaN( chr3 ) ) {
         enc4 = 64;
      }

      output = output + keyStr.charAt( enc1 ) + keyStr.charAt( enc2 ) + 
         keyStr.charAt( enc3 ) + keyStr.charAt( enc4 );
   } while( i < input.length );
   
   return output;
}

/*---------------------------------------------------------------------*/
/*    utf8_decode ...                                                  */
/*---------------------------------------------------------------------*/
function utf8_decode( input ) {
   var string = "";
   var i = 0;
   var c = c1 = c2 = 0;

   while ( i < input.length ) {
      c = input.charCodeAt(i);

      if( c < 128 ) {
	 string += String.fromCharCode( c );
	 i++;
      }
      else if( (c > 191) && (c < 224) ) {
	 c2 = input.charCodeAt( i + 1 );
	 string += String.fromCharCode( ((c & 31) << 6) | (c2 & 63) );
	 i += 2;
      }
      else {
	 c2 = input.charCodeAt( i + 1 );
	 c3 = input.charCodeAt( i + 2 );
	 string += String.fromCharCode( ((c & 15) << 12) |
					((c2 & 63) << 6) |
					(c3 & 63) );
	 i += 3;
      }

   }

   return string;
}

/*---------------------------------------------------------------------*/
/*    base64_decode ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function base64_decode( input ) {
   var output = "";
   var chr1, chr2, chr3;
   var enc1, enc2, enc3, enc4;
   var i = 0;

   // remove all characters that are not A-Z, a-z, 0-9, +, /, or =
   input = input.replace( /[^A-Za-z0-9\+\/\=]/g, "" );

   do {
      enc1 = keyStr.indexOf( input.charAt( i++ ) );
      enc2 = keyStr.indexOf( input.charAt( i++ ) );
      enc3 = keyStr.indexOf( input.charAt( i++ ) );
      enc4 = keyStr.indexOf( input.charAt( i++ ) );

      chr1 = (enc1 << 2) | (enc2 >> 4);
      chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
      chr3 = ((enc3 & 3) << 6) | enc4;

      output = output + String.fromCharCode( chr1 );

      if( enc3 != 64 ) {
         output = output + String.fromCharCode( chr2 );
      }
      if( enc4 != 64 ) {
         output = output + String.fromCharCode( chr3 );
      }
   } while( i < input.length );

   return utf8_decode( output );
}

/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/share/hop-request.js              */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Sat Dec 25 06:57:53 2004                          */
/*    Last change :  Mon Nov  1 09:44:41 2010 (serrano)                */
/*    Copyright   :  2004-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    WITH-HOP implementation                                          */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    hop_anim_latency ...                                             */
/*    -------------------------------------------------------------    */
/*    The latency before starting a with_hop animation.                */
/*---------------------------------------------------------------------*/
var hop_anim_latency = 400;

/*---------------------------------------------------------------------*/
/*    hop_busy_anim ...                                                */
/*---------------------------------------------------------------------*/
var hop_busy_vis_16_16 = false;
var hop_busy_vis_32_32 = false;

var hop_busy_anim_16_16 = "data:image/gif;base64,R0lGODlhEAAQAOcAAAAAAAEBAQICAgMDAwQEBAUFBQYGBgcHBwgICAkJCQoKCgsLCwwMDA0NDQ4ODg8PDxAQEBERERISEhMTExQUFBUVFRYWFhcXFxgYGBkZGRoaGhsbGxwcHB0dHR4eHh8fHyAgICEhISIiIiMjIyQkJCUlJSYmJicnJygoKCkpKSoqKisrKywsLC0tLS4uLi8vLzAwMDExMTIyMjMzMzQ0NDU1NTY2Njc3Nzg4ODk5OTo6Ojs7Ozw8PD09PT4+Pj8/P0BAQEFBQUJCQkNDQ0REREVFRUZGRkdHR0hISElJSUpKSktLS0xMTE1NTU5OTk9PT1BQUFFRUVJSUlNTU1RUVFVVVVZWVldXV1hYWFlZWVpaWltbW1xcXF1dXV5eXl9fX2BgYGFhYWJiYmNjY2RkZGVlZWZmZmdnZ2hoaGlpaWpqamtra2xsbG1tbW5ubm9vb3BwcHFxcXJycnNzc3R0dHV1dXZ2dnd3d3h4eHl5eXp6ent7e3x8fH19fX5+fn9/f4CAgIGBgYKCgoODg4SEhIWFhYaGhoeHh4iIiImJiYqKiouLi4yMjI2NjY6Ojo+Pj5CQkJGRkZKSkpOTk5SUlJWVlZaWlpeXl5iYmJmZmZqampubm5ycnJ2dnZ6enp+fn6CgoKGhoaKioqOjo6SkpKWlpaampqenp6ioqKmpqaqqqqurq6ysrK2tra6urq+vr7CwsLGxsbKysrOzs7S0tLW1tba2tre3t7i4uLm5ubq6uru7u7y8vL29vb6+vr+/v8DAwMHBwcLCwsPDw8TExMXFxcbGxsfHx8jIyMnJycrKysvLy8zMzM3Nzc7Ozs/Pz9DQ0NHR0dLS0tPT09TU1NXV1dbW1tfX19jY2NnZ2dra2tvb29zc3N3d3d7e3t/f3+Dg4OHh4eLi4uPj4+Tk5OXl5ebm5ufn5+jo6Onp6erq6uvr6+zs7O3t7e7u7u/v7/Dw8PHx8fLy8vPz8/T09PX19fb29vf39/j4+Pn5+fr6+vv7+/z8/P39/f7+/v///yH/C05FVFNDQVBFMi4wAwEAAAAh/hVDcmVhdGVkIHdpdGggVGhlIEdJTVAAIfkEAQoA/wAsAAAAABAAEAAACF8A/wkc+E+ECIIICRo0mHAgESIFF/5jxgzhw4cRJ1Ks6PAiwY0cOyakSNCMmYYDSZo0iRLkypMNQf5jiVIjQUSIRoYUiBPnx403e/5TpUojyaBDiRY92lBp0ZoDiTYMCAAh+QQBCgD/ACwAAAAAEAAQAAAIXgD/CRz4jwgRgggJGjSYcKAZMwUX/hMhAuHDhxEnUqzo8CLBjRw7JqRIEBGihgOZMftn0iRKlSpbnmwIc6VLlP9UElSlKqHOnTx7poQJlGfOlTURGk36kyZRnEMbBgQAIfkEAQoA/wAsAAAAABAAEAAACF8A/wkc+M+MGYIICRo0mHAgIkQFF/4jQgThw4cRJ1Ks6PAiwY0cOyakSFCVqoYDRYj4Z9IkSpUqW55sCHOlS5T/VBJkxiwhT4Q8fw4M2nNo0H8/iQLtqVRoQ6U4jTYMCAAh+QQBCgD/ACwAAAAAEAAQAAAIXgD/CRz4DxEigggJGjSYcKAqVQUX/jNjBuHDhxEnUqzo8CLBjRw7JqRIkBmzhgOJEPln0iRKlSpbnmwIc6VLlP9UlpxJUIQIhDJ7+vw5MKjLoUSLngzqE2dQnEobBgQAIfkEAQoA/wAsAAAAABAAEAAACGAA/wkc+E+VKoIICRo0mHAgM2YFF/5DhAjhw4cRJ1Ks6PAiwY0cOyakSBBjQ4FmzPy7CLFhypQsT75UaVKmSpEIiRCx6HGgTp0lPYoQ8e/nzqD/hg4terShUqInCS5NGBAAIfkEAQoA/wAsAAAAABAAEAAACF8A/wkc+I8ZM4IICRo0mHAgw4UHValCCLFgRIkTHS4kiDGjxoQSFR5sKBARIosMG5o0WVHlSoskS54cKEJEQjNmENasSRAnToI7bRIh8s9nTqBChxL9SVIp0ZgDhzYMCAAh+QQBCgD/ACwAAAAAEAAQAAAIYAD/CRz4jxkzgggJGjSYcCDDhQcZKlxYMCJFhxcFQkQocSJBESIaDlSl6h9IkCJJkjwZsqHKkihF/iNJkAiRhIgQIbRpk2DOnDV5/jNj5t9PnUGHEi0KVOTSojIHEm0YEAAh+QQBCgD/ACwAAAAAEAAQAAAIXwD/CRz4jxkzgggJGjSYcKAIEQUXRkT48OHEhQcdVlQokaBFhAwHEiHScCDDkSNLYkRJsiHGfylLThxoxkxCVaoQ1qxJECdOgjttIkL0z2dOoEKHEv1ZUilRmQOHNgwIADs=";

var hop_busy_anim_32_32_simple = "data:image/gif;base64,R0lGODlhIAAgALMMAOxiJlM8GvrYydTOxu1sNPGJXPjErX5tU15IKJ+Sf/Snhb62qf///wAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJBQAMACwAAAAAIAAgAAAETJDJSau9OOvNu/9gKI6YQQBoqq4AYXAnK6sEN9+pjd/6Lve+FTCY2xBZw2OSuAw2fc9dFDflGY+q6kz728SwtY0J/CKZz+i0es3ORAAAIfkECQUADAAsAAAAACAAIAAABEWQyUmrvTjrzbv/YCiOmgKcaIoqoeqm7fvGskrX6I0DOt7XP1lwBtrBisbT0LW0IZPN4yepfBqjOZDJyCJ5v+CweEzmRAAAIfkECQUADAAsAAAAACAAIAAABEKQyUmrvTjrzbv/YCiOXQGcKFCQU+qykpvCjIzS9onnu93LvxcsBwjOhjykTwlkCllE4815hCZZJtmKxu16v+AwKwIAIfkECQUADAAsAAAAACAAIAAABDyQyUmrvTjrzbv/YCiOIGCSmQmgmMpe7lvF8kTXzF3rMv/6LCBKSCKOjCJkSFk64STMT9QzfVqv2KzWEwEAIfkEBQUADAAsAAAAACAAIAAABDyQyUmrvTjrzbv/YCiOISCQmolm6nq1bgXH00wzNp3Hu9uvP1SQNBwVRcfS6VZbMnFOZhI0fVqv2Kw2EwEAIfkEBQUADAAsDgAGAAMAFAAABAkwyEmrvTjrGgEAIfkEBQUADAAsCwAGAAkAFAAABBLwhEmDrDjrzbv/YCiOZHhhRwQAIfkEBQUADAAsCAAGAA8AFAAABBYwhUkrlTbrzbv/YCiOZGmeaKpeYBIBACH5BAkFAAwALAYABgAUABQAAAQdcKFAq70BSczv7GAojmRpnmiqrmzrvnD7ndpMahEAIfkECQUADAAsAAAAACAAIAAABEWQyUmrvTjrzbv/YCiOWhKcaIomoeqm7fvGskrX6I0HOt7XP1lwBtrBisbT0LW0IZPN4yepfBqjOZDJyCJ5v+CweEzmRAAAIfkECQUADAAsAAAAACAAIAAABEKQyUmrvTjrzbv/YCiO3RGcaHCQU+qykpvCjIzS9onnu93LvxcsFwjOhjykTwlkCllE4815hCZZJtmKxu16v+AwKwIAIfkECQUADAAsAAAAACAAIAAABDyQyUmrvTjrzbv/YCiOYGCSmRmgmMpe7lvF8kTXzF3rMv/6LCBKSCKOjCJkSFk64STMT9QzfVqv2KzWEwEAIfkEBQUADAAsAAAAACAAIAAABDyQyUmrvTjrzbv/YCiOYTCQmolm6nq1bgXH00wzNp3Hu9uvP1SQNBwVRcfS6VZbMnFOZhI0fVqv2Kw2EwEAIfkEBQUADAAsDgAGAAMAFAAABAkQyEmrvTjrGgEAIfkEBQUADAAsCwAGAAkAFAAABBKwgEmBrDjrzbv/YCiOZHhhRQQAIfkEBQUADAAsCAAGAA8AFAAABBZQgUkrlTbrzbv/YCiOZGmeaKpeoBIBACH5BAUFAAwALAYABgAUABQAAAQd0BBAq72ASMzv7GAojmRpnmiqrmzrvnD7ndpMahEAOw==";

var hop_busy_anim_32_32 = "data:image/gif;base64,R0lGODlhIAAgAOf/AAMABQACAAABDgABEwgBAAADBgwFAwYJBQwLAA0KDxkLBBINDBYOBhEQBRoRAhUTAiIVAhwXAiIZCC0bCCMfCSgeCSsgBCMjDTAgByokCC8mBTAqETgqBT8tC0IvBkcuCD8xDjwzB0EzCT00D0Y2BVA6DVU6Dk49Bk1BEE5CCVdEBlZFDlhKClxJFGJJFVlMFF9MD2FSC2ZRDFdYDG5TBmxWCHFVFGtaFWxbDWlbI3ZeCIBcAH9cC4BdF31fDXdgFXlhDHRiFXtiAnxjA4FiBX5hGINgIYVhG4FjGohjCXloBn1lGoNkFIFoFoRpDYhoGIFsDodpKIhtBItrEolqIohrMIhuE4ZtI4hwHZVzApVzEpB1G5R3BZN2E454E5J4LZx5DpJ5NZl7DpB7L51+A598HJR+K5iFB5eCNqKDDJ6FC6iCDp+GGpiFRZuGOqSKApyISKOLMaCLRa6NDbOMEKqQHLWSBaOSPKeRRLSSFrGVBaeSTLKWGbuXALqXD7eaELyZIMWaBrSaOcuaC8OeCcGdGrSfNLieRLqfNr+hHL2hMMmjAMOkErijP8ijFM6iEbmiVLikSMKkK8OlIcenA8CkO8mkI7+kQ7ekW76kSb2kUM2nGr6oPceoJcWnN7moWMWrGraoZNKqEdapEtatAM2tINWuF9CwFtWuJd6vC76va9qxCdGxJcSyYtuzH9+1AOW0AN61E+K4ANa6E+q5DOa7CeC8HO68AOm+AOO/Dem+Ec++c86+eezAFu7CAOfCFfK/GPPBA+rEAObGANXBafXCCPLFCu7HCfTHAP3DE/rGAP/GANbGgdXGh/3IAPjKAPrLAP7KANbKdv/LAvbOANbLfvPNF/HQAP/MAPzNA//MBv/QAOHNe//QC9zOiN/Qdt3Qfd/RcN3Pj97Qg/7UAP7VE//XAOLUev/XF9/Ye/zaGf/cAOTXg+PWnOPYpOLchv7hCezceubcjevalOvdgufdlercm+benOnijOzfpezjmuzpnvPpoffyoPvxqP///yH/C05FVFNDQVBFMi4wAwEAAAAh/hFDcmVhdGVkIHdpdGggR0lNUAAh+QQJCgD/ACwAAAAAIAAgAAAI/gD/CRxIsOCuZgUTKlw48JsVK+AYSlzIbQgwYzy8Tdwo8FuTYs6gGXsyjqPEcD2OOVvpzFiPiCYTejwGLWRNaMeeSItJ8BsQYyyDtiSyk2e4JsZuBq3Z8glMjt+KHJsWciW0mtNqUium46lEbk5osiwnhcQJNeWCjvSqkNtPqiuPlQAwYEAAEyqV0TS2g21PJ8CYQiO3QkAAAAAKAECBrteHPOTWKvwmBGjVazYCFFAMgACAAClO5QgAY5SxHxoJgmNyLNtKauTKGPgsoECA2wEIJCig4cyayE9S/wtHxBgsasuyAcMSQIIHA7cBGO4coEOvZdtCYixZzUqvbmpa/hz7QyGAC1nPthz2TKEBgBG9rl6lJhKLOHFN4j+jocBBClbkrNTNLB0AoIA1KpQwjFAh6YKEQPIw0UtIteDCEjWvHcOAEsB0YA2GTDkzjS5P1DNQPUv8IthNTG3TBA6DnMLSVc48o0sRJhIkDxC/LMXiNoRMAE9VLI14RI4FyYNEL88wKKIsCszgRyrCJGUjEvowdI8PExa5UlZzLOHCBg9MQEkvTNwzEYq+KCViSNtksw05tGxSSxFqblRPDz16KRQ0vzSBpJ5LxEekUDcOylE9Ejo5Ypo8nbhEm0Q+UwsSeUYq0J59iqjLkZoWNE8RwlzlYKahDmQPE7n0QoSiDqlCeAUVWcaqkDvtxBQQACH5BAkKAP8ALAQAAAAYACAAAAj+AP8JHEhQYLOCCBMSjLMFn8KHA1s98uUG4sNzYpxBC7TLYsIi0Jw565bknUeCd3Jt0ziN2pWTAonZEUlzWiw8J+NJCRmSJrQ14DxSeabR2TSezrIBcfgQ0iqauVScODVNpDE0D7mlqerMGgYBAiC8coZsY6uE9Jz0XAdDAIC3I+D5yGMODDuEZoyxnBPg7dsAQdgEsGLsR8FWlLI5o/YMBIACAAJINlDAwhlhtPYMTJeFFjVnyW4Y8BDZLwEHtURuoyNNIJZshFr8GnFgzrMXAAgsYABgDrTf1KBtaffvijFyNAyEsLWSmgwAW2rI6CkS2hOB+7QkxVVdJLoFjDyhqGPpbHW1gbwI8URKLggYUFV5xpJTEM0vnxq35fFyVOQ0Y1Eg1A8TRNFklCgZ8PGKMb9NoU9C96xRk1HIdOHCBQyIEggzD4WyCjRc5bcNNKPQ0oZFVRxjoIHQNOERP1YQRZ0zz2jxoEfM+BGiUY6oAtM/cNTym0i9hPHjP/4YUeAzR/hz5D/6gPFbGvU8KZAqoqyCiZUDjfEFlwO5k49FAQEAIfkECQoA/wAsCAAAABAAIAAACP4A/wkcSLCgQYGCBB08OMnRwoKCSNFS9HCgpGLONlX818iUM2evKD6UdOujMo0LM4l69tEZLEQLFdFymcoZsk4LRTnzJaUGKWerFBZE9MpZnwoLnPh6NclgKWXIgBgAEMJOGkeHCBp69YwUBwAAEMRYMUcSwU7GlIlxAKBAgQYpCIkaKGgRqUUwTjQAYOBBmmK4RCJaJQaHDkIsDGhYwfWZJYGXXpEZQuqZHxFA3rBUVmjgJly1nkHz5STNKmjOJg7kpMsZamVpCCH7iNKzMtfP5uiZjatSQU8lP/aBMoeUqE8FNen8WCuNjjSeDnoy9vEZslqFshrM9LOlMbMLLyK2XBXpYaZVJh9XnDT71aWNmWIpU7+xk/uNkAHhH4hpf8WAACH5BAkKAP8ALAwAAAAIACAAAAiYAP8JHEiwYEFJBv+ZMlhKlsFVxgzKUiaqIC5nqwr68uVwIKtVc2oRXGVHBSmCsrhQmJNoYK0aB2LUcXmiQIg/AjstIkFARSyBibjoiCDFl0BLZBbJIBTxXylSxsi8ujXQl7M+HAfqcrYImauBsa4uYjXQ1VUuBFkpK+aoYDFnPwlu/UqwljJUBV01JYhKpMGFBhEa1JSQYEAAIfkECQoA/wAsDwAAAAIAIAAACCQA/wkcSLCgwUX/2PzD8S/GPx3/nPxL8w8hqX8XRf2zY7Bjx4AAIfkECQoA/wAsDAAAAAgAIAAACJgA/wkcSLAgQUkG/5lKKKuUQWOrCopSJqvgKme4Csry5atgrTmrWBEkpcJORIGJ5lDgUlFgnRgHatQa+CdEgRMzBcZSQYDEok4CfUmJoINLIoHGCMlYRMaSwFuvyBgj5fDfxj7OOgp0hWyRM10DWS3CGosgF6yuCDoqpkzkwFjOihV09bUgKmU5CRpL6xGVwYUGERrUlLBgQAAh+QQJCgD/ACwIAAAAEAAgAAAI/gD/CRxIsKBBgYIEHTzoaNLCgopokVL4UOAmZ8UkVfyn6JUzZ6YaVdyk7OMtjQsRwfro7JmoTAs7IXOWaiUtRQcFrXJGqoYUX85EHZz0ypeTBRX6OHuFqOAhR2nshABgAAgyZaUKSpqzIgYCAAA4kHr2yhBBUYRSNChQAIADMcqMdRqoCFexNA8MAGhwAsYiUosoWnpGdoUGAywI6cAhZlXTf4VKPnsDRISfZ6SGkHl1SWBEZ9BWpXHiC9qzWrg2EbzoDBmhNCWhOdPFiWAlXK31zHkmW5lqgp9EkZoDRalJTwY9pdGRphZLUZoMHipUC9mzj8aQH5RkjCVPmAcjJO38mLGipZLOVoFfeMkjMocbz8da/7D93I0CAXXG/w8T/40BAQAh+QQJCgD/ACwEAAAAGAAgAAAI/gD/CRxI8F+zgggTEsS3JY7ChwTd+HrUCuLDXYGgORNzziLCd0m6OXMGrYjHgleoTdO4LdedkwLxxJo2sqYdYifBrdFYUyM0KfEs4gOSjSRJmhqfUbGIxtjIaadOqMhVcxWkh60yInP2CoIAARisPU3DLSE7MOby+IA3AoBbATDWjYTmhB7CH8asBGATJIBbtwHmrHRmzEzBPbSEnbFQwECAxwAKAADxjJqzbJQqCpRGZ9vIWg4I/PXrwcCNZM6o0cqS7l+7LdCoQZs9BwCDBaJfPJtzYMSvFoSyYRH4hOdcGTW2AJBheZutEAZokDN2RWC1zs4Gq/PAaAG6uSNxnhXVsm+gnFg+s4MCE4Sc0dkkCfEqGMUYzaNe8mxLP/IXGoT6TDGbMa/wkYEo99X0DBP9JMRMIKIwcIELXSBDU4Jr3PNQG7SMAs02+9W00iqhWNSEcTWNdEwVHumjxTMpJmUFPyep4kiC2fnBDEz/hNHLXNDUAgeP//hzBIzOPGOEP0T+U08as4GhT5MCYbKKKKpQOdAXY2g5UD7uWBQQACH5BAkKAP8ALAAAAAAgACAAAAj+AP8JHEiwYLNdBRMqXDgQnBUr3xhKXOiNhzFgQ7hN3Chw3BNj0JwVaxKRI0NwPYw5W+nsWI9wJhVKe3IsJDSbx0jGJCiNiEqWQI0BKRkT3MeVIVnaNNYEpklwOopRcwZtGtWkIacdK0JUotGfK8upOUFCSjmlx5xo9LoD5DFlLU0EGDAAQIljLKcJXavwK7k8H3qhQwGgAAAAAQSsIIcVmJOuA739MDYKRoAcp1IEAEDgcIECAWxco7rSmBDI3j6SW3NGQ4EEBALIDlBAwGYDZchNdZbtGBNwA8dZDLltWa8OATonRhzAgAcJAbAAy7aMGixjRGCKwwKS2s2bvUb+AGhAgTPiLc9kuQhA4c+xFmq69bJS7R8SXUmBDiuhwpoCAB3M0s1K5LCSggMK0PAMNL00Ic4/9Tyhi1VIOUONNR0AowQDx+y2mzO41BJSL0zIM1A9RejyzFUsnTIIDk1sg5RNWP2yRD0F1XPEhECFBM8EhGxzE4ss/QKEiQnpc9+CxgiTih8zKCALhUA580wvSCCp0D1M9ELJBA9s4MISc1S1EpXO9OLDPRPdU0Qtm9BCzjbZCOkMhTb5ciNH9TTxS355AfVLDziahKIuVVbI4J47ccljoiQWutM/9yBRy4qkQaOnpJNCuCOVg3LaKaX33SRMEfOMmlA9RPSSCxMR9qiqkD5UXKGlrAW1405MAQEAIfkECQoA/wAsBAAAABgAIAAACP4A/wkcSPBfs4IIExLEtyWOwocE3fh61Ariw12BoDkTc84iwndJujlzBq2Ix4JXqE3TuC3XnZMC8cSaNrKmHWInwa3RWFMjNCnxLOIDko0kSZoan1GxiMbYyGmnTqjIVXMVpIetMiJz9gqCAAEYrD1Nwy0hOzDm8viANwKAWwEw1o2E5oQewh/GrARgEySAW7cB5qx0ZsxMwT20hJ2xUMBAgMcACgAA8Yyas2yUKgqURmfbyFoOCPz168HAjWTOqNHKku5fuy3QqEGbPQcAgwWiXzybc2DErxaEsmER+ITnXBk1tgCQYXmbrRAGaJAzdkVgtc7OBqvzwGgBurkjcZ4V1bJvoJxYPrODAhOEnNHZJAnxKhjFGM2jXvJsSz/yFxqE+kwxmzGv8JGBKPfV9AwT/STETCCiMHCBC10gQ1OCa9zzUBu0jALNNvvVtNIqoVjUhHE1jXRMFR7po8UzKSZlBT8nqeJIgtn5wQxM/4TRy1zQ1AIHj//4cwSMzjxjhD9E/lNPGrOBoU+TAmGyiiiqUDnQF2NoOVA+7lgUEAAh+QQJCgD/ACwIAAAAEAAgAAAI/gD/CRxIsKBBgYIEHTzoaNLCgopokVL4UOAmZ8UkVfyn6JUzZ6YaVdyk7OMtjQsRwfro7JmoTAs7IXOWaiUtRQcFrXJGqoYUX85EHZz0ypeTBRX6OHuFqOAhR2nshABgAAgyZaUKSpqzIgYCAAA4kHr2yhBBUYRSNChQAIADMcqMdRqoCFexNA8MAGhwAsYiUosoWnpGdoUGAywI6cAhZlXTf4VKPnsDRISfZ6SGkHl1SWBEZ9BWpXHiC9qzWrg2EbzoDBmhNCWhOdPFiWAlXK31zHkmW5lqgp9EkZoDRalJTwY9pdGRphZLUZoMHipUC9mzj8aQH5RkjCVPmAcjJO38mLGipZLOVoFfeMkjMocbz8da/7D93I0CAXXG/w8T/40BAQAh+QQJCgD/ACwMAAAACAAgAAAImAD/CRxIsCBBSQb/mUooq5RBY6sKilImq+AqZ7gKyvLlq2CtOatYESSlwk5EgYnmUOBSUWCdGAdq1Br4J0SBEzMFxlJBgMSiTgJ9SYmgg0sigcYIyVhExpLAW6/IGCPl8N/GPs46CnSFbJEzXQNZLcIaiyAXrK4IOiqmTOTAWM6KFXT1tSAqZTkJGkvrEZXBhQYRGtSUsGBAACH5BAkKAP8ALA8AAAACACAAAAgkAP8JHEiwoMFF/9j8w/Evxj8d/5z8S/MPIal/F0X9s2OwY8eAACH5BAkKAP8ALAwAAAAIACAAAAiYAP8JHEiwYEFJBv+ZMlhKlsFVxgzKUiaqIC5nqwr68uVwIKtVc2oRXGVHBSmCsrhQmJNoYK0aB2LUcXmiQIg/AjstIkFARSyBibjoiCDFl0BLZBbJIBTxXylSxsi8ujXQl7M+HAfqcrYImauBsa4uYjXQ1VUuBFkpK+aoYDFnPwlu/UqwljJUBV01JYhKpMGFBhEa1JSQYEAAIfkECQoA/wAsCAAAABAAIAAACP4A/wkcSLCgQYGCBB08OMnRwoKCSNFS9HCgpGLONlX818iUM2evKD6UdOujMo0LM4l69tEZLEQLFdFymcoZsk4LRTnzJaUGKWerFBZE9MpZnwoLnPh6NclgKWXIgBgAEMJOGkeHCBp69YwUBwAAEMRYMUcSwU7GlIlxAKBAgQYpCIkaKGgRqUUwTjQAYOBBmmK4RCJaJQaHDkIsDGhYwfWZJYGXXpEZQuqZHxFA3rBUVmjgJly1nkHz5STNKmjOJg7kpMsZamVpCCH7iNKzMtfP5uiZjatSQU8lP/aBMoeUqE8FNen8WCuNjjSeDnoy9vEZslqFshrM9LOlMbMLLyK2XBXpYaZVJh9XnDT71aWNmWIpU7+xk/uNkAHhH4hpf8WAACH5BAkKAP8ALAQAAAAYACAAAAj+AP8JHEhQYLOCCBMSjLMFn8KHA1s98uUG4sNzYpxBC7TLYsIi0Jw565bknUeCd3Jt0ziN2pWTAonZEUlzWiw8J+NJCRmSJrQ14DxSeabR2TSezrIBcfgQ0iqauVScODVNpDE0D7mlqerMGgYBAiC8coZsY6uE9Jz0XAdDAIC3I+D5yGMODDuEZoyxnBPg7dsAQdgEsGLsR8FWlLI5o/YMBIACAAJINlDAwhlhtPYMTJeFFjVnyW4Y8BDZLwEHtURuoyNNIJZshFr8GnFgzrMXAAgsYABgDrTf1KBtaffvijFyNAyEsLWSmgwAW2rI6CkS2hOB+7QkxVVdJLoFjDyhqGPpbHW1gbwI8URKLggYUFV5xpJTEM0vnxq35fFyVOQ0Y1Eg1A8TRNFklCgZ8PGKMb9NoU9C96xRk1HIdOHCBQyIEggzD4WyCjRc5bcNNKPQ0oZFVRxjoIHQNOERP1YQRZ0zz2jxoEfM+BGiUY6oAtM/cNTym0i9hPHjP/4YUeAzR/hz5D/6gPFbGvU8KZAqoqyCiZUDjfEFlwO5k49FAQEAOw==";

/*---------------------------------------------------------------------*/
/*    hop_apply_form_url ...                                           */
/*---------------------------------------------------------------------*/
function hop_apply_form_url( service, args ) {
   var nargs = null;
   var els = args[ 0 ].elements;

   for( i = els.length - 1 ; i >=0 ; i-- ) {
      if( els[ i ].type == "checkbox" ) {
	 nargs = sc_cons( els[ i ].checked ? els[ i ].value : false, nargs );
	 nargs = sc_cons( sc_jsstring2keyword( els[ i ].name ), nargs );
      } else {
	 if( els[ i ].type == "radio" ) {
	    if( els[ i ].checked ) {
	       nargs = sc_cons( els[ i ].value, nargs );
	       nargs = sc_cons( sc_jsstring2keyword( els[ i ].name ), nargs );
	    }
	 } else {
	    if( els[ i ].name !== "" ) {
	       nargs = sc_cons( els[ i ].value, nargs );
	       nargs = sc_cons( sc_jsstring2keyword( els[ i ].name ), nargs );
	    }
	 }
      }
   }

   return hop_apply_url( service, nargs );
}

/*---------------------------------------------------------------------*/
/*    hop_apply_url ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function hop_apply_url( service, args ) {
   if( sc_isPair( args ) ) {
      return service
	 + "?hop-encoding=hop"
	 + "&vals=" + hop_bigloo_serialize( args );
   } else {
      if( (args.length == 1) && hop_is_dom_form_element( args[ 0 ] ) ) {
	 return hop_apply_form_url( service, args );
      } else {
	 return service
	    + "?hop-encoding=hop"
	    + "&vals=" + hop_bigloo_serialize( sc_vector2list( args ) );
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_default_failure ...                                          */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function hop_default_failure( xhr ) {
   if( !document ) return;

   var div = document.createElement( "div" );
   var hstack = xhr.hopStack ? hop_make_exception_stack( xhr.hopStack ) : false;
   var jsstack = xhr.jsStack ? hop_make_exception_stack( xhr.jsStack ) : false;
   
   if( "exception" in xhr ) {
      hop_report_exception( xhr.exception );
   } else {
      if( xhr.responseError ) {
	 div.appendChild( xhr.responseError );
      } else {
	 var t = xhr.responseText;
	 if( t ) {
	    if( t.match( /<!DOCTYPE[^>]*>/) ) {
	       /* we have received the complete document */
	       t = t.replace( /<!DOCTYPE[^>]*>/g, "" );
	       t = t.replace( /<head[^>]*>/g, "<div style='display: none;'>" );
	       t = t.replace( /<\/head>/g, "</div>" );
	       t = t.replace( /<(meta|link)[^>]*>/g, "<span style='display: none'></span>" );
	       t = t.replace( /<html[^>]*>/g, "<div style='width: 100%; height: 100%; overflow: auto'>" );
	       t = t.replace( /<\/html>/g, "</div>" );
	       t = t.replace( /<body[^>]*>/g, "<div style='width: 100%; height: 100%; overflow: auto'>" );
	       t = t.replace( /<\/body>/g, "</div>" );
	       t = t.replace( /&quot;/g, "\"" );
	       div.innerHTML = t;
	    } else {
	       /* we have received a partial text */
	       div.innerHTML = "foo: " + t;
	    }
	 } else {
	    div.innerHTML = "Status: " + xhr.status + " -- " + xhr.statusText;
	 }
      }

      document.body.appendChild(
	 hop_make_exception_frame( div, hstack, jsstack ) );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_anim_16_16 ...                                               */
/*---------------------------------------------------------------------*/
function hop_anim_16_16( title ) {
   if( !hop_busy_vis_16_16 ) {
      var vis = document.createElement( "div" );
      
      node_style_set( vis, "position", "fixed" );
      node_style_set( vis, "top", "5px" );
      node_style_set( vis, "right", "5px" );
      node_style_set( vis, "z-index", "100" );
      node_style_set( vis, "background", "#eeeeee" );
      node_style_set( vis, "border-color", "black" );
      node_style_set( vis, "border-style", "outset" );
      node_style_set( vis, "border-width", "1px" );
      node_style_set( vis, "padding-top", "3px" );
      node_style_set( vis, "width", "20px" );
      node_style_set( vis, "height", "20px" );
      node_style_set( vis, "-moz-border-radius", "0.2em" );
      node_style_set( vis, "-moz-opacity", "0.7" );
      
      vis.align = "center";
      vis.count = false;

      var img = document.createElement( "img" );
      img.className = "hop-busy-anim";

      if( !hop_config.inline_image ) {
	 img.src = hop_share_directory() + "/icons/anims/busy-anim-16.gif";
      } else {
	 img.src = hop_busy_anim_16_16;
      }

      vis.appendChild( img );
      
      hop_busy_vis_16_16 = vis;
   }
   return hop_busy_vis_16_16;
}

/*---------------------------------------------------------------------*/
/*    hop_anim_32_32 ...                                               */
/*---------------------------------------------------------------------*/
function hop_anim_32_32( title ) {
   if( !hop_busy_vis_32_32 ) {
      var vis = document.createElement( "div" );
      
      node_style_set( vis, "position", "fixed" );
      node_style_set( vis, "top", "5px" );
      node_style_set( vis, "right", "5px" );
      
      vis.align = "center";
      vis.count = false;

      var img = document.createElement( "img" );
      img.className = "hop-busy-anim";

      if( !hop_config.inline_image ) {
	 img.src = hop_share_directory() + "/icons/anims/busy-anim-32.gif";
      } else {
	 img.src = hop_busy_anim_32_32;
      }

      vis.appendChild( img );
      hop_busy_vis_32_32 = vis;
   }

   return hop_busy_vis_32_32;
}

/*---------------------------------------------------------------------*/
/*    hop_default_anim ...                                             */
/*---------------------------------------------------------------------*/
var hop_default_anim = hop_anim_32_32;

/*---------------------------------------------------------------------*/
/*    hop_default_anim_set ...                                         */
/*---------------------------------------------------------------------*/
/*** META ((export with-hop-default-anim-set!) (arity #t)) */
function hop_default_anim_set( anim ) {
   var old = hop_default_anim;
   hop_default_anim = anim;
   return old;
}

/*---------------------------------------------------------------------*/
/*    hop_default_anim_get ...                                         */
/*---------------------------------------------------------------------*/
/*** META ((export with-hop-default-anim) (arity #t)) */
function hop_default_anim_get() {
   return hop_default_anim;
}

/*---------------------------------------------------------------------*/
/*    hop_anim_vis ...                                                 */
/*---------------------------------------------------------------------*/
var hop_anim_vis = false;
var hop_anim_fun = false;

/*---------------------------------------------------------------------*/
/*    hop_stop_anim ...                                                */
/*---------------------------------------------------------------------*/
function hop_stop_anim( xhr ) {
   if( xhr.hop_anim ) {
      if( xhr.hop_anim_interval ) {
	 clearInterval( xhr.hop_anim_interval );
	 xhr.hop_anim_interval = false;
      }

      xhr.hop_anim.count--;
      if( xhr.hop_anim.count == 1 )
	 node_style_set( xhr.hop_anim, "display", "none" );
   }
}
   
/*---------------------------------------------------------------------*/
/*    hop_start_anim ...                                               */
/*---------------------------------------------------------------------*/
function hop_start_anim( service, user_anim ) {
   var anim = user_anim( service );

   if( !anim.count ) {
      document.body.appendChild( anim );
      anim.count = 2;
   } else {
      anim.count++;
      anim.title = service;
      node_style_set( anim, "display", "block" );
   }

   return anim;
}

/*---------------------------------------------------------------------*/
/*    hop_default_success ...                                          */
/*---------------------------------------------------------------------*/
function hop_default_success( h, xhr ) {
   return h;
}

/*---------------------------------------------------------------------*/
/*    hop_send_request ...                                             */
/*    -------------------------------------------------------------    */
/*    In this function SUCCESS and FAILURE are *always* bound to       */
/*    functions.                                                       */
/*    -------------------------------------------------------------    */
/*    This function DOES NOT evaluates its result.                     */
/*---------------------------------------------------------------------*/
function hop_send_request( svc, sync, success, failure, anim, henv, auth, t, x ) {
   var xhr = x ? x : hop_make_xml_http_request();

   /* MS, 20 Jun 08: I cannot understand why but sometime sc_error is  */
   /* unbound (at least in Firefox) when used inside a catch! Binding  */
   /* it to a local var eliminates this problem.                       */
   var hop_header_ctype = hop_header_content_type;
   var hop_header_serialize = hop_header_hop_serialize;
   var succ = (typeof success === "function") ? success : hop_default_success;
   var fail = (typeof failure === "function") ? failure : hop_default_failure;
   var hstack = hop_debug() > 0 ? hop_get_stack( 1 ) : false;

   function onreadystatechange() {
      if( xhr.readyState == 4 ) {
	 try {
	    var status = xhr.status;

	    xhr.hopStack = hstack;

	    switch( status ) {
	       case 200:
		  try {
		     var ctype = hop_header_ctype( xhr );
		     var expr;

		     if( ctype === "application/x-javascript" ) {
			var serialize = hop_header_serialize( xhr );

			/* ctype must match the value hop-json-mime-type */
			/* which is defined in runtime/param.scm.        */
			try {
			   if( serialize === "javascript" ) {
			      expr = eval( xhr.responseText );
			   } else if( serialize === "hop" ) {
			      expr = hop_string_to_obj( decodeURIComponent( xhr.responseText ) );
			   } else if( serialize === "json" ) {
			      expr = hop_unjson( hop_json_parse( xhr.responseText ) );
			   } else {
			      sc_error( svc,
					"Unknown serialization format",
					serialize );
			   }
			} catch( exc ) {
			   xhr.exception = exc;
			   xhr.exception.hopStack = hstack;
			   xhr.exception.hopService = svc;
			   xhr.exception.message = xhr.responseText;
			   fail( xhr );
			   expr = false;
			}

			return succ( expr, xhr );
		     } else if( (ctype === "text/html") ||
				(ctype === "application/xhtml+xml") ) {
			var el = hop_create_element( xhr.responseText );

			return succ( el, xhr );
		     } else {
			return succ( xhr.responseText, xhr );
		     }
		  } catch( exc ) {
		     xhr.exception = exc;
		     xhr.exception.hopStack = hstack;
		     xhr.exception.hopService = svc;
		     fail( xhr );
		     return false;
		  }

	       case 204:
		  return false;

	       case 257:
		  return hop_js_eval( xhr );

	       case 258:
		  if( xhr.responseText != null )
		     return eval( xhr.responseText );
		  else
		     return false;

	       case 259:
		  hop_set_cookie( xhr );
		  return false;

	       case 407:
		  fail( xhr );
		  return false;

	       default:
		  if( (typeof status == "number") &&
		      (status > 200) && (status < 300) ) {
		     return succ( xhr.responseText, xhr );
		  } else {
		     fail( xhr );
		     return false;
		  }
	    }
	 } catch( exc ) {
	    xhr.exception = exc;
	    xhr.exception.hopStack = hstack;
	    xhr.exception.hopService = svc;
	    fail( xhr );
	    return false;
	 } finally {
	    if( typeof hop_stop_anim === "function" ) { 
	       hop_stop_anim( xhr );
	    }
	 }
      }

      return false;
   }

   if( !sync ) {
      xhr.onreadystatechange = onreadystatechange;
   }

   xhr.open( "PUT", svc, (sync != true) );

   if( t ) {
      if( "setTimeouts" in xhr ) {
	 xhr.setTimeouts = t;
      } else {
	 xhr.timeout = t;
	 xhr.ontimeout = failure;
      }
   }

   if( hop_config.navigator_family != "safari" &&
       hop_config.navigator_family != "chrome" &&
       hop_config.navigator_family != "webkit" )
      xhr.setRequestHeader( 'Connection', 'close' );
   
   xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded; charset=ISO-8859-1' );
   
   if( henv.length > 0 ) {
      xhr.setRequestHeader( 'Hop-Env', hop_serialize_request_env() );
   }

   if( auth ) {
      xhr.setRequestHeader( 'Authorization', auth );
   }

   if( xhr.multipart === true ) {
      /* This header is needed to let the server */
      /* disable timeout for this connection     */
      xhr.setRequestHeader( 'Xhr-Multipart', "true" );
   }
   
   try {
      xhr.send( null );

      if( anim ) {
	 var a = (anim instanceof Function) ? anim : hop_default_anim_get();
	 
	 if( hop_has_setInterval ) {
	    xhr.hop_anim = true;
	    xhr.hop_anim_interval =
	       setInterval( function() {
		     clearInterval( xhr.hop_anim_interval );
		     if( xhr.hop_anim == true )
			xhr.hop_anim = hop_start_anim( svc, a );
		  }, hop_anim_latency );
	 } else {
	    xhr.hop_anim_interval = false;
	    xhr.hop_anim = hop_start_anim( svc, a );
	 }
      } else {
	 xhr.hop_anim = false;
      }

      if( sync ) {
	 if( xhr.readyState == 4 ) {
	    onreadystatechange();
	 } else {
	    sc_error( svc,
		      "with-hop synchronous call failed",
		      "readyState: " + xhr.readyState );
	 }
      }
   } catch( e ) {
      if( typeof hop_stop_anim === "function" ) { 
	 hop_stop_anim( xhr );
      }

      e.hopObject = svc;
      throw e;
   }

   return xhr;
}

/*---------------------------------------------------------------------*/
/*    with_hop ...                                                     */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity -2)) */
function with_hop( svc, success, failure, sync, anim, timeout ) {
   return hop_send_request( svc, sync,
			    success, failure,
			    true, hop_serialize_request_env(), false, timeout );
}

/*---------------------------------------------------------------------*/
/*    with_hop ...                                                     */
/*---------------------------------------------------------------------*/
/*** META
(define-macro (with-hop svc . rest)
   (let ((success #f)
	 (fail #f)
	 (sync #f)
	 (anim #t)
	 (user #f)
	 (password #f)
	 (authorization #f)
	 (timeout #f))
      (let loop ((rest rest))
	 (cond
	    ((null? rest)
	     `((@ hop_send_request _)
	       ,svc
	       ,sync
	       ,(or success '(lambda (h) h))
	       ,(or fail '(@ hop_default_failure _))
	       ,anim
	       ((@ hop_serialize_request_env _))
	       ,(cond
		   (authorization
		    authorization)
		   ((and (string? user)
			 (string? password))
		    (string-append
		     "Basic "
		     (base64-encode
		      (string-append
		       user ":" password)))))
	       ,timeout))
	    ((eq? (car rest) :anim)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :anim argument" rest)
		 (set! anim (cadr rest)))
	     (loop (cddr rest)))
	    ((eq? (car rest) :authorization)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :authorization argument" rest)
		 (set! authorization (cadr rest)))
	     (loop (cddr rest)))
	    ((eq? (car rest) :user)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :user argument" rest)
		 (set! user (cadr rest)))
	     (loop (cddr rest)))
	    ((eq? (car rest) :sync)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :sync argument" rest)
		 (set! sync (cadr rest)))
	     (loop (cddr rest)))
	    ((eq? (car rest) :password)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :password argument" rest)
		 (set! password (cadr rest)))
	     (loop (cddr rest)))
	    ((eq? (car rest) :timeout)
	     (if (null? (cdr rest))
		 (error 'with-hop "Illegal :timeout argument" rest)
		 (set! timeout (cadr rest)))
	     (loop (cddr rest)))
	    ((not success)
	     (set! success (car rest))
	     (loop (cdr rest)))
	    ((not fail)
	     (set! fail (car rest))
	     (loop (cdr rest)))
	    (else
             (error 'with-hop "Illegal argument" rest))))))
*/

/*---------------------------------------------------------------------*/
/*    with_hop_callcc ...                                              */
/*---------------------------------------------------------------------*/
/* function with_hop_callcc( service ) {                               */
/*    var sc_storage = sc_CALLCC_STORAGE;                              */
/*    if (sc_storage.doRestore) {                                      */
/*       var res = sc_callcc();                                        */
/*       if (res.failure)                                              */
/* 	 throw res.value; // TODO                                      */
/*       else                                                          */
/* 	 return res.value;                                             */
/*    } else {                                                         */
/*       sc_callcc(function(k) {                                       */
/* 	 function success(val) {                                       */
/* 	    k({value: val});                                           */
/* 	 };                                                            */
/* 	 function failure(val) {                                       */
/* 	    k({failure: true, value: val});                            */
/* 	 };                                                            */
/* 	 hop( service,                                                 */
/* 	      function( http ) {                                       */
/* 		 switch( http.status ) {                               */
/* 		 case 200:                                             */
/* 		    if( hop_is_http_json( http ) ) {                   */
/* 		       success( eval( http.responseText ) );           */
/* 		    } else {                                           */
/* 		       success( http.responseText );                   */
/* 		    }                                                  */
/* 		    return;                                            */
/* 		 case 202:                                             */
/* 		    success( hop_unserialize( http.responseText ) );   */
/* 		    return;                                            */
/* 		 default:                                              */
/* 		    success( http );                                   */
/* 		    return;                                            */
/* 		 }                                                     */
/* 	      },                                                       */
/* 	      failure );                                               */
/* 	 sc_EMPTY_CALLCC(); // abort execution here.                   */
/*       });                                                           */
/*    }                                                                */
/*    return undefined; // for FF2.0                                   */
/* }                                                                   */

/*---------------------------------------------------------------------*/
/*    hop_request_env ...                                              */
/*---------------------------------------------------------------------*/
var hop_request_env = [];
var hop_request_env_string = "";
var hop_request_env_invalid = false;

/*---------------------------------------------------------------------*/
/*    hop_serialize_request_env ...                                    */
/*---------------------------------------------------------------------*/
function hop_serialize_request_env() {
   if( hop_request_env_invalid ) {
      var tmp = null;

      for( var p in hop_request_env ) {
	 if( (typeof hop_request_env[ p ] != "function") &&
	     (hop_request_env[ p ] != undefined) ) {
	    tmp = sc_cons( sc_cons( p, hop_request_env[ p ] ), tmp );
	 }
      }

      hop_request_env_string = hop_bigloo_serialize( tmp );
   }
      
   return hop_request_env_string;
}

/*---------------------------------------------------------------------*/
/*    hop_request_reset ...                                            */
/*    -------------------------------------------------------------    */
/*    Is this really needed?                                           */
/*    I think that if it is, a function that returns the whole list    */
/*    of currently binding cells will also be required. For now,       */
/*    this function is not exported.                                   */
/*---------------------------------------------------------------------*/
function hop_request_reset() {
   hop_request_env_string = "";
   hop_request_env_set = false;
   return null;
}

/*---------------------------------------------------------------------*/
/*    hop_request_set ...                                              */
/*---------------------------------------------------------------------*/
/*** META ((export request-set!) (arity #t)) */
function hop_request_set( key, val ) {
   hop_request_env_invalid = true;
   hop_request_env[ key ] = val;
   return val;
}

/*---------------------------------------------------------------------*/
/*    hop_request_get ...                                              */
/*---------------------------------------------------------------------*/
/*** META ((export request-get)
           (arity #t)
           (peephole (hole 1 "hop_request[" key"]")))
*/
function hop_request_get( key ) {
   return hop_request[ key ];
}


/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/share/hop-lib.js                  */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Sep 20 08:04:30 2007                          */
/*    Last change :  Mon Nov  8 14:33:47 2010 (serrano)                */
/*    Copyright   :  2007-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    Various HOP library functions.                                   */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    Standard JS library                                              */
/*---------------------------------------------------------------------*/
/*** META ((export Math) (JS Math)) */
/*** META ((export navigator) (JS navigator)) */
/*** META ((export eval) (JS eval)) */
/*** META ((export hop_update) (JS hop_update)) */
/*** META ((export confirm) (JS confirm)) */
/*** META ((export setInterval) (JS setInterval)) */
/*** META ((export clearInterval) (JS clearInterval)) */
/*** META ((export arguments) (JS arguments)) */
/*** META ((export hop-session) (JS hop_session)) */
/*** META ((export hop-realm) (JS hop_realm)) */
/*** META ((export md5sum) (JS md5sum)) */
/*** META ((export md5sum-string) (JS hdex_md5)) */
/*** META ((export hop-debug) (JS hop_debug)) */

/*---------------------------------------------------------------------*/
/*    hop_callback ...                                                 */
/*---------------------------------------------------------------------*/
function hop_callback( proc ) {
   if( hop_debug() > 0 ) {
      if( !(typeof proc === "function" ) ) {
	 var hstack = hop_get_stack( 1 );
	 e = new Error( "handler not a procedure: " + proc );
	 
	 e.hopStack = hstack;
	 hop_report_exception( e );

	 return function( e ) {
	    throw( e );
	 }
      } else {
	 var hstack =
	    ((typeof hop_get_stack) === "function") ?
	    hop_get_stack( 2 ) : null;
	 
	 return function( e ) {
	    try {
	       return proc.apply( this, arguments );
	    } catch( exc ) {
	       if( sc_isPair( exc.hopStack ) ) {
		  exc.hopStack = sc_append( exc.hopStack, hstack );
	       }
	       else {
		  try {
		     exc.hopStack = hstack;
		  } catch( _ ) {
		  }
	       }

	       hop_report_exception( exc );
	    }
	 }
      }
   } else {
      return proc;
   }
}   
   
/*---------------------------------------------------------------------*/
/*    hop_trace ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export trace) (arity -1)) */
function hop_trace() {
   if( hop_debug() > 0 ) {
      var svc = hop_apply_url( hop_service_base() + "/trace", arguments );
      hop_send_request( svc, true, function() {}, function() {}, false, [] );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_tprint ...                                                   */
/*---------------------------------------------------------------------*/
function hop_tprint( file, pos, rest ) {
   var svc = hop_apply_url( hop_service_base() + "/trace/tprint",
			    [ file, pos, rest ] );
   hop_send_request( svc, true, function() {}, function() {}, false, [] );
}

/*---------------------------------------------------------------------*/
/*    tprint ...                                                       */
/*---------------------------------------------------------------------*/
/*** META
(define-macro (tprint . rest)
   (if (epair? rest)
       (match-case (cer rest)
	  ((at ?name ?pos)
	   `((@ hop_tprint _) ,(relative-file-name name (pwd))
			      ,(file-position->line pos name)
			      (list ,@rest)))
	  (else
	   `((@ hop_tprint _) #f #f (list ,@rest))))
       `((@ hop_tprint _) #f #f (list ,@rest))))
*/

/*---------------------------------------------------------------------*/
/*    hop_for ...                                                      */
/*---------------------------------------------------------------------*/
/*** META ((export js-for) (arity #t)) */
function hop_for( proc, obj ) {
   for( var p in obj ) {
      proc( p, obj[ p ] );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_in ...                                                       */
/*---------------------------------------------------------------------*/
/*** META ((export js-in?) (arity #t)
           (peephole (infix 2 2 " in "))
           (type bool))
*/
function hop_in( field, obj ) {
   return field in obj;
}

/*---------------------------------------------------------------------*/
/*    hop_instanceof ...                                               */
/*---------------------------------------------------------------------*/
/*** META ((export js-instanceof?) (arity #t)
           (peephole (infix 2 2 " instanceof "))
           (type bool))
*/
function hop_instanceof( obj, klass ) {
   return obj instanceof klass;
}

/*---------------------------------------------------------------------*/
/*    hop_properties_to_list ...                                       */
/*---------------------------------------------------------------------*/
/*** META ((export js-properties->list) (arity #t)) */
function hop_properties_to_list( obj ) {
   var res = null;

   for( var p in obj ) {
      res = sc_cons( sc_cons( p, obj[ p ] ), res );
   }
   
   return sc_reverseBang( res );
}

/*---------------------------------------------------------------------*/
/*    hop_replace_inner ...                                            */
/*---------------------------------------------------------------------*/
function hop_replace_inner( el ) {
   if( el != undefined ) {
      return function( html ) {
	 if( html ) {
	    hop_innerHTML_set( el, html );
	 }
      }
   } else {
      sc_error( "hop_replace_inner", "Can't find element", el );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_replace_inner_id ...                                         */
/*---------------------------------------------------------------------*/
function hop_replace_inner_id( id ) {
   return hop_replace_inner( document.getElementById( id ) );
}

/*---------------------------------------------------------------------*/
/*    hop_set_cookie ...                                               */
/*---------------------------------------------------------------------*/
function hop_set_cookie( http ) {
   try {
      var cookie = http.getResponseHeader( "set-cookie" );
      if( cookie )
	 document.cookie = cookie;
   } catch( e ) {
      ;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_cookie_remove ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export cookie-remove!) (arity #t)) */
function hop_cookie_remove( name, path, domain ) {
   if( hop_cookie_get_value( name ) ) {
      hop_cookie_set_value( name, "", path, domain );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_cookie_get_value ...                                         */
/*---------------------------------------------------------------------*/
/*** META ((export cookie-get) (arity #t)) */
function hop_cookie_get_value( name ) {
   var cookies = document.cookie;
   var i = cookies.indexOf( name + "=" );
   
   if( i !== -1 ) {
      var start = i + name.length + 1;
      var end = cookies.indexOf( ";", start );
      if( end == -1 ) end = cookies.length;
      return unescape( cookies.substring( start, end ) );
   } else {
      return null;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_cookie_set_value ...                                         */
/*---------------------------------------------------------------------*/
/*** META ((export cookie-set!) (arity -3)) */
function hop_cookie_set_value( name, val, path, domain, expires ) {
   var cookie = name + "=" + val;

   if( (path instanceof String) || (typeof path == "string") ) {
      cookie += "; path=" + path;
   } else {
      cookie += "; path=/";
   }

   if( (expires instanceof String) || (typeof expires == "string") ) {
      cookie += "; expires=" + expires;
   } else {
      if( expires instanceof Date ) {
	 cookie += "; expires=" + expires.toGMTString();
      }
   }

   if( (domain instanceof String) || (typeof domain == "string") ) {
      cookie += "; domain=" + domain;
   }
   
   document.cookie = cookie;
}

/*---------------------------------------------------------------------*/
/*    hop_load_frequency ...                                           */
/*---------------------------------------------------------------------*/
var hop_load_frequency = 100;

/*---------------------------------------------------------------------*/
/*    hop_load_frequency ...                                           */
/*---------------------------------------------------------------------*/
var hop_load_frequency = 100;

/*---------------------------------------------------------------------*/
/*    hop_load ...                                                     */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity -2)) */
function hop_load( src, timeout ) {
   var script = document.createElement( "script" );
   script.src = src;
   var loaded = false;
   var holder = document.getElementsByTagName( "head" );

   if( !timeout || (timeout == undefined) ) timeout = -1;

   if( holder != null ) {
      
      if( timeout != 0 ) script.onload = function( e ) { loaded = true; }
      
      holder[ 0 ].appendChild( script );

      if( timeout != 0 ) {
	 var it;
	 var p = function() {
	    if( loaded == true ) {
	       clearInterval( it );
	    } else {
	       if( timeout > 0 ) {
		  timeout -= hop_load_frequency;
		  if( timeout <= 0 ) {
		     clearInterval( it );
		     sc_error( "hop_load", "Cannot load file", src );
		  }
	       }
	    }
	 };
	 it = setInterval( p, hop_load_frequency );
      }
   } else {
      sc_error( "hop_load", "Can't find HEAD element", src );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_window_onload_add ...                                        */
/*---------------------------------------------------------------------*/
/*** META ((export add-window-onload!) (arity 1)) */
var hop_window_onload_add = function( proc ) {
   /* backward compatibility */
   return hop_add_event_listener( window, "load", proc );
}

/*    var oldonload = window.onload;                                   */
/*    var wproc = hop_callback( proc );                                */
/*                                                                     */
/*    if( typeof oldonload != 'function' ) {                           */
/*       window.onload = wproc;                                        */
/*    } else {                                                         */
/*       window.onload = function( e ) {                               */
/* 	 oldonload( e );                                               */
/* 	 wproc( e );                                                   */
/*       }                                                             */
/*    }                                                                */
/* }                                                                   */
/*                                                                     */
/* hop_window_onload_add( function( e ) {                              */
/*       {* once the window is loaded, onload handlers *}              */
/*       {* must be invoked eargly                     *}              */
/*       hop_window_onload_add = function( proc ) { proc( e ); }       */
/*    } );                                                             */
/*                                                                     */

/*---------------------------------------------------------------------*/
/*    hop_update ...                                                   */
/*    -------------------------------------------------------------    */
/*    This function is called when a widget selects a new child        */
/*    (e.g., a notepad or a tabslider). It gives a child the           */
/*    opportunity to update (i.e., to re-compute dimensions).          */
/*    Widgets interested have to register by setting their             */
/*    hop_update field (see hop-tabslider.js for an example).          */
/*---------------------------------------------------------------------*/
function hop_update( node ) {
   /* update the children recursively */
   if( node.hop_update != undefined ) {
      node.hop_update();
   }
   /* traverse the all tree */
   for( var i = 0; i < node.childNodes.length; i++ ) {
      hop_update( node.childNodes[ i ] );
   }
}

/*---------------------------------------------------------------------*/
/*    hop_typeof ...                                                   */
/*    -------------------------------------------------------------    */
/*    A wrapper for using typeof as a function in Hop.                 */
/*---------------------------------------------------------------------*/
/*** META ((export typeof) (arity #t)) */
function hop_typeof( obj ) {
   if( obj instanceof Object ) {
      if( obj instanceof Date ) {
	 return "date";
      } else {
	 if( obj instanceof RegExp ) {
	    return "regexp";
	 } else {
	    if( typeof obj.hop_typeof == "function" ) 
	       return obj.hop_typeof();
	    else
	       return "object";
	 }
      }
   } else {
      var tname = typeof obj;

      if( tname == "string" ) {
	 if( sc_isSymbol( obj ) )
	    return "symbol";
	 if( sc_isKeyword( obj ) )
	    return "keyword";

	 return tname;
      }
      return tname;
   }
}

/*---------------------------------------------------------------------*/
/*    after ...                                                        */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function after( timeout, proc ) {
   var tm = sc_isNumber( timeout ) ? timeout : 1;
   var wproc = hop_callback( proc );
   
   var i = setInterval( function() { clearInterval( i ); wproc() }, tm );
   return true;
}

/*---------------------------------------------------------------------*/
/*    timeout ...                                                      */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function timeout( tm, proc ) {
   var wproc = hop_callback( proc );

   if( wproc() ) {
      var i = setInterval(
	 function() { if( !wproc() ) clearInterval( i )}, tm );
   }
}

/*---------------------------------------------------------------------*/
/*    url-decode ...                                                   */
/*---------------------------------------------------------------------*/
/*** META ((export url-decode) (arity #t)) */
function url_decode( s ) {
   try {
      return decodeURI( s );
   } catch( e ) {
      return s;
   }
}

/*---------------------------------------------------------------------*/
/*    url-encode ...                                                   */
/*---------------------------------------------------------------------*/
/*** META ((export url-encode) (arity #t)) */
function url_encode( s ) {
   return encodeURI( s );
}

/*---------------------------------------------------------------------*/
/*    string-hex-extern ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export string-hex-extern) (arity #t)) */
function string_hex_extern( str ) {
  var res = "";
  var l = str.length;

  for( var i = 0; i < l; i++ ) {
    res += "0123456789abcdef".charAt( (str.charCodeAt( i ) >> 4) & 15 )
         + "0123456789abcdef".charAt( (str.charCodeAt( i ) & 15) );
  }
  
  return res;
}

/*---------------------------------------------------------------------*/
/*    string-hex-intern ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export string-hex-intern) (arity #t)) */
function string_hex_intern( s ) {
   var res = "";
   var l = s.length;
   var z = '0'.charCodeAt( 0 );
   var n = '9'.charCodeAt( 0 );
   var a = 'a'.charCodeAt( 0 );
   var f = 'f'.charCodeAt( 0 );
   var A = 'A'.charCodeAt( 0 );
   
   function hex_to_num( c ) {
      if( (c >= z) && ( c<= n) ) {
	 return c - z;
      }
      if( (c >= a) && ( c<= f) ) {
	 return (c - a) + 10;;
      }
      return (c - A) + 10;
   }
      
   for( var i = 0; i < l; i += 2 ) {
      var d1 = hex_to_num( s.charCodeAt( i ) );
      var d2 = hex_to_num( s.charCodeAt( i + 1 ) );

      res += String.fromCharCode( (d1 << 4) + d2 );
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    make_date ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity -1)) */
function make_date() {
   var l = arguments.length, i = 0;
   var year = 1970;
   var month = 1;
   var day = 1;
   var hours = 1;
   var minutes = 1;
   var seconds = 1;

   while( i < l ) {
      var k = arguments[ i++ ];
      
      if( sc_isKeyword( k ) ) {
	 var prop = sc_keyword2jsstring( k );
	 if( prop === "year" ) year = arguments[ i++ ]; 
	 else if( prop === "month" ) month = (arguments[ i++ ] - 1); 
	 else if( prop === "day" ) day = arguments[ i++ ]; 
	 else if( prop === "hours" ) hours = arguments[ i++ ]; 
	 else if( prop === "minutes" ) minutes = arguments[ i++ ]; 
	 else if( prop === "seconds" ) seconds = arguments[ i++ ]; 
	 else i++;
      }
   }

   return new Date( year, month, day, hours, minutes, seconds );
}

/*---------------------------------------------------------------------*/
/*    date_copy ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity -2)) */
function date_copy() {
   var l = arguments.length, i = 1;
   var date = arguments[ 0 ];
   var year = date.getFullYear();
   var month = date.getMonth();
   var day = date.getDate();
   var hours = date.getHours();
   var minutes = date.getMinutes();
   var seconds = date.getSeconds();

   while( i < l ) {
      var k = arguments[ i++ ];
      
      if( sc_isKeyword( k ) ) {
	 var prop = sc_keyword2jsstring( k );
	 if( prop === "year" ) year = arguments[ i++ ]; 
	 else if( prop === "month" ) month = (arguments[ i++ ] - 1);  
	 else if( prop === "day" ) day = arguments[ i++ ]; 
	 else if( prop === "hours" ) hours = arguments[ i++ ]; 
	 else if( prop === "minutes" ) minutes = arguments[ i++ ]; 
	 else if( prop === "seconds" ) seconds = arguments[ i++ ]; 
	 else i++;
      }
   }

   return new Date( year, month, day, hours, minutes, seconds );
}

/*---------------------------------------------------------------------*/
/*    date->seconds ...                                                */
/*---------------------------------------------------------------------*/
/*** META ((export date->seconds) (arity #t)) */
function date_seconds( d ) {
   return d.getTime() / 1000;
}

/*---------------------------------------------------------------------*/
/*    seconds_date ...                                                 */
/*---------------------------------------------------------------------*/
/*** META ((export seconds->date) (arity #t)) */
function seconds_date( d ) {
   return new Date( d * 1000 );
}

/*---------------------------------------------------------------------*/
/*    date_to_rfc2822 ...                                              */
/*---------------------------------------------------------------------*/
/*** META ((export date->rfc282-date) (arity #t)) */
function date_to_rfc2822( d ) {
   return d.toTimeString();
}

/*---------------------------------------------------------------------*/
/*    date_from_rfc2822 ...                                            */
/*---------------------------------------------------------------------*/
/*** META ((export rfc282-date->date) (arity #t)) */
function date_from_rfc2822( s ) {
   return new Date( s );
}

/*---------------------------------------------------------------------*/
/*    day_seconds ...                                                  */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function day_seconds() {
   return 86400;
}

/*---------------------------------------------------------------------*/
/*    date-year ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_year( d ) {
   return d.getFullYear();
}

/*---------------------------------------------------------------------*/
/*    date-month ...                                                   */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_month( d ) {
   return d.getMonth() + 1;
}

/*---------------------------------------------------------------------*/
/*    date-day ...                                                     */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_day( d ) {
   return d.getDate();
}

/*---------------------------------------------------------------------*/
/*    date-yday ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_yday( d ) {
   var d0 = new Date( d.getFullYear(), 0, 1,
		      d.getHours(), d.getMinutes(),
		      d.getSeconds(), d.getMilliseconds() );

   return Math.round(((d.getTime() - d0.getTime()) / 1000) / day_seconds()) + 1;
}

/*---------------------------------------------------------------------*/
/*    date-wday ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_wday( d ) {
   return d.getDay() + 1;
}

/*---------------------------------------------------------------------*/
/*    date-hour ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_hour( d ) {
   return d.getHours();
}

/*---------------------------------------------------------------------*/
/*    date-minute ...                                                  */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_minute( d ) {
   return d.getMinutes();
}   

/*---------------------------------------------------------------------*/
/*    date-second ...                                                  */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function date_second( d ) {
   return d.getSeconds();
}   

/*---------------------------------------------------------------------*/
/*    hop_day_names ...                                                */
/*---------------------------------------------------------------------*/
var hop_day_names =
   [ "Sunday", "Monday",  "Tuesday", "Wednesday", "Thursday", "Friday",  "Saturday" ];

/*---------------------------------------------------------------------*/
/*    day-name ...                                                     */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function day_name( day ) {
   if( day < 1 ) 
      sc_error( "date-name", "Illegal day number", day );
   else if( day > 7 )
      return sc_jsstring2string( hop_day_names[ day % 7 ] );
   else
      return sc_jsstring2string( hop_day_names[ day - 1 ] );
}

/*---------------------------------------------------------------------*/
/*    day-aname ...                                                    */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function day_aname( day ) {
   if( day < 1 ) 
      sc_error( "date-name", "Illegal day number", day );
   else if( day > 7 )
      return sc_jsstring2string( hop_day_names[ day % 7 ].substring( 0, 2 ) );
   else
      return sc_jsstring2string( hop_day_names[ day - 1 ].substring( 0, 2 ) );
}

/*---------------------------------------------------------------------*/
/*    hop_month_names ...                                              */
/*---------------------------------------------------------------------*/
var hop_month_names =
   [ "January", "February", "March", "April", "May", "June",
     "July", "August", "September", "October", "November", "December" ];

/*---------------------------------------------------------------------*/
/*    month-name ...                                                   */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function month_name( month ) {
   if( month < 1 ) 
      sc_error( "date-name", "Illegal month number", month );
   else if( month > 12 )
      return sc_jsstring2string( hop_month_names[ month % 12 ] );
   else
      return sc_jsstring2string( hop_month_names[ month - 1 ] );
}

/*---------------------------------------------------------------------*/
/*    month-aname ...                                                  */
/*---------------------------------------------------------------------*/
/*** META ((export #t) (arity #t)) */
function month_aname( month ) {
   if( month < 1 ) 
      sc_error( "date-name", "Illegal month number", month );
   else if( month > 12 )
      return sc_jsstring2string( hop_month_names[ month % 12 ].substring( 0, 2 ) );
   else
      return sc_jsstring2string( hop_month_names[ month - 1 ].substring( 0, 2 ) );
}

/*---------------------------------------------------------------------*/
/*    hop_alist2jsobject ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export alist->jsobject) (arity #t)) */
function hop_alist2jsobject( alist ) {
   var o = {};

   while( sc_isPair( alist ) ) {
      if( !sc_isPair( alist.car ) || !sc_isPair( alist.car.cdr ) )
	 sc_error( "alist->object", "Illegal entry", alist.car );
      if( !sc_isKeyword( alist.car.car ) )
	 sc_error( "alist->object", "Illegal key", alist.car.car );
      
      o[ sc_keyword2jsstring( alist.car.car ) ] = alist.car.cdr.car;
      alist = alist.cdr;
   }

   return o;
}

/*---------------------------------------------------------------------*/
/*    hop_jsobject2alist ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export jsobject->alist) (arity #t)) */
function hop_jsobject2alist( obj ) {
   var l = null;

   for( p in obj ) {
      var c = sc_cons( sc_jsstring2keyword( p ), sc_cons( o[ p ], null ) );
      l = sc_cons( c, l );
   }

   return l;
}

/*---------------------------------------------------------------------*/
/*    hop_plist2object ...                                             */
/*---------------------------------------------------------------------*/
/*** META ((export plist->jsobject) (arity #t)) */
function hop_plist2jsobject( plist ) {
   var o = {};

   while( sc_isPair( plist ) ) {
      if( !sc_isKeyword( plist.car ) )
	 sc_error( "plist->object", "Illegal key", plist.car.car );
      if( !sc_isPair( plist.cdr ) ) 
	 sc_error( "plist->object", "Illegal entry", plist );
      
      o[ sc_keyword2jsstring( plist.car ) ] = plist.cdr.car;
      plist = plist.cdr.cdr;
   }

   return o;
}

/*---------------------------------------------------------------------*/
/*    hop_jsobject2plist ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export jsobject->plist) (arity #t)) */
function hop_jsobject2plist( obj ) {
   var l = null;

   for( p in obj ) {
      l = sc_cons( sc_jsstring2keyword( p ), sc_cons( o[ p ], l ) );
   }

   return l;
}

/*---------------------------------------------------------------------*/
/*    hop_xml_make_id ...                                              */
/*---------------------------------------------------------------------*/
var hop_id_count = 0;

/*** META ((export xml-make-id) (arity #t)) */
function hop_xml_make_id( obj ) {
   return (obj instanceof String ? obj : "id") + hop_id_count++;
}
/*=====================================================================*/
/*    serrano/prgm/project/hop/2.0.x/share/hop-history.js              */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu Sep 20 07:59:42 2007                          */
/*    Last change :  Sat Jan  2 08:19:30 2010 (serrano)                */
/*    Copyright   :  2007-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    HOP history manager.                                             */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    hop_state_history_handler ...                                    */
/*---------------------------------------------------------------------*/
var hop_current_state_history = undefined;
var hop_state_history_handler = {};
var hop_location_event_initp = false;

/*---------------------------------------------------------------------*/
/*    hop_state_history_register_handler ...                           */
/*---------------------------------------------------------------------*/
function hop_state_history_register_handler( key, reset, proc ) {
   hop_state_history_handler[ key ] = { reset: reset, proc: proc };
}

/*---------------------------------------------------------------------*/
/*    _hop_state_entry ...                                             */
/*    -------------------------------------------------------------    */
/*    Private class.                                                   */
/*---------------------------------------------------------------------*/
function _hop_state_entry( op, val ) {
   this.op = op;
   this.val = val;
   this.close = false;
}

/*---------------------------------------------------------------------*/
/*    hop_state_history_to_location ...                                */
/*---------------------------------------------------------------------*/
function hop_state_history_to_location( state ) {
   var loc = undefined;
   
   for( p in state ) {
      if( state[ p ] instanceof _hop_state_entry ) {
	 if( loc == undefined ) {
	    loc = "#" + p + "=" + state[ p ].op + ":" + state[ p ].val;
	 } else {
	    loc += "," + p + "=" + state[ p ].op + ":" + state[ p ].val;
	 }
      }
   }

   return loc;
}

/*---------------------------------------------------------------------*/
/*    hop_hash_history_regexp ...                                      */
/*---------------------------------------------------------------------*/
var hop_hash_history_regexp = /#?([^=]+)=([^:]+):([^,]+)+/;

/*---------------------------------------------------------------------*/
/*    hop_location_to_state_history ...                                */
/*---------------------------------------------------------------------*/
function hop_location_to_state_history( hash ) {
   var state = {};
   var split = hash.split( "," );
   for( var i = 0; i < split.length; i++ ) {
      var el = split[ i ].match( hop_hash_history_regexp );
      if( el ) {
	 var id = el[ 1 ];
	 var op = el[ 2 ];
	 var val = el [ 3 ];

	 state[ id ] = new _hop_state_entry( op, val );
      }
   }

   return state;
}

/*---------------------------------------------------------------------*/
/*    hop_state_history_push ...                                       */
/*    -------------------------------------------------------------    */
/*    Store the new state but don't add a new location to the          */
/*    browser URL bar.                                                 */
/*---------------------------------------------------------------------*/
function hop_state_history_push( id, op, val ) {
   if( hop_current_state_history == undefined ) {
      /* create a new state */
      hop_current_state_history = {};
      hop_current_state_history[ id ] = new _hop_state_entry( op, val );
   } else {
      /* update the current state */
      var olde = hop_current_state_history[ id ];

      if( olde == undefined ) {
	 /* add a new entry to the current state */
	 hop_current_state_history[ id ] = new _hop_state_entry( op, val );
      } else {
	 if( (olde.op != op) || (olde.val != val) ) {
	    /* update the current state */
	    olde.op = op;
	    olde.val = val;
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_state_history_flush ...                                      */
/*    -------------------------------------------------------------    */
/*    Generates a new browser URL from the current history state.      */
/*---------------------------------------------------------------------*/
function hop_state_history_flush() {
   /* store the new state as a location for bookmarking an history */
   var loc = hop_state_history_to_location( hop_current_state_history );
   var old = window.location.href;
   var i = old.indexOf( "#" );

   /* store the new browser URL */
   if( i == -1 ) {
      hop_active_location_set( document, old + loc );
   } else {
      hop_active_location_set( document, old.substring( 0, i ) + loc );
   }
}
   
/*---------------------------------------------------------------------*/
/*    hop_state_history_transaction ...                                */
/*---------------------------------------------------------------------*/
var hop_state_history_transaction = 0;

/*---------------------------------------------------------------------*/
/*    hop_state_history_add ...                                        */
/*---------------------------------------------------------------------*/
function hop_state_history_add( id, op, val ) {
   /* prepare the new current state */
   hop_state_history_push( id, op, val );

   if( hop_state_history_transaction == 0 ) {
      hop_state_history_flush();
   }
}

/*---------------------------------------------------------------------*/
/*    hop_with_history ...                                             */
/*---------------------------------------------------------------------*/
/*** META ((export with-history) (arity #t)) */
function hop_with_history( proc ) {
   var res;
   hop_state_history_transaction++;
   try {
      res = proc();
   } finally {
      hop_state_history_transaction--;
   }
   hop_state_history_flush();
   return res;
}
   
/*---------------------------------------------------------------------*/
/*    hop_state_history_reset ...                                      */
/*    -------------------------------------------------------------    */
/*    When there is already an existing state, we have to reset all    */
/*    its entries.                                                     */
/*---------------------------------------------------------------------*/
function hop_state_history_reset() {
   if( hop_current_state_history != undefined ) {
      /* there is a state, we reset all the entries */
      for( p in hop_current_state_history ) {
	 if( hop_current_state_history[ p ] instanceof _hop_state_entry ) {
	    var op = hop_current_state_history[ p ].op;
	    var handler =  hop_state_history_handler[ op ];
	    if( handler != undefined ) {
	       handler.proc( p, handler.reset );
	    }
	 }
      }

      /* and we erase the state itself */
      hop_current_state_history = undefined;
   }
}

/*---------------------------------------------------------------------*/
/*    hop_state_history_update ...                                     */
/*    -------------------------------------------------------------    */
/*    Compare the two states, reset the entries of the old ones        */
/*    that are no longer present in the new one. Execute the           */
/*    entries that are novel in the new state.                         */
/*    -------------------------------------------------------------    */
/*    This function returns the number of entries that have not        */
/*    been correctly updated.                                          */
/*---------------------------------------------------------------------*/
function hop_state_history_update( olds, news ) {
   var res = 0;

   if( olds == undefined ) {
      /* set the new values */
      for( p in news ) {
	 var state = news[ p ];
	 if( state instanceof _hop_state_entry ) {
	    var op = state.op;
	    var handler = hop_state_history_handler[ op ];

	    if( (handler != undefined) && !state.close ) {
	       if( handler.proc( p, state.val ) ) {
		  state.close = true;
	       } else {
		  res++;
	       }
	    }
	 }
      }
   } else {
      /* reset all the entries that used to be in old    */
      /* state that are no longer present in the new one */
      for( p in olds ) {
	 if( (olds[ p ] instanceof _hop_state_entry) &&
	     !(news[ p ] instanceof _hop_state_entry) ) {
	    var op = olds[ p ].op;
	    var handler = hop_state_history_handler[ op ];

	    if( handler != undefined ) {
	       handler.proc( p, handler.reset );
	    }
	 }
      }

      /* update all the entries that are not */
      /* present and equal in old state      */
      for( p in news ) {
	 var state = news[ p ];
	 if( state instanceof _hop_state_entry ) {
	    if( !(olds[ p ] instanceof _hop_state_entry) ||
		(state.op != olds[ p ].op) ||
		(state.val != olds[ p ].val) ) {
	       var op = state.op;
	       var handler = hop_state_history_handler[ op ];
	       
	       if( (handler != undefined) && !state.close ) {
		  if( handler.proc( p, state.val ) ) {
		     state.close = true;
		  } else {
		     res++;
		  }
	       }
	    }
	 }
      }
   }

   return res;
}

/*---------------------------------------------------------------------*/
/*    hop_hash_history_check_regexp ...                                */
/*---------------------------------------------------------------------*/
var hop_hash_history_check_regexp = new RegExp( "^#(?:[^=]+=[^:]+:[^,]+,?)+$" );

/*---------------------------------------------------------------------*/
/*    hop_hash_historyp ...                                            */
/*    -------------------------------------------------------------    */
/*    Is a hash value a legal Hop history?                             */
/*---------------------------------------------------------------------*/
function hop_hash_historyp( hash ) {
   return hop_hash_history_check_regexp.exec( hash );
}

/*---------------------------------------------------------------------*/
/*    hop_eval_history_counter ...                                     */
/*---------------------------------------------------------------------*/
var hop_eval_history_interval = false;

/*---------------------------------------------------------------------*/
/*    hop_retry_eval_history_state ...                                 */
/*---------------------------------------------------------------------*/
function hop_retry_eval_history_state( count, old_state, new_state ) {
   var fun = function() {
      var c = hop_state_history_update( old_state, new_state );

      /* the interval is cancelled if any of the following holds: */
      /*   * c == 0: the update complete                          */
      /*   * c == count: no progress has been made                */
      /*   * hop_eval_history_interval.invalid == false: the      */
      /*     has changed again.                                   */
      if( (c == 0) || (c == count) || hop_eval_history_interval.invalid ) {
	 /* no progress as been made, or the update */
	 /* complete, we cancel the interval        */
	 clearInterval( hop_eval_history_interval );
      }
   }
   hop_eval_history_interval = setInterval( fun, 200 );
   hop_eval_history_interval.invalid = false;
}

/*---------------------------------------------------------------------*/
/*    hop_eval_history_state ...                                       */
/*    -------------------------------------------------------------    */
/*    This function is invoked when the location has changed.          */
/*---------------------------------------------------------------------*/
function hop_eval_history_state( location ) {
   var hash = location.hash;

   if( hop_eval_history_interval )
      hop_eval_history_interval.invalid = true;
   
   if( hash.length == 0 ) {
      hop_state_history_reset();
   } else {
      if( hop_hash_historyp( hash ) ) {
	 var new_state = hop_location_to_state_history( hash );
	 var old_state = hop_current_state_history;
	 var count = hop_state_history_update( old_state, new_state );

	 if( count == 0 ) {
	    /* the update is complete, we state the new state and exit */
	    hop_current_state_history = new_state;
	 } else {
	    /* periodically retry to update */
	    hop_retry_eval_history_state( count, old_state, new_state );
	 }
      }
   }
}

/*---------------------------------------------------------------------*/
/*    hop_current_history ...                                          */
/*---------------------------------------------------------------------*/
/*** META ((export current-history) (arity #t)) */
function hop_current_history() {
   var hash = location.hash;
   
   if( hash.length == 0 ) {
      return false;
   }

   if( hop_hash_historyp( hash ) ) {
      return hop_location_to_state_history( hash );
   }

   return false;
}

/*---------------------------------------------------------------------*/
/*    hop_replay_history ...                                           */
/*---------------------------------------------------------------------*/
/*** META ((export replay-history) (arity #t)) */
function hop_replay_history( hist ) {
   hop_current_state_history = undefined;
   var loc = function( v ) { this.hash = v; }
   hop_eval_history_state( new loc( hop_state_history_to_location( hist ) ) );
}
   
/*---------------------------------------------------------------------*/
/*    _hop_history ...                                                 */
/*    -------------------------------------------------------------    */
/*    Private constructor.                                             */
/*---------------------------------------------------------------------*/
function _hop_history( key ) {
   this.key = key;
}

/*---------------------------------------------------------------------*/
/*    hop_make_history ...                                             */
/*    -------------------------------------------------------------    */
/*    This is the high level constructor presented to the Hop          */
/*    API.                                                             */
/*---------------------------------------------------------------------*/
/*** META ((export make-history) (arity -3)) */
function hop_make_history( key, handler, reset ) {
   hop_state_history_register_handler( key, reset, handler );
   return new _hop_history( key );
}

/*---------------------------------------------------------------------*/
/*    hop_history_add ...                                              */
/*    -------------------------------------------------------------    */
/*    This high level function for adding an entry into the history.   */
/*---------------------------------------------------------------------*/
/*** META ((export history-add!) (arity #t)) */
function hop_history_add( history, id, val ) {
   if( !history instanceof _hop_history ) {
      alert( "*** ERROR: Illegal history object -- " + history );
      return false;
   } else {
      return hop_state_history_add( id, history.key, val );
   }
}

/*---------------------------------------------------------------------*/
/*    Install the location event listener                              */
/*---------------------------------------------------------------------*/
if( hop_enable_location_event ) {
   if( !hop_location_event_initp ) {
      hop_location_event_initp = true;
      hop_add_event_listener(
	 window, "ready",
	 function( e ) {
	    hop_add_event_listener( document, "location", hop_eval_history_state );
	 } );
   }
}

/*=====================================================================*/
/*    serrano/prgm/project/hop/2.2.x/share/hopscheme.js                */
/*    -------------------------------------------------------------    */
/*    Author      :  Manuel Serrano                                    */
/*    Creation    :  Thu May 24 14:35:05 2007                          */
/*    Last change :  Wed Sep  8 09:02:27 2010 (serrano)                */
/*    Copyright   :  2007-10 Manuel Serrano                            */
/*    -------------------------------------------------------------    */
/*    Hop adpatation of the scheme2js runtime.                         */
/*=====================================================================*/

/*---------------------------------------------------------------------*/
/*    Serialization                                                    */
/*---------------------------------------------------------------------*/
function hop_bigloo_serialize_pair( l ) {
   var res = "";
   var len = 0;

   while (sc_isPair( l ) ) {
      res += hop_bigloo_serialize( l.car );
      l = l.cdr;
      len++;
   }

   if( l == null ) {
      return hop_serialize_word( len + 1 ) + res + ".";
   } else {
      return hop_serialize_word( len + 1 ) + res + hop_bigloo_serialize( l );
   }
}

sc_Pair.prototype.hop_bigloo_serialize = function() {
   return '(' + hop_bigloo_serialize_pair( this );
};

/*---------------------------------------------------------------------*/
/*    typeof                                                           */
/*---------------------------------------------------------------------*/
sc_Pair.prototype.hop_typeof = function() {
   return "pair";
};

sc_Vector.prototype.hop_typeof = function() {
   return "vector";
};

sc_Struct.prototype.hop_typeof = function() {
   return "struct";
};

sc_OutputPort.prototype.hop_typeof = function() {
   return "output-port";
};

sc_StringOutputPort.prototype.hop_typeof = function() {
   return "output-port";
};

sc_GenericOutputPort.prototype.hop_typeof = function() {
   return "output-port";
};

sc_InputPort.prototype.hop_typeof = function() {
   return "input-port";
};

Boolean.prototype.hop_typeof = function() {
   return "bbool";
};

String.prototype.hop_typeof = function() {
    return hop_typeof(this.toString());
};

sc_Char.prototype.hop_typeof = function() {
   return "bchar";
};

]]>
</script>
<script type='text/javascript'>
<![CDATA[

var hop_onerror_handler_hop_exception;
var hop_last_exception_hop_exception;
var BgL_sc_objzd2ze3string_35z31_hop_exception;
var in_exception_report_hop_exception;
var const_hop_exception;
var BgL_sc_const_36z00_hop_exception;
var BgL_sc_const_37z00_hop_exception;
var BgL_sc_const_38z00_hop_exception;
var BgL_sc_const_39z00_hop_exception;
var BgL_sc_const_40z00_hop_exception;
var BgL_sc_const_41z00_hop_exception;
var BgL_sc_const_42z00_hop_exception;
var BgL_sc_const_43z00_hop_exception;
var BgL_sc_const_44z00_hop_exception;
var BgL_sc_const_45z00_hop_exception;
var BgL_sc_const_46z00_hop_exception;
var BgL_sc_const_47z00_hop_exception;
var BgL_sc_const_48z00_hop_exception;
var BgL_sc_const_49z00_hop_exception;
var BgL_sc_const_50z00_hop_exception;
var BgL_sc_const_51z00_hop_exception;
var BgL_sc_const_52z00_hop_exception;
var BgL_sc_const_53z00_hop_exception;
var BgL_sc_const_54z00_hop_exception;
var BgL_sc_const_55z00_hop_exception;
var BgL_sc_const_56z00_hop_exception;
var BgL_sc_const_57z00_hop_exception;
var BgL_sc_const_58z00_hop_exception;
var hop_get_stack;
var hop_report_exception;
var hop_mangledp;
var hop_demangle;
var hop_make_exception_stack;
var hop_make_exception_frame;
const_hop_exception = "position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    opacity: 0.8;\n    background: #242222;\n    z-index: 1000000";
BgL_sc_const_36z00_hop_exception = "font-family: arial; font-size: 10pt; overflow: visible";
BgL_sc_const_37z00_hop_exception = "font-family: monospace; color: #777";
BgL_sc_const_38z00_hop_exception = "at ([^ ]+) [(]([^ ]+)(:[0-9]+:[0-9]+)[)]";
BgL_sc_const_39z00_hop_exception = "font-size: 9pt; padding-left: 1em";
BgL_sc_const_40z00_hop_exception = "data:image\u002fpng;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A\u002fwD\u002foL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kGBA8VBixNgawAAAsWSURBVGje7Zp5cF3Vfcc\u002fd3mbnlZbq2VJlrUvXrRhG8dyhKG2jI1jEuMQwDZ2CyYQoCYdSGmBYJrJZDqdadKmSUM7nZBJZrJM2sKUUuI07bBMp9OEmJIGgsHxgm1ZSA9J795379n6x32WZSy3BmxwJtyZ39zfO+fe3znf3+\u002f3Ped37jzLGMNv8mXzG359COCDvtxTyvcs60LajQF3a7jRQMKBxxV8wcD4hRrg+jx33YvkmC9q2FNSXooTizF27GSbgS7g44B\u002fqafQKgV75i\u002ftYOjrX2Ho0b+ibfijSBjWsN0AF0IuFoC4hr1x16Z713YSy4dwuwZov+kmCkvSSHhAwTwFvFe5WAC2aFjdcPkAJauuhMksZMZJNnXStvYKNNRouE0D71UuBoACDfcVlRbSuWsHFJSAl4VcDpSh9ZqPUbVgPiHcrqD9UozA7xvobtu4jlTvCvA9CMNIPB+3opbF1wzjOnaZgocvNQ40SLi7vKGGxi1bwIqB758GEAYQhNT2L6ehuw0BmxWsvZRS6PMGyps3DOMu7IhSR4gZAELwfaxEIe0fHSRmW66ChzXYlwKAHgFbazuaqFu\u002fEUIZ5X0QRFHwvOh3GILnUdPSQfuyHgRcpmDLBePAu8xFV8Ejrmsnu2\u002fYilNTD9lsNNkgICwtJaysxCgVgcjlsHBZPLiK0pIiBHxRQcUHCWCDhPXNq1cw9yNDkIsmjucRVlXhL12K199P0NFxRlRKyqpYsnIAAws07PqgUsjWsCeVStCyeTOkiqOVJwgwjoNqbCTmusQtC9XSgi4ujtIpDCEnaGnvYk55GQI+raHyPQN4F97fLmHVwtUrKFrUA54\u002f7X1VW4tTWkoiHicZjxMrLET19kbEzuUg8CmIpVjSvxQsq07DH7\u002ffESiTcH9peSntH782WjZzPvg+Jp2G1lbitk0YBGSzWeKA3dmJbmzMc0SA59O+YCF1dTWEcLOGpe8nBx5W0NS2\u002fipSLd2QjVKHMISuLtxUCiEEruuSTCYRQmDbNta6dZBIRKkU5EgI6OnqxLGttII\u002fM2C9HynULODmqvoaFly1FqSGIBd5tqoKq76e2c7ZmUwGq6IC+vpgcjIfBY+FZXNobWkkhCENV130FDLwOQvSXZuuJl5dl\u002fdmAEpBe\u002fs533NOHZgGB6GoaJrQbjagf2EjBckEEr6go5rqokVgpYAdDT2d1A4OQaiiyWez0NAANTUAWLOc7hLJZKRUVMDwMExNTe\u002fQtbgsaWtCQp+GGy9WMZfW8KVEImZ3fewa7MKyqGTwfYjHYcmSWaLlY\u002fIHMNueMdSaNdDaGqWSEFgTU\u002fSWlVFWlEbAQwYWvONi7jy8\u002fykBly9c3sfcxX3gzSgXFi2CkpLIjon8Y5QGEwcTj\u002fQzCu8CuPFGkHJ6h56bzdHXWI+xrBoFd17QFALSEu4qLimkc+PVEC+MKkzfh3Qa09aWt6LRhCidw3JsLMuJxLFxYhZGzxi6pwcWL4aJiQjIRJaegjS15WWEsEND2wUjsYE9Brrahlbijh8leO7JaNdVBtXVhUkk8iuPhWOlcGzYv\u002f9n3Hfv\u002fTz40F5eO\u002fQrbBRYFqcWKGPb6J07IRYH3yfjZXhTZulrbiTu2GUSHjkfDpzPV4lKAXdUNtSyYGkn\u002fk++j\u002fz1YdzaJgqu3YnT3Y2DzhM3Iu+TTz3PjhtuYuTNLJZl8Xd\u002f\u002fXX+5pvfZt3wGoQICW1JgROHvj6mhj7CoUe\u002fxsm4wH4jQ11HL83Vlfz86PFNMegFfnpeXyXOlT4a7jRQ2bzyMqw3XkUdPYx2wT9wAH9+JZMhGJUDLDSC\u002f37xCW79vc8wMn4cmyy2meDY2Bi7dt3KCz\u002f7AaOZgE9ccR3PPPNztDH4n9zKSIGFlhB6OcaPHaGrtoakY8ckfF6B81524n4Bn21Y1M68+gpy\u002f\u002fVvKED74Kwfxrn6WgpcjdBgjMfBIyN8YsuDHD78EpaxMZaFtgAtOXbsAJs23cuj33iMw2Nj3HLLTvY9\u002fQxFl62k+ra7kX6U26PHjlCEpLe+FgkbDHzyXa1CgKNhb8x1Eu2rV6BffwmZmcBoMOk4uevvATeN9gNs4\u002fLCi6+z8Xc2cPD1X1JeXIaFBkTeWgxwOHb4dR584C7K0i7f+c73aagrIsjmKN++m0RrHToAKTWjJ96gvWIuJfEYAvZqqHjHJDawUcC6+d1tlKRdwpdfwFigc8DWbTw3Kblr932ENjz4yJ\u002fS37OEBQ3d\u002fPLVgzy+71lq5zdgTBzbaJLJFHPnVqGw6O9dwRP\u002fso\u002fWtmpq6xeihIdTU0vlZ\u002f4ArSO4mfFxyHksrq5EQaOa5czw\u002fwGwFOxJFaToHFyOfOk\u002fkBNZjAJdUYLefCtXDA5QkjI01czjR0\u002f+I0\u002f964v88B\u002fuZ35NGQM9Dfzq0Mts+9RNKOLs3rWdv\u002fzqV9i0cStPPfsjUgmNpR20EhgtEVOTFK29hkR3G8qPonD82FE655RSnUoSRmeGinfCgd0KVrWvHKDQFuQO\u002fAJjgxIgNu9AVtcjPY\u002fPPXAvr\u002fz6IE8\u002f\u002fc8s65mPlPX4chRj4mhvnK89+mWWLh2gf3ANRw+d5M\u002f\u002f9ssk5AlEGBLIKZS0UBJkEKAL0sy57W5M3AEDE1NZ\u002fKkJltVU4lpWnYw+ApzXRlYt4I\u002fKa6po7ltEbv9zqJzEBCBbWwiu\u002fV2Un0VJiZAKKSVSBgQiIBQelknj+5NokwIm+PQd9\u002fDTZx\u002fn1tvXU5FOYFOOUgotDEqpaRFTkxRcOUz6yjXThD46coK6ZJzmokLCKI1W\u002fp8RyN8f0DCveXkv9uhhwkMHIu+7LlNbbkEkU8hcDiElSiqEEIShQkuJUmAkeH4OISRh6NDSVsd3v\u002fsE33vieY4cHWMyN4mQkkAowjBECIEQApmX4p27cSpLMRKyuZDRzDhLykqIWVZMwZ8YsM\u002f5YctAk4Bt1fW1zF8wD3\u002f\u002fcygdTUpWVRAODCGzWYSUSCmjgaVEa41SBplT5IIcqVSSkZERTpwYYc6cOHfc8xA\u002f\u002fvvn2Xr9Njo7utl23Q1k3vJR6lQEIwk9D6eplVhnB0pETj06Nk6ZBYuKCwlgtYYrz7kTa\u002fhD27LSXatXwPHXECOjGBeMBsYzOK+8iBxYjcCA62JcF2IuxnExjoPjOBhL4NtJalqbyPkCoRS3f7YZ37cxegKt04yO+hSWOCglUUKilUIJAYB89RWCQ4cxdgQgJzQjb71FX3Eh\u002fzOVZVLpvQ48A3hnADAwKGFHy+IOKqtKmfrxPrQF2hAZ83xSX7qHcPUGdLIArQ3StlG2DZYdlRKWBcbC2JGK5WA0jBgFGrS20EZjDExpjdYGpTVKaZQxGKWZ\u002fMk+goNHMG40tgUcn5pibjLFsqJCnspMXGbDDcA3zgCgYE8ylbTbL+8j+MV\u002fIt8cRzuR97Uh0k+O4T72TXS+TRlQp\u002frN6TZtQOOglYqcoMC4IMPp8mRazvptgYmdtmeAQBpeG8\u002fQXlLMftflhJQ3zwago6h8Dinp4R18GePakTEzQ2IRkGiCUdvp5SsazTrFMqPzs4n6tQanIO\u002fVGaLftn7r\u002fFgzmelgkQkEXi6gOubwhpS1Z3HAggMTY5nWyQmP4mVrUUpj9CmJwjut67fps\u002fUpjTGn+\u002fUZ70Vhi57J96nT7Xqmjfx7aE2gNceFxIGR2Uj8F17WG\u002f73p59n7rzqaPAZoqd1ztE+Sz\u002f5fm3e1sZZ9iNbZ9s+FX4Lw0mhGJEKB751FgAD\u002f2TBdWNjmTtHxjKNGhyTX4BmlNZn3M3bcnm2Z871zrnuM\u002fVZav\u002fjLjwGfHU6cz78r8SHAH7LAfwv3UC6JoGBIwEAAAAASUVORK5CYII=";
BgL_sc_const_41z00_hop_exception = "font-weight: bold";
BgL_sc_const_42z00_hop_exception = "color: red; font-weight: bold";
BgL_sc_const_43z00_hop_exception = "border-top: 1px dashed #ccc; margin-top: 2ex";
BgL_sc_const_44z00_hop_exception = "font-weight: bold; margin-bttom: 1ex;";
BgL_sc_const_45z00_hop_exception = "font-size: 9pt; padding-left: 1em;";
BgL_sc_const_46z00_hop_exception = "[(]at ([^ ]+) ([^ ]+)[)]";
BgL_sc_const_47z00_hop_exception = "width: 100%; font-size: 9pt; overflow: visible; padding-left: 1em";
BgL_sc_const_48z00_hop_exception = "margin:0; padding: 0";
BgL_sc_const_49z00_hop_exception = "font-size: 20pt; padding-bottom: 4px";
BgL_sc_const_50z00_hop_exception = "JavaScript stack:";
BgL_sc_const_51z00_hop_exception = "Hop client stack:";
BgL_sc_const_52z00_hop_exception = "width: 100%; font-family: arial; font-size: 10pt; background: #FFFFF7; border-bottom: 1px solid #ccc; overflow: visible";
BgL_sc_const_53z00_hop_exception = "font-family: monospace; font-size: 10pt";
BgL_sc_const_54z00_hop_exception = "height: 64px; vertical-align: top; padding-top: 10px; text-align: center";
BgL_sc_const_55z00_hop_exception = "font-family: arial; font-size: 10pt; padding: 5px";
BgL_sc_const_56z00_hop_exception = "color: #777; font-weight: bold";
BgL_sc_const_57z00_hop_exception = "position: fixed;\n    top: 60px;\n    bottom: 60px;\n    left: 150px;\n    right: 150px;\n    min-width: 20em;\n    max-width: 100em;\n    opacity: 0.97;\n    background: white;\n    z-index: 10000001;\n    text-align: left;\n    border: 3px dashed red; padding: 4px;\n    color: black;\n    overflow: hidden;\n    overflow-y: auto;";
BgL_sc_const_58z00_hop_exception = "HopClientSideError";
sc_tmp = hop_mangledp = function(string) {
      var tmp3461;
      var tmp3460;
      var tmp3459;
      var len;
      len = string.length;
      if (len > 7) {
        tmp3459 = sc_arity_check(sc_isSubstring, 3)(string, "BgL_", 4);
        if ((tmp3459 !== false? tmp3459: sc_arity_check(sc_isSubstring, 3)(string, "BGl_", 4)) !== false) {
          if (sc_arity_check(sc_stringRef, 2)(string, len - 3).val === new sc_Char("z").val) {
            tmp3460 = sc_arity_check(sc_isCharAlphabetic, 1)(sc_arity_check(sc_stringRef, 2)(string, len - 2));
            if ((tmp3460 !== false? tmp3460: SC_NUMBER_CLASS.indexOf(sc_arity_check(sc_stringRef, 2)(string, len - 2).val) != -1) !== false) {
              tmp3461 = sc_arity_check(sc_isCharAlphabetic, 1)(sc_arity_check(sc_stringRef, 2)(string, len - 1));
              if (tmp3461 !== false) {
                return tmp3461;
              } else {
                return SC_NUMBER_CLASS.indexOf(sc_arity_check(sc_stringRef, 2)(string, len - 1).val) != -1;
              }
            } else {
              return false;
            }
          } else {
            return false;
          }
        } else {
          return false;
        }
      } else {
        return false;
      }
    }, sc_tmp.name = "bigloo-mangled?", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 6903)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_demangle = function(string) {
      var get_8bits_integer;
      var subvector;
      var bigloo_demangle_at;
      var clen;
      var len;
      len = string.length;
      clen = len - 3;
      sc_tmp = get_8bits_integer = function(r) {
            var i2;
            var i1;
            var c2;
            var c1;
            c1 = sc_arity_check(sc_stringRef, 2)(string, r + 1);
            c2 = sc_arity_check(sc_stringRef, 2)(string, r + 2);
            if (SC_NUMBER_CLASS.indexOf(c1.val) != -1) {
              i1 = c1.val.charCodeAt(0) - new sc_Char("0").val.charCodeAt(0);
            } else {
              i1 = 10 + (c1.val.charCodeAt(0) - new sc_Char("a").val.charCodeAt(0));
            }
            if (SC_NUMBER_CLASS.indexOf(c2.val) != -1) {
              i2 = c2.val.charCodeAt(0) - new sc_Char("0").val.charCodeAt(0);
            } else {
              i2 = 10 + (c2.val.charCodeAt(0) - new sc_Char("a").val.charCodeAt(0));
            }
            return i1 + (i2 << 4);
          }, sc_tmp.name = "get-8bits-integer", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 7848)", sc_tmp.sc_arity = 1, sc_tmp;
      sc_tmp = subvector = function(vec, len) {
            var i;
            var l;
            var g3463;
            var g3462;
            g3462 = len - 1;
            g3463 = null;
            i = g3462;
            l = g3463;
            while (!(i === -1)) {
              l = new sc_Pair(vec[i], l);
              --i;
            }
            return sc_arity_check(sc_list2string, 1)(l);
          }, sc_tmp.name = "subvector", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 8045)", sc_tmp.sc_arity = 2, sc_tmp;
      sc_tmp = bigloo_demangle_at = function(offset) {
            var nc;
            var i;
            var c;
            var r;
            var w;
            var checksum;
            var new_1;
            new_1 = sc_arity_check(sc_makeVector, 1)(clen);
            r = offset;
            w = 0;
            checksum = 0;
            while (!(r === clen)) {
              c = sc_arity_check(sc_stringRef, 2)(string, r);
              if (c.val === new sc_Char("z").val) {
                if (sc_arity_check(sc_stringRef, 2)(string, r + 1).val === new sc_Char("z").val) {
                  return new sc_Values([sc_arity_check(subvector, 2)(new_1, w - 1), r + 2]);
                } else {
                  i = sc_arity_check(get_8bits_integer, 1)(r);
                  nc = new sc_Char(String.fromCharCode(i));
                  new_1[w] = nc;
                  r += 3;
                  ++w;
                  checksum ^= i;
                }
              } else {
                new_1[w] = c;
                ++r;
                ++w;
              }
            }
            if (checksum === sc_arity_check(get_8bits_integer, 1)(r)) {
              return new sc_Values([sc_arity_check(subvector, 2)(new_1, w), r + 3]);
            } else {
              return new sc_Values([string, r + 3]);
            }
          }, sc_tmp.name = "bigloo-demangle-at", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 8206)", sc_tmp.sc_arity = 1, sc_tmp;
      if (sc_arity_check(hop_mangledp, 1)(string) === false) {
        return string;
      } else {
        if (sc_arity_check(sc_isSubstring, 3)(string, "BgL_", 4) !== false) {
          return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                      return sc_arity_check(bigloo_demangle_at, 1)(4);
                    }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(str, offset) {
                      return str;
                    }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
        } else {
          if (sc_arity_check(sc_isSubstring, 3)(string, "BGl_", 4) !== false) {
            return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                        return sc_arity_check(bigloo_demangle_at, 1)(4);
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(id, offset) {
                        return sc_arity_check(sc_callWithValues, 2)((sc_tmp = function() {
                                    return sc_arity_check(bigloo_demangle_at, 1)(offset);
                                  }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 0, sc_tmp), (sc_tmp = function(module, offset) {
                                    return id + "@" + module;
                                  }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 2, sc_tmp));
          } else {
            return string;
          }
        }
      }
    }, sc_tmp.name = "bigloo-demangle", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 7582)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_get_stack = function(offset) {
      var depth = null;
      for (var sc_tmp = arguments.length - 1; sc_tmp >= 1; --sc_tmp) {
        depth = sc_cons(arguments[sc_tmp], depth);
      }
      var frame;
      var caller;
      var n;
      var stack;
      var g3466;
      var g3465;
      var proc;
      var offset_2;
      var g3464;
      g3464 = arguments.callee;
      proc = g3464;
      offset_2 = offset;
      while (!(offset_2 === 0)) {
        if (proc !== false) {
          proc = proc.caller;
          --offset_2;
        } else {
          return null;
        }
      }
      if (depth instanceof sc_Pair) {
        g3465 = depth.car;
      } else {
        g3465 = 10;
      }
      g3466 = null;
      caller = proc;
      n = g3465;
      stack = g3466;
      while (caller && n > 0) {
        frame = new sc_Pair(caller, sc_arity_check(sc_vector2list, 1)(caller.arguments));
        caller = caller.caller;
        --n;
        stack = new sc_Pair(frame, stack);
      }
      return sc_arity_check(sc_reverseBang, 1)(stack);
    }, sc_tmp.name = "hop-get-stack", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 9757)", sc_tmp.sc_arity = -2, sc_tmp;
in_exception_report_hop_exception = "\uEBACno";
sc_tmp = hop_make_exception_frame = function() {
      var args = null;
      for (var sc_tmp = arguments.length - 1; sc_tmp >= 0; --sc_tmp) {
        args = sc_cons(arguments[sc_tmp], args);
      }
      var stmp;
      var g3467;
      var g3470;
      var g3468;
      var g3469;
      var mask;
      g3467 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", const_hop_exception, "");
      mask = g3467;
      g3469 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", "overflow: auto", args);
      stmp = g3469;
      g3468 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_57z00_hop_exception, stmp);
      g3470 = sc_arity_check(dom_create, 3)("div", mask, g3468);
      sc_arity_check(hop_add_event_listener, 3)(g3470, "click", (sc_tmp = function(event) {
            var g3471;
            in_exception_report_hop_exception = "\uEBACno";
            g3471 = this.parentNode.removeChild(this);
            if (g3471 !== false) {
              false;
            } else {
              sc_arity_check(hop_stop_propagation, 2)(event, false);
            }
            return g3471;
          }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
      return g3470;
    }, sc_tmp.name = "<EXCEPTION-FRAME>", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 10996)", sc_tmp.sc_arity = -1, sc_tmp;
sc_tmp = BgL_sc_objzd2ze3string_35z31_hop_exception = function(o, longp) {
      var stmp;
      var g3475;
      var g3477;
      var m;
      var name;
      var g3473;
      if (typeof o === 'function') {
        if (!sc_arity_check(sc_isString, 1)(o.name)) {
          name = sc_arity_check(sc_withOutputToString, 1)((sc_tmp = function() {
                  return sc_arity_check(sc_write, 1)(o);
                }, sc_tmp.name = "", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 11706)", sc_tmp.sc_arity = 0, sc_tmp));
        } else {
          if (o.name.length > 0) {
            name = o.name;
          } else {
            g3473 = sc_arity_check(dom_create, 2)("i", "anonymous");
            name = g3473;
          }
        }
        if (longp && sc_arity_check(sc_isString, 1)(o.location)) {
          m = sc_arity_check(sc_pregexpMatch, 2)(BgL_sc_const_46z00_hop_exception, o.location);
          if (m !== false) {
            g3477 = sc_arity_check(dom_create, 8)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", m.cdr.car, m.cdr.car, "!", m.cdr.cdr.car);
            stmp = g3477;
            g3475 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp, ", ");
            return sc_arity_check(sc_list, 4)(g3475, "(", name, " ...)");
          } else {
            return sc_arity_check(sc_list, 3)("(", name, " ...)");
          }
        } else {
          if (longp !== false) {
            return sc_arity_check(sc_list, 3)("(", name, " ...)");
          } else {
            return name;
          }
        }
      } else {
        if (sc_arity_check(sc_isString, 1)(o)) {
          return o;
        } else {
          return sc_arity_check(sc_withOutputToString, 1)((sc_tmp = function() {
                      return sc_arity_check(sc_write, 1)(o);
                    }, sc_tmp.name = "", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 12279)", sc_tmp.sc_arity = 0, sc_tmp));
        }
      }
    }, sc_tmp.name = "obj->string", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 11544)", sc_tmp.sc_arity = 2, sc_tmp;
sc_tmp = hop_make_exception_stack = function(stack) {
      var stmp;
      var stmp_3;
      var stmp_4;
      var stmp_5;
      var frame;
      var tail3535;
      var L3531;
      var falseHead3534;
      var g3481;
      var g3479;
      var g3478;
      falseHead3534 = new sc_Pair(null, null);
      tail3535 = falseHead3534;
      L3531 = stack;
      while (!(L3531 === null)) {
        frame = L3531.car;
        stmp_4 = new sc_Pair(sc_arity_check(sc_list, 2)(sc_arity_check(BgL_sc_objzd2ze3string_35z31_hop_exception, 2)(frame.car, true), "\n"), null);
        tail3535.cdr = stmp_4;
        tail3535 = tail3535.cdr;
        L3531 = L3531.cdr;
      }
      stmp_3 = falseHead3534.cdr;
      g3481 = sc_arity_check(dom_create, 4)("pre", "\uEBADstyle", BgL_sc_const_45z00_hop_exception, stmp_3);
      sc_arity_check(hop_add_event_listener, 3)(g3481, "click", (sc_tmp = function(event) {
            var g3482;
            g3482 = sc_arity_check(hop_stop_propagation, 1)(event);
            if (g3482 !== false) {
              false;
            } else {
              sc_arity_check(hop_stop_propagation, 2)(event, false);
            }
            return g3482;
          }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
      stmp = g3481;
      g3479 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_44z00_hop_exception, BgL_sc_const_51z00_hop_exception);
      stmp_5 = g3479;
      g3478 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_55z00_hop_exception, stmp_5, stmp);
      return g3478;
    }, sc_tmp.name = "<EXCEPTION-STACK>", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 12516)", sc_tmp.sc_arity = 1, sc_tmp;
sc_tmp = hop_report_exception = function(exc) {
      var stmp;
      var stmp_6;
      var stmp_7;
      var stmp_8;
      var stmp_9;
      var stmp_10;
      var stmp_11;
      var stmp_12;
      var stmp_13;
      var stmp_14;
      var stmp_15;
      var stmp_16;
      var stmp_17;
      var stmp_18;
      var stmp_19;
      var stmp_20;
      var stmp_21;
      var stmp_22;
      var stmp_23;
      var stmp_24;
      var stmp_25;
      var stmp_26;
      var stmp_27;
      var stmp_28;
      var stmp_29;
      var stmp_30;
      var stmp_31;
      var stmp_32;
      var stmp_33;
      var stmp_34;
      var stmp_35;
      var stmp_36;
      var stmp_37;
      var stmp_38;
      var stmp_39;
      var stmp_40;
      var stmp_41;
      var stmp_42;
      var stmp_43;
      var stmp_44;
      var stmp_45;
      var g3485;
      var g3486;
      var m;
      var g3483;
      var g3484;
      var href;
      var l;
      var i;
      var f;
      var tail3540;
      var L3536;
      var falseHead3539;
      var g3490;
      var g3489;
      var g3488;
      var l_46;
      var s;
      var s_47;
      var tail3550;
      var L3546;
      var s_48;
      var tail3545;
      var L3541;
      var g3518;
      var g3525;
      var g3487;
      var stack;
      var tmp3526;
      var g3524;
      var g3519;
      var g3521;
      var g3522;
      var g3523;
      var g3520;
      var g3497;
      var g3502;
      var g3506;
      var g3507;
      var g3516;
      var g3517;
      var g3514;
      var g3515;
      var g3511;
      var g3512;
      var g3513;
      var g3508;
      var g3509;
      var g3510;
      var g3503;
      var g3505;
      var g3499;
      var g3501;
      var src;
      var g3496;
      var g3495;
      var g3494;
      var location;
      var url;
      var name;
      var msg;
      var g3493;
      var message;
      var L3546_49;
      var falseHead3549;
      var L3541_50;
      var falseHead3544;
      var e;
      var e_51;
      var e_52;
      var tmp3527;
      if (in_exception_report_hop_exception === "\uEBACyes") {
        return sc_arity_check(sc_raise, 1)(exc);
      } else {
        if (document.body && !(document.body === null)) {
          in_exception_report_hop_exception = "\uEBACyes";
          tmp3527 = exc === false;
          if ((tmp3527 !== false? tmp3527: exc === undefined) !== false) {
            e_52 = new Error();
            e_52.message = "unknown error";
            e = e_52;
          } else {
            if (sc_arity_check(sc_isString, 1)(exc)) {
              e_51 = new Error();
              e_51.message = exc;
              e = e_51;
            } else {
              e = exc;
            }
          }
          if (!("message" in e)) {
            message = "unknwown error";
          } else {
            if (sc_arity_check(sc_isString, 1)(e.message)) {
              falseHead3544 = new sc_Pair(null, null);
              L3541_50 = sc_arity_check(sc_stringSplit, 2)(e.message, "\n ");
              tail3545 = falseHead3544;
              L3541 = L3541_50;
              while (!(L3541 === null)) {
                s_48 = L3541.car;
                stmp_45 = new sc_Pair(sc_arity_check(hop_demangle, 1)(s_48) + " ", null);
                tail3545.cdr = stmp_45;
                tail3545 = tail3545.cdr;
                L3541 = L3541.cdr;
              }
              stmp_44 = falseHead3544.cdr;
              message = sc_arity_check(sc_apply, 2)(sc_stringAppend, stmp_44);
            } else {
              if (sc_arity_check(sc_isSymbol, 1)(e.message)) {
                message = e.message.slice(1);
              } else {
                if (sc_arity_check(sc_isKeyword, 1)(e.message)) {
                  message = e.message.slice(1);
                } else {
                  if (sc_arity_check(sc_isNumber, 1)(e.message)) {
                    message = e.message;
                  } else {
                    if (!(e.message === undefined)) {
                      message = sc_arity_check(BgL_sc_objzd2ze3string_35z31_hop_exception, 2)(e.message, false);
                    } else {
                      if (sc_arity_check(sc_isString, 1)(e.description)) {
                        falseHead3549 = new sc_Pair(null, null);
                        L3546_49 = sc_arity_check(sc_stringSplit, 2)(e.description, "\n ");
                        tail3550 = falseHead3549;
                        L3546 = L3546_49;
                        while (!(L3546 === null)) {
                          s_47 = L3546.car;
                          stmp_43 = new sc_Pair(sc_arity_check(hop_demangle, 1)(s_47) + " ", null);
                          tail3550.cdr = stmp_43;
                          tail3550 = tail3550.cdr;
                          L3546 = L3546.cdr;
                        }
                        stmp_42 = falseHead3549.cdr;
                        message = sc_arity_check(sc_apply, 2)(sc_stringAppend, stmp_42);
                      } else {
                        message = "unknwown error";
                      }
                    }
                  }
                }
              }
            }
          }
          if (e && "scObject" in e) {
            g3493 = sc_arity_check(dom_create, 2)("tt", sc_arity_check(BgL_sc_objzd2ze3string_35z31_hop_exception, 2)(e.scObject, false));
            stmp_41 = g3493;
            msg = sc_arity_check(sc_list, 3)(message, " -- ", stmp_41);
          } else {
            msg = message;
          }
          if (sc_arity_check(sc_isString, 1)(e.name)) {
            name = e.name;
          } else {
            if (e.name === undefined) {
              name = BgL_sc_const_58z00_hop_exception;
            } else {
              name = sc_arity_check(BgL_sc_objzd2ze3string_35z31_hop_exception, 2)(e.name, false);
            }
          }
          if (sc_arity_check(sc_isString, 1)(e.fileName)) {
            url = e.fileName;
          } else {
            url = document.location.href;
          }
          if (sc_arity_check(sc_isString, 1)(e.hopLocation)) {
            location = e.hopLocation;
          } else {
            location = "Client Error";
          }
          if (e.lineNumber && !(e.lineNumber === undefined)) {
            g3494 = sc_arity_check(dom_create, 4)("a", "\uEBADhref", url, url);
            src = sc_arity_check(sc_list, 3)(g3494, ", line ", e.lineNumber);
          } else {
            if (e.line && !(e.line === undefined)) {
              g3495 = sc_arity_check(dom_create, 4)("a", "\uEBADhref", url, url);
              src = sc_arity_check(sc_list, 3)(g3495, ", line ", e.line);
            } else {
              g3496 = sc_arity_check(dom_create, 3)("a", "\uEBADhref", url);
              src = g3496;
            }
          }
          if (sc_arity_check(sc_isString, 1)(e.stack)) {
            stack = e.stack;
            g3487 = sc_arity_check(sc_stringSplit, 2)(stack, "\n");
            BgL_whilezd2break3598zd2: {
              l_46 = g3487;
              s = 2;
              while (!(l_46 === null)) {
                if (s === 0) {
                  falseHead3539 = new sc_Pair(null, null);
                  tail3540 = falseHead3539;
                  L3536 = l_46;
                  while (!(L3536 === null)) {
                    f = L3536.car;
                    i = sc_arity_check(sc_stringIndex, 2)(f, new sc_Char("@"));
                    l = f.length;
                    if (i !== false) {
                      href = f.substring(i + 1, l);
                      g3484 = sc_arity_check(dom_create, 6)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", href, href);
                      stmp_14 = g3484;
                      g3483 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp_14, ", ");
                      stmp_12 = sc_arity_check(sc_list, 3)(g3483, f.substring(0, i), "\n");
                    } else {
                      m = sc_arity_check(sc_pregexpMatch, 2)(BgL_sc_const_38z00_hop_exception, f);
                      if (m !== false) {
                        g3486 = sc_arity_check(dom_create, 9)("a", "\uEBADstyle", "color: inherit", "\uEBADhref", m.cdr.cdr.car, m.cdr.car, "!", m.cdr.cdr.car, m.cdr.cdr.cdr.car);
                        stmp_13 = g3486;
                        g3485 = sc_arity_check(dom_create, 5)("span", "\uEBADstyle", "color: #777", stmp_13, ", ");
                        stmp_12 = sc_arity_check(sc_list, 4)(g3485, "(", m.cdr.car, " ...)\n");
                      } else {
                        stmp_12 = sc_arity_check(sc_list, 2)(f, "\n");
                      }
                    }
                    stmp_11 = new sc_Pair(stmp_12, null);
                    tail3540.cdr = stmp_11;
                    tail3540 = tail3540.cdr;
                    L3536 = L3536.cdr;
                  }
                  stmp_10 = falseHead3539.cdr;
                  g3490 = sc_arity_check(dom_create, 4)("pre", "\uEBADstyle", BgL_sc_const_39z00_hop_exception, stmp_10);
                  sc_arity_check(hop_add_event_listener, 3)(g3490, "click", (sc_tmp = function(event) {
                        var g3491;
                        g3491 = sc_arity_check(hop_stop_propagation, 1)(event);
                        if (g3491 !== false) {
                          false;
                        } else {
                          sc_arity_check(hop_stop_propagation, 2)(event, false);
                        }
                        return g3491;
                      }, sc_tmp.name = "", sc_tmp.location = "#f", sc_tmp.sc_arity = 1, sc_tmp));
                  stmp_9 = g3490;
                  g3489 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_41z00_hop_exception, BgL_sc_const_50z00_hop_exception);
                  stmp_15 = g3489;
                  g3488 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_55z00_hop_exception, stmp_15, stmp_9);
                  {
                    stmp_8 = g3488;
                    break BgL_whilezd2break3598zd2;
                  }
                } else {
                  l_46 = l_46.cdr;
                  --s;
                }
              }
              stmp_8 = "";
            }
            if (e.hopService !== false) {
              tmp3526 = !(e.hopService === undefined);
            } else {
              tmp3526 = false;
            }
            if ((tmp3526 !== false? tmp3526: e.hopStack instanceof sc_Pair) !== false) {
              stmp_16 = BgL_sc_const_43z00_hop_exception;
            } else {
              stmp_16 = "margin-top: 2ex";
            }
            g3525 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", stmp_16, stmp_8);
            stmp_7 = g3525;
          } else {
            stmp_7 = false;
          }
          if (e.hopStack instanceof sc_Pair) {
            g3524 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", e.hopService && !(e.hopService === undefined)? BgL_sc_const_43z00_hop_exception: "margin-top: 2ex", sc_arity_check(hop_make_exception_stack, 1)(e.hopStack));
            stmp_18 = g3524;
          } else {
            stmp_18 = false;
          }
          if (e.hopService && !(e.hopService === undefined)) {
            g3523 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", "font-size: 10pt", sc_arity_check(BgL_sc_objzd2ze3string_35z31_hop_exception, 2)(e.hopService, false));
            stmp_22 = g3523;
            g3522 = sc_arity_check(dom_create, 2)("tr", stmp_22);
            stmp_21 = g3522;
            g3521 = sc_arity_check(dom_create, 4)("table", "\uEBADstyle", BgL_sc_const_47z00_hop_exception, stmp_21);
            stmp_20 = g3521;
            g3520 = sc_arity_check(dom_create, 4)("div", "\uEBADstyle", BgL_sc_const_41z00_hop_exception, "Service:");
            stmp_23 = g3520;
            g3519 = sc_arity_check(dom_create, 5)("div", "\uEBADstyle", BgL_sc_const_55z00_hop_exception, stmp_23, stmp_20);
            stmp_19 = g3519;
          } else {
            stmp_19 = false;
          }
          g3518 = sc_arity_check(dom_create, 6)("div", "\uEBADstyle", BgL_sc_const_36z00_hop_exception, stmp_19, stmp_18, stmp_7);
          stmp_6 = g3518;
          g3517 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_37z00_hop_exception, sc_arity_check(hop_properties_to_string, 1)(e));
          stmp_28 = g3517;
          g3516 = sc_arity_check(dom_create, 2)("tr", stmp_28);
          stmp_27 = g3516;
          g3515 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_53z00_hop_exception, src);
          stmp_30 = g3515;
          g3514 = sc_arity_check(dom_create, 2)("tr", stmp_30);
          stmp_29 = g3514;
          g3513 = sc_arity_check(dom_create, 4)("span", "\uEBADstyle", BgL_sc_const_56z00_hop_exception, name);
          stmp_33 = g3513;
          g3512 = sc_arity_check(dom_create, 6)("td", "\uEBADstyle", "font-size: 11pt", stmp_33, ": ", msg);
          stmp_32 = g3512;
          g3511 = sc_arity_check(dom_create, 2)("tr", stmp_32);
          stmp_31 = g3511;
          g3510 = sc_arity_check(dom_create, 4)("span", "\uEBADstyle", BgL_sc_const_42z00_hop_exception, location);
          stmp_36 = g3510;
          g3509 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_49z00_hop_exception, stmp_36);
          stmp_35 = g3509;
          g3508 = sc_arity_check(dom_create, 2)("tr", stmp_35);
          stmp_34 = g3508;
          g3507 = sc_arity_check(dom_create, 7)("table", "\uEBADstyle", "width: 100%", stmp_34, stmp_31, stmp_29, stmp_27);
          stmp_26 = g3507;
          g3506 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_48z00_hop_exception, stmp_26);
          stmp_25 = g3506;
          g3505 = sc_arity_check(dom_create, 5)("img", "\uEBADsrc", BgL_sc_const_40z00_hop_exception, "\uEBADalt", "Error");
          stmp_38 = g3505;
          g3503 = sc_arity_check(dom_create, 4)("td", "\uEBADstyle", BgL_sc_const_54z00_hop_exception, stmp_38);
          stmp_37 = g3503;
          g3502 = sc_arity_check(dom_create, 3)("tr", stmp_37, stmp_25);
          stmp_24 = g3502;
          g3501 = sc_arity_check(dom_create, 3)("col", "\uEBADwidth", "64px");
          stmp_40 = g3501;
          g3499 = sc_arity_check(dom_create, 2)("colgroup", stmp_40);
          stmp_39 = g3499;
          g3497 = sc_arity_check(dom_create, 5)("table", "\uEBADstyle", BgL_sc_const_52z00_hop_exception, stmp_39, stmp_24);
          stmp = sc_arity_check(hop_make_exception_frame, 2)(g3497, stmp_6);
          return sc_arity_check(dom_append_child, 2)(document.body, stmp);
        } else {
          return sc_arity_check(hop_add_event_listener, 3)(window, "load", (sc_tmp = function(e) {
                      return sc_arity_check(hop_report_exception, 1)(exc);
                    }, sc_tmp.name = "", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 18933)", sc_tmp.sc_arity = 1, sc_tmp));
        }
      }
    }, sc_tmp.name = "hop-report-exception", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 18188)", sc_tmp.sc_arity = 1, sc_tmp;
hop_last_exception_hop_exception = false;
sc_tmp = hop_onerror_handler_hop_exception = function(msg, url, line) {
      var tmp3530;
      var i;
      var g3529;
      var exc;
      var exc_53;
      var tmp3528;
      g3529 = hop_config.filtered_errors.length - 1;
      BgL_whilezd2break3599zd2: {
        i = g3529;
        while (i >= 0) {
          tmp3530 = url === hop_config.filtered_errors[i];
          if (tmp3530 !== false) {
            {
              tmp3528 = tmp3530;
              break BgL_whilezd2break3599zd2;
            }
          } else {
            --i;
          }
        }
        tmp3528 = false;
      }
      if (tmp3528 !== false) {
        return tmp3528;
      } else {
        if (hop_last_exception_hop_exception && hop_last_exception_hop_exception.message === msg) {
          exc = hop_last_exception_hop_exception;
        } else {
          exc_53 = new Error();
          exc_53.message = msg;
          exc_53.fileName = url;
          exc_53.lineNumber = line;
          exc_53.hopStack = sc_arity_check(hop_get_stack, 1)(2);
          exc = exc_53;
        }
        sc_arity_check(hop_report_exception, 1)(exc);
        return sc_arity_check(hop_debug, 0)() < 2;
      }
    }, sc_tmp.name = "hop-onerror-handler", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 19954)", sc_tmp.sc_arity = 3, sc_tmp;
if (sc_arity_check(hop_debug, 0)() > 0) {
  sc_arity_check(sc_errorHookSet, 1)((sc_tmp = function(exc, _) {
        hop_last_exception_hop_exception = exc;
        exc.hopStack = sc_arity_check(hop_get_stack, 1)(3);
        return exc;
      }, sc_tmp.name = "", sc_tmp.location = "(at /usr/local/share/hop/hop-exception.scm 20796)", sc_tmp.sc_arity = 2, sc_tmp));
  window.onerror = hop_onerror_handler_hop_exception;
}

]]>
</script>
<link id='link3' href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAADJklEQVQ4jXWRy2tcdRzFP7/f/d2ZO5lXpknHmhraYmwraRNTQrUxGAUVER9/gIgggqAIgi6qLisFQbqooAuhG3HlQlQCkpbEKiXUtlprk9rWPGzeM0lmJjNzZ+7cx9eFQUT0wNmd81mco0SEMAqRSBAEJYBWWFqjlAbg1RNnUoMHu8xQ725tXO/g7YnJj6RUffDZk+8GBkCjURYIwq1bt3ti8XhfzNh77ZjZ2+Ykut975bmHMql4ol4pmUrSJK9Y0fibr78cABgAPwgQEYIwZFe+86W2dPtxrS1jaYhESGUUddfFsR0+/OIc/fvu97O7dwGgq26TWrNFsVRlsVBm8uoNXXebplJzWd8sUSpXCSJw3QbFap35pVWeGjoyUKvVADBKKV47+ZlC65H1YvHEvg57+OhAP9qysSybIAzZ2NykXCwwcXWGfC5JfmdHbnr6evuhQ4fL+q/xVEYk+jKdSg1vVV2anoeI4DZd/MBHowh8j0s37zDSv5+W59nG2F0AWkT4+PgLFdvET8fiDuW6x8LSCoHfwmt6BH6ARCFrpRoLhRIP9x+g5jbQltm/fYBGG8P68uwHTipVCLHYLG8hKHw/oOE18Rouv8yu0N3ZTnvSQVkWth0bBDDZpGMBCYXyDz/6/Ol7eoffr1S2AAFAAS2vwY+/LfLYkR78IKDpN8GyBi79PNWmt5M5Qfqu//DN17XKxtJaxSUIfOy4Qy6ToSmGUq3Ok0ODxNqSpFIZnFj8PsfWeQ04QAZQURg2py+MntqoehCGZNNpTNyhLSjz9uPddHTswG8FRBIhEXu+vTwzokXEBf4AGkBufe7a6I1rP021ooh6w2OtsEZhy6Pv2BP4ng8igCKbScYeeaCnSwOISA2YAjaA2JXzo6darQBjGzKpNPce6MXJ7CCZcsjl2okZzeLiQiEbl4phWyISATNKqXxx5c6v5dLGVn5nZyYRc9DaYrNU9r+/ODk9dm7su/HxifNzs3MXEwln9W/AP0AFpZQ3P/P7VDKdPXZzfpmxs2cvfPX5p++srixfFpHGvwv/6bvvyu85+vSLZ55565M3/i8jIvwJxb+mJbWncx8AAAAASUVORK5CYII=' rel='shortcut icon'></link><style type='text/css'>
<![CDATA[

div.foot-buttons {
  margin-top: 1ex;
}

a.foot-button {
  opacity: 0.3;
  background-color: inherit;
  color: inherit;
  text-decoration: none;
}

a.foot-button:hover {
  opacity: 1;
}

a.foot-button img {
  border-width: 0;
  background: transparent;
  padding-left: 5px;
  padding-right: 5px;
}

mi {
  font-family: cmmi10;
}

mo {
  font-family: cmr10;
}

div[hssclass=hop-error] {
  top: 0;
  left: 0;
  right: 0;
  position: absolute;
  overflow: hidden;
  min-height: 60ex;
  max-height: 60ex;
}

body[hssclass=hop-error] div[hssclass=hop-error] {
  top: 3ex;
  left: 4em;
  right: 4em;
  background: white;
  border: 4px dashed;
  position: absolute;
  overflow: hidden;
  border-color: red;
}

div[hssclass=hop-error].warning {
  border-color: darkorange;
}

div[hssclass=hop-error].notfound {
  border-color: blue;
}

div[hssclass=hop-error].security {
  border-color: #f00;
}

div[hssclass=hop-error].remote {
  border-color: orange;
}

div[hssclass=hop-error] > img {
  position: absolute;
  left: 24px;
  top: 20px;
}

div[hssclass=hop-error] > div {
  position: absolute;
  left: 96px;
  top: 20px;
  right: 1em;
  bottom: 1ex;
}

div[hssclass=hop-error-title] {
  font-size: x-large;
  font-weight: bold;
  border-bottom: 1px solid #bbb;
  color: red;
}

div[hssclass=hop-error-msg] {
  margin-bottom: 20px;
  margin-top: 20px;
  padding-bottom: 20px;
  padding-top: 20px;
  font-family: sans-serif;
  font-weight: bold;
}

div[hssclass=hop-error-msg] tt {
  font-weight: 200;
  font-size: large;
}

div[hssclass=hop-error] pre {
  overflow: auto;
  min-height: 80ex;
  max-height: 80ex;
  border: 1px dashed #bbb;
  background-color: #ffe;
  font-size: 8pt;
  color: #333;
  font-weight: 200;
  padding-bottom: 5ex;
  padding: 2px;
}

div[hssclass=hop-error] tt.notfound {
  color: blue;
}


]]>
</style>
<script type='text/javascript'>
<![CDATA[

var BGl_hoptexzd2popupzd2zzhoptex_clientz00;
sc_tmp = BGl_hoptexzd2popupzd2zzhoptex_clientz00 = function(id, event, offset) {
      var px;
      var py;
      var ex;
      var el;
      el = sc_arity_check(dom_get_element_by_id, 1)(id);
      ex = sc_arity_check(hop_event_mouse_x, 1)(event);
      if (offset > 0) {
        py = offset + sc_arity_check(hop_event_mouse_y, 1)(event);
      } else {
        py = sc_arity_check(hop_current_window_height, 0)() - (offset + sc_arity_check(hop_event_mouse_y, 1)(event));
      }
      if (ex + 300 > sc_arity_check(hop_current_window_width, 0)()) {
        px = sc_arity_check(hop_current_window_width, 0)() - 500;
      } else {
        px = ex;
      }
      sc_arity_check(node_style_set, 3)(el, "\uEBADdisplay", "block");
      sc_arity_check(node_style_set, 3)(el, offset > 0? "\uEBADtop": "\uEBADbottom", sc_arity_check(sc_format, 2)("~apx", py));
      return sc_arity_check(node_style_set, 3)(el, "\uEBADleft", sc_arity_check(sc_format, 2)("~apx", px));
    }, sc_tmp.name = "hoptex-popup", sc_tmp.location = "(at /users/serrano/prgm/project/hop/weblets/hoptex/hoptex.scm 1260)", sc_tmp.sc_arity = 3, sc_tmp;

]]>
</script>
<style type='text/css'>
<![CDATA[

@font-face {  font-family: ParkAvenue;
  src: url(  "/users/serrano/prgm/project/hop/weblets/hoptex/etc/fonts/Parkavenue.ttf" ) , local("Parkavenue") , url(  "http://www.free-fonts-ttf.org/true-type-fonts/download.php?image_id=5263" );
}
div[hssclass=hoptex] {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
  width: 48em;
  font-family: FreeSerif;
  font-size: 12pt;
  background: white;
}

div[hssclass=hoptex-body] {
  text-align: justify;
  font-weight: normal;
}

div[hssclass=hoptex-title] {
  text-align: right;
  border-top: 1px solid #555;
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  margin-bottom: 0.5em;
  margin-top: 0.5em;
  border-bottom: 2px solid #555;
  text-shadow: #aaa 6px 6px 6px;
  font-size: 40pt;
  font-family: ParkAvenue;
  font-weight: bold;
}

img[hssclass=hoptex-favicon] {
  display: none;
}

div[hssclass=hoptex-author] {
  white-space: pre-line;
  text-align: right;
  font-weight: bold;
  font-size: 110%;
}

div[hssclass=hoptex-author] em {
  font-size: 85%;
  color: #777;
  font-weight: normal;
}

div[hssclass=hoptex-author] tt {
  font-size: 70%;
  font-weight: normal;
}

div.foot {
  margin-left: auto;
  margin-right: auto;
  width: 30%;
  border-top: 1px solid #ccc;
  margin-top: 5ex;
  min-width: 20em;
}

div[hssclass=hoptex-abstract] {
  margin-top: 2em;
  margin-bottom: 3em;
  text-align: center;
  margin-right: auto;
  margin-left: auto;
  width: 95%;
}

div[hssclass=hoptex-abstract] div[hssclass=hoptex-abstract-content] {
  font-size: 95%;
  padding: 0 1em 0 1em;
  font-weight: normal;
  font-style: italic;
  background-color: #f9f9ff;
  box-shadow: 5px 5px 10px #777;
  -moz-box-shadow: 5px 5px 10px #777;
  -webkit-box-shadow: 5px 5px 10px #777;
  border: 1px solid #eee;
  text-align: justify;
}

h1 {
  font-size: 140%;
  border-top: 1px solid black;
  border-bottom: 1px solid black;
  text-shadow: #ccc 6px 6px 6px;
  margin-top: 3em;
}

h2 {
  font-size: 130%;
  text-shadow: #ccc 4px 4px 4px;
}

tt {
  font-family: FreeMono;
  font-size: 98%;
}

code {
  font-family: FreeMono;
  font-weight: 400;
}

pre {
  font-family: FreeMono;
  font-weight: 400;
  font-size: 95%;
}

div[hssclass=hoptex-margin]#left {
  position: fixed;
  left: 0em;
  top: 0em;
  width: 15em;
  bottom: 0em;
  opacity: 0.92;
}

div[hssclass=hoptex-toc] {
  margin-top: 3em;
  text-align: left;
  font-size: 80%;
  background-color: #f9fff9;
  border: 1px solid #eee;
  color: #000;
  padding-left: 1em;
  box-shadow: 5px 5px 10px #777;
  -moz-box-shadow: 5px 5px 10px #777;
  -webkit-box-shadow: 5px 5px 10px #777;
  margin-left: 0.4em;
}

div[hssclass=hoptex-toc] div[hssclass=hoptex-toc-content]:before {
  padding-top: 0.5em;
  content: "Table of Contents";
  display: block;
  text-shadow: #ccc 6px 6px 6px;
  font-weight: bold;
  font-size: 110%;
}

div[hssclass=hoptex-toc] div[hssclass=hoptex-toc-content] {
  font-weight: normal;
  text-align: left;
}

div[hssclass=hoptex-toc] ol {
  padding: 0;
  list-style-type: none;
  font-weight: 200;
}

div[hssclass=hoptex-toc] ol ol {
  padding-left: 2em;
  list-style-type: none;
  font-weight: 200;
  font-style: italic;
}

div[hssclass=hoptex-toc] a {
  font-weight: inherit;
  color: inherit;
  text-decoration: none;
}

div[hssclass=hoptex-toc] a:hover {
  font-weight: bold;
}

div[hssclass=hoptex-tof] {
  margin-top: 3em;
  text-align: left;
  font-size: 80%;
  background-color: #f9fff9;
  border: 1px solid #eee;
  color: #000;
  padding-left: 1em;
  overflow: hidden;
  box-shadow: 5px 5px 10px #777;
  -moz-box-shadow: 5px 5px 10px #777;
  -webkit-box-shadow: 5px 5px 10px #777;
  margin-left: 0.4em;
}

div[hssclass=hoptex-tof] div[hssclass=hoptex-tof-content]:before {
  padding-top: 0.5em;
  content: "Table of Figures";
  display: block;
  text-shadow: #ccc 6px 6px 6px;
  font-weight: bold;
  font-size: 110%;
}

div[hssclass=hoptex-tof] div[hssclass=hoptex-tof-content] {
  font-weight: normal;
  text-align: left;
}

div[hssclass=hoptex-tof] ol {
  padding: 0;
  list-style-type: none;
  font-weight: 200;
}

div[hssclass=hoptex-tof] a.hoptex-figure-ref {
  white-space: nowrap;
  color: black;
  text-decoration: none;
  font-style: italic;
}

div[hssclass=hoptex-tof] a.hoptex-figure-ref:hover {
  font-weight: bold;
}

div[hssclass=hoptex-tof] a.hoptex-figure-ref:visited {
  color: black;
}

span[hssclass=hoptex-footnote-ref] {
  font-size: 80%;
  color: #00a0ff;
  vertical-align: top;
  cursor: help;
}

span[hssclass=hoptex-footnote-ref]:after {
  content: "\2020";
}

span[hssclass=hoptex-footnote-ref]:before {
  content: "\202F";
}

div[hssclass=hoptex-footnote] {
  color: black;
  font-style: roman;
  display: none;
  position: absolute;
  background: #fee;
  border: 1px solid #ccc;
  width: 30em;
  padding: 4px;
  border-radius: 0.3em;
  -moz-border-radius: 0.3em;
  -webkit-border-radius: 0.3em;
  opacity: 0.92;
  box-shadow: 5px 5px 10px #555;
  -moz-box-shadow: 5px 5px 10px #555;
  -webkit-box-shadow: 5px 5px 10px #555;
}

span[hssclass=hoptex-section-unbound] {
  font-weight: 200;
  color: #f00;
  cursor: pointer;
}

span[hssclass=hoptex-section-unbound]:after {
  content: "\202F\2620";
}

a[hssclass=hoptex-section-ref] {
  text-decoration: none;
  color: #00a0ff;
  border-bottom: 1px solid transparent;
}

a[hssclass=hoptex-section-ref]:visited {
  color: inherit;
}

a[hssclass=hoptex-section-ref]:hover {
  border-bottom: 1px dotted #00a0ff;
}

a[hssclass=hoptex-section-ref]:after {
  content: "\202F\2386";
  vertical-align: top;
  font-size: 90%;
}

span[hssclass=hoptex-subsection]:before {
  content: ".";
}

span[hssclass=hoptex-section1]:after {
  content: ".\202F";
}

a span[hssclass=hoptex-section1]:after {
  content: "";
}

span[hssclass=hoptex-section2]:after {
  content: "\202F";
}

a span[hssclass=hoptex-section2]:after {
  content: none;
}

span[hssclass=hoptex-section3]:after {
  content: "\202F";
}

a span[hssclass=hoptex-section3]:after {
  content: none;
}

div[hssclass=hoptex-figure] {
  width: 94%;
  text-align: left;
  margin-left: auto;
  margin-right: auto;
  padding: 0;
  border-collapse: collapse;
}

table[hssclass=hoptex-figure-content] {
  width: 100%;
  margin: 0;
  border-collapse: collapse;
  background: #fffffa;
  box-shadow: 5px 5px 10px #777;
  -webkit-box-shadow: 5px 5px 10px #777;
  -moz-box-shadow: 5px 5px 10px #777;
  border: 1px solid #eee;
  border-spacing: 0;
}

table[hssclass=hoptex-figure-content] td[hssclass=hoptex-figure-content] {
  padding: 0;
}

div[hssclass=hoptex-figure-caption] {
  margin-top: 1ex;
  font-weight: 200;
  text-align: center;
  font-size: 95%;
  margin-bottom: 4ex;
}

div[hssclass=hoptex-figure-caption] a.hoptex-figure-ref {
  text-decoration: none;
}

div[hssclass=hoptex-figure-caption] a,
div[hssclass=hoptex-figure-caption] a:visited {
  color: black;
  text-decoration: none;
}

div[hssclass=hoptex-figure-caption] span[hssclass=hoptex-figure-counter] {
  font-weight: bold;
}

div[hssclass=hoptex-figure-caption] span[hssclass=hoptex-figure-counter]:before {
  content: "Figure ";
}

div[hssclass=hoptex-figure-caption] span[hssclass=hoptex-figure-counter]:after {
  content: ":\202F\202F";
}

@media screen and (max-width: 70em) { div[hssclass=hoptex] {
  text-align: right;
  margin-right: 2em;
}

 }
@media handheld { div[hssclass=hoptex-margin]#left {
  display: none;
}

div[hssclass=hoptex] {
  text-align: center;
}

 }
@media screen and (min-width: 60em) { div[hssclass=hoptex-margin]#left {
  display: none;
}

div[hssclass=hoptex] {
  text-align: center;
  margin-right: auto;
}

 }
@media screen and (min-width: 65em) { div[hssclass=hoptex-margin]#left {
  width: 15em;
  display: block;
}

div[hssclass=hoptex] {
  text-align: right;
  margin-right: 2em;
}

 }
@media screen and (min-width: 70em) { div[hssclass=hoptex-margin]#left {
  width: 20em;
  display: block;
}

div[hssclass=hoptex] {
  text-align: right;
  margin-right: 2em;
}

 }
@media screen and (min-width: 70em) { div[hssclass=hoptex] {
  margin-right: 5em;
}

 }
@media screen and (min-width: 90em) { div[hssclass=hoptex] {
  text-align: center;
  margin-right: auto;
}

 }
@media print { div[hssclass=hoptex-margin],
div.foot {
  display: none;
}

 }

]]>
</style>
<style type='text/css'>
<![CDATA[

div[hssclass=hoptex-bib-popup] {
  display: none;
  position: absolute;
  background: #efe;
  border: 1px solid #ccc;
  font-size: 85%;
  width: 30em;
  padding: 4px;
  border-radius: 0.4em;
  -moz-border-radius: 0.4em;
  -webkit-border-radius: 0.4em;
  opacity: 0.92;
  box-shadow: 5px 5px 10px #555;
  -moz-box-shadow: 5px 5px 10px #555;
  -webkit-box-shadow: 5px 5px 10px #555;
}

span[hssclass=hoptex-bib-ref]:before {
  content: "[";
}

span[hssclass=hoptex-bib-ref]:after {
  content: "]";
}

span[hssclass=hoptex-bib-ref] a {
  text-decoration: none;
}

span[hssclass=hoptex-bib-ref] a.extern:hover {
  text-decoration: underline;
}

td.hoptex-bib-entry-key {
  text-align: right;
  width: 2em;
  vertical-align: top;
}

td.hoptex-bib-entry-key:before {
  content: "[";
}

td.hoptex-bib-entry-key:after {
  content: "]";
}

span.hoptex-bib-entry-author {
}

td.hoptex-bib-entry-value {
  text-align: justify;
}

.hoptex-bib-entry-title:before {
  content: " \2015  ";
  font-weight: 200;
}

a.hoptex-bib-entry-title {
  text-decoration: none;
  color: #00a;
}

a.hoptex-bib-entry-title:hover {
  text-decoration: underline;
}

a.hoptex-bib-entry-title span.hoptex-bib-entry-url {
  display: none;
}

span.hoptex-bib-entry-series:before,
span.hoptex-bib-entry-date:before,
span.hoptex-bib-entry-location:before,
span.hoptex-bib-entry-address:before,
span.hoptex-bib-entry-volume:before,
span.hoptex-bib-entry-publisher:before,
span.hoptex-bib-entry-editor:before,
span.hoptex-bib-entry-institution:before,
span.hoptex-bib-entry-type:before,
span.hoptex-bib-entry-school:before {
  content: ", ";
}

span.hoptex-bib-entry-number[lang=francais]:before,
span.hoptex-bib-entry-number[lang=french]:before {
  content: ", N\b0 ";
}

span.hoptex-bib-entry-number:before {
  content: ", ";
}

span.hoptex-bib-entry-volume:before {
  content: " (";
}

span.hoptex-bib-entry-volume:after {
  content: ")";
}

span.hoptex-bib-entry-chapter:before {
  content: ", ch. ";
  font-weight: normal;
}

tr.hoptex-bib-entry-inbook span.hoptex-bib-entry-title {
  font-weight: normal;
}

span.hoptex-bib-entry-chapter {
  font-weight: bold;
}

span.hoptex-bib-entry-booktitle:before,
span.hoptex-bib-entry-journal:before {
  content: " in ";
  font-style: normal;
}

span.hoptex-bib-entry-booktitle,
span.hoptex-bib-entry-journal {
  font-style: italic;
}

span.hoptex-bib-entry-editor {
  font-style: italic;
}

span.hoptex-bib-entry-editor:after {
  content: " ed.";
}

div.hoptex-bib-entry-popup span.hoptex-bib-entry-booktitle,
div.hoptex-bib-entry-popup span.hoptex-bib-entry-journal {
  font-weight: bold;
  color: #222;
}

span.hoptex-bib-entry-pages:before {
  content: " (pp. ";
}

span.hoptex-bib-entry-pages:after {
  content: ")";
}

span.hoptex-bib-entry-et-al {
  font-style: italic;
}

span.hoptex-bib-entry-title,
a.hoptex-bib-entry-title {
  font-weight: bold;
}

a.bibhref {
  text-decoration: none;
}

span.hoptex-bib-entry-missing {
  font-weight: bold;
  color: #f00;
}

div[hssclass=hoptex-bib] {
  margin-top: 2em;
  text-align: center;
  margin-right: auto;
  margin-left: auto;
}

div[hssclass=hoptex-bib] div[hssclass=hoptex-bib-content] {
  font-weight: normal;
  text-align: justify;
}

@media print { a.hoptex-bib-entry-title span.hoptex-bib-entry-url {
  display: inline;
  font-family: monospace;
  font-weight: 200;
  font-size: 95%;
  color: black;
}

a.hoptex-bib-entry-title span.hoptex-bib-entry-url:before {
  content: ", ";
  font-weight: 200;
  font-size: 95%;
  color: black;
}

 }

]]>
</style>
<style type='text/css'>
<![CDATA[

p[hssclass=hoptex-prog],
textarea[hssclass=hoptex-prog] {
  font-weight: 400;
  font-size: 95%;
  font-family: FreeMono , "Bitstream Vera Sans Mono";
  white-space: pre;
  text-align: left;
  margin: 0;
  padding: 0;
  padding: 0.3em;
}

textarea[hssclass=hoptex-prog] {
  display: none;
  background-color: #ccf;
}

div[hssclass=hoptex-prog-buttons] {
  text-align: right;
  font-size: 72%;
  margin: 0 0 2px 0;
  padding: 0 2px 4px 0;
}

div[hssclass=hoptex-prog-buttons] span {
  cursor: pointer;
  margin: 0 4px 0 0;
  padding: 0 10px 0 10px;
  border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-border-radius: 2px;
  border: 1px solid #777;
  color: black;
  font-weight: bold;
  font-family: sans-serif;
  background-image: -moz-linear-gradient(-90deg , #ccc9bd , #a6a18c);
  background: -webkit-gradient(linear , 0% 0% , 0% 100% , from(#ccc9bd) , to(#a6a18c));
}

div[hssclass=hoptex-prog-buttons] span:hover {
  color: darkorange;
  background: #efefeb;
}

div[hssclass=hoptex-prog-buttons] span.save {
  visibility: hidden;
  margin-right: 5px;
}

div[hssclass=hoptex-prog-buttons] span.run {
  background-image: -moz-linear-gradient(-90deg , #DDDBD3 , #b8b4a3);
  background: -webkit-gradient(linear , 0% 0% , 0% 100% , from(#DDDBD3) , to(#b8b4a3));
}

div[hssclass=hoptex-prog-buttons] span.run:hover {
}

div[hssclass=hoptex-prog-buttons] span.save:hover {
}

div[hssclass=hoptex-prog-buttons] span.use {
  visibility: hidden;
  margin-right: 5px;
}

div[hssclass=hoptex-prog-buttons] span.use:hover {
}

p[hssclass=hoptex-prog] span.hoptex-prog-comment {
  color: #ffa600;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-line-comment {
  color: #ffa600;
  font-style: italic;
}

p[hssclass=hoptex-prog] span.hoptex-prog-markup {
  color: #1919af;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-string {
  color: red;
}

p[hssclass=hoptex-prog] span.hoptex-prog-type {
  color: #00cf00;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-define {
  color: #6959cf;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-special {
  color: #ee0000;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-client {
  color: #ee0000;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-server {
  color: #0000ee;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-important {
  color: #ee0000;
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-reserved {
  font-weight: bold;
}

p[hssclass=hoptex-prog] span.hoptex-prog-field {
  font-weight: bold;
}


]]>
</style>
<style type='text/css'>
<![CDATA[

@media tex { em:before {
  content: "{\\em{";
}

em:after {
  content: "}}";
}

i:before {
  content: "{\\textit{";
}

i:after {
  content: "}}";
}

strong:before {
  content: "{\\textbf{";
}

strong:after {
  content: "}}";
}

tt:before,
code:before {
  content: "{\\texttt{";
}

tt:after,
code:after {
  content: "}}";
}

sub:before {
  content: "$_{\\mbox{\\scriptsize{";
}

sub:after {
  content: "}}}$";
}

sup:before {
  content: "$^{\\mbox{\\scriptsize{";
}

sup:after {
  content: "}}}$";
}

q:before {
  content: "``";
}

q:after {
  content: "''";
}

u:before {
  content: "{\\underline{";
}

u:after {
  content: "}}";
}

kbd:before {
  content: "{\\fbox{";
}

kbd:after {
  content: "}}";
}

p.noindent:before {
  content: "\\noindent ";
}

div[hssclass=hoptex-abstract] {
  text-align: justify;
}

div[hssclass=hoptex-abstract] div[hssclass=hoptex-abstract-content] {
  font-style: inherit;
  font-size: inherit;
}

div[hssclass=hoptex-abstract]:before {
  content: "\\begin{abstract}\n";
}

div[hssclass=hoptex-abstract]:after {
  content: "\\end{abstract}\n";
}

h1:before {
  content: "\\section{";
}

h2:before {
  content: "\\subsection{";
}

h3:before {
  content: "\\subsubsection{";
}

h4:before {
  content: "\\paragraph{";
}

h5:before {
  content: "\\subparagraph{";
}

h1:after,
h2:after,
h3:after,
h4:after,
h5:after {
  content: "}";
}

ul:before {
  content: "\\begin{itemize}\n\n";
}

ul:after {
  content: "\\end{itemize}\n";
}

ol:before {
  content: "\\begin{enumerate}\n\n";
}

ol:after {
  content: "\\end{enumerate}\n";
}

li:before {
  content: "\\item";
}

li:after {
  content: "\n";
}

img {
  width: 80%;
  proc: "error:procedure";
}

img:before {
  content: "\\noindent\\begin{center}\n";
}

img:after {
  content: "\n\\end{center}";
}

div[hssclass=hoptex-figure] {
  text-align: inherit;
}

pre,
p[hssclass=hoptex-prog] {
  font-size: small;
  proc: "error:procedure";
}

div[hssclass=hoptex-figure] pre,
div[hssclass=hoptex-figure] p[hssclass=hoptex-prog] {
  margin: 0;
}

pre:before,
p[hssclass=hoptex-prog]:before {
  content: "\\begin{center}\n";
}

pre:after,
p[hssclass=hoptex-prog]:after {
  content: "\\end{center}\n";
}

a {
  proc: "error:procedure";
}

div[hssclass=hoptex-figure]:before {
  content: "\\begin{figure}[htb]\n";
}

div[hssclass=hoptex-figure]:after {
  content: "\\end{figure}\n";
}

div[hssclass=hoptex-figure].multicolumns:before {
  content: "\\begin{figure*}[htb]\n";
}

div[hssclass=hoptex-figure].multicolumns:after {
  content: "\\end{figure*}\n";
}

div[hssclass=hoptex-figure-caption] {
  text-align: inherit;
}

div[hssclass=hoptex-figure-caption]:before {
  content: "\\caption{";
}

div[hssclass=hoptex-figure-caption]:after {
  content: "}";
}

table[hssclass=hoptex-figure-content] {
  proc: "error:procedure";
}

table {
  proc: "error:procedure";
}

tr {
  proc: "error:procedure";
}

th:before {
  content: "{\\textbf{\\textsf{";
}

th:after {
  content: "}}}";
}

h1.hoptex-bibliography {
  display: none;
}

div[hssclass=hoptex-bibliography]:before {
  content: "\\begin{small}\n\\bibliographystyle{abbrvnat}\n";
}

div[hssclass=hoptex-bibliography] {
  proc: "error:procedure";
}

div[hssclass=hoptex-bibliography]:after {
  content: "\\end{small}\n";
}

 }

]]>
</style>
<title>HSS: a Compiler for Cascading Style Sheets</title>
<style type='text/css'>
<![CDATA[

div[hssclass=hop-lframe] {
  border: 1px solid black;
  box-shadow: 5px 5px 5px #888;
  -webkit-box-shadow: 5px 5px 5px #888;
  -moz-box-shadow: 5px 5px 5px #888;
}

div[hssclass=hop-lframe]  {
  background: #edeceb;
}

div[hssclass=hop-lframe] div[hssclass=hop-lflabel] > span {
  background: #edeceb;
}

div[hssclass=hop-lframe] div[hssclass=hop-lfbody] {
  padding: 2px;
}

div[hssclass=hop-lframe]  {
  padding: 10px;
}

div[hssclass=hop-lframe] div[hssclass=hop-lfborder] {
  border: 2px groove #ddd;
}

div[hssclass=hop-lframe] div[hssclass=hop-lfborder] {
  border-radius: 4px;
  -moz-border-radius: 4px;
  -webkit-border-radius: 4px;
}

div[hssclass=hop-lframe] div[hssclass=hop-lflabel] {
  text-align: left;
}

div[hssclass=hop-lframe] div[hssclass=hop-lflabel] {
  top: -12px;
}

div[hssclass=hop-lflabel] span {
  font-style: roman;
}

div[hssclass=hop-lframe] div[hssclass=hop-lfborder] {
  position: relative;
}

div[hssclass=hop-lframe] div[hssclass=hop-lflabel] {
  position: relative;
  left: 10px;
  margin-right: 20px;
}


]]>
</style>
<style type='text/css'>
<![CDATA[

@media tex { div[hssclass=hoptex-bibliography]:before {
  content: "\\begin{small}\n\\bibliographystyle{abbrvnat}\n";
}

 }

]]>
</style>
<style type='text/css'>
<![CDATA[

pre.bibtex {
  padding-top: 4ex;
  font-size: 70%;
  font-weight: bold;
}

pre.bibtex img {
  vertical-align: bottom;
}

div[hssclass=hoptex-figure]#fig-Cnotations table[hssclass=hoptex-figure-content] {
  margin-top: 2em;
  background: #faffff;
}

table#notations {
  font-size: 92%;
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  text-align: center;
  border: 0;
}

table#notations td {
  vertical-align: top;
  text-align: left;
}

div[hssclass=hoptex-figure]#fig-related-work {
  width: 100%;
}

table[hssclass=hoptex-figure-content] td[hssclass=hoptex-figure-content] {
  padding: 2px;
}

div[hssclass=hoptex-figure]#fig-related-work table[hssclass=hoptex-figure-content] {
  font-size: 85%;
}

div[hssclass=hoptex-figure]#fig-related-work table[hssclass=hoptex-figure-content] td[hssclass=hoptex-figure-content] {
  padding: 0;
}

div[hssclass=hoptex-figure]#fig-related-work div[hssclass=hoptex-figure-caption] {
  text-align: justify;
  font-size: 90%;
}

table.related-work {
  border-collapse: collapse;
}

table.related-work > tr {
  border-top: 1px dashed #aaa;
}

table.related-work td {
  text-align: center;
}

table.related-work tr.legend {
  border-top: 1px solid #aaa;
  border-bottom: 1px solid #aaa;
  background: #eee;
  font-size: 80%;
}

table.related-work tr.last {
  border-bottom: 1px solid black;
}

table.related-work td {
  vertical-align: top;
}

table.related-work td {
  vertical-align: top;
}

table.related-work tr.legend th {
  text-align: center;
  font-weight: bold;
  font-family: sans serif;
}

table.related-work-system {
  width: 100%;
}

table.related-work-system td,
table.related-work-system th {
  text-align: left;
}

table.related-work-list {
  width: 100%;
}

table.related-work-list td {
  text-align: center;
}

div[hssclass=hop-lframe]  {
  background: #f2f2f2;
}

div[hssclass=hop-lframe] div[hssclass=hop-lflabel] > span {
  background: #f2f2f2;
}

div[hssclass=hop-lframe].lframe-right div[hssclass=hop-lflabel] {
  text-align: right;
}

div[hssclass=hop-lframe].lframe-right div[hssclass=hop-lfborder] {
  border-radius: 0;
  -moz-border-radius: 0;
  -webkit-border-radius: 0;
}

div[hssclass=hop-lframe].lframe-right div[hssclass=hop-lfborder] {
  border: 2px ridge green;
}

div[hssclass=hop-lframe].lframe-right  {
  background: #f7f7f7;
}

div[hssclass=hop-lframe].lframe-right div[hssclass=hop-lflabel] > span {
  background: #f7f7f7;
}

div[hssclass=hop-lframe].lframe-right div[hssclass=hop-lfbody] div[hssclass=hop-lflabel] span {
  font-variant: small-caps;
}

@media tex { div[hssclass=hoptex-figure]#fig-related-work {
  float: -350;
}

table#related-work:before {
  content: "\\begin{center}\\begin{small}\n\\begin{tabular*}{\\textwidth}{lcccccccccc}\\hline\n";
}

table#related-work:after {
  content: "\\end{tabular*}\n\\end{small}\\end{center}\n";
}

table#related-work {
  proc: "error:procedure";
}

table#related-work-list:before {
  content: "\\begin{tabular}{c}\n";
}

table#related-work-list {
  proc: none;
}

table#related-work tr.legend {
  border-top: 0;
  border-bottom: 0;
  background: none;
  font-size: inherit;
}

table#notations:before {
  content: "\\noindent\\begin{small}\n\\begin{tabular}{|p{7em}p{20em}|}\\hline\n";
}

table#notations:after {
  content: "\\hline\\end{tabular}\n\\end{small}\n";
}

table#notations {
  proc: none;
}

 }

]]>
</style>
<style type='text/css'>
<![CDATA[

div[hssclass=prog-syntax] {
  font-size: 90%;
  margin: 0;
}

div[hssclass=prog-syntax] > table {
  border-collapse: collapse;
  width: 100%;
}

span.prog-syntax-domain {
  font-family: arial;
  font-style: italic;
}

span.prog-syntax-domain sup {
  font-size: 80%;
}

div[hssclass=prog-syntax] > table td {
  white-space: nowrap;
}

div[hssclass=prog-syntax] > table td.prog-syntax-lhs {
  width: 2em;
}

div[hssclass=prog-syntax] > table tr > td.assign {
  text-align: center;
  width: 2em;
}

div[hssclass=prog-syntax] > table tr > td.prog-syntax-def {
  text-align: center;
  width: 2em;
}

div[hssclass=prog-syntax] > table tr > td.prog-syntax-rhs {
  width: 15em;
}

div[hssclass=prog-syntax] > table td.prog-syntax-comment {
  color: #444;
  text-align: right;
  white-space: nowrap;
  padding-left: 2em;
  font-style: italic;
  width: 10em;
}

span.prog-syntax-comment {
  font-style: italic;
}

tt.prog-syntax-terminal {
  font-weight: bold;
  color: #0a0;
}

tt.prog-syntax-terminal:before {
  content: " '";
  font-weight: 200;
  color: black;
}

tt.prog-syntax-terminal:after {
  content: "' ";
  font-weight: 200;
  color: black;
}

span.prog-syntax-keyword {
  font-weight: bold;
}

table#notations {
  font-size: 90%;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
  text-align: center;
  border: 1px solid black;
}

table#notations td {
  vertical-align: top;
}

@media tex { div[hssclass=prog-syntax] table:before {
  content: "\\begin{tabular*}{\\linewidth}{p{1.2em}p{0.4em}l@{\\extracolsep{\\fill}}r}\n";
}

div[hssclass=prog-syntax] table:after {
  content: "\\end{tabular*}\n";
}

div[hssclass=prog-syntax] table {
  proc: none;
}

span.prog-syntax-domain:before {
  content: "{\\textsf{";
}

span.prog-syntax-domain:after {
  content: "}}";
}

tt.prog-syntax-terminal {
  font-weight: 200;
}

tt.prog-syntax-terminal:before {
  content: "{\\texttt{";
}

tt.prog-syntax-terminal:after {
  content: "}}";
}

 }

]]>
</style>
</head>
<body id='_2118'><div id='_2111' hssclass='hoptex'><div id='_2110' hssclass='hoptex-body'>


<div id='_0' hssclass='hoptex-title' >HSS: a Compiler for Cascading Style Sheets
</div>







<div id='left' hssclass='hoptex-margin' ><div id='_6' hssclass='hoptex-margin-content'><div id='hoptex-toc' hssclass='hoptex-toc' ><div id='_2075' hssclass='hoptex-toc-content'><ol id='_2074'><li id='_2045'><a id='_2044' href='#Introduction'><span id='_1939' hssclass='hoptex-section1'>1</span> Introduction </a></li><li id='_2047'><a id='_2046' href='#Background'><span id='_1940' hssclass='hoptex-section1'>2</span> Background </a></li><li id='_2058'><a id='_2048' href='#The HSS language'><span id='_1941' hssclass='hoptex-section1'>3</span> The HSS language </a><ol id='_2057'><li id='_2050'><a id='_2049' href='#HSS user-defined properties'><span id='_1943' hssclass='hoptex-section2'>3<span id='_1942' hssclass='hoptex-subsection'>1</span></span> HSS user-defined properties </a></li><li id='_2052'><a id='_2051' href='#HSS user-defined functions'><span id='_1951' hssclass='hoptex-section2'>3<span id='_1950' hssclass='hoptex-subsection'>2</span></span> HSS user-defined functions </a></li><li id='_2054'><a id='_2053' href='#HSS user-defined types'><span id='_1959' hssclass='hoptex-section2'>3<span id='_1958' hssclass='hoptex-subsection'>3</span></span> HSS user-defined types </a></li><li id='_2056'><a id='_2055' href='#Computed values'><span id='_1967' hssclass='hoptex-section2'>3<span id='_1966' hssclass='hoptex-subsection'>4</span></span> Computed values </a></li></ol></li><li id='_2065'><a id='_2059' href='#The HSS compiler'><span id='_1974' hssclass='hoptex-section1'>4</span> The HSS compiler </a><ol id='_2064'><li id='_2061'><a id='_2060' href='#Compiling Simple Rules'><span id='_1976' hssclass='hoptex-section2'>4<span id='_1975' hssclass='hoptex-subsection'>1</span></span> Compiling Simple Rules </a></li><li id='_2063'><a id='_2062' href='#Compiling User Rules'><span id='_1984' hssclass='hoptex-section2'>4<span id='_1983' hssclass='hoptex-subsection'>2</span></span> Compiling User Rules </a></li></ol></li><li id='_2067'><a id='_2066' href='#Limits and Future work'><span id='_1985' hssclass='hoptex-section1'>5</span> Limits and Future work </a></li><li id='_2069'><a id='_2068' href='#Related work'><span id='_1986' hssclass='hoptex-section1'>6</span> Related work </a></li><li id='_2071'><a id='_2070' href='#Conclusion'><span id='_1987' hssclass='hoptex-section1'>7</span> Conclusion </a></li><li id='_2073'><a id='_2072' href='#Acknowledgments'><span id='_1988' hssclass='hoptex-section1'>8</span> Acknowledgments </a></li></ol></div></div>
<div id='hoptex-tof' hssclass='hoptex-tof' ><div id='_2109' hssclass='hoptex-tof-content'><ol id='_2108'><li id='_2077'><a id='_2076' class='hoptex-figure-ref' href='#fig:Hn' title='Figure 1'><span id='_1923' hssclass='hoptex-figure-counter'>1</span> Grammar for HSS.</a></li><li id='_2079'><a id='_2078' class='hoptex-figure-ref' href='#fig:S' title='Figure 2'><span id='_1924' hssclass='hoptex-figure-counter'>2</span> Grammar for HSS selectors.</a></li><li id='_2081'><a id='_2080' class='hoptex-figure-ref' href='#fig:D' title='Figure 3'><span id='_1925' hssclass='hoptex-figure-counter'>3</span> Grammar for HSS declarations.</a></li><li id='_2083'><a id='_2082' class='hoptex-figure-ref' href='#fig:Hprop' title='Figure 4'><span id='_1926' hssclass='hoptex-figure-counter'>4</span> Grammar for HSS property compilers.</a></li><li id='_2085'><a id='_2084' class='hoptex-figure-ref' href='#fig:Hfun' title='Figure 5'><span id='_1927' hssclass='hoptex-figure-counter'>5</span> Function definition.</a></li><li id='_2087'><a id='_2086' class='hoptex-figure-ref' href='#fig:Htypes' title='Figure 6'><span id='_1928' hssclass='hoptex-figure-counter'>6</span> HSS types.</a></li><li id='_2089'><a id='_2088' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7'><span id='_1929' hssclass='hoptex-figure-counter'>7</span> Definition of the new lframe type element</a></li><li id='_2091'><a id='_2090' class='hoptex-figure-ref' href='#fig:H0' title='Figure 8'><span id='_1930' hssclass='hoptex-figure-counter'>8</span> Grammar for normalized HSS.</a></li><li id='_2093'><a id='_2092' class='hoptex-figure-ref' href='#fig-Cnotations' title='Figure 9'><span id='_1931' hssclass='hoptex-figure-counter'>9</span> Notations. This figure presents the notations used by the 
compilation algorithms.</a></li><li id='_2095'><a id='_2094' class='hoptex-figure-ref' href='#fig:Ccomp' title='Figure 10'><span id='_1932' hssclass='hoptex-figure-counter'>10</span> Dispatching rules</a></li><li id='_2097'><a id='_2096' class='hoptex-figure-ref' href='#fig:Ccomp-simple' title='Figure 11'><span id='_1933' hssclass='hoptex-figure-counter'>11</span> Compiling simple rule</a></li><li id='_2099'><a id='_2098' class='hoptex-figure-ref' href='#fig:Calias' title='Figure 12'><span id='_1934' hssclass='hoptex-figure-counter'>12</span> Compilation of selectors</a></li><li id='_2101'><a id='_2100' class='hoptex-figure-ref' href='#fig:Cdecl' title='Figure 13'><span id='_1935' hssclass='hoptex-figure-counter'>13</span> Compiling declarations</a></li><li id='_2103'><a id='_2102' class='hoptex-figure-ref' href='#fig:Cexpr' title='Figure 14'><span id='_1936' hssclass='hoptex-figure-counter'>14</span> Compiling property values</a></li><li id='_2105'><a id='_2104' class='hoptex-figure-ref' href='#fig:Cuser' title='Figure 15'><span id='_1937' hssclass='hoptex-figure-counter'>15</span> User rules compilation</a></li><li id='_2107'><a id='_2106' class='hoptex-figure-ref' href='#fig-related-work' title='Figure 16'><span id='_1938' hssclass='hoptex-figure-counter'>16</span> This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.</a></li></ol></div></div>
</div></div>

<div id='_11' hssclass='hoptex-author' >Manuel Serrano
<em id='_7'>Inria Sophia Antipolis</em>
<tt id='_8'>Manuel.Serrano@inria.fr</tt>
<tt id='_10'><a id='_9' href='http://www.inria.fr/indes/Manuel.Serrano'>http://www.inria.fr/indes/Manuel.Serrano</a></tt>
</div>


<pre id='_14' class='bibtex'>@InProceedings{ serrano:ppdp10,
  author = {Serrano, M.},
  title = {HSS: a Compiler for Cascading Style Sheets},
  booktitle = {10th ACM Sigplan Int'l Conference on 
               Principles and Practice of Declarative Programming (PPDP'2010)},
  year = 2010,
  month = jul,
  address = {Hagenberg, Austria},
  url = {<tt id='_13'><a id='_12' href='http://www-sop.inria.fr/members/Manuel.Serrano/publi/serrano-ppdf10.pdf'>http://www-sop.inria.fr/members/Manuel.Serrano/publi/serrano-ppdf10.pdf</a></tt>};
}</pre>

<div id='_22' hssclass='hoptex-abstract' ><div id='_21' hssclass='hoptex-abstract-content'><p id='_17'>This ar&shy;ti&shy;cle pre&shy;sents HSS<span id='_2043' hssclass='hoptex-footnote-ref' onmouseover='{ var result3302;
result3302 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("footnote2042"), event, -15);

 undefined; }' onmouseout='{ var result3316;
result3316 = sc_arity_check(node_style_set, 3)(("footnote2042"), "\uEBADdisplay", "none");

 undefined; }'>1<div id='footnote2042' hssclass='hoptex-footnote'>This work is supported in part by 
the French ANR agency, grant <tt id='_15'>ANR&shy;-09&shy;-EMER&shy;-009&shy;-01</tt>.</div></span>, 
a com&shy;pil&shy;er for CSS. It is first ar&shy;gued that gen&shy;er&shy;at&shy;ing CSS im&shy;proves 
porta&shy;bil&shy;i&shy;ty and main&shy;tain&shy;abil&shy;i&shy;ty of CSS files. This claim is sup&shy;port&shy;ed 
by re&shy;al&shy;is&shy;tic ex&shy;am&shy;ples. Then, the HSS com&shy;pi&shy;la&shy;tion al&shy;go&shy;rithm is pre&shy;sent&shy;ed. 
It is sim&shy;ple enough to be eas&shy;i&shy;ly adapt&shy;ed to most web de&shy;vel&shy;op&shy;ment kit&shy;s.
</p>
<p id='_20'>HSS can be used as a stand-alone HSS-&shy;to-C&shy;SS com&shy;pil&shy;er in the goal of
en&shy;rich&shy;ing CSS with user de&shy;fined vari&shy;ables, func&shy;tions, and el&shy;e&shy;ment
type&shy;s. It can also be used with the Hop web de&shy;vel&shy;op&shy;ment kit in which
case, work&shy;ing hand in hand with the Hop pro&shy;gram&shy;ming lan&shy;guage, it can
be used to im&shy;ple&shy;ment <em id='_18'>skinning</em> or <em id='_19'>theming</em> of web
ap&shy;pli&shy;ca&shy;tion&shy;s.
</p></div></div>



<a id='_23' name='Introduction'></a><h1 id='_24' name='Introduction'><span id='_1939' hssclass='hoptex-section1'>1</span> Introduction </h1>

<p id='_28'>Cas&shy;cad&shy;ing Style Sheets (hence&shy;forth CSS) is used to ex&shy;press
for&shy;mat&shy;ting in HTML and XHTM&shy;L. It is a declar&shy;a&shy;tive lan&shy;guage that can&shy;not
ex&shy;press com&shy;pu&shy;ta&shy;tion. The cor&shy;rect&shy;ness of CSS files can be checked
stat&shy;i&shy;cal&shy;ly by CSS parsers (named <em id='_25'>validators</em> in the web
jar&shy;gon). The W3C for ex&shy;am&shy;ple, pro&shy;vides one on-&shy;line (see
<tt id='_27'><a id='_26' href='http://jigsaw.w3.org/css-validator/'>http://jigsaw.w3.org/css-validator/</a></tt>).
</p>
<p id='_29'>CSS is es&shy;sen&shy;tial for de&shy;vel&shy;op&shy;ing Web user in&shy;ter&shy;face (hence&shy;forth
UI). It is used for fine graph&shy;i&shy;cal tun&shy;ings as well as for man&shy;ag&shy;ing UIs
glob&shy;al lay&shy;out&shy;s. As pro&shy;mot&shy;ed by stan&shy;dard en&shy;gi&shy;neer&shy;ing method&shy;olo&shy;gies, CSS
en&shy;forces a strong sep&shy;a&shy;ra&shy;tion be&shy;tween the im&shy;ple&shy;men&shy;ta&shy;tion of the
ap&shy;pli&shy;ca&shy;tion and its UI.
</p>
<p id='_34'>CSS is de&shy;fined by a W3C spec&shy;i&shy;fi&shy;ca&shy;tion <span id='bibref1580'  hssclass='hoptex-bib-ref'><a id='_1582' href='http://www.w3.org/TR/2009/CR-CSS2-20090423/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1581"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1581"), "\uEBADdisplay", "none");

 undefined; }'>9</a><div id='bibref1581' hssclass='hoptex-bib-popup'><table id='_1592'><tr id='_1591'><td id='_1583' class='hoptex-bib-entry-key'>9</td><td id='_1590' class='hoptex-bib-entry-value'><span id='_1584' class='hoptex-bib-entry-author'>World Wide Web Consortium, </span><a id='_1586' class='hoptex-bib-entry-title' href='http://www.w3.org/TR/2009/CR-CSS2-20090423/'>Cascading Style Sheets level 2 Revision 1 CSS2.1 Specification<span id='_1585' class='hoptex-bib-entry-url'>http://www.w3.org/TR/2009/CR-CSS2-20090423/</span></a><span id='_1587' class='hoptex-bib-entry-number'>CR-CSS2-20090423</span><span id='_1588' class='hoptex-bib-entry-institution'>W3C Recommendation</span><span id='_1589' class='hoptex-bib-entry-date'>Apr 2009</span>.</td></tr></table></div></span>. A
re&shy;vised ver&shy;sion is in prepa&shy;ra&shy;tion (CSS lev&shy;el 3) that sup&shy;ports
ad&shy;di&shy;tion&shy;al graph&shy;i&shy;cal tun&shy;ings such as opac&shy;i&shy;ty, shad&shy;ed box&shy;es, or round
bor&shy;der&shy;s. Few browsers al&shy;ready sup&shy;port CSS lev&shy;el 3 but most browsers
sup&shy;port var&shy;i&shy;ous ex&shy;ten&shy;sions of CSS lev&shy;el 2 for pro&shy;vid&shy;ing sim&shy;i&shy;lar fan&shy;cy
graph&shy;i&shy;cal fea&shy;tures (for in&shy;stance, Mozil&shy;la ex&shy;ten&shy;sions are de&shy;scribed at
<tt id='_33'><a id='_32' href='https://developer.mozilla.org/En/CSS_Reference/Mozilla_Extensions'><tt id='_31'>https://developer.mozilla.org</tt></a></tt>).
</p>
<p id='_35'>Two re&shy;stric&shy;tions of CSS have mo&shy;ti&shy;vat&shy;ed the pre&shy;sent work.
</p>
<ul id='_48'><li id='_41'> The di&shy;ver&shy;si&shy;ty of ex&shy;ten&shy;sions web browsers sup&shy;port makes it dif&shy;fi&shy;cult to
write <em id='_36'>portable</em> CSS files. Ex&shy;ten&shy;sions are so com&shy;mon that they are even
an&shy;tic&shy;i&shy;pat&shy;ed and ac&shy;knowl&shy;edged by the W3C's spec&shy;i&shy;fi&shy;ca&shy;tion (see Sec&shy;tion
<em id='_38'><a id='_37' href='http://www.w3.org/TR/CSS21/syndata.html#vendor-keywords'>Vendor-specific
extensions</a></em> of CSS2.1). Ex&shy;ten&shy;sions are tau&shy;to&shy;log&shy;i&shy;cal&shy;ly not
stan&shy;dard&shy;ized and thus yield to porta&shy;bil&shy;i&shy;ty is&shy;sues. Fre&shy;quent&shy;ly, browsers sup&shy;port
sim&shy;i&shy;lar graph&shy;i&shy;cal tun&shy;ings but ex&shy;pressed by dif&shy;fer&shy;ent syn&shy;tax&shy;es. For
in&shy;stance, both Fire&shy;fox and Sa&shy;fari sup&shy;port round bor&shy;ders but the top
left ra&shy;dius is called <code id='_39'>-moz-border-radius-topLeft</code> by Fire&shy;fox and
<code id='_40'>-webkit-border-top-left-radius</code> by Sa&shy;fari! These dis&shy;crep&shy;an&shy;cies have
two neg&shy;a&shy;tive ef&shy;fect&shy;s. First, they clut&shy;ter portable CSS files with re&shy;dun&shy;dant
but ven&shy;dor-spe&shy;cif&shy;ic dec&shy;la&shy;ra&shy;tions. Sec&shy;ond, they im&shy;pose to the pro&shy;gram&shy;mers 
the bur&shy;den of be&shy;ing aware and fa&shy;mil&shy;iar with all browsers speci&shy;fici&shy;ties.
</li><li id='_47'> Users can&shy;not de&shy;clare new el&shy;e&shy;ments. Al&shy;though con&shy;sis&shy;tent with stat&shy;ic
val&shy;i&shy;da&shy;tion, this is in&shy;ad&shy;e&shy;quate with cur&shy;rent web de&shy;vel&shy;op&shy;ment trends
where many JavaScript li&shy;braries ab&shy;stract upon HTML to pro&shy;vide new sets
of wid&shy;gets and graph&shy;i&shy;cal fa&shy;cil&shy;i&shy;ties but that are forced to un&shy;veil
pri&shy;vate im&shy;ple&shy;men&shy;ta&shy;tion de&shy;tails be&shy;cause CSS can&shy;not be ex&shy;tend&shy;ed. For
in&shy;stance, the JQuery's doc&shy;u&shy;men&shy;ta&shy;tion (see
<tt id='_43'><a id='_42' href='http://docs.jquery.com'>http://docs.jquery.com</a>)</tt> teach&shy;es us that the <em id='_44'>datepicker</em> wid&shy;get of
the ver&shy;sion 1.3.2 is im&shy;ple&shy;ment&shy;ed with a HTML <code id='_45'>DIV</code> of the class 
<code id='_46'>ui-datepicker</code>. 
</li></ul>

<p id='_50'>Our con&shy;tri&shy;bu&shy;tion, HSS, a com&shy;pil&shy;er for CSS, im&shy;proves over these two
as&shy;pect&shy;s.  It brings com&shy;put&shy;ing fa&shy;cil&shy;i&shy;ties to CSS and it al&shy;lows users to
ex&shy;tend CSS. A HSS file is com&shy;posed of a list of dec&shy;la&shy;ra&shy;tions and
rules. Dec&shy;la&shy;ra&shy;tions de&shy;fine new HTML el&shy;e&shy;ments, new prop&shy;er&shy;ty at&shy;tributes,
new prop&shy;er&shy;ty func&shy;tions, or vari&shy;ables. Rules are CSS rules where
prop&shy;er&shy;ty val&shy;ues can be dy&shy;nam&shy;i&shy;cal&shy;ly com&shy;put&shy;ed. The HSS com&shy;pil&shy;er can be
used of&shy;f-&shy;line to stat&shy;i&shy;cal&shy;ly trans&shy;late HSS source files into CSS files
that can be used by any HTML doc&shy;u&shy;ments, in&shy;de&shy;pen&shy;dent&shy;ly of any
par&shy;tic&shy;u&shy;lar web pro&shy;gram&shy;ming en&shy;vi&shy;ron&shy;men&shy;t. HSS files can also be used
on-&shy;line by Hop, a de&shy;vel&shy;op&shy;ment kit for the dif&shy;fuse Web, that em&shy;beds
HSS in its run&shy;time sys&shy;tem <span id='bibref1593'  hssclass='hoptex-bib-ref'><a id='_1595' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1594"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1594"), "\uEBADdisplay", "none");

 undefined; }'>8</a><div id='bibref1594' hssclass='hoptex-bib-popup'><table id='_1605'><tr id='_1604'><td id='_1596' class='hoptex-bib-entry-key'>8</td><td id='_1603' class='hoptex-bib-entry-value'><span id='_1597' class='hoptex-bib-entry-author'>Serrano, M.  and Gallesio, E.  and Loitsch, F. </span><a id='_1599' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html'>HOP, a language for programming the Web 2.0<span id='_1598' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html</span></a><span id='_1600' class='hoptex-bib-entry-booktitle'>Proceedings of the First Dynamic Languages Symposium</span><span id='_1601' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1602' class='hoptex-bib-entry-date'>Oct 2006</span>.</td></tr></table></div>,&#x2009;<a id='_1607' href='#bibentry-1' class='local' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1606"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1606"), "\uEBADdisplay", "none");

 undefined; }'>1</a><div id='bibref1606' hssclass='hoptex-bib-popup'><table id='_1617'><tr id='_1616'><td id='_1608' class='hoptex-bib-entry-key'>1</td><td id='_1615' class='hoptex-bib-entry-value'><span id='_1610' class='hoptex-bib-entry-author'>Boudol, G. <span id='_1609' class='hoptex-bib-entry-et-al'>et al.</span></span><span id='_1611' class='hoptex-bib-entry-title'>Towards Reasoning for Web Applications: an Operational Semantics for Hop</span><span id='_1612' class='hoptex-bib-entry-booktitle'>Proceedings of the first Workshop on Analysis and Programming Languages for Web Applications and Cloud Applications</span><span id='_1613' class='hoptex-bib-entry-address'>Toronto, Canada</span><span id='_1614' class='hoptex-bib-entry-date'>Jun 2010</span>.</td></tr></table></div></span>. HSS ac&shy;tu&shy;al&shy;ly stands for
Hop-C&shy;SS.
</p>

<p id='_56'>Sec&shy;tion <a id='_1990' hssclass='hoptex-section-ref' href='#Background' title='Background'><span id='_1940' hssclass='hoptex-section1'>2</span></a> pre&shy;sents the min&shy;i&shy;mum CSS
back&shy;ground need&shy;ed to un&shy;der&shy;stand the pa&shy;per. Sec&shy;tion <a id='_1991' hssclass='hoptex-section-ref' href='#The HSS language' title='The HSS language'><span id='_1941' hssclass='hoptex-section1'>3</span></a> pre&shy;sents the HSS lan&shy;guage.  It shows ex&shy;am&shy;ples that
il&shy;lus&shy;trate the HSS ex&shy;ten&shy;sion&shy;s. Sec&shy;tion <a id='_1992' hssclass='hoptex-section-ref' href='#The HSS compiler' title='The HSS compiler'><span id='_1974' hssclass='hoptex-section1'>4</span></a>
pre&shy;sents the com&shy;pi&shy;la&shy;tion pro&shy;cess that trans&shy;lates a HSS source file
into a CSS file. Sec&shy;tion <a id='_1993' hssclass='hoptex-section-ref' href='#Limits and Future work' title='Limits and Future work'><span id='_1985' hssclass='hoptex-section1'>5</span></a> pre&shy;sents
fu&shy;ture work. Sec&shy;tion <a id='_1994' hssclass='hoptex-section-ref' href='#Related work' title='Related work'><span id='_1986' hssclass='hoptex-section1'>6</span></a> com&shy;pares HSS with
oth&shy;er sys&shy;tems that gen&shy;er&shy;ate CSS files.
</p>

<a id='_57' name='Background'></a><h1 id='_58' name='Background'><span id='_1940' hssclass='hoptex-section1'>2</span> Background </h1>

<p id='_60'>In the mid 90s the web first start&shy;ed with plain HTML doc&shy;u&shy;ments that
were used to ex&shy;press both struc&shy;ture and vi&shy;su&shy;al as&shy;pect&shy;s. In or&shy;der to
sim&shy;pli&shy;fy au&shy;thor&shy;ing and site main&shy;te&shy;nance, the struc&shy;tur&shy;ing and the
pre&shy;sen&shy;ta&shy;tion of the doc&shy;u&shy;ments have then been sep&shy;a&shy;rat&shy;ed: nowa&shy;days HTML
is used for struc&shy;tur&shy;ing and CSS (<em id='_59'>Cascading Style Sheets</em>) is used
to at&shy;tach vi&shy;su&shy;al styles. In this sec&shy;tion we pre&shy;sent a brief CSS
tu&shy;to&shy;ri&shy;al. Read&shy;ers fa&shy;mil&shy;iar with CSS may skip this sec&shy;tion.
</p>
<p id='_61'>A web page is de&shy;scribed by a HTML tree whose nodes have chil&shy;dren
and at&shy;tributes such iden&shy;ti&shy;fiers, class&shy;es, or ac&shy;tions to be
ex&shy;e&shy;cut&shy;ed when the mouse flies over them. CSS is a declar&shy;a&shy;tive
lan&shy;guage that let pro&shy;gram&shy;mers spec&shy;i&shy;fy the graph&shy;i&shy;cal ren&shy;der&shy;ing of HTML
nodes. For in&shy;stance, a CSS dec&shy;la&shy;ra&shy;tion may spec&shy;i&shy;fy that a node is 
red, that it uses a large bold font, and that it is
dec&shy;o&shy;rat&shy;ed with a dot&shy;ted blue bor&shy;der.
</p>
<p id='_62'>A CSS file is com&shy;posed of CSS dec&shy;la&shy;ra&shy;tions which have
two parts:
</p><ol id='_67'><li id='_64'> a pat&shy;tern, also known as a <em id='_63'>selector</em>, that dis&shy;tin&shy;guish&shy;es the 
nodes on which the dec&shy;la&shy;ra&shy;tion  ap&shy;plies.
</li><li id='_66'> a list of <em id='_65'>properties</em> that ex&shy;press the graph&shy;i&shy;cal con&shy;fig&shy;u&shy;ra&shy;tions. 
</li></ol>

<p id='_68'>The syn&shy;tax of CSS dec&shy;la&shy;ra&shy;tions mim&shy;ics those of C struc&shy;tures. 
In the fol&shy;low&shy;ing dec&shy;la&shy;ra&shy;tion:
</p>
<pre id='_69'>div.example {
  color: blue;
}
</pre>

<p id='_77' class='noindent' ><q id='_71'><code id='_70'>div.example</code></q> is the se&shy;lec&shy;tor and <q id='_73'><code id='_72'>color</code></q> is
the spec&shy;i&shy;fied prop&shy;er&shy;ty. This dec&shy;la&shy;ra&shy;tion reads as fol&shy;lows:
all the HTML <code id='_74'>div</code> el&shy;e&shy;ments (a <code id='_75'>div</code> is a plain box)
that be&shy;long to the <code id='_76'>example</code> class are paint&shy;ed in blue. The fol&shy;low&shy;ing HTML
snip&shy;pet shows how such an el&shy;e&shy;ment can be de&shy;clared:
</p>
<pre id='_78'>&lt;DIV class=&quot;example&quot; id=&quot;ex1&quot;&gt;
  This is an example
 &lt;/DIV&gt;
</pre>

<p id='_79' class='noindent' >Us&shy;ing the Hop pro&shy;gram&shy;ming lan&shy;guage, one would write:
</p>
<pre id='_80'>(&lt;DIV&gt; :class &quot;example&quot; :id &quot;ex1&quot; 
   &quot;This is an example&quot;)
</pre>

<p id='_82'>Var&shy;i&shy;ous se&shy;lec&shy;tors al&shy;low CSS dec&shy;la&shy;ra&shy;tions to se&shy;lect nodes. In
ad&shy;di&shy;tion to the <em id='_81'>class</em> se&shy;lec&shy;tor pre&shy;sent&shy;ed above, three
oth&shy;er se&shy;lec&shy;tors are fre&shy;quent&shy;ly used all along this pa&shy;per:
</p>
<ul id='_110'><li id='_89'> <code id='_83'>#</code>: the <em id='_84'>identifier</em> se&shy;lec&shy;tor that fil&shy;ters el&shy;e&shy;ments ac&shy;cord&shy;ing
to their iden&shy;ti&shy;fi&shy;er. For in&shy;stance, the se&shy;lec&shy;tor

<pre id='_85'>div#ex1 { ... } 
</pre>

<p id='_88' class='noindent' >match&shy;es ex&shy;act&shy;ly the unique el&shy;e&shy;ment whose iden&shy;ti&shy;fi&shy;er
is <q id='_87'><code id='_86'>ex1</code></q> (HTML de&shy;mands unique&shy;ness of iden&shy;ti&shy;fiers).
</p></li><li id='_100'> <code id='_92'>[<em id='_90'>attr</em>=<em id='_91'>val</em>]</code>: the <em id='_93'>attribute</em> se&shy;lec&shy;tor that fil&shy;ters 
 el&shy;e&shy;ments ac&shy;cord&shy;ing to their at&shy;tribute val&shy;ues. For in&shy;stance, the se&shy;lec&shy;tor

<pre id='_94'>div[hssclass=myhssclass] { ... } 
</pre>

<p id='_98' class='noindent' >match&shy;es all the el&shy;e&shy;ments whose at&shy;tribute
<code id='_95'>hssclass</code> is the string of char&shy;ac&shy;ters <q id='_97'><code id='_96'>myhssclass</code></q>. Such 
an el&shy;e&shy;ment can be cre&shy;at&shy;ed with:
</p>
<pre id='_99'>(&lt;SPAN&gt; :hssclass &quot;myhssclass&quot; ....)
</pre>

</li><li id='_109'> <code id='_101'>:hover</code>: a <em id='_102'>virtual</em> se&shy;lec&shy;tor that match&shy;es only when the
mouse flies over the el&shy;e&shy;ments match&shy;ing the rest of the se&shy;lec&shy;tor. For
in&shy;stance the dec&shy;la&shy;ra&shy;tion:

<pre id='_103'>div.example:hover { 
  color: red; 
}
</pre>

<p id='_108' class='noindent' >can be used to turn to red <code id='_104'>div.example</code> el&shy;e&shy;ments when
the mouse flies over them. Us&shy;ing the two dec&shy;la&shy;ra&shy;tions pro&shy;duces a
graph&shy;i&shy;cal an&shy;i&shy;ma&shy;tion. The <code id='_105'>div</code> el&shy;e&shy;ments of the class <q id='_107'><code id='_106'>example</code></q>
are all blue but the one un&shy;der the mouse which is red.
</p></li></ul>


<p id='_111'>The se&shy;lec&shy;tors, may range from sim&shy;ple el&shy;e&shy;ment such as above to rich
con&shy;tex&shy;tu&shy;al pat&shy;tern&shy;s. If all con&shy;di&shy;tions in the pat&shy;tern are true for a
cer&shy;tain el&shy;e&shy;ment, the se&shy;lec&shy;tor match&shy;es the el&shy;e&shy;men&shy;t. Con&shy;tex&shy;tu&shy;al pat&shy;terns
ex&shy;press prop&shy;er&shy;ties of part of doc&shy;u&shy;ments. For in&shy;stance, the se&shy;lec&shy;tor
of the fol&shy;low&shy;ing dec&shy;la&shy;ra&shy;tion:
</p>
<pre id='_112'>div.example span.important { ... }
</pre>

<p id='_117' class='noindent' >match&shy;es <code id='_113'>span</code> el&shy;e&shy;ments of the class
<code id='_114'>important</code> whose an&shy;ces&shy;tor (di&shy;rect or not in the HTML tree) is a
<code id='_115'>div</code> of the class <code id='_116'>example</code>. In the fol&shy;low&shy;ing ex&shy;am&shy;ple:
</p>
<pre id='_118'>(&lt;DIV&gt; :class &quot;tutorial&quot;
   (&lt;DIV&gt; :class &quot;example&quot; 
      (&lt;SPAN&gt; :class &quot;important&quot; :id &quot;span1&quot;
         (&lt;SPAN&gt; :class &quot;important&quot; :id &quot;span2&quot;)))
   (&lt;SPAN&gt; :class &quot;important&quot; :id &quot;span3&quot;))
</pre>

<p id='_127' class='noindent' >only the el&shy;e&shy;ments <code id='_119'>span1</code> and <code id='_120'>span2</code> are se&shy;lect&shy;ed by
the pat&shy;tern. The el&shy;e&shy;ment <code id='_121'>span3</code> does not match be&shy;cause its only
an&shy;ces&shy;tor is a <code id='_122'>div</code> of the class <q id='_124'><code id='_123'>tutorial</code></q>, as op&shy;posed to 
<q id='_126'><code id='_125'>example</code></q>.
</p>
<p id='_128'>An el&shy;e&shy;ment may match sev&shy;er&shy;al se&shy;lec&shy;tors. For in&shy;stance, if we add
the fol&shy;low&shy;ing dec&shy;la&shy;ra&shy;tion to our pre&shy;vi&shy;ous ex&shy;am&shy;ple:
</p>
<pre id='_129'>span.important {
  color: green;
}
</pre>

<p id='_138' class='noindent' >all the <code id='_130'>span</code> el&shy;e&shy;ments of the class <q id='_132'><code id='_131'>important</code></q>
that are chil&shy;dren of <code id='_133'>div</code> of the class <q id='_135'><code id='_134'>example</code></q> match&shy;es the
two se&shy;lec&shy;tors. To re&shy;solve this am&shy;bi&shy;gu&shy;i&shy;ty, which means here choos&shy;ing
be&shy;tween green and blue for paint&shy;ing the <code id='_136'>span</code>, CSS re&shy;sorts on a
nor&shy;mal&shy;ized al&shy;go&shy;rithm that se&shy;lects amongst all the match&shy;ing rules the
<em id='_137'>most specific</em> one.
</p>
<p id='_140'>Read&shy;ers keen to un&shy;der&shy;stand the full tech&shy;ni&shy;cal de&shy;tails and
sub&shy;tleties of CSS may re&shy;fer to the W3C spec&shy;i&shy;fi&shy;ca&shy;tions
<span id='bibref1618'  hssclass='hoptex-bib-ref'><a id='_1620' href='http://www.w3.org/TR/2009/CR-CSS2-20090423/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1619"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1619"), "\uEBADdisplay", "none");

 undefined; }'>9</a><div id='bibref1619' hssclass='hoptex-bib-popup'><table id='_1630'><tr id='_1629'><td id='_1621' class='hoptex-bib-entry-key'>9</td><td id='_1628' class='hoptex-bib-entry-value'><span id='_1622' class='hoptex-bib-entry-author'>World Wide Web Consortium, </span><a id='_1624' class='hoptex-bib-entry-title' href='http://www.w3.org/TR/2009/CR-CSS2-20090423/'>Cascading Style Sheets level 2 Revision 1 CSS2.1 Specification<span id='_1623' class='hoptex-bib-entry-url'>http://www.w3.org/TR/2009/CR-CSS2-20090423/</span></a><span id='_1625' class='hoptex-bib-entry-number'>CR-CSS2-20090423</span><span id='_1626' class='hoptex-bib-entry-institution'>W3C Recommendation</span><span id='_1627' class='hoptex-bib-entry-date'>Apr 2009</span>.</td></tr></table></div></span>.
</p>

<a id='_141' name='The HSS language'></a><h1 id='_142' name='The HSS language'><span id='_1941' hssclass='hoptex-section1'>3</span> The HSS language </h1>

<p id='_143'>HSS is both a declar&shy;a&shy;tive lan&shy;guage built on top of CSS and a
com&shy;pil&shy;er that trans&shy;lates the HSS lan&shy;guage into CSS. Any cor&shy;rect CSS
file is a cor&shy;rect HSS source file.  Ad&shy;di&shy;tion&shy;al&shy;ly, HSS sup&shy;ports four
syn&shy;tac&shy;tic ex&shy;ten&shy;sions:
</p>
<ul id='_152'><li id='_145'> <code id='_144'>define-hss-property</code>, which de&shy;fines new CSS prop&shy;er&shy;ties;
</li><li id='_147'> <code id='_146'>define-hss-function</code>, which de&shy;fines new CSS func&shy;tions;
</li><li id='_149'> <code id='_148'>define-hss-type</code>, which de&shy;fines new CSS el&shy;e&shy;ments;
</li><li id='_151'> <code id='_150'>$-form</code>, which al&shy;lows ar&shy;bi&shy;trary dy&shy;nam&shy;ic com&shy;pu&shy;ta&shy;tion&shy;s.
</li></ul>

<p id='_160'>The for&shy;mal syn&shy;tax of HSS is de&shy;scribed by the <span id='_153' class='prog-syntax-domain'>H</span> syn&shy;tax pre&shy;sent&shy;ed in Fig&shy;ures
<a id='_2002' class='hoptex-figure-ref' href='#fig:Hn' title='Figure 1: Grammar for HSS.'><span id='_1923' hssclass='hoptex-figure-counter'>1</span></a>, <a id='_2003' class='hoptex-figure-ref' href='#fig:S' title='Figure 2: Grammar for HSS selectors.'><span id='_1924' hssclass='hoptex-figure-counter'>2</span></a>, <a id='_2004' class='hoptex-figure-ref' href='#fig:D' title='Figure 3: Grammar for HSS declarations.'><span id='_1925' hssclass='hoptex-figure-counter'>3</span></a>, 
<a id='_2005' class='hoptex-figure-ref' href='#fig:Hprop' title='Figure 4: Grammar for HSS property compilers.'><span id='_1926' hssclass='hoptex-figure-counter'>4</span></a>, <a id='_2006' class='hoptex-figure-ref' href='#fig:Hfun' title='Figure 5: Function definition.'><span id='_1927' hssclass='hoptex-figure-counter'>5</span></a> and <a id='_2007' class='hoptex-figure-ref' href='#fig:Htypes' title='Figure 6: HSS types.'><span id='_1928' hssclass='hoptex-figure-counter'>6</span></a>.
</p>

<div id='fig:Hn' hssclass='hoptex-figure' class='article-figure-centered' label='Grammar for HSS.'><a id='_221' name='Grammar for HSS.'></a><table id='_224' hssclass='hoptex-figure-content'><tr id='_223'><td id='_222' hssclass='hoptex-figure-content'><div id='_220' hssclass='prog-syntax'><table id='_219'><tr id='_167'><td id='_162' class='prog-syntax-lhs'><span id='_161' class='prog-syntax-domain'>H</span></td><td id='_163' class='prog-syntax-def'>::=</td><td id='_165' class='prog-syntax-rhs'><span id='_164' class='prog-syntax-domain'>X</span></td><td id='_166' class='prog-syntax-comment'>HSS definition</td></tr><tr id='_174'><td id='_168' class='prog-syntax-lhs'></td><td id='_169' class='prog-syntax-def'>|</td><td id='_172' class='prog-syntax-rhs'><tt id='_170' class='prog-syntax-terminal'>$</tt><tt id='_171'>expr</tt></td><td id='_173' class='prog-syntax-comment'>Hop expression</td></tr><tr id='_193'><td id='_175' class='prog-syntax-lhs'></td><td id='_176' class='prog-syntax-def'>|</td><td id='_191' class='prog-syntax-rhs'><span id='_178' class='prog-syntax-domain'>S<sub id='_177'>1</sub></span><tt id='_179' class='prog-syntax-terminal'>,</tt> &#8230; <tt id='_180' class='prog-syntax-terminal'>,</tt><span id='_182' class='prog-syntax-domain'>S<sub id='_181'>n</sub></span> <tt id='_183' class='prog-syntax-terminal'>{</tt><span id='_185' class='prog-syntax-domain'>D<sub id='_184'>1</sub></span><tt id='_186' class='prog-syntax-terminal'>;</tt> &#8230; <span id='_188' class='prog-syntax-domain'>D<sub id='_187'>m</sub></span><tt id='_189' class='prog-syntax-terminal'>;</tt> <tt id='_190' class='prog-syntax-terminal'>}</tt> </td><td id='_192' class='prog-syntax-comment'>rule set</td></tr><tr id='_202'><td id='_195' class='prog-syntax-lhs'><span id='_194' class='prog-syntax-domain'>X</span></td><td id='_196' class='prog-syntax-def'>::=</td><td id='_200' class='prog-syntax-rhs'><span id='_199' class='prog-syntax-domain'>H<sub id='_198'><span id='_197' class='prog-syntax-domain'>prop</span></sub></span></td><td id='_201' class='prog-syntax-comment'>property definition</td></tr><tr id='_210'><td id='_203' class='prog-syntax-lhs'></td><td id='_204' class='prog-syntax-def'>|</td><td id='_208' class='prog-syntax-rhs'><span id='_207' class='prog-syntax-domain'>H<sub id='_206'><span id='_205' class='prog-syntax-domain'>fun</span></sub></span></td><td id='_209' class='prog-syntax-comment'>function definition</td></tr><tr id='_218'><td id='_211' class='prog-syntax-lhs'></td><td id='_212' class='prog-syntax-def'>|</td><td id='_216' class='prog-syntax-rhs'><span id='_215' class='prog-syntax-domain'>H<sub id='_214'><span id='_213' class='prog-syntax-domain'>type</span></sub></span></td><td id='_217' class='prog-syntax-comment'>type definition</td></tr></table></div></td></tr></table><div id='_226' hssclass='hoptex-figure-caption'><a id='_2008' class='hoptex-figure-ref' href='#fig:Hn' title='Figure 1: Grammar for HSS.'><span id='_1923' hssclass='hoptex-figure-counter'>1</span></a>Grammar for HSS.</div><a id='_227' name='fig:Hn'></a></div>


<p id='_237'>The def&shy;i&shy;ni&shy;tions of <span id='_230' class='prog-syntax-domain'>H<sub id='_229'><span id='_228' class='prog-syntax-domain'>prop</span></sub></span> <span id='_233' class='prog-syntax-domain'>H<sub id='_232'><span id='_231' class='prog-syntax-domain'>fun</span></sub></span>, and <span id='_236' class='prog-syntax-domain'>H<sub id='_235'><span id='_234' class='prog-syntax-domain'>type</span></sub></span> will be pre&shy;sent&shy;ed
in the rest of this sec&shy;tion along with ex&shy;am&shy;ples.
</p>

<div id='fig:S' hssclass='hoptex-figure' class='article-figure-centered' label='Grammar for HSS selectors.'><a id='_318' name='Grammar for HSS selectors.'></a><table id='_321' hssclass='hoptex-figure-content'><tr id='_320'><td id='_319' hssclass='hoptex-figure-content'><div id='_317' hssclass='prog-syntax'><table id='_316'><tr id='_249'><td id='_239' class='prog-syntax-lhs'><span id='_238' class='prog-syntax-domain'>S</span></td><td id='_240' class='prog-syntax-def'>::=</td><td id='_247' class='prog-syntax-rhs'><span id='_242' class='prog-syntax-domain'>S'<sub id='_241'>1</sub></span> <span id='_243' class='prog-syntax-domain'>op</span> &#8230; <span id='_244' class='prog-syntax-domain'>op</span> <span id='_246' class='prog-syntax-domain'>S'<sub id='_245'>k</sub></span></td><td id='_248' class='prog-syntax-comment'>compound selector</td></tr><tr id='_255'><td id='_251' class='prog-syntax-lhs'><span id='_250' class='prog-syntax-domain'>S'</span></td><td id='_252' class='prog-syntax-def'>::=</td><td id='_253' class='prog-syntax-rhs'>IDENT</td><td id='_254' class='prog-syntax-comment'>element type</td></tr><tr id='_262'><td id='_256' class='prog-syntax-lhs'></td><td id='_257' class='prog-syntax-def'>|</td><td id='_260' class='prog-syntax-rhs'><span id='_258' class='prog-syntax-domain'>S'</span> <tt id='_259' class='prog-syntax-terminal'>.</tt> STRING</td><td id='_261' class='prog-syntax-comment'>class</td></tr><tr id='_269'><td id='_263' class='prog-syntax-lhs'></td><td id='_264' class='prog-syntax-def'>|</td><td id='_267' class='prog-syntax-rhs'><span id='_265' class='prog-syntax-domain'>S'</span> <tt id='_266' class='prog-syntax-terminal'>:</tt> STRING</td><td id='_268' class='prog-syntax-comment'>pseudo-element</td></tr><tr id='_276'><td id='_271' class='prog-syntax-lhs'><span id='_270' class='prog-syntax-domain'>op</span></td><td id='_272' class='prog-syntax-def'>::=</td><td id='_274' class='prog-syntax-rhs'>'&nbsp;' | <tt id='_273' class='prog-syntax-terminal'>&lt;</tt></td><td id='_275' class='prog-syntax-comment'>child of</td></tr><tr id='_282'><td id='_277' class='prog-syntax-lhs'></td><td id='_278' class='prog-syntax-def'>|</td><td id='_280' class='prog-syntax-rhs'><tt id='_279' class='prog-syntax-terminal'>&gt;</tt></td><td id='_281' class='prog-syntax-comment'>descendant of</td></tr><tr id='_288'><td id='_283' class='prog-syntax-lhs'></td><td id='_284' class='prog-syntax-def'>|</td><td id='_286' class='prog-syntax-rhs'><tt id='_285' class='prog-syntax-terminal'>+</tt></td><td id='_287' class='prog-syntax-comment'>sibling</td></tr><tr id='_296'><td id='_289' class='prog-syntax-lhs'></td><td id='_290' class='prog-syntax-def'>|</td><td id='_294' class='prog-syntax-rhs'><tt id='_291' class='prog-syntax-terminal'>[</tt> IDENT <span id='_292' class='prog-syntax-domain'>opa</span> STRING <tt id='_293' class='prog-syntax-terminal'>]</tt></td><td id='_295' class='prog-syntax-comment'>attribute</td></tr><tr id='_303'><td id='_298' class='prog-syntax-lhs'><span id='_297' class='prog-syntax-domain'>opa</span></td><td id='_299' class='prog-syntax-def'>::=</td><td id='_301' class='prog-syntax-rhs'><tt id='_300' class='prog-syntax-terminal'>=</tt></td><td id='_302' class='prog-syntax-comment'>match exact</td></tr><tr id='_309'><td id='_304' class='prog-syntax-lhs'></td><td id='_305' class='prog-syntax-def'>|</td><td id='_307' class='prog-syntax-rhs'><tt id='_306' class='prog-syntax-terminal'>~=</tt></td><td id='_308' class='prog-syntax-comment'>match member</td></tr><tr id='_315'><td id='_310' class='prog-syntax-lhs'></td><td id='_311' class='prog-syntax-def'>|</td><td id='_313' class='prog-syntax-rhs'><tt id='_312' class='prog-syntax-terminal'>|=</tt></td><td id='_314' class='prog-syntax-comment'>match start</td></tr></table></div></td></tr></table><div id='_323' hssclass='hoptex-figure-caption'><a id='_2009' class='hoptex-figure-ref' href='#fig:S' title='Figure 2: Grammar for HSS selectors.'><span id='_1924' hssclass='hoptex-figure-counter'>2</span></a>Grammar for HSS selectors.</div><a id='_324' name='fig:S'></a></div>


<p id='_327'>The ac&shy;tu&shy;al con&shy;crete syn&shy;tax of <span id='_325' class='syntax-comment'>child of</span> op&shy;er&shy;a&shy;tor is only the emp&shy;ty string. For the sake of
read&shy;abil&shy;i&shy;ty of the pa&shy;per, we have added here
the ter&shy;mi&shy;nal <tt id='_326' class='syntax-terminal'>&lt;</tt>.
</p>

<div id='fig:D' hssclass='hoptex-figure' class='article-figure-centered' label='Grammar for HSS declarations.'><a id='_364' name='Grammar for HSS declarations.'></a><table id='_367' hssclass='hoptex-figure-content'><tr id='_366'><td id='_365' hssclass='hoptex-figure-content'><div id='_363' hssclass='prog-syntax'><table id='_362'><tr id='_335'><td id='_329' class='prog-syntax-lhs'><span id='_328' class='prog-syntax-domain'>D</span></td><td id='_330' class='prog-syntax-def'>::=</td><td id='_333' class='prog-syntax-rhs'>IDENT <tt id='_331' class='prog-syntax-terminal'>:</tt> <span id='_332' class='prog-syntax-domain'>E</span></td><td id='_334' class='prog-syntax-comment'>declaration</td></tr><tr id='_343'><td id='_337' class='prog-syntax-lhs'><span id='_336' class='prog-syntax-domain'>E</span></td><td id='_338' class='prog-syntax-def'>::=</td><td id='_341' class='prog-syntax-rhs'><tt id='_339' class='prog-syntax-terminal'>$</tt><tt id='_340'>expr</tt></td><td id='_342' class='prog-syntax-comment'>Hop expression</td></tr><tr id='_356'><td id='_344' class='prog-syntax-lhs'></td><td id='_345' class='prog-syntax-def'>|</td><td id='_354' class='prog-syntax-rhs'>IDENT<tt id='_346' class='prog-syntax-terminal'>(</tt><span id='_348' class='prog-syntax-domain'>E<sub id='_347'>1</sub></span><tt id='_349' class='prog-syntax-terminal'>,</tt> &#8230; <tt id='_350' class='prog-syntax-terminal'>,</tt><span id='_352' class='prog-syntax-domain'>E<sub id='_351'>p</sub></span><tt id='_353' class='prog-syntax-terminal'>)</tt></td><td id='_355' class='prog-syntax-comment'>function call</td></tr><tr id='_361'><td id='_357' class='prog-syntax-lhs'></td><td id='_358' class='prog-syntax-def'>|</td><td id='_359' class='prog-syntax-rhs'>STRING</td><td id='_360' class='prog-syntax-comment'>literal</td></tr></table></div></td></tr></table><div id='_369' hssclass='hoptex-figure-caption'><a id='_2010' class='hoptex-figure-ref' href='#fig:D' title='Figure 3: Grammar for HSS declarations.'><span id='_1925' hssclass='hoptex-figure-counter'>3</span></a>Grammar for HSS declarations.</div><a id='_370' name='fig:D'></a></div>



<p id='_371'>In this sec&shy;tion we pre&shy;sent suc&shy;ces&shy;sive&shy;ly the HSS ex&shy;ten&shy;sions, each
ac&shy;com&shy;pa&shy;nied with a re&shy;al&shy;is&shy;tic mo&shy;ti&shy;vat&shy;ing ex&shy;am&shy;ple.
</p>

<a id='_372' name='HSS user-defined properties'></a><h2 id='_373' name='HSS user-defined properties'><span id='_1943' hssclass='hoptex-section2'>3<span id='_1942' hssclass='hoptex-subsection'>1</span></span> HSS user-defined properties </h2>

<p id='_374'>A reg&shy;u&shy;lar CSS dec&shy;la&shy;ra&shy;tion as&shy;signs a val&shy;ue to a prop&shy;er&shy;ty. Its syn&shy;tax
con&shy;sists of a prop&shy;er&shy;ty name fol&shy;lowed by colon fol&shy;lowed by a
val&shy;ue. Ex&shy;am&shy;ples:
</p>
<pre id='_375'>border: 1px solid red;
font-size: 120%;
background: rgb(100,50,200);
</pre>

<p id='_377'>The set of prop&shy;er&shy;ty names that can be used in an as&shy;sign&shy;ment is
closed, <em id='_376'>i.e.,</em> users can&shy;not de&shy;fine their own prop&shy;er&shy;ties.
</p>

<a id='_378' name='HSS properties'></a><h3 id='_379' name='HSS properties'><span id='_1946' hssclass='hoptex-section3'>3<span id='_1944' hssclass='hoptex-subsection'>1</span><span id='_1945' hssclass='hoptex-subsection'>1</span></span> HSS properties </h3>

<p id='_381'>HSS ex&shy;tends CSS by al&shy;low&shy;ing de&shy;vel&shy;op&shy;ers to de&shy;clare their own new CSS
prop&shy;er&shy;ties. HSS pro&shy;gram&shy;mers de&shy;clare <em id='_380'>property compilers</em> that
rewrite a dec&shy;la&shy;ra&shy;tion into a list of new HSS dec&shy;la&shy;ra&shy;tions. These new
dec&shy;la&shy;ra&shy;tions are them&shy;selves com&shy;piled. This pro&shy;cess it&shy;er&shy;ates un&shy;til the
dec&shy;la&shy;ra&shy;tions pro&shy;duced by com&shy;pi&shy;la&shy;tion only con&shy;cern prim&shy;i&shy;tive CSS-2
prop&shy;er&shy;ties.
</p>
<p id='_383'>HSS views a prop&shy;er&shy;ty as con&shy;sist&shy;ing of a list of strings (the
pa&shy;ram&shy;e&shy;ters) plus a dis&shy;tin&shy;guished string (the pri&shy;or&shy;i&shy;ty); the user may
de&shy;fine a func&shy;tion, a <em id='_382'>property compiler</em>, that takes these and
re&shy;turns a string that re&shy;places the prop&shy;er&shy;ty cal&shy;l. In the ex&shy;am&shy;ple:
</p>
<pre id='_384'>border: 1px solid red ! important;
</pre>

<p id='_390' class='noindent' >The prop&shy;er&shy;ty com&shy;pil&shy;er is the user-de&shy;fined func&shy;tion as&shy;so&shy;ci&shy;at&shy;ed with
<code id='_385'>border</code>, the <em id='_386'>value</em> pa&shy;ram&shy;e&shy;ter is bound to the list <code id='_387'>&quot;1px&quot;
&quot;solid&quot; &quot;red&quot;</code> and the <em id='_388'>priority</em> is the string
<code id='_389'>&quot;important&quot;</code>. The re&shy;sult of a prop&shy;er&shy;ty com&shy;pil&shy;er is a string that is
in&shy;sert&shy;ed in the gen&shy;er&shy;at&shy;ed file, in re&shy;place&shy;ment of the prop&shy;er&shy;ty cal&shy;l.
</p>
<div id='fig:Hprop' hssclass='hoptex-figure' class='article-figure-centered' label='Grammar for HSS property compilers.'><a id='_407' name='Grammar for HSS property compilers.'></a><table id='_410' hssclass='hoptex-figure-content'><tr id='_409'><td id='_408' hssclass='hoptex-figure-content'><div id='_406' hssclass='prog-syntax'><table id='_405'><tr id='_404'><td id='_394' class='prog-syntax-lhs'><span id='_393' class='prog-syntax-domain'>H<sub id='_392'><span id='_391' class='prog-syntax-domain'>prop</span></sub></span></td><td id='_395' class='prog-syntax-def'>::=</td><td id='_402' class='prog-syntax-rhs'><tt id='_396' class='prog-syntax-terminal'>(</tt><tt id='_397' class='prog-syntax-terminal'>define-hss-property</tt> <tt id='_398' class='prog-syntax-terminal'>(</tt>IDENT IDENT IDENT<tt id='_399' class='prog-syntax-terminal'>)</tt> <tt id='_400'>expr</tt><tt id='_401' class='prog-syntax-terminal'>)</tt></td><td id='_403' class='prog-syntax-comment'></td></tr></table></div></td></tr></table><div id='_412' hssclass='hoptex-figure-caption'><a id='_2011' class='hoptex-figure-ref' href='#fig:Hprop' title='Figure 4: Grammar for HSS property compilers.'><span id='_1926' hssclass='hoptex-figure-counter'>4</span></a>Grammar for HSS property compilers.</div><a id='_413' name='fig:Hprop'></a></div>

<p id='_416'>Prop&shy;er&shy;ty com&shy;pil&shy;ers are de&shy;fined by the <code id='_414'>define-hss-property</code> form
whose syn&shy;tax is giv&shy;en Fig&shy;ure <a id='_2012' class='hoptex-figure-ref' href='#fig:Hprop' title='Figure 4: Grammar for HSS property compilers.'><span id='_1926' hssclass='hoptex-figure-counter'>4</span></a>. Their sig&shy;na&shy;ture
is as fol&shy;lows:
</p>
<pre id='_418' class='syntax'><i id='_417'>property compiler:</i> string list &#215; string &#8594; string
</pre>

<p id='_420'>The body of the prop&shy;er&shy;ty com&shy;pil&shy;er is giv&shy;en by the ex&shy;pres&shy;sion <tt id='_419'>expr</tt>
that be&shy;longs to the pro&shy;gram&shy;ming lan&shy;guage used with HSS. The cur&shy;rent ac&shy;tu&shy;al
HSS im&shy;ple&shy;men&shy;ta&shy;tion uses Hop so the rest of the pa&shy;per.
</p>
<p id='_424'>The fol&shy;low&shy;ing ex&shy;am&shy;ple de&shy;fines a new <code id='_421'>black-and-white</code> prop&shy;er&shy;ty that
con&shy;trols the back&shy;ground and fore&shy;ground col&shy;ors of HTML el&shy;e&shy;ments. It
ac&shy;cepts two pos&shy;si&shy;ble val&shy;ues <code id='_422'>regular</code> and <code id='_423'>invert</code>. It might be de&shy;fined as:
</p>

<pre id='_425'>(define-hss-property (black-and-white val prio)
   (if (string=? (car val) &quot;regular&quot;)
       &quot;color: black; background: white;&quot;
       &quot;color: white; background: black;&quot;))
</pre>

<p id='_426' class='noindent' >and might be used in rules such as:
</p>
<pre id='_427'>div.box {
  black-and-white: invert;
}
</pre>

<p id='_429'>Note: it might be not&shy;ed that a prop&shy;er&shy;ty com&shy;pil&shy;er re&shy;turns a new HSS
frag&shy;ment that is in&shy;sert&shy;ed in the style sheet. Be&shy;cause it is deemed
sim&shy;pler to gen&shy;er&shy;ate ac&shy;tu&shy;al HSS ex&shy;ter&shy;nal syn&shy;tax than any in&shy;ter&shy;nal
for&shy;mat, it has been de&shy;cid&shy;ed that prop&shy;er&shy;ty com&shy;pil&shy;ers re&shy;turn strings
in&shy;stead of ab&shy;stract syn&shy;tax trees. As pre&shy;sent&shy;ed in Sec&shy;tion
<a id='_1995' hssclass='hoptex-section-ref' href='#The HSS compiler' title='The HSS compiler'><span id='_1974' hssclass='hoptex-section1'>4</span></a> these strings are parsed back by the
HSS com&shy;pil&shy;er in or&shy;der to com&shy;plete the com&shy;pi&shy;la&shy;tion pro&shy;cess.
</p>
<a id='_430' name='Motivating example: browser compatibility'></a><h3 id='_431' name='Motivating example: browser compatibility'><span id='_1949' hssclass='hoptex-section3'>3<span id='_1947' hssclass='hoptex-subsection'>1</span><span id='_1948' hssclass='hoptex-subsection'>2</span></span> Motivating example: browser compatibility </h3>

<p id='_436'>The ac&shy;tu&shy;al CSS prop&shy;er&shy;ties set is spe&shy;cif&shy;ic to each brows&shy;er. All
main&shy;stream browsers sup&shy;port a su&shy;per&shy;set of CSS-2.1
prop&shy;er&shy;ties. Ven&shy;dor-spe&shy;cif&shy;ic prop&shy;er&shy;ties have name pre&shy;fixed with a
dis&shy;tin&shy;guish&shy;ing mark, <em id='_432'>e.g.,</em> <tt id='_433'>-moz-</tt>, <tt id='_434'>-webkit-</tt>, or
<tt id='_435'>-o-</tt>. Im&shy;ple&shy;ment&shy;ing CSS files com&shy;pat&shy;i&shy;ble with all the ma&shy;jor browsers
is then te&shy;dious be&shy;cause clut&shy;tered with many ven&shy;dor-spe&shy;cif&shy;ic re&shy;dun&shy;dant
dec&shy;la&shy;ra&shy;tions. For in&shy;stance, spec&shy;i&shy;fy&shy;ing round bor&shy;ders for box&shy;es could
yield to:
</p>
<pre id='_437'>pre.example {
  -moz-border-radius: 1em 2em 1em 2em;
  -webkit-border-top-left-radius: 1em;
  -webkit-border-top-right-radius: 2em;
  -webkit-border-bottom-right-radius: 1em;
  -webkit-border-bottom-left-radius: 2em;
  border-top-left-radius: 1em;
  border-top-right-radius: 2em;
  border-bottom-right-radius: 1em;
  border-bottom-left-radius: 2em;
}
</pre>

<p id='_438'>HSS prop&shy;er&shy;ties can be used to en&shy;sure brows&shy;er com&shy;pat&shy;i&shy;bil&shy;i&shy;ty
au&shy;to&shy;mat&shy;i&shy;cal&shy;ly. For in&shy;stance, the com&shy;pat&shy;i&shy;bil&shy;i&shy;ty rule for round bor&shy;ders
could be de&shy;fined as:
</p>

<pre id='_439'>(define-hss-property (border-radius v p)
   (match-case v
     ((?tl ?tr ?br ?bl)
      (format &quot;-moz-border-radius: ~a ~a ~a ~a;
          -webkit-border-top-left-radius: ~a;
          -webkit-border-top-right-radius: ~a;
          -webkit-border-bottom-right-radius: ~a;
          -webkit-border-bottom-left-radius: ~a;
          border-top-left-radius: ~a;
          border-top-right-radius: ~a;
          border-bottom-right-radius: ~a;
          border-bottom-left-radius: ~a;&quot;
          tl tr br bl tl tr br bl tl tr br bl))
     ((?r)
      (format &quot;-moz-border-radius: ~a;
          -webkit-border-radius: ~a;
          border-radius: ~a;&quot; 
          r r r))
     (else
      (error 'border-radius &quot;wrong number of args&quot; v))))
</pre>

<p id='_442'>The HSS prop&shy;er&shy;ty <code id='_440'>border-radius</code> can be giv&shy;en ei&shy;ther four val&shy;ues
(one for each of the four cor&shy;ners) or only one val&shy;ue (that is used for
all the four cor&shy;ners). Pro&shy;vid&shy;ed with this def&shy;i&shy;ni&shy;tion, the pre&shy;vi&shy;ous
<code id='_441'>pre.example</code> ex&shy;am&shy;ple can be re-writ&shy;ten us&shy;ing the fol&shy;low&shy;ing com&shy;pact
dec&shy;la&shy;ra&shy;tion:
</p>
<pre id='_443'>pre.example {
  border-radius: 1em 2em 1em 2em;
}
</pre>

<p id='_444'>This ex&shy;am&shy;ple il&shy;lus&shy;trates two ad&shy;van&shy;tages of HSS over CSS dec&shy;la&shy;ra&shy;tions:
</p>
<ol id='_449'><li id='_446'> HSS source files are more <em id='_445'>compact</em> than their cor&shy;re&shy;spond&shy;ing CSS files;
</li><li id='_448'> HSS files are <em id='_447'>easier to maintain</em> be&shy;cause if a new brows&shy;er shows up 
 with its own syn&shy;tax for sup&shy;port&shy;ing a pop&shy;u&shy;lar ex&shy;ten&shy;sion, only the HSS rule 
 declar&shy;ing that ex&shy;ten&shy;sion has to be mod&shy;i&shy;fied, not the user HSS sources. 
 HSS helps ap&shy;pli&shy;ca&shy;tions de&shy;vel&shy;op&shy;ers to write portable CSS files.
</li></ol>

<a id='_450' name='HSS user-defined functions'></a><h2 id='_451' name='HSS user-defined functions'><span id='_1951' hssclass='hoptex-section2'>3<span id='_1950' hssclass='hoptex-subsection'>2</span></span> HSS user-defined functions </h2>

<p id='_452'>A CSS val&shy;ue may be a lit&shy;er&shy;al (a string, a num&shy;ber, a col&shy;or, etc.), a
URI, or a func&shy;tion cal&shy;l. Ex&shy;am&shy;ples:
</p>
<pre id='_453'>color: red;
background: rgb(20%,40%,15%);
content: attr(bg);
</pre>

<p id='_454'>As prop&shy;er&shy;ties, func&shy;tions can&shy;not be de&shy;fined by users and
main&shy;stream browsers ex&shy;tend the set de&shy;fined by CSS-2. As prop&shy;er&shy;ties,
these ex&shy;ten&shy;sions raise porta&shy;bil&shy;i&shy;ty is&shy;sues.
</p>

<a id='_455' name='HSS functions'></a><h3 id='_456' name='HSS functions'><span id='_1954' hssclass='hoptex-section3'>3<span id='_1952' hssclass='hoptex-subsection'>2</span><span id='_1953' hssclass='hoptex-subsection'>1</span></span> HSS functions </h3>

<p id='_459'>HSS sup&shy;ports user-de&shy;fined func&shy;tion&shy;s. They are in&shy;tro&shy;duced by the
<code id='_457'>define-hss-function</code> form whose syn&shy;tax is giv&shy;en Fig&shy;ure <a id='_2013' class='hoptex-figure-ref' href='#fig:Hfun' title='Figure 5: Function definition.'><span id='_1927' hssclass='hoptex-figure-counter'>5</span></a>.
</p>
<div id='fig:Hfun' hssclass='hoptex-figure' class='article-figure-centered' label='Function definition.'><a id='_476' name='Function definition.'></a><table id='_479' hssclass='hoptex-figure-content'><tr id='_478'><td id='_477' hssclass='hoptex-figure-content'><div id='_475' hssclass='prog-syntax'><table id='_474'><tr id='_473'><td id='_463' class='prog-syntax-lhs'><span id='_462' class='prog-syntax-domain'>H<sub id='_461'><span id='_460' class='prog-syntax-domain'>fun</span></sub></span></td><td id='_464' class='prog-syntax-def'>::=</td><td id='_471' class='prog-syntax-rhs'><tt id='_465' class='prog-syntax-terminal'>(</tt><tt id='_466' class='prog-syntax-terminal'>define-hss-function</tt> <tt id='_467' class='prog-syntax-terminal'>(</tt>IDENT IDENT ...<tt id='_468' class='prog-syntax-terminal'>)</tt> <tt id='_469'>expr</tt><tt id='_470' class='prog-syntax-terminal'>)</tt></td><td id='_472' class='prog-syntax-comment'></td></tr></table></div></td></tr></table><div id='_481' hssclass='hoptex-figure-caption'><a id='_2014' class='hoptex-figure-ref' href='#fig:Hfun' title='Figure 5: Function definition.'><span id='_1927' hssclass='hoptex-figure-counter'>5</span></a>Function definition.</div><a id='_482' name='fig:Hfun'></a></div>

<p id='_483' class='noindent' >The sig&shy;na&shy;ture of a HSS func&shy;tion is:
</p>
<pre id='_485' class='syntax'><i id='_484'>value function:</i> string &#215; ... &#8594; string</pre>


<p id='_486'>The for&shy;mal pa&shy;ram&shy;e&shy;ters of HSS func&shy;tions are bound to strings
rep&shy;re&shy;sent&shy;ing the ac&shy;tu&shy;al val&shy;ues spec&shy;i&shy;fied at the call sites. For
in&shy;stance, in the prop&shy;er&shy;ty as&shy;sign&shy;ment:
</p>
<pre id='_487'>background: rgb(20%,40%,15%);
</pre>

<p id='_495'>The three for&shy;mal pa&shy;ram&shy;e&shy;ters of the <code id='_488'>rgb</code> func&shy;tion are bound to 
<q id='_490'><code id='_489'>20</code>%</q>, <q id='_492'><code id='_491'>40</code>%</q>, and <q id='_494'><code id='_493'>15</code>%</q>.
</p>
<a id='_496' name='Motivating example: specification compatibility'></a><h3 id='_497' name='Motivating example: specification compatibility'><span id='_1957' hssclass='hoptex-section3'>3<span id='_1955' hssclass='hoptex-subsection'>2</span><span id='_1956' hssclass='hoptex-subsection'>2</span></span> Motivating example: specification compatibility </h3>

<p id='_501'>CSS-3 ex&shy;tends CSS-2 in many di&shy;rec&shy;tion&shy;s. In par&shy;tic&shy;u&shy;lar, the col&shy;or
mod&shy;ule has been sig&shy;nif&shy;i&shy;cant&shy;ly aug&shy;ment&shy;ed. CSS-3 col&shy;ors may be
spec&shy;i&shy;fied us&shy;ing <em id='_498'>RGB</em> com&shy;po&shy;nents as well as <em id='_499'>HSL</em> or <em id='_500'>HSLA</em>
com&shy;po&shy;nents. For in&shy;stance
</p>
<pre id='_502'>div.highlight {
  background: rgb(255,0,0);
  opacity: 0.9;
}
</pre>

<p id='_503' class='noindent' >may also be writ&shy;ten us&shy;ing CSS-3 spec&shy;i&shy;fi&shy;ca&shy;tion as:
</p>
<pre id='_504'>div.highlight {
  background: hsla(0,100%,50%,90%);
}
</pre>

<p id='_508'>The CSS-3 <code id='_505'>hsla</code> func&shy;tion can be de&shy;fined as a HSS val&shy;ue func&shy;tion and
calls to <code id='_506'>hsla</code> con&shy;vert&shy;ed into CSS-2 at&shy;tribute val&shy;ues dur&shy;ing the HSS
com&shy;pi&shy;la&shy;tion. With HSS, <code id='_507'>hsla</code> can be de&shy;fined as:
</p>

<pre id='_509'>(define-hss-function (hsla h s l a)
   (multiple-value-bind (r g b)
      (hsl-&gt;rgb (string-&gt;number h) 
                (string-&gt;number s)
                (string-&gt;number l))
      (format &quot;rgb(~a,~a,~a); opacity:~a;&quot; 
              r g b 
              (percentage-&gt;real a))))
</pre>

<p id='_522'>This def&shy;i&shy;ni&shy;tion uses the Hop li&shy;brary func&shy;tion <code id='_510'>hsl-&gt;rgb</code> that
re&shy;turns the <em id='_511'>RGB</em> com&shy;po&shy;nents of a <em id='_512'>HSL</em> col&shy;or spec&shy;i&shy;fi&shy;ca&shy;tion. This
func&shy;tion re&shy;turns three val&shy;ues that are bound to lo&shy;cal vari&shy;ables
(<code id='_513'>r</code>, <code id='_514'>g</code>, and <code id='_515'>b</code>) by the <code id='_516'>multiple-value-bind</code>
for&shy;m. The <code id='_517'>a</code> com&shy;po&shy;nent is com&shy;piled into an CSS2 <code id='_518'>opacity</code> at&shy;tribute.
Pro&shy;vid&shy;ed with this def&shy;i&shy;ni&shy;tion of
<code id='_519'>hsla</code>, the ex&shy;am&shy;ple above us&shy;ing the <em id='_520'>HSLA</em> com&shy;po&shy;nents will be
com&shy;piled into an equiv&shy;a&shy;lent CSS-2 com&shy;pat&shy;i&shy;ble <em id='_521'>RGB</em> for&shy;m.
</p>
<p id='_523'>This ex&shy;am&shy;ple shows that HSS can be used to en&shy;sure back&shy;ward
com&shy;pat&shy;i&shy;bil&shy;i&shy;ty of CSS files. Us&shy;ing HSS func&shy;tions, a CSS-3 source
file can be com&shy;piled into an equiv&shy;a&shy;lent CSS-2 file. This com&shy;pi&shy;la&shy;tion
can be au&shy;to&shy;mat&shy;i&shy;cal&shy;ly trig&shy;gered by clients-&shy;side pro&shy;grams for which
an au&shy;to-&shy;con&shy;fig&shy;u&shy;ra&shy;tion test shows a lack of CSS-3 sup&shy;port.
</p>

<a id='_524' name='HSS user-defined types'></a><h2 id='_525' name='HSS user-defined types'><span id='_1959' hssclass='hoptex-section2'>3<span id='_1958' hssclass='hoptex-subsection'>3</span></span> HSS user-defined types </h2>

<p id='_530'>HTML types (<em id='_526'>e.g.</em>, <code id='_527'>DIV</code>, <code id='_528'>TABLE</code>, ...) are cen&shy;tral to the
pat&shy;tern match&shy;ing rules that de&shy;ter&shy;mine which style rules ap&shy;ply to each
el&shy;e&shy;ment of a doc&shy;u&shy;ment tree. HTML is not ex&shy;ten&shy;si&shy;ble, <em id='_529'>i.e.</em>, users
can&shy;not de&shy;fine new types, as is CSS. HSS al&shy;lows pro&shy;gram&shy;mers to de&shy;fine
new types that are used in the se&shy;lec&shy;tor rules as any prim&shy;i&shy;tive type.
This is one of the main HSS con&shy;tri&shy;bu&shy;tion&shy;s.
</p>

<a id='_531' name='HSS types'></a><h3 id='_532' name='HSS types'><span id='_1962' hssclass='hoptex-section3'>3<span id='_1960' hssclass='hoptex-subsection'>3</span><span id='_1961' hssclass='hoptex-subsection'>1</span></span> HSS types </h3>

<p id='_534'>Types are de&shy;fined by the <code id='_533'>define-hss-type</code> form whose syn&shy;tax is:
</p>
<div id='fig:Htypes' hssclass='hoptex-figure' class='article-figure-centered' label='HSS types.'><a id='_555' name='HSS types.'></a><table id='_558' hssclass='hoptex-figure-content'><tr id='_557'><td id='_556' hssclass='hoptex-figure-content'><div id='_554' hssclass='prog-syntax'><table id='_553'><tr id='_552'><td id='_538' class='prog-syntax-lhs'><span id='_537' class='prog-syntax-domain'>H<sub id='_536'><span id='_535' class='prog-syntax-domain'>type</span></sub></span></td><td id='_539' class='prog-syntax-def'>::=</td><td id='_550' class='prog-syntax-rhs'><tt id='_540' class='prog-syntax-terminal'>(</tt><tt id='_541' class='prog-syntax-terminal'>define-hss-type</tt> IDENT <span id='_542' class='prog-syntax-domain'>S</span> [ <tt id='_543' class='prog-syntax-terminal'>:body</tt> <span id='_544' class='prog-syntax-domain'>S</span> ] <span id='_547' class='prog-syntax-domain'>H<sub id='_546'><span id='_545' class='prog-syntax-domain'>prop</span></sub></span><sup id='_548'>*</sup> <tt id='_549' class='prog-syntax-terminal'>)</tt></td><td id='_551' class='prog-syntax-comment'></td></tr></table></div></td></tr></table><div id='_560' hssclass='hoptex-figure-caption'><a id='_2015' class='hoptex-figure-ref' href='#fig:Htypes' title='Figure 6: HSS types.'><span id='_1928' hssclass='hoptex-figure-counter'>6</span></a>HSS types.</div><a id='_561' name='fig:Htypes'></a></div>


<p id='_563'>The rest of this sec&shy;tion il&shy;lus&shy;trates type def&shy;i&shy;ni&shy;tions with var&shy;i&shy;ous
ex&shy;am&shy;ples. The first one shows that <code id='_562'>define-hss-type</code> can be used to
as&shy;sign names to se&shy;lec&shy;tors. For in&shy;stance, pro&shy;vid&shy;ed with the fol&shy;low&shy;ing
dec&shy;la&shy;ra&shy;tion,
</p>
<pre id='_564'>(define-hss-type warning &quot;span.warning&quot;)
</pre>

<p id='_567' class='noindent' >the new type <code id='_565'>warning</code> can be used as a sub&shy;sti&shy;tute of 
<code id='_566'>span.warning</code>. Hence, one may write:
</p>

<pre id='_568'>/* global warning's borders */
warning { 
  border: 4px dotted red;
}
/* &quot;important&quot; warning's color */
div.important warning {
  color: red;
}
/* buttons embedded inside warnings */
div.important warning button {
  background: yellow;
}
</pre>

<p id='_576'>The first rule (glob&shy;al warn&shy;ing) spec&shy;i&shy;fies the gen&shy;er&shy;al graph&shy;i&shy;cal
as&shy;pect of a <em id='_569'>warning</em> span (a span with a wide red dot&shy;ted
bor&shy;der). The sec&shy;ond rule (im&shy;port warn&shy;ing) over&shy;rides <em id='_570'>warning</em> spans
by spec&shy;i&shy;fy&shy;ing that <em id='_571'>important warning</em> spans, <em id='_572'>e.g.,</em> amongst the
<em id='_573'>warning</em> spans those that are in&shy;clud&shy;ed in&shy;side <em id='_574'>important</em> divs,
in ad&shy;di&shy;tion to be red-bor&shy;dered, are writ&shy;ten in red. The third rule
spec&shy;i&shy;fies that but&shy;tons that might be em&shy;bed&shy;ded in&shy;side <em id='_575'>import
warning</em> spans en&shy;joy a yel&shy;low back&shy;ground.
</p>
<p id='_579'>HSS types may be ac&shy;com&shy;pa&shy;nied with type&shy;-spe&shy;cif&shy;ic prop&shy;er&shy;ties. For
in&shy;stance it can be found con&shy;ve&shy;nient to as&shy;so&shy;ci&shy;ate a <em id='_577'>level</em> to the
warn&shy;ing el&shy;e&shy;ments de&shy;fined above. The high&shy;er the lev&shy;el, the more vis&shy;i&shy;ble
the graph&shy;i&shy;cal ren&shy;der&shy;ing. The <em id='_578'>level</em> prop&shy;er&shy;ty of warn&shy;ing el&shy;e&shy;ments
can be im&shy;ple&shy;ment&shy;ed as:
</p>
<pre id='_580'>(define-hss-type warning &quot;span.warning&quot;
   (define-hss-property (level l)
      (cond
         ((string=? l &quot;benign&quot;)
          &quot;border: 2px solid red;&quot;)
         ((string=? l &quot;important&quot;)
          &quot;border: 4px dotted red;&quot;)
         ((string=? l &quot;critical&quot;)
          &quot;border: 4px dotted red; 
           color: red;&quot;)
         (else
          &quot;border: 4px dotted red; 
           color: red; 
           background: yellow&quot;))))
</pre>

<p id='_582'>ro&shy;vid&shy;ed with these dec&shy;la&shy;ra&shy;tions, <code id='_581'>warning</code> can be used in
ex&shy;pres&shy;sions such as:
</p>
<pre id='_583'>warning#disk-failure {
  level: critical;
}
</pre>

<p id='_590'>As seen in Sec&shy;tion <a id='_1996' hssclass='hoptex-section-ref' href='#Background' title='Background'><span id='_1940' hssclass='hoptex-section1'>2</span></a> the <code id='_585'>#</code> pat&shy;tern op&shy;er&shy;a&shy;tor
match&shy;es el&shy;e&shy;ments ac&shy;cord&shy;ing to their iden&shy;ti&shy;fi&shy;er (here
<code id='_586'>disk-failure</code>). Then, the se&shy;lec&shy;tor <code id='_587'>warning#disk-failure</code> match&shy;es
any el&shy;e&shy;ment that be&shy;longs to the <code id='_588'>warning</code> class and whose iden&shy;ti&shy;fi&shy;er
is <code id='_589'>disk-failure</code>. Such an el&shy;e&shy;ment can be build with a Hop
ex&shy;pres&shy;sion such as:
</p>
<pre id='_591'>(&lt;SPAN&gt; :class &quot;warning&quot; :id &quot;disk-failure&quot; 
   &quot;Unable to read disk /dev/sda1&quot;)
</pre>

<a id='_592' name='Motivating example: abstraction'></a><h3 id='_593' name='Motivating example: abstraction'><span id='_1965' hssclass='hoptex-section3'>3<span id='_1963' hssclass='hoptex-subsection'>3</span><span id='_1964' hssclass='hoptex-subsection'>2</span></span> Motivating example: abstraction </h3>

<p id='_594'>Many mod&shy;ern web frame&shy;works ab&shy;stract over HTML by propos&shy;ing ad&shy;di&shy;tion&shy;al sets of
wid&shy;get&shy;s. JQuery or the Dojo toolk&shy;it are two pop&shy;u&shy;lar rep&shy;re&shy;sen&shy;ta&shy;tives of this
kind. These frame&shy;works con&shy;sist of JavaScript APIs that amongst oth&shy;er things
im&shy;ple&shy;ment wid&shy;get con&shy;struc&shy;tors. 
</p>
<p id='_596'>The Hop <span id='bibref1631'  hssclass='hoptex-bib-ref'><a id='_1633' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1632"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1632"), "\uEBADdisplay", "none");

 undefined; }'>8</a><div id='bibref1632' hssclass='hoptex-bib-popup'><table id='_1643'><tr id='_1642'><td id='_1634' class='hoptex-bib-entry-key'>8</td><td id='_1641' class='hoptex-bib-entry-value'><span id='_1635' class='hoptex-bib-entry-author'>Serrano, M.  and Gallesio, E.  and Loitsch, F. </span><a id='_1637' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html'>HOP, a language for programming the Web 2.0<span id='_1636' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html</span></a><span id='_1638' class='hoptex-bib-entry-booktitle'>Proceedings of the First Dynamic Languages Symposium</span><span id='_1639' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1640' class='hoptex-bib-entry-date'>Oct 2006</span>.</td></tr></table></div></span> de&shy;vel&shy;op&shy;ment kit pro&shy;vides sim&shy;i&shy;lar
fa&shy;cil&shy;i&shy;ties with an im&shy;por&shy;tant dif&shy;fer&shy;ence :
</p><ul id='_602'><li id='_599'> Hop is a mul&shy;ti&shy;-ti&shy;er lan&shy;guage so its new wid&shy;gets are sup&shy;port&shy;ed on 
 the <em id='_597'>client-side</em> as well as on the <em id='_598'>server-side</em>;
</li><li id='_601'> pre-de&shy;fined HTML markups <em id='_600'>and</em> user-de&shy;fined markups use the same syn&shy;tax.
</li></ul>

<p id='_604'>For in&shy;stance, in Hop, one might cre&shy;ate <em id='_603'>labelled frames</em> with two
fol&shy;low&shy;ing dec&shy;la&shy;ra&shy;tions:
</p>
<pre id='_605'>(define-tag &lt;LFRAME&gt; (body)
   (&lt;DIV&gt; :hssclass &quot;hop-lframe&quot;
      (&lt;DIV&gt; :hssclass &quot;hop-lfborder&quot;
         (&lt;DIV&gt; :hssclass &quot;hop-lfbody&quot; body))))
  
(define-tag &lt;LFLABEL&gt; (body)
   (&lt;DIV&gt; :hssclass &quot;hop-lflabel&quot;
      (&lt;SPAN&gt; body)))
</pre>

<p id='_606'>These two user-de&shy;fined markups can be used as any HTML el&shy;e&shy;ments such as:
</p>
<pre id='_607'>(&lt;LFRAME&gt; :class &quot;lframe-left&quot;
   (&lt;LFLABEL&gt; &quot;A Label&quot;)
   (&lt;DIV&gt; :id &quot;a-lfbody&quot; &quot;The lframe body.&quot;))
</pre>

<p id='_608' class='noindent' >Hop com&shy;piles this ex&shy;pres&shy;sion into:
</p>
<pre id='_609'>&lt;DIV&gt; class=&quot;lframe-left&quot; hssclass=&quot;hop-lframe&quot;&gt;
 &lt;DIV hssclass=&quot;hop-lfborder&quot;&gt;
  &lt;DIV hssclass=&quot;hop-lfbody&quot;&gt;
   &lt;DIV hssclass=&quot;hop-lflabel&quot;&gt;
    &lt;SPAN&gt;A Label&lt;/SPAN&gt;
   &lt;/DIV&gt;
   &lt;DIV id='a-lfbody'&gt;The lframe body.&lt;/DIV&gt;
  &lt;/DIV&gt;
 &lt;/DIV&gt;
&lt;/DIV&gt;
</pre>

<p id='_617'>Be&shy;ing able to de&shy;fine new wid&shy;gets is es&shy;sen&shy;tial to web de&shy;vel&shy;op&shy;ment
kit&shy;s. It al&shy;lows de&shy;vel&shy;op&shy;ers to cre&shy;ate <em id='_610'>abstractions</em> on top of HTML
in or&shy;der to help cre&shy;at&shy;ing rich user in&shy;ter&shy;faces on the web. Web
de&shy;vel&shy;op&shy;ers then no longer di&shy;rect&shy;ly use HTML <code id='_611'>DIV</code>, <code id='_612'>SPAN</code>, or
<code id='_613'>TABLE</code> but
<code id='_614'>NOTEPAD</code>, <code id='_615'>TREE</code>, or <code id='_616'>DATEPICKER</code> in&shy;stead.
</p>
<p id='_621'>Un&shy;for&shy;tu&shy;nate&shy;ly, CSS does not sup&shy;port type ab&shy;strac&shy;tion. Thus,
graph&shy;i&shy;cal tun&shy;ings can only be ap&shy;plied to prim&shy;i&shy;tive HTML el&shy;e&shy;ments even
when they are only used to im&shy;ple&shy;ment high&shy;-lev&shy;el ab&shy;strac&shy;tion&shy;s. For
in&shy;stance, the JQuery's API doc&shy;u&shy;men&shy;ta&shy;tion ac&shy;knowl&shy;edges that a
<code id='_618'>DATEPICKER</code> is im&shy;ple&shy;ment&shy;ed as a HTML <code id='_619'>DIV</code> of the class
<code id='_620'>ui-datepicker</code>. Un&shy;veil&shy;ing these im&shy;ple&shy;men&shy;ta&shy;tion de&shy;tails is op&shy;posed
to elab&shy;o&shy;rat&shy;ing safe and sound ab&shy;strac&shy;tions on top of a min&shy;i&shy;mal core
ker&shy;nel.
</p>
<p id='_624'>HSS user-de&shy;fined types can pre&shy;vent CSS con&shy;fig&shy;u&shy;ra&shy;tions to break ab&shy;strac&shy;tions
of high&shy;-lev&shy;el APIs. This is il&shy;lus&shy;trat&shy;ed with the HSS spec&shy;i&shy;fi&shy;ca&shy;tion
of <code id='_622'>LFRAME</code> pre&shy;sent&shy;ed Fig&shy;ure <a id='_2016' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a>. It shows the def&shy;i&shy;ni&shy;tion
of the type el&shy;e&shy;ment and its spe&shy;cif&shy;ic prop&shy;er&shy;ties.
</p>
<div id='fig:lframe' hssclass='hoptex-figure'  label='Definition of the new lframe type element'><a id='_626' name='Definition of the new lframe type element'></a><table id='_629' hssclass='hoptex-figure-content'><tr id='_628'><td id='_627' hssclass='hoptex-figure-content'><pre id='_625'>(define-hss-type lframe &quot;div[hssclass=hop-lframe]&quot;
   :body &quot;div[hssclass=hop-lfbody]&quot;
   (define-hss-property (-hop-label-margin v)
      (format &quot;padding: ~l;&quot; v))
   (define-hss-property (-hop-label-border v)
      (format &quot;div[hssclass=hop-lfborder] { 
                  border: ~l; }&quot; v))
   (define-hss-property (padding v)
      (format &quot;div[hssclass=hop-lfbody] { 
                  padding: ~l; }&quot; v))
   (define-hss-property (-hop-label-border-radius v)
      (format &quot;div[hssclass=hop-lfborder] { 
                  border-radius: ~l; }&quot; v))
   (define-hss-property (-hop-label-align v)
      (format &quot;div[hssclass=hop-lflabel] { 
                  text-align: ~l; }&quot; v))
   (define-hss-property (-hop-label-offset v)
      (format &quot;div[hssclass=hop-lflabel] { 
                  top: -~l; }&quot; v))
   (define-hss-property (background v)
      (list (format &quot;background: ~a;&quot; (car v))
            (format &quot;div[hssclass=hop-lflabel] &gt; span { 
                       background: ~a; 
                     }&quot; 
                    (car v)))))
  
(define-hss-type lflabel 
   &quot;div[hssclass=hop-lframe] 
      div[hssclass=hop-lflabel] 
        span&quot;)</pre></td></tr></table><div id='_631' hssclass='hoptex-figure-caption'><a id='_2017' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a>Definition of the new lframe type element</div><a id='_632' name='fig:lframe'></a></div>

<p id='_634'>HSS type&shy;-spe&shy;cif&shy;ic prop&shy;er&shy;ties are nest&shy;ed in&shy;side a HSS type
dec&shy;la&shy;ra&shy;tion. They are sim&shy;i&shy;lar to glob&shy;al prop&shy;er&shy;ties as pre&shy;sent&shy;ed
Sec&shy;tion <a id='_1997' hssclass='hoptex-section-ref' href='#HSS user-defined properties' title='HSS user-defined properties'><span id='_1943' hssclass='hoptex-section2'>3<span id='_1942' hssclass='hoptex-subsection'>1</span></span></a> with two
dif&shy;fer&shy;ences:
</p><ul id='_637'><li id='_635'> they are only bound for the de&shy;fined type el&shy;e&shy;ment;
</li><li id='_636'> in&shy;stead of re&shy;turn&shy;ing plain strings, the as&shy;so&shy;ci&shy;at&shy;ed prop&shy;er&shy;ty com&shy;pil&shy;ers 
may re&shy;turn list of strings. 
</li></ul>

<p id='_638'>The sig&shy;na&shy;ture of a type&shy;-spe&shy;cif&shy;ic prop&shy;er&shy;ty com&shy;pil&shy;er is:
</p>
<pre id='_641' class='syntax'><i id='_639'>type property compiler:</i>
  string list &#215; string &#8594; string <span id='_640' class='math'>+</span> string list</pre>

<p id='_653'>When the re&shy;turned val&shy;ue is a list, any of the con&shy;tained strings can
ei&shy;ther be a HSS prop&shy;er&shy;ty as&shy;sign&shy;ment or a plain HSS rule. The first
case is used to con&shy;fig&shy;ure the HTML el&shy;e&shy;ment as&shy;so&shy;ci&shy;at&shy;ed with the de&shy;fined
HTML el&shy;e&shy;men&shy;t. The sec&shy;ond case is used to con&shy;fig&shy;ure HTML el&shy;e&shy;ments
em&shy;bed&shy;ded in&shy;side the HTML el&shy;e&shy;men&shy;t. In the ex&shy;am&shy;ple of Fig&shy;ure
<a id='_2018' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a>, <code id='_643'>-hop-label-margin</code> is ap&shy;plied to HTML
<code id='_644'>DIV</code> whose <code id='_645'>hssclass</code> is
<code id='_646'>hop-lframe</code>. The <code id='_647'>-hop-label-border</code> is ap&shy;plied to HTML <code id='_648'>DIV</code>
whose <code id='_649'>hssclass</code> is <code id='_650'>hop-lfborder</code> and that are chil&shy;dren of
<code id='_651'>LFRAME</code> el&shy;e&shy;ments. Sec&shy;tion <a id='_1998' hssclass='hoptex-section-ref' href='#The HSS compiler' title='The HSS compiler'><span id='_1974' hssclass='hoptex-section1'>4</span></a> shows how
these prop&shy;er&shy;ties are com&shy;piled into CSS.
</p>

<p id='_657'>The <code id='_654'>:body</code> ar&shy;gu&shy;ment is bound to a se&shy;lec&shy;tor string. It is used to
change the HSS com&shy;pil&shy;er alias&shy;ing res&shy;o&shy;lu&shy;tion. The <code id='_655'>:body</code> ar&shy;gu&shy;ment is
added to a se&shy;lec&shy;tor rule when the type el&shy;e&shy;ment is not used in the
right-&shy;most po&shy;si&shy;tion or when it is used with a pseu&shy;do-s&shy;e&shy;lec&shy;tor such as
<code id='_656'>:first-child</code>.
</p>

<p id='_659'>The de&shy;fault con&shy;fig&shy;u&shy;ra&shy;tion of <code id='_658'>LFRAME</code> that is giv&shy;en by:
</p>
<pre id='_660'>lframe {
  background: #edeceb;
  border: 1px solid black;
  padding: 2px;
  box-shadow: 5px 5px 5px #888;
  -hop-label-margin: 10px;
  -hop-label-border: 2px groove #ddd;
  -hop-label-border-radius: 4px;
  -hop-label-align: left;
  -hop-label-offset: 12px;
}
lflabel {
  font-style: roman;
}
</pre>

<p id='_661' class='noindent' >It pro&shy;duces the fol&shy;low&shy;ing ren&shy;der&shy;ing:
</p>
<div id='_666' hssclass='hop-lframe' class='lframe-left'><div id='_665' hssclass='hop-lfborder'><div id='_664' hssclass='hop-lfbody'><div id='_663' hssclass='hop-lflabel'><span id='_662'>A Label</span></div>The lframe body.</div></div></div>



<p id='_669' class='noindent' >Chang&shy;ing the graph&shy;i&shy;cal as&shy;pects of a <code id='_668'>LFRAME</code> no longer re&shy;quires
to be aware of its im&shy;ple&shy;men&shy;ta&shy;tion. For in&shy;stance
</p>
<pre id='_670'>lframe.lframe-right {
  -hop-label-align: right;
  -hop-label-border-radius: 0;
  -hop-label-border: 2px ridge green;
}
lframe.lframe-right lflabel {
  font-variant: small-caps;
}
</pre>

<p id='_671' class='noindent' >changes the de&shy;fault ren&shy;der&shy;ing. It flush&shy;es right the frame
la&shy;bel writ&shy;ten us&shy;ing a small caps font and used a green ridge
bor&shy;der. It is ren&shy;dered as:
</p>
<div id='_676' hssclass='hop-lframe' class='lframe-right'><div id='_675' hssclass='hop-lfborder'><div id='_674' hssclass='hop-lfbody'><div id='_673' hssclass='hop-lflabel'><span id='_672'>A Label</span></div>The lframe body.</div></div></div>




<a id='_678' name='Computed values'></a><h2 id='_679' name='Computed values'><span id='_1967' hssclass='hoptex-section2'>3<span id='_1966' hssclass='hoptex-subsection'>4</span></span> Computed values </h2>

<p id='_681'>CSS is a pure&shy;ly declar&shy;a&shy;tive lan&shy;guage. It can&shy;not be used to
ex&shy;press com&shy;pu&shy;ta&shy;tion&shy;s. CSS val&shy;ues are thus lit&shy;er&shy;al&shy;s. The fourth
ex&shy;ten&shy;sion sup&shy;port&shy;ed by HSS al&shy;lows com&shy;put&shy;ed val&shy;ues to be <em id='_680'>injected</em>
in&shy;side gen&shy;er&shy;at&shy;ed CSS files. 
</p>
<a id='_682' name='The $-form'></a><h3 id='_683' name='The $-form'><span id='_1970' hssclass='hoptex-section3'>3<span id='_1968' hssclass='hoptex-subsection'>4</span><span id='_1969' hssclass='hoptex-subsection'>1</span></span> The $-form </h3>

<p id='_686'>HSS ex&shy;tends CSS state&shy;ments and val&shy;ues with one ad&shy;di&shy;tion&shy;al syn&shy;tax
that <em id='_684'>inject</em> com&shy;pile-&shy;time val&shy;ues in the gen&shy;er&shy;at&shy;ed CSS file. The
<code id='_685'>$-form</code> per&shy;mits HSS source files to de&shy;clare lo&shy;cal vari&shy;ables
or im&shy;port vari&shy;ables or to bind val&shy;ues to prop&shy;er&shy;ties. The
fol&shy;low&shy;ing ex&shy;am&shy;ple
</p>
<pre id='_687'>$(module hss-example)

$(define bg &quot;#999&quot;)
$(define (light-color v) ...not given here...)
 
button {
  background: $bg;
}
button:hover {
  background: $(light-color bg);
}
</pre>

<p id='_691' class='noindent' >de&shy;fines a Hop mod&shy;ule <code id='_688'>hss-example</code> that de&shy;clares one
glob&shy;al vari&shy;able <code id='_689'>bg</code> and one func&shy;tion <code id='_690'>light-color</code>. The glob&shy;al
vari&shy;able is used twice in the ex&shy;am&shy;ple to spec&shy;i&shy;fy the back&shy;ground col&shy;or
of but&shy;ton&shy;s.
</p>

<a id='_692' name='Motivating example: skins'></a><h3 id='_693' name='Motivating example: skins'><span id='_1973' hssclass='hoptex-section3'>3<span id='_1971' hssclass='hoptex-subsection'>4</span><span id='_1972' hssclass='hoptex-subsection'>2</span></span> Motivating example: skins </h3>

<p id='_694'>In&shy;ject&shy;ing dy&shy;nam&shy;ic val&shy;ues roots HSS in&shy;side the de&shy;vel&shy;op&shy;ment kit that
em&shy;beds it. As demon&shy;strat&shy;ed by the ex&shy;am&shy;ples, it al&shy;lows the vari&shy;ables
and the val&shy;ues of the pro&shy;gram&shy;ming lan&shy;guage to be used in&shy;side HSS
files. This may be used to cus&shy;tomize HSS files. For in&shy;stance, as&shy;sum&shy;ing
a Hop data struc&shy;ture that im&shy;ple&shy;ments skins:
</p>
<pre id='_695'>(module skinning
  (export (class skin
             button-border
             button-background
             button-font
             toolbar-icon-size
             toolbar-style
             ...)
          (get-current-skin::skin)))
</pre>

<p id='_697' class='noindent' >Then, HSS files may use these <em id='_696'>skins</em> in source files such as:
</p>
<pre id='_698'>$(module hss-example
   (import skinning))

$(define skin (get-current-skin))

button {
  border: $(skin-border skin);
  background: $(skin-button-bg skin);
  font: $(skin-font skin);
}
button:hover {
  background: $(light-color (skin-button-bg skin));
}
...
</pre>

<p id='_699'>This tech&shy;nique for im&shy;ple&shy;ment&shy;ing skins al&shy;lows ap&shy;pli&shy;ca&shy;tions
con&shy;ceived and im&shy;ple&shy;ment&shy;ed in&shy;de&shy;pen&shy;dent&shy;ly to share graph&shy;i&shy;cal
con&shy;fig&shy;u&shy;ra&shy;tions. Glob&shy;al&shy;ly co&shy;her&shy;ent vi&shy;su&shy;al as&shy;pect can thus be
en&shy;forced at the en&shy;vi&shy;ron&shy;ment lev&shy;el.
</p>

<a id='_700' name='The HSS compiler'></a><h1 id='_701' name='The HSS compiler'><span id='_1974' hssclass='hoptex-section1'>4</span> The HSS compiler </h1>

<p id='_705'>This sec&shy;tion pre&shy;sents the whole HSS com&shy;pil&shy;er. The com&shy;pi&shy;la&shy;tions
al&shy;go&shy;rithms are giv&shy;en Fig&shy;ures <a id='_2019' class='hoptex-figure-ref' href='#fig:Ccomp' title='Figure 10: Dispatching rules'><span id='_1932' hssclass='hoptex-figure-counter'>10</span></a> through
<a id='_2020' class='hoptex-figure-ref' href='#fig:Cuser' title='Figure 15: User rules compilation'><span id='_1937' hssclass='hoptex-figure-counter'>15</span></a>. They use the syn&shy;tac&shy;tic no&shy;ta&shy;tions pre&shy;sent&shy;ed
Fig&shy;ure <a id='_2021' class='hoptex-figure-ref' href='#fig-Cnotations' title='Figure 9: Notations. This figure presents the notations used by the 
compilation algorithms.'><span id='_1931' hssclass='hoptex-figure-counter'>9</span></a>.  Read&shy;ers only in&shy;ter&shy;est&shy;ed by the
HSS de&shy;sign and not con&shy;cerned by the tech&shy;ni&shy;cal as&shy;pects of its
im&shy;ple&shy;men&shy;ta&shy;tion can safe&shy;ly skip this sec&shy;tion.
</p>
<p id='_710'>The first step of the com&shy;pi&shy;la&shy;tion <em id='_706'>normalizes</em> HSS pro&shy;gram&shy;s. It
pro&shy;duces rules that con&shy;tain only one se&shy;lec&shy;tor and it eval&shy;u&shy;ates glob&shy;al
Hop ex&shy;pres&shy;sion&shy;s. Af&shy;ter that stage pro&shy;grams are de&shy;scribed by the
gram&shy;mar <span id='_708' class='prog-syntax-domain'>H<sup id='_707'>0</sup></span> giv&shy;en in Fig&shy;ure <a id='_2022' class='hoptex-figure-ref' href='#fig:H0' title='Figure 8: Grammar for normalized HSS.'><span id='_1930' hssclass='hoptex-figure-counter'>8</span></a>.
</p>
<div id='fig:H0' hssclass='hoptex-figure' class='article-figure-centered' label='Grammar for normalized HSS.'><a id='_729' name='Grammar for normalized HSS.'></a><table id='_732' hssclass='hoptex-figure-content'><tr id='_731'><td id='_730' hssclass='hoptex-figure-content'><div id='_728' hssclass='prog-syntax'><table id='_727'><tr id='_726'><td id='_713' class='prog-syntax-lhs'><span id='_712' class='prog-syntax-domain'>H<sup id='_711'>0</sup></span></td><td id='_714' class='prog-syntax-def'>::=</td><td id='_724' class='prog-syntax-rhs'><span id='_715' class='prog-syntax-domain'>S</span> <tt id='_716' class='prog-syntax-terminal'>{</tt><span id='_718' class='prog-syntax-domain'>D<sub id='_717'>1</sub></span><tt id='_719' class='prog-syntax-terminal'>;</tt> &#8230; <span id='_721' class='prog-syntax-domain'>D<sub id='_720'>m</sub></span><tt id='_722' class='prog-syntax-terminal'>;</tt> <tt id='_723' class='prog-syntax-terminal'>}</tt> </td><td id='_725' class='prog-syntax-comment'>rule</td></tr></table></div></td></tr></table><div id='_734' hssclass='hoptex-figure-caption'><a id='_2023' class='hoptex-figure-ref' href='#fig:H0' title='Figure 8: Grammar for normalized HSS.'><span id='_1930' hssclass='hoptex-figure-counter'>8</span></a>Grammar for normalized HSS.</div><a id='_735' name='fig:H0'></a></div>

<p id='_743'><span id='_736' class='prog-syntax-domain'>H</span>, the com&shy;plete syn&shy;tax for HSS and <span id='_738' class='prog-syntax-domain'>H<sup id='_737'>0</sup></span> are re&shy;lat&shy;ed by:
<div id='_742' class='GLOP' style='text-align: center'><span id='_740' class='prog-syntax-domain'>H<sup id='_739'>0</sup></span> &#8834; <span id='_741' class='prog-syntax-domain'>H</span></div>
</p><p id='_749' class='noindent' >In ad&shy;di&shy;tion, <span id='_744' class='prog-syntax-domain'>C</span>, the ac&shy;tu&shy;al CSS syn&shy;tax is re&shy;lat&shy;ed to <span id='_745' class='prog-syntax-domain'>H</span> by:
<div id='_748' style='text-align: center'><span id='_746' class='prog-syntax-domain'>C</span> &#8834; <span id='_747' class='prog-syntax-domain'>H</span></div>
</p><p id='_751' class='noindent' ><span id='_750' class='cal'>C</span>, the com&shy;pi&shy;la&shy;tion func&shy;tion that trans&shy;forms a HSS
pro&shy;gram into a CSS pro&shy;gram, has the fol&shy;low&shy;ing pro&shy;to&shy;type: 
</p>
<div id='_757' style='text-align: center'><tt id='_756'><span id='_752' class='cal'>C</span> : <span id='_754' class='prog-syntax-domain'>H<sup id='_753'>0</sup></span>
&#215; &#964; &#215; &#961; &#215; &#966; &#8594; <span id='_755' class='prog-syntax-domain'>C</span></tt></div>

<p id='_763' class='noindent' ><span id='_759' class='prog-syntax-domain'>H<sup id='_758'>0</sup></span> is the pro&shy;gram to be com&shy;piled, &#964; is the el&shy;e&shy;ment type 
en&shy;vi&shy;ron&shy;ment that is ex&shy;tend&shy;ed by <code id='_760'>define-hss-type</code>,
&#961; is the prop&shy;er&shy;ty en&shy;vi&shy;ron&shy;ment that is ex&shy;tend&shy;ed by
<code id='_761'>define-hss-property</code>, and &#966; is the 
func&shy;tion en&shy;vi&shy;ron&shy;ment that is ex&shy;tend&shy;ed by
<code id='_762'>define-hss-function</code>. 
</p>
<p id='_764'>The com&shy;pi&shy;la&shy;tion al&shy;go&shy;rithm han&shy;dles each rule sep&shy;a&shy;rate&shy;ly. It re&shy;solves
type el&shy;e&shy;ment alias&shy;ing and it in&shy;vokes prop&shy;er&shy;ty and val&shy;ue com&shy;pil&shy;er&shy;s.
</p>
<p id='_779'>In this pre&shy;sen&shy;ta&shy;tion, the com&shy;pi&shy;la&shy;tion of the rule 
<div id='_778' style='text-align: center' class='center'><tt id='_777'><span id='_766' class='prog-syntax-domain'>S<sub id='_765'>1</sub></span> <span id='_768' class='prog-syntax-domain'>op<sub id='_767'>1</sub></span> &#8230; <span id='_770' class='prog-syntax-domain'>op<sub id='_769'>n-1</sub></span> <span id='_772' class='prog-syntax-domain'>S<sub id='_771'>n</sub></span> {<span id='_774' class='prog-syntax-domain'>D<sub id='_773'>1</sub></span>; &#8230; <span id='_776' class='prog-syntax-domain'>D<sub id='_775'>m</sub></span>;}</tt></div>
</p>
<p id='_783' class='noindent' >in the type en&shy;vi&shy;ron&shy;ment <sub id='_780'>&#964;</sub>, the prop&shy;er&shy;ty
en&shy;vi&shy;ron&shy;ment <sub id='_781'>&#961;</sub>, and the func&shy;tion en&shy;vi&shy;ron&shy;ment <sub id='_782'>&#966;</sub> is writ&shy;ten:
</p>
<div id='_799' style='text-align: center' class='center'><tt id='_798'><span id='_784' class='cal'>C</span>&#10214;<span id='_786' class='prog-syntax-domain'>S<sub id='_785'>1</sub></span> <span id='_788' class='prog-syntax-domain'>op<sub id='_787'>1</sub></span> &#8230; <span id='_790' class='prog-syntax-domain'>op<sub id='_789'>n-1</sub></span> <span id='_792' class='prog-syntax-domain'>S<sub id='_791'>n</sub></span> {<span id='_794' class='prog-syntax-domain'>D<sub id='_793'>1</sub></span>; &#8230; <span id='_796' class='prog-syntax-domain'>D<sub id='_795'>m</sub></span>;}&#10215;<sub id='_797'>&#964;&#961;&#966;</sub></tt></div>

<div id='fig-Cnotations' hssclass='hoptex-figure'  label='Notations. This figure presents the notations used by the 
compilation algorithms.'><a id='_901' name='Notations. This figure presents the notations used by the 
compilation algorithms.'></a><table id='_904' hssclass='hoptex-figure-content'><tr id='_903'><td id='_902' hssclass='hoptex-figure-content'><table id='notations'><tr id='_815'><td id='_805'><span id='_804' style='font-size: 90%'><span id='_800' class='prog-syntax-domain'>S</span><span id='_801' style='font-size: 121%'>&#8595;</span><sub id='_803'><span id='_802' style='font-size: 80%; font-family: serif;'>type</span></sub></span></td><td id='_814'>the <em id='_806'>type</em> of a selector <span id='_807' class='prog-syntax-domain'>S</span>. <em id='_808'>e.g.,</em> <span id='_812' style='font-size: 90%'>div#foo<span id='_809' style='font-size: 121%'>&#8595;</span><sub id='_811'><span id='_810' style='font-size: 80%; font-family: serif;'>type</span></sub></span> = <tt id='_813'>div</tt></td></tr><tr id='_834'><td id='_821'><span id='_820' style='font-size: 90%'><span id='_816' class='prog-syntax-domain'>S</span><span id='_817' style='font-size: 121%'>&#8595;</span><sub id='_819'><span id='_818' style='font-size: 80%; font-family: serif;'>&#961;</span></sub></span></td><td id='_833'>the property set of the type of the sector <span id='_822' class='prog-syntax-domain'>S</span>. <span id='_827' style='font-size: 90%'><span id='_823' class='prog-syntax-domain'>S</span><span id='_824' style='font-size: 121%'>&#8595;</span><sub id='_826'><span id='_825' style='font-size: 80%; font-family: serif;'>&#961;</span></sub></span> &#8801; <span id='_832' style='font-size: 90%'>&#961; (<span id='_828' class='prog-syntax-domain'>S</span><span id='_829' style='font-size: 121%'>&#8595;</span><sub id='_831'><span id='_830' style='font-size: 80%; font-family: serif;'>type</span></sub>)</span>.</td></tr><tr id='_848'><td id='_840'><span id='_839' style='font-size: 90%'>&#964;(<span id='_835' style='font-size: 80%'>IDENT</span>)<span id='_836' style='font-size: 121%'>&#8595;</span><sub id='_838'><span id='_837' style='font-size: 80%; font-family: serif;'>selector</span></sub></span></td><td id='_847'>the selector of user-defined types <em id='_841'>e.g.,</em> <span id='_845' style='font-size: 90%'>&#964;(lframe)<span id='_842' style='font-size: 121%'>&#8595;</span><sub id='_844'><span id='_843' style='font-size: 80%; font-family: serif;'>selector</span></sub></span> = <q id='_846'>div[hssclass=hop-lframe]</q></td></tr><tr id='_862'><td id='_854'><span id='_853' style='font-size: 90%'>&#964;(<span id='_849' style='font-size: 80%'>IDENT</span>)<span id='_850' style='font-size: 121%'>&#8595;</span><sub id='_852'><span id='_851' style='font-size: 80%; font-family: serif;'>body</span></sub></span></td><td id='_861'>the optional body of user-defined types <em id='_855'>e.g.,</em> <span id='_859' style='font-size: 90%'>&#964;(lframe)<span id='_856' style='font-size: 121%'>&#8595;</span><sub id='_858'><span id='_857' style='font-size: 80%; font-family: serif;'>body</span></sub></span> = <q id='_860'>div[hssclass=hop-lfbody]</q></td></tr><tr id='_871'><td id='_869'><span id='_868' style='font-size: 90%'><span id='_867' style='font-size: 90%'>&#961;(<span id='_863' style='font-size: 80%'>IDENT</span>)<span id='_864' style='font-size: 121%'>&#8595;</span><sub id='_866'><span id='_865' style='font-size: 80%; font-family: serif;'>selector</span></sub></span></span></td><td id='_870'>the selector of a type property.</td></tr><tr id='_880'><td id='_878'><span id='_877' style='font-size: 90%'><span id='_876' style='font-size: 90%'>&#961;(<span id='_872' style='font-size: 80%'>IDENT</span>)<span id='_873' style='font-size: 121%'>&#8595;</span><sub id='_875'><span id='_874' style='font-size: 80%; font-family: serif;'>compiler</span></sub></span></span></td><td id='_879'>the compiler of user-defined property.</td></tr><tr id='_897'><td id='_888'><span id='_887' style='font-size: 90%'>T<span id='_881' style='font-size: 121%'>&#8595;</span><sub id='_883'><span id='_882' style='font-size: 80%; font-family: serif;'>1</span></sub> and T<span id='_884' style='font-size: 121%'>&#8595;</span><sub id='_886'><span id='_885' style='font-size: 80%; font-family: serif;'>2</span></sub></span></td><td id='_896'>the first and second projection.  <em id='_889'>e.g.,</em> <span id='_894' style='font-size: 90%'><tt id='_890'>&#10216;a &#215; b&#10217;</tt><span id='_891' style='font-size: 121%'>&#8595;</span><sub id='_893'><span id='_892' style='font-size: 80%; font-family: serif;'>2</span></sub></span> = <tt id='_895'>b</tt></td></tr><tr id='_900'><td id='_898'>&#167;</td><td id='_899'>the concatenation of lists.</td></tr></table></td></tr></table><div id='_906' hssclass='hoptex-figure-caption'><a id='_2024' class='hoptex-figure-ref' href='#fig-Cnotations' title='Figure 9: Notations. This figure presents the notations used by the 
compilation algorithms.'><span id='_1931' hssclass='hoptex-figure-counter'>9</span></a>Notations. This figure presents the notations used by the 
compilation algorithms.</div><a id='_907' name='fig-Cnotations'></a></div>


<p id='_910'><span id='_909' class='prog-syntax-domain'>S<sub id='_908'>n</sub></span> drives the com&shy;pi&shy;la&shy;tion of rules such as:
</p>
<div id='_925' class='center'><tt id='_924'><span id='_911' class='cal'>C</span>&#10214;<span id='_913' class='prog-syntax-domain'>S<sub id='_912'>1</sub></span> <span id='_915' class='prog-syntax-domain'>op<sub id='_914'>1</sub></span> &#8230; <span id='_917' class='prog-syntax-domain'>op<sub id='_916'>n-1</sub></span> <span id='_919' class='prog-syntax-domain'>S<sub id='_918'>n</sub></span> {<span id='_921' class='prog-syntax-domain'>D<sub id='_920'>1</sub></span>; &#8230; <span id='_923' class='prog-syntax-domain'>D<sub id='_922'>m</sub></span>;}&#10215;</tt></div>

<ul id='_937'><li id='_930'> If <span id='_927' class='prog-syntax-domain'>S<sub id='_926'>n</sub></span> is a reg&shy;u&shy;lar el&shy;e&shy;ment then the com&shy;pi&shy;la&shy;tion con&shy;sists in 
re&shy;solv&shy;ing se&shy;lec&shy;tor alias&shy;ing and ex&shy;pand&shy;ing glob&shy;al HSS prop&shy;er&shy;ties. 
This is im&shy;ple&shy;ment&shy;ed by the <span id='_929' class='cal'>C<sub id='_928'>simple</sub></span> func&shy;tion.
</li><li id='_936'> If <span id='_932' class='prog-syntax-domain'>S<sub id='_931'>n</sub></span> is a user-de&shy;fined el&shy;e&shy;ment then more im&shy;por&shy;tant mod&shy;i&shy;fi&shy;ca&shy;tions
are in&shy;volved. In par&shy;tic&shy;u&shy;lar one HSS rule of this type may be com&shy;piled
into sev&shy;er&shy;al CSS rules. The func&shy;tion <span id='_934' class='cal'>C<sub id='_933'>user</sub></span> is used to com&shy;pile
such rules. Fig&shy;ure <a id='_2025' class='hoptex-figure-ref' href='#fig:Ccomp' title='Figure 10: Dispatching rules'><span id='_1932' hssclass='hoptex-figure-counter'>10</span></a> pre&shy;sents the part of the
al&shy;go&shy;rithm that dis&shy;patch&shy;es ac&shy;cord&shy;ing to rules kind.
</li></ul>


<div id='fig:Ccomp' hssclass='hoptex-figure'  label='Dispatching rules'><a id='_994' name='Dispatching rules'></a><table id='_997' hssclass='hoptex-figure-content'><tr id='_996'><td id='_995' hssclass='hoptex-figure-content'><pre id='_993' class='algo'><span id='_938' class='cal'>C</span>&#10214;<span id='_940' class='prog-syntax-domain'>S<sub id='_939'>1</sub></span> <span id='_942' class='prog-syntax-domain'>op<sub id='_941'>1</sub></span> &#8230; <span id='_944' class='prog-syntax-domain'>op<sub id='_943'>n-1</sub></span> <span id='_946' class='prog-syntax-domain'>S<sub id='_945'>n</sub></span> {<span id='_948' class='prog-syntax-domain'>D<sub id='_947'>1</sub></span>; &#8230; <span id='_950' class='prog-syntax-domain'>D<sub id='_949'>m</sub></span>;}&#10215;<sub id='_951'>&#964;&#961;&#966;</sub> = 
  <span id='_952' class='prog-syntax-keyword'>if</span> <span id='_954' class='prog-syntax-domain'>S<sub id='_953'>n</sub></span><span id='_955' style='font-size: 121%'>&#8595;</span><sub id='_957'><span id='_956' style='font-size: 80%; font-family: serif;'>type</span></sub> &#8713; &#964; <span id='_958' class='prog-syntax-keyword'>or</span> pseudo(<span id='_960' class='prog-syntax-domain'>S<sub id='_959'>n</sub></span>) 
      <span id='_961' class='prog-syntax-keyword'>then</span> <span id='_963' class='cal'>C<sub id='_962'>simple</sub></span>&#10214;<span id='_965' class='prog-syntax-domain'>S<sub id='_964'>1</sub></span> <span id='_967' class='prog-syntax-domain'>op<sub id='_966'>1</sub></span> &#8230; <span id='_969' class='prog-syntax-domain'>op<sub id='_968'>n-1</sub></span> <span id='_971' class='prog-syntax-domain'>S<sub id='_970'>n</sub></span> {<span id='_973' class='prog-syntax-domain'>D<sub id='_972'>1</sub></span>; &#8230; <span id='_975' class='prog-syntax-domain'>D<sub id='_974'>m</sub></span>;}&#10215;<sub id='_976'>&#964;&#961;&#966;</sub>
      <span id='_977' class='prog-syntax-keyword'>then</span> <span id='_979' class='cal'>C<sub id='_978'>user</sub></span>&#10214;<span id='_981' class='prog-syntax-domain'>S<sub id='_980'>1</sub></span> <span id='_983' class='prog-syntax-domain'>op<sub id='_982'>1</sub></span> &#8230; <span id='_985' class='prog-syntax-domain'>op<sub id='_984'>n-1</sub></span> <span id='_987' class='prog-syntax-domain'>S<sub id='_986'>n</sub></span> {<span id='_989' class='prog-syntax-domain'>D<sub id='_988'>1</sub></span>; &#8230; <span id='_991' class='prog-syntax-domain'>D<sub id='_990'>m</sub></span>;}&#10215;<sub id='_992'>&#964;&#961;&#966;</sub></pre></td></tr></table><div id='_999' hssclass='hoptex-figure-caption'><a id='_2026' class='hoptex-figure-ref' href='#fig:Ccomp' title='Figure 10: Dispatching rules'><span id='_1932' hssclass='hoptex-figure-counter'>10</span></a>Dispatching rules</div><a id='_1000' name='fig:Ccomp'></a></div>



<a id='_1001' name='Compiling Simple Rules'></a><h2 id='_1002' name='Compiling Simple Rules'><span id='_1976' hssclass='hoptex-section2'>4<span id='_1975' hssclass='hoptex-subsection'>1</span></span> Compiling Simple Rules </h2>

<p id='_1009'>The func&shy;tion <span id='_1004' class='cal'>C<sub id='_1003'>simple</sub></span> com&shy;piles <em id='_1005'>simple</em> rules by
re&shy;solv&shy;ing type alias&shy;ing and ex&shy;pand&shy;ing at&shy;tributes name and
val&shy;ue. Sec&shy;tion <a id='_1999' hssclass='hoptex-section-ref' href='#HSS user-defined types' title='HSS user-defined types'><span id='_1959' hssclass='hoptex-section2'>3<span id='_1958' hssclass='hoptex-subsection'>3</span></span></a> of&shy;fers a first
ex&shy;am&shy;ple for <span id='_1008' class='cal'>C<sub id='_1007'>simple</sub></span> that is de&shy;tailed be&shy;low. In the rule:
</p>
<pre id='_1010'>div.important warning button {
  background: yellow;
}
</pre>

<p id='_1012' class='noindent' ><code id='_1011'>warning</code> is a user de&shy;fined type but not used in the right-&shy;most
po&shy;si&shy;tion of the se&shy;lec&shy;tor. So it does not drive the rule prop&shy;er&shy;ties
ex&shy;pan&shy;sion. That rule ac&shy;tu&shy;al&shy;ly con&shy;fig&shy;ures but&shy;tons, not warn&shy;ings. Hence,
its com&shy;pi&shy;la&shy;tion mere&shy;ly con&shy;sists in re&shy;solv&shy;ing se&shy;lec&shy;tor alias&shy;ing. It
then pro&shy;duces:
</p>
<pre id='_1013'>div.important span.warning button {
  background: yellow;
}
</pre>

<p id='_1016'>This ex&shy;am&shy;ple il&shy;lus&shy;trates type alias&shy;ing, the Sec&shy;tion
<a id='_2000' hssclass='hoptex-section-ref' href='#HSS properties' title='HSS properties'><span id='_1946' hssclass='hoptex-section3'>3<span id='_1944' hssclass='hoptex-subsection'>1</span><span id='_1945' hssclass='hoptex-subsection'>1</span></span></a> pro&shy;vides an ex&shy;am&shy;ple of at&shy;tribute alias&shy;ing
and val&shy;ue ex&shy;pan&shy;sion. In that Sec&shy;tion a <code id='_1015'>black-and-white</code> prop&shy;er&shy;ty
has been de&shy;fined. It can be used in rules such as: 
</p>
<pre id='_1017'>div.box {
  black-and-white: invert;
}
</pre>

<p id='_1019'>Ex&shy;pand&shy;ing the at&shy;tribute <code id='_1018'>black-and-white</code> pro&shy;duces:
</p>
<pre id='_1020'>div.box {
  color: white;
  background: black;
}
</pre>

<p id='_1024'>The func&shy;tion <span id='_1022' class='cal'>C<sub id='_1021'>simple</sub></span>, in charge of this trans&shy;for&shy;ma&shy;tion, is
pre&shy;sent&shy;ed in Fig&shy;ure <a id='_2027' class='hoptex-figure-ref' href='#fig:Ccomp-simple' title='Figure 11: Compiling simple rule'><span id='_1933' hssclass='hoptex-figure-counter'>11</span></a>.
</p>

<div id='fig:Ccomp-simple' hssclass='hoptex-figure'  label='Compiling simple rule'><a id='_1071' name='Compiling simple rule'></a><table id='_1074' hssclass='hoptex-figure-content'><tr id='_1073'><td id='_1072' hssclass='hoptex-figure-content'><pre id='_1070' class='algo'><span id='_1026' class='cal'>C<sub id='_1025'>simple</sub></span>&#10214;<span id='_1028' class='prog-syntax-domain'>S<sub id='_1027'>1</sub></span> <span id='_1030' class='prog-syntax-domain'>op<sub id='_1029'>1</sub></span> &#8230; <span id='_1032' class='prog-syntax-domain'>op<sub id='_1031'>n-1</sub></span> <span id='_1034' class='prog-syntax-domain'>S<sub id='_1033'>n</sub></span> {<span id='_1036' class='prog-syntax-domain'>D<sub id='_1035'>1</sub></span>; &#8230; <span id='_1038' class='prog-syntax-domain'>D<sub id='_1037'>m</sub></span>;}&#10215;<sub id='_1039'>&#964;&#961;&#966;</sub> = 
  <span id='_1041' class='cal'>C<sub id='_1040'>alias</sub></span>&#10214;<span id='_1043' class='prog-syntax-domain'>S<sub id='_1042'>1</sub></span>&#10215;<sub id='_1044'>&#964;</sub> <span id='_1046' class='prog-syntax-domain'>op<sub id='_1045'>1</sub></span> &#8230; <span id='_1048' class='prog-syntax-domain'>op<sub id='_1047'>n-1</sub></span> <span id='_1050' class='cal'>C<sub id='_1049'>alias</sub></span>&#10214;<span id='_1052' class='prog-syntax-domain'>S<sub id='_1051'>n</sub></span>&#10215;<sub id='_1053'>&#964;</sub> { 
     <span id='_1055' class='cal'>C<sub id='_1054'>decl</sub></span>&#10214;<span id='_1057' class='prog-syntax-domain'>D<sub id='_1056'>1</sub></span>&#10215;<sub id='_1058'>&#964;&#961;&#966;</sub><span id='_1059' style='font-size: 121%'>&#8595;</span><sub id='_1061'><span id='_1060' style='font-size: 80%; font-family: serif;'>2</span></sub>; &#8230; <span id='_1063' class='cal'>C<sub id='_1062'>decl</sub></span>&#10214;<span id='_1065' class='prog-syntax-domain'>D<sub id='_1064'>m</sub></span>&#10215;<sub id='_1066'>&#964;&#961;&#966;</sub><span id='_1067' style='font-size: 121%'>&#8595;</span><sub id='_1069'><span id='_1068' style='font-size: 80%; font-family: serif;'>2</span></sub>; 
  }</pre></td></tr></table><div id='_1076' hssclass='hoptex-figure-caption'><a id='_2028' class='hoptex-figure-ref' href='#fig:Ccomp-simple' title='Figure 11: Compiling simple rule'><span id='_1933' hssclass='hoptex-figure-counter'>11</span></a>Compiling simple rule</div><a id='_1077' name='fig:Ccomp-simple'></a></div>



<a id='_1078' name='Compiling Selectors'></a><h3 id='_1079' name='Compiling Selectors'><span id='_1979' hssclass='hoptex-section3'>4<span id='_1977' hssclass='hoptex-subsection'>1</span><span id='_1978' hssclass='hoptex-subsection'>1</span></span> Compiling Selectors </h3>

<p id='_1085'>The com&shy;pi&shy;la&shy;tion of sim&shy;ple se&shy;lec&shy;tors is giv&shy;en by the func&shy;tion <span id='_1081' class='cal'>C<sub id='_1080'>alias</sub></span> giv&shy;en in Fig&shy;ure <a id='_2029' class='hoptex-figure-ref' href='#fig:Calias' title='Figure 12: Compilation of selectors'><span id='_1934' hssclass='hoptex-figure-counter'>12</span></a>. As shown in the
<code id='_1083'>warning</code> ex&shy;am&shy;ple, it re&shy;places user-de&shy;fined types, <em id='_1084'>i.e.,</em> types
bound in the &#964; en&shy;vi&shy;ron&shy;ment, with the se&shy;lec&shy;tor ex&shy;pres&shy;sion
giv&shy;en at the type dec&shy;la&shy;ra&shy;tion.
</p>


<div id='fig:Calias' hssclass='hoptex-figure'  label='Compilation of selectors'><a id='_1140' name='Compilation of selectors'></a><table id='_1143' hssclass='hoptex-figure-content'><tr id='_1142'><td id='_1141' hssclass='hoptex-figure-content'><pre id='_1139' class='algo'><span id='_1087' class='cal'>C<sub id='_1086'>alias</sub></span>&#10214;IDENT&#10215;<sub id='_1088'>&#964;</sub> = 
  <span id='_1089' class='prog-syntax-keyword'>if</span> IDENT &#8712; &#964; 
     <span id='_1090' class='prog-syntax-keyword'>then</span> <span id='_1092' class='cal'>C<sub id='_1091'>alias</sub></span>&#10214;&#964;(IDENT)<span id='_1093' style='font-size: 121%'>&#8595;</span><sub id='_1095'><span id='_1094' style='font-size: 80%; font-family: serif;'>selector</span></sub>&#10215;<sub id='_1096'>&#964;</sub> 
     <span id='_1097' class='prog-syntax-keyword'>else</span> IDENT
<span id='_1099' class='cal'>C<sub id='_1098'>alias</sub></span>&#10214;IDENT.STRING&#10215;<sub id='_1100'>&#964;</sub> = 
  <span id='_1101' class='prog-syntax-keyword'>if</span> IDENT &#8712; &#964; 
     <span id='_1102' class='prog-syntax-keyword'>then</span> <span id='_1104' class='cal'>C<sub id='_1103'>alias</sub></span>&#10214;&#964;(IDENT)<span id='_1105' style='font-size: 121%'>&#8595;</span><sub id='_1107'><span id='_1106' style='font-size: 80%; font-family: serif;'>selector</span></sub>.STRING&#10215;<sub id='_1108'>&#964;</sub> 
     <span id='_1109' class='prog-syntax-keyword'>else</span> IDENT.STRING
<span id='_1111' class='cal'>C<sub id='_1110'>alias</sub></span>&#10214;IDENT:STRING&#10215;<sub id='_1112'>&#964;</sub> = 
  <span id='_1113' class='prog-syntax-keyword'>if</span> IDENT &#8712; &#964; 
     <span id='_1114' class='prog-syntax-keyword'>then</span> <span id='_1115' class='prog-syntax-keyword'>let</span> i = &#964;(IDENT) <span id='_1116' class='prog-syntax-keyword'>in</span>
            <span id='_1117' class='prog-syntax-keyword'>if</span> i<span id='_1118' style='font-size: 121%'>&#8595;</span><sub id='_1120'><span id='_1119' style='font-size: 80%; font-family: serif;'>body</span></sub> 
               <span id='_1121' class='prog-syntax-keyword'>then</span> <span id='_1123' class='cal'>C<sub id='_1122'>alias</sub></span>&#10214;i<span id='_1124' style='font-size: 121%'>&#8595;</span><sub id='_1126'><span id='_1125' style='font-size: 80%; font-family: serif;'>selector</span></sub> &lt; i<span id='_1127' style='font-size: 121%'>&#8595;</span><sub id='_1129'><span id='_1128' style='font-size: 80%; font-family: serif;'>body</span></sub>:STRING&#10215;<sub id='_1130'>&#964;</sub> 
               <span id='_1131' class='prog-syntax-keyword'>else</span> <span id='_1133' class='cal'>C<sub id='_1132'>alias</sub></span>&#10214;i<span id='_1134' style='font-size: 121%'>&#8595;</span><sub id='_1136'><span id='_1135' style='font-size: 80%; font-family: serif;'>selector</span></sub>:STRING&#10215;<sub id='_1137'>&#964;</sub>
     <span id='_1138' class='prog-syntax-keyword'>else</span> IDENT:STRING
</pre></td></tr></table><div id='_1145' hssclass='hoptex-figure-caption'><a id='_2030' class='hoptex-figure-ref' href='#fig:Calias' title='Figure 12: Compilation of selectors'><span id='_1934' hssclass='hoptex-figure-counter'>12</span></a>Compilation of selectors</div><a id='_1146' name='fig:Calias'></a></div>



<p id='_1149'>One sub&shy;tle&shy;ty is in&shy;tro&shy;duced by pseu&shy;do-ele&shy;ments that ac&shy;tu&shy;al&shy;ly change
the alias res&shy;o&shy;lu&shy;tion. This is il&shy;lus&shy;trat&shy;ed by the fol&shy;low&shy;ing ex&shy;am&shy;ple 
that uses the <code id='_1147'>lframe</code> el&shy;e&shy;ment pre&shy;sent&shy;ed in Fig&shy;ure <a id='_2031' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a>:
</p>
<pre id='_1150'>lframe:first-child {
  border: 1px solid red;
}
</pre>

<p id='_1158'>The in&shy;ten&shy;tion of this rule is to set a bor&shy;der to the first <em id='_1151'>user</em>
child of <code id='_1152'>lframe</code> el&shy;e&shy;ments by op&shy;po&shy;si&shy;tion to the child of the el&shy;e&shy;ment
that im&shy;ple&shy;ments the out&shy;er box of the <code id='_1153'>lframe</code>. This in&shy;ten&shy;tion is
spec&shy;i&shy;fied in HSS by adding a <code id='_1154'>:body</code> ar&shy;gu&shy;ment to the type
dec&shy;la&shy;ra&shy;tion. The <code id='_1155'>:body</code> ar&shy;gu&shy;ment is bound to a se&shy;lec&shy;tor string which
is used to change the HSS com&shy;pil&shy;er alias&shy;ing res&shy;o&shy;lu&shy;tion. The <code id='_1156'>:body</code> ar&shy;gu&shy;ment 
is added to a se&shy;lec&shy;tor rule when the type el&shy;e&shy;ment is not used in the
right-&shy;most po&shy;si&shy;tion or when it is used with a pseu&shy;do-s&shy;e&shy;lec&shy;tor such as
<code id='_1157'>:first-child</code>. 
</p>
<p id='_1168'>In this ex&shy;am&shy;ple, since the dec&shy;la&shy;ra&shy;tion of <code id='_1159'>lframe</code>
spec&shy;i&shy;fies a <code id='_1160'>:body</code> ar&shy;gu&shy;ment, then <code id='_1161'>:first-child</code> must be re&shy;solved
against that el&shy;e&shy;ment, not against the el&shy;e&shy;ment im&shy;ple&shy;ment&shy;ing the out&shy;er
<code id='_1162'>lframe</code> box. Hence, re&shy;mem&shy;ber&shy;ing that <code id='_1163'>lframe</code>'s <code id='_1164'>:body</code> at&shy;tribute
is <code id='_1165'>div[hssclass=hop-lfbody]</code>, <span id='_1167' class='cal'>C<sub id='_1166'>alias</sub></span> com&shy;piles the 
pre&shy;vi&shy;ous dec&shy;la&shy;ra&shy;tion into:
</p>
<pre id='_1169'>div[hssclass=hop-lframe] 
   div[hssclass=hop-lfbody]:first-child {
  border: 1px solid red;
}
</pre>

<p id='_1171'>With&shy;out the <code id='_1170'>:body</code> op&shy;tion&shy;al ar&shy;gu&shy;ment it would have been com&shy;piled into:
</p>
<pre id='_1172'>div[hssclass=hop-lframe]:first-child {
  border: 1px solid red;
}
</pre>

<a id='_1173' name='Compiling Declarations'></a><h3 id='_1174' name='Compiling Declarations'><span id='_1982' hssclass='hoptex-section3'>4<span id='_1980' hssclass='hoptex-subsection'>1</span><span id='_1981' hssclass='hoptex-subsection'>2</span></span> Compiling Declarations </h3>

<p id='_1178'>Dec&shy;la&shy;ra&shy;tions are com&shy;piled by the func&shy;tion <span id='_1176' class='cal'>C<sub id='_1175'>decl</sub></span> (see
Fig&shy;ure <a id='_2032' class='hoptex-figure-ref' href='#fig:Cdecl' title='Figure 13: Compiling declarations'><span id='_1935' hssclass='hoptex-figure-counter'>13</span></a>). The en&shy;vi&shy;ron&shy;ment &#961; binds
prop&shy;er&shy;ty iden&shy;ti&shy;fier&shy;s. For each iden&shy;ti&shy;fi&shy;er it as&shy;so&shy;ci&shy;ates a se&shy;lec&shy;tor and 
a com&shy;pil&shy;er.
</p>

<div id='fig:Cdecl' hssclass='hoptex-figure'  label='Compiling declarations'><a id='_1197' name='Compiling declarations'></a><table id='_1200' hssclass='hoptex-figure-content'><tr id='_1199'><td id='_1198' hssclass='hoptex-figure-content'><pre id='_1196' class='algo'><span id='_1180' class='cal'>C<sub id='_1179'>decl</sub></span>&#10214;IDENT : E&#10215;<sub id='_1181'>&#964;&#961;&#966;</sub> = 
  <span id='_1182' class='prog-syntax-keyword'>if</span> IDENT &#8712; &#961;
     <span id='_1183' class='prog-syntax-keyword'>then</span> <span id='_1184' class='prog-syntax-keyword'>let</span> s = &#961;(IDENT)<span id='_1185' style='font-size: 121%'>&#8595;</span><sub id='_1187'><span id='_1186' style='font-size: 80%; font-family: serif;'>selector</span></sub>
              c = &#961;(IDENT)<span id='_1188' style='font-size: 121%'>&#8595;</span><sub id='_1190'><span id='_1189' style='font-size: 80%; font-family: serif;'>compiler</span></sub> <span id='_1191' class='prog-syntax-keyword'>in</span>
            &#10216;s &#215; c(E)&#10217;
     <span id='_1192' class='prog-syntax-keyword'>else</span> &#10216;false &#215; IDENT : <span id='_1194' class='cal'>C<sub id='_1193'>expr</sub></span>&#10214;E&#10215;<sub id='_1195'>&#966;</sub>&#10217;
</pre></td></tr></table><div id='_1202' hssclass='hoptex-figure-caption'><a id='_2033' class='hoptex-figure-ref' href='#fig:Cdecl' title='Figure 13: Compiling declarations'><span id='_1935' hssclass='hoptex-figure-counter'>13</span></a>Compiling declarations</div><a id='_1203' name='fig:Cdecl'></a></div>


<p id='_1208'>The sec&shy;ond func&shy;tion need&shy;ed to com&shy;pile HSS dec&shy;la&shy;ra&shy;tions is <span id='_1205' class='cal'>C<sub id='_1204'>expr</sub></span> (see
Fig&shy;ure <a id='_2034' class='hoptex-figure-ref' href='#fig:Cexpr' title='Figure 14: Compiling property values'><span id='_1936' hssclass='hoptex-figure-counter'>14</span></a>). It takes in charge the com&shy;pi&shy;la&shy;tion
of ex&shy;pres&shy;sion&shy;s. It re&shy;solves <code id='_1207'>$-</code>forms and user-de&shy;fined func&shy;tions
bound in the en&shy;vi&shy;ron&shy;ment &#966;.
</p>

<div id='fig:Cexpr' hssclass='hoptex-figure'  label='Compiling property values'><a id='_1229' name='Compiling property values'></a><table id='_1232' hssclass='hoptex-figure-content'><tr id='_1231'><td id='_1230' hssclass='hoptex-figure-content'><pre id='_1228' class='algo'><span id='_1210' class='cal'>C<sub id='_1209'>expr</sub></span>&#10214;STRING&#10215;<sub id='_1211'>&#966;</sub> = STRING
<span id='_1213' class='cal'>C<sub id='_1212'>expr</sub></span>&#10214;$expr&#10215;<sub id='_1214'>&#966;</sub> = HOP(expr)
<span id='_1216' class='cal'>C<sub id='_1215'>expr</sub></span>&#10214;IDENT(expr)&#10215;<sub id='_1217'>&#966;</sub> = 
   <span id='_1218' class='prog-syntax-keyword'>let</span> e = <span id='_1220' class='cal'>C<sub id='_1219'>expr</sub></span>&#10214;expr&#10215;<sub id='_1221'>&#966;</sub> <span id='_1222' class='prog-syntax-keyword'>in</span>
     <span id='_1223' class='prog-syntax-keyword'>if</span> IDENT &#8712; &#966; 
        <span id='_1224' class='prog-syntax-keyword'>then</span> <span id='_1225' class='prog-syntax-keyword'>let</span> f = &#966;(IDENT) <span id='_1226' class='prog-syntax-keyword'>in</span> f(e) 
        <span id='_1227' class='prog-syntax-keyword'>else</span> IDENT(e)
</pre></td></tr></table><div id='_1234' hssclass='hoptex-figure-caption'><a id='_2035' class='hoptex-figure-ref' href='#fig:Cexpr' title='Figure 14: Compiling property values'><span id='_1936' hssclass='hoptex-figure-counter'>14</span></a>Compiling property values</div><a id='_1235' name='fig:Cexpr'></a></div>



<a id='_1236' name='Compiling User Rules'></a><h2 id='_1237' name='Compiling User Rules'><span id='_1984' hssclass='hoptex-section2'>4<span id='_1983' hssclass='hoptex-subsection'>2</span></span> Compiling User Rules </h2>

<p id='_1241'>The right most el&shy;e&shy;ment type of a se&shy;lec&shy;tor spec&shy;i&shy;fies the el&shy;e&shy;ments
the rule ap&shy;plied to. The left el&shy;e&shy;ments lim&shy;it the
set of el&shy;e&shy;ments the rule ap&shy;plies to so they do not im&shy;pact the
com&shy;pi&shy;la&shy;tion of rule at&shy;tributes. In the rest of this sec&shy;tion, rules
where the right most el&shy;e&shy;ment is a user de&shy;clared type are re&shy;ferred to
as <em id='_1238'>user rules</em>. This sec&shy;tion pre&shy;sents the HSS com&shy;pi&shy;la&shy;tion func&shy;tion
<span id='_1240' class='cal'>C<sub id='_1239'>user</sub></span> that han&shy;dles them.
</p>
<p id='_1248'>As shown in Sec&shy;tion <a id='_2001' hssclass='hoptex-section-ref' href='#HSS user-defined types' title='HSS user-defined types'><span id='_1959' hssclass='hoptex-section2'>3<span id='_1958' hssclass='hoptex-subsection'>3</span></span></a> and in
par&shy;tic&shy;u&shy;lar in the <code id='_1243'>lframe</code> ex&shy;am&shy;ple pre&shy;sent&shy;ed in Fig&shy;ure
<a id='_2036' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a>, prop&shy;er&shy;ties of user de&shy;fined types may be
as&shy;so&shy;ci&shy;at&shy;ed with se&shy;lec&shy;tors. For in&shy;stance, the <code id='_1245'>padding</code> prop&shy;er&shy;ty of
the user de&shy;fined <code id='_1246'>lframe</code> type is as&shy;so&shy;ci&shy;at&shy;ed with the se&shy;lec&shy;tor
<code id='_1247'>div[hssclass=hop-lfbody]</code>. HSS has to gen&shy;er&shy;ate new
se&shy;lec&shy;tors that ac&shy;com&shy;mo&shy;dates the se&shy;lec&shy;tor used in the user type dec&shy;la&shy;ra&shy;tion
and the se&shy;lec&shy;tor used in the prop&shy;er&shy;ty dec&shy;la&shy;ra&shy;tion. This is il&shy;lus&shy;trat&shy;ed with
two ex&shy;am&shy;ples. The first one il&shy;lus&shy;trates the com&shy;pi&shy;la&shy;tion frame&shy;work when
the prop&shy;er&shy;ty does not come with its se&shy;lec&shy;tor. The sec&shy;ond il&shy;lus&shy;trates the
com&shy;pi&shy;la&shy;tion when a se&shy;lec&shy;tor is as&shy;so&shy;ci&shy;at&shy;ed to a prop&shy;er&shy;ty.
</p>
<ul id='_1270'><li id='_1260'> The <code id='_1249'>-hop-label-margin</code> de&shy;fines a prop&shy;er&shy;ty of the main HTML el&shy;e&shy;ment 
that im&shy;ple&shy;ments the <code id='_1250'>lframe</code>, <em id='_1251'>i.e.,</em> a <code id='_1252'>div</code> el&shy;e&shy;ment whose <code id='_1253'>hssclass</code>
is <code id='_1254'>hop-lframe</code>.
Hence, when the prop&shy;er&shy;ty <code id='_1255'>-hop-label-margin</code> is used in a dec&shy;la&shy;ra&shy;tion, 
it is com&shy;piled into a dec&shy;la&shy;ra&shy;tion ap&shy;plied to a 
<code id='_1256'>div[hssclass=hop-lframe]</code> el&shy;e&shy;men&shy;t. So the
dec&shy;la&shy;ra&shy;tion:

<pre id='_1257'>lframe.foo {
  -hop-label-margin: 10px;
}
</pre>

<p id='_1258' class='noindent' >is com&shy;piled into:
</p>
<pre id='_1259'>div[hssclass=hop-lframe].foo {
  padding: 10px;
}
</pre>

</li><li id='_1269'> The <code id='_1261'>-hop-label-border</code> prop&shy;er&shy;ty is as&shy;so&shy;ci&shy;at&shy;ed with the
se&shy;lec&shy;tor <code id='_1262'>div[hssclass=hop-lfborder]</code>. So, when used in
a rule, the se&shy;lec&shy;tor on which this con&shy;fig&shy;u&shy;ra&shy;tion ap&shy;plies is not the <code id='_1263'>lframe</code>
el&shy;e&shy;ment it&shy;self but the <code id='_1264'>div[hssclass=hop-lfborder]</code> that is nest&shy;ed in the 
<code id='_1265'>lframe</code>. Then, the dec&shy;la&shy;ra&shy;tion:

<pre id='_1266'>lframe.foo {
  -hop-label-border: 2px groove #ddd;
}
</pre>

<p id='_1267' class='noindent' >is com&shy;piled into:
</p>
<pre id='_1268'>div[hssclass=hop-lframe].foo 
   div[hssclass=hop-lfborder] {
  border: 2px groove #ddd;
}</pre></li></ul>


<p id='_1277'>To ac&shy;com&shy;plish this trans&shy;for&shy;ma&shy;tion, the func&shy;tion <span id='_1272' class='cal'>C<sub id='_1271'>user</sub></span> first
splits the ini&shy;tial rule into <em id='_1273'>m</em> rules where <em id='_1274'>m</em> is the num&shy;ber of
prop&shy;er&shy;ties held by the rule. Sec&shy;ond, it com&shy;putes the se&shy;lec&shy;tor of these
new rules ac&shy;cord&shy;ing to prop&shy;er&shy;ty dec&shy;la&shy;ra&shy;tions. The whole def&shy;i&shy;ni&shy;tion of
<span id='_1275' class='cal'>C</span> is giv&shy;en in Fig&shy;ure <a id='_2037' class='hoptex-figure-ref' href='#fig:Cuser' title='Figure 15: User rules compilation'><span id='_1937' hssclass='hoptex-figure-counter'>15</span></a> where, for
sim&shy;pli&shy;fy&shy;ing the pre&shy;sen&shy;ta&shy;tion, it is as&shy;sumed that type prop&shy;er&shy;ty
com&shy;pil&shy;ers only re&shy;turn sin&shy;gle strings.
</p>

<div id='fig:Cuser' hssclass='hoptex-figure'  label='User rules compilation'><a id='_1351' name='User rules compilation'></a><table id='_1354' hssclass='hoptex-figure-content'><tr id='_1353'><td id='_1352' hssclass='hoptex-figure-content'><pre id='_1350' class='algo'><span id='_1279' class='cal'>C<sub id='_1278'>user</sub></span>&#10214;<span id='_1281' class='prog-syntax-domain'>S<sub id='_1280'>1</sub></span> <span id='_1283' class='prog-syntax-domain'>op<sub id='_1282'>1</sub></span> &#8230; <span id='_1285' class='prog-syntax-domain'>op<sub id='_1284'>n-1</sub></span> <span id='_1287' class='prog-syntax-domain'>S<sub id='_1286'>n</sub></span> {<span id='_1289' class='prog-syntax-domain'>D<sub id='_1288'>1</sub></span>; &#8230; <span id='_1291' class='prog-syntax-domain'>D<sub id='_1290'>m</sub></span>;}&#10215;<sub id='_1292'>&#964;&#961;&#966;</sub> = 
  <span id='_1293' class='prog-syntax-keyword'>let</span> &#961;' = <span id='_1295' class='prog-syntax-domain'>S<sub id='_1294'>n</sub></span><span id='_1296' style='font-size: 121%'>&#8595;</span><sub id='_1298'><span id='_1297' style='font-size: 80%; font-family: serif;'>&#961;</span></sub> &#167; &#961; <span id='_1299' class='prog-syntax-keyword'>in</span>
      d1 = <span id='_1301' class='cal'>C<sub id='_1300'>decl</sub></span>&#10214;<span id='_1303' class='prog-syntax-domain'>D<sub id='_1302'>1</sub></span>&#10215; <span id='_1304' class='prog-syntax-keyword'>in</span> 
    <span id='_1305' class='prog-syntax-keyword'>if</span> d1<span id='_1306' style='font-size: 121%'>&#8595;</span><sub id='_1308'><span id='_1307' style='font-size: 80%; font-family: serif;'>1</span></sub> 
       <span id='_1309' class='prog-syntax-keyword'>then</span> <span id='_1310' class='cal'>C</span>&#10214;<span id='_1312' class='prog-syntax-domain'>S<sub id='_1311'>1</sub></span> <span id='_1314' class='prog-syntax-domain'>op<sub id='_1313'>1</sub></span> &#8230; <span id='_1316' class='prog-syntax-domain'>op<sub id='_1315'>n-1</sub></span> <span id='_1318' class='prog-syntax-domain'>S<sub id='_1317'>n</sub></span> &lt; d1<span id='_1319' style='font-size: 121%'>&#8595;</span><sub id='_1321'><span id='_1320' style='font-size: 80%; font-family: serif;'>1</span></sub> {d1<span id='_1322' style='font-size: 121%'>&#8595;</span><sub id='_1324'><span id='_1323' style='font-size: 80%; font-family: serif;'>2</span></sub>;}&#10215;<sub id='_1325'>&#964;&#961;&#966;</sub>
       <span id='_1326' class='prog-syntax-keyword'>else</span> <span id='_1328' class='cal'>C<sub id='_1327'>alias</sub></span>&#10214;<span id='_1330' class='prog-syntax-domain'>S<sub id='_1329'>1</sub></span>&#10215;<sub id='_1331'>&#964;</sub> <span id='_1333' class='prog-syntax-domain'>op<sub id='_1332'>1</sub></span> &#8230; <span id='_1335' class='prog-syntax-domain'>op<sub id='_1334'>n-1</sub></span> <span id='_1337' class='cal'>C<sub id='_1336'>alias</sub></span>&#10214;<span id='_1339' class='prog-syntax-domain'>S<sub id='_1338'>n</sub></span>&#10215;<sub id='_1340'>&#964;</sub> {d1<span id='_1341' style='font-size: 121%'>&#8595;</span><sub id='_1343'><span id='_1342' style='font-size: 80%; font-family: serif;'>2</span></sub>;}
    &#8230;
    <span id='_1344' class='prog-syntax-keyword'>let</span> dm = <span id='_1346' class='cal'>C<sub id='_1345'>decl</sub></span>&#10214;<span id='_1348' class='prog-syntax-domain'>D<sub id='_1347'>m</sub></span>&#10215; <span id='_1349' class='prog-syntax-keyword'>in</span> 
       &#8230;</pre></td></tr></table><div id='_1356' hssclass='hoptex-figure-caption'><a id='_2038' class='hoptex-figure-ref' href='#fig:Cuser' title='Figure 15: User rules compilation'><span id='_1937' hssclass='hoptex-figure-counter'>15</span></a>User rules compilation</div><a id='_1357' name='fig:Cuser'></a></div>




<a id='_1358' name='Limits and Future work'></a><h1 id='_1359' name='Limits and Future work'><span id='_1985' hssclass='hoptex-section1'>5</span> Limits and Future work </h1>

<p id='_1361'>HSS sup&shy;ports a high&shy;er lev&shy;el of ab&shy;strac&shy;tion than CSS be&shy;cause it can
be used to hide wid&shy;gets im&shy;ple&shy;men&shy;ta&shy;tion de&shy;tail&shy;s. How&shy;ev&shy;er, not all HTML
style spec&shy;i&shy;fi&shy;ca&shy;tions are giv&shy;en in CSS files. Some are spec&shy;i&shy;fied
stat&shy;i&shy;cal&shy;ly via the HTML <code id='_1360'>:style</code> at&shy;tribute and oth&shy;ers are even
com&shy;put&shy;ed dy&shy;nam&shy;i&shy;cal&shy;ly on the clien&shy;t-&shy;side code. In all these cas&shy;es, HSS
is hope&shy;less. 
</p>

<p id='_1365'>It could be ap&shy;peal&shy;ing to re&shy;sort on the Hop dual com&shy;pil&shy;er
that al&shy;lows a same source code to be com&shy;piled for the serv&shy;er (via
na&shy;tive code com&shy;pi&shy;la&shy;tion) as well as com&shy;piled for the client (via
JavaScript code com&shy;pi&shy;la&shy;tion <span id='bibref1644'  hssclass='hoptex-bib-ref'><a id='_1646' href='#bibentry-4' class='local' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1645"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1645"), "\uEBADdisplay", "none");

 undefined; }'>4</a><div id='bibref1645' hssclass='hoptex-bib-popup'><table id='_1657'><tr id='_1656'><td id='_1647' class='hoptex-bib-entry-key'>4</td><td id='_1655' class='hoptex-bib-entry-value'><span id='_1648' class='hoptex-bib-entry-author'>Loitsch, F.  and Serrano, M. </span><span id='_1649' class='hoptex-bib-entry-title'>Trends in Functional Programming</span><span id='_1650' class='hoptex-bib-entry-chapter'>Hop Client-Side Compilation</span><span id='_1651' class='hoptex-bib-entry-publisher'>Seton Hall University, Intellect Bristol, ed. Morazán, M. T.</span><span id='_1652' class='hoptex-bib-entry-address'>UK/Chicago, USA</span><span id='_1653' class='hoptex-bib-entry-date'> 2008</span><span id='_1654' class='hoptex-bib-entry-pages'>141--158</span>.</td></tr></table></div></span>) to run the HSS
com&shy;pil&shy;er on the server-&shy;side <em id='_1363'>and</em> on the clien&shy;t-&shy;side of web
ap&shy;pli&shy;ca&shy;tion&shy;s. How&shy;ev&shy;er, we think that this would be un&shy;re&shy;al&shy;is&shy;tic be&shy;cause
the HSS im&shy;ple&shy;men&shy;ta&shy;tion is too big. It is un&shy;de&shy;cid&shy;able if HSS is need&shy;ed
or not on the client side, then HSS would have to be in&shy;clud&shy;ed in the
reg&shy;u&shy;lar clien&shy;t-&shy;side run&shy;time sys&shy;tem, that is shipped with <em id='_1364'>all</em> the
web pages de&shy;liv&shy;ered to clients. This would dra&shy;mat&shy;i&shy;cal&shy;ly en&shy;large the
load time of all Hop ap&shy;pli&shy;ca&shy;tions as it would clut&shy;ter the mem&shy;o&shy;ry of
the web browsers than ex&shy;e&shy;cute them.
</p>
<p id='_1372'>User-de&shy;fined HTML el&shy;e&shy;ments can be as&shy;signed names us&shy;ing the
<code id='_1366'>define-hss-type</code> for&shy;m. De&shy;vel&shy;op&shy;ers re&shy;fer to these names for
spec&shy;i&shy;fy&shy;ing graph&shy;i&shy;cal tun&shy;ings, in&shy;de&shy;pen&shy;dent&shy;ly of the im&shy;ple&shy;men&shy;ta&shy;tion
de&shy;tail&shy;s. Un&shy;for&shy;tu&shy;nate&shy;ly this name bind&shy;ing fails at to&shy;tal&shy;ly hid&shy;ing
im&shy;ple&shy;men&shy;ta&shy;tion de&shy;tails be&shy;cause it does not pre&shy;vent the ref&shy;er&shy;enced
HTML se&shy;quence to be im&shy;pact&shy;ed by gen&shy;er&shy;al CSS rules. For in&shy;stance, 
a <code id='_1367'>lframe</code> as de&shy;fined in Fig&shy;ure <a id='_2039' class='hoptex-figure-ref' href='#fig:lframe' title='Figure 7: Definition of the new lframe type element'><span id='_1929' hssclass='hoptex-figure-counter'>7</span></a> is ac&shy;tu&shy;al&shy;ly
an alias for <code id='_1369'>div[hssclass=hop-lframe]</code>. Then, <code id='_1370'>lframe</code> is
im&shy;pact&shy;ed by any gen&shy;er&shy;al rule men&shy;tion&shy;ing <code id='_1371'>DIV</code> el&shy;e&shy;ment such as:
</p>
<pre id='_1373'>div {
  background-color: red;
}
</pre>

<p id='_1379'>Al&shy;though users may re&shy;fer to <code id='_1374'>lframe</code> by a ded&shy;i&shy;cat&shy;ed type name, 
a <code id='_1375'>lframe</code> is still a HTML <code id='_1376'>DIV</code> that can be con&shy;fig&shy;ured di&shy;rect&shy;ly by 
a CSS file! This let users in&shy;fer that a <code id='_1377'>lframe</code> is ac&shy;tu&shy;al&shy;ly im&shy;ple&shy;ment&shy;ed
with a <code id='_1378'>DIV</code>. We see no so&shy;lu&shy;tion to this prob&shy;lem.
</p>

<p id='_1382'>The cur&shy;rent ver&shy;sion of HSS does not sup&shy;port user-de&shy;fined
pseu&shy;do-ele&shy;ments. How&shy;ev&shy;er, this could help im&shy;prov&shy;ing the back&shy;ward
com&shy;pat&shy;i&shy;bil&shy;i&shy;ty be&shy;tween CSS-2 and CSS-3. CSS-3 de&shy;fines ad&shy;di&shy;tion&shy;al
pseu&shy;do-ele&shy;ments such as <code id='_1380'>:last-child</code> or <code id='_1381'>:nth</code>. Some of these are
es&shy;sen&shy;tial and can&shy;not be sim&shy;u&shy;lat&shy;ed. Some could. This will be sub&shy;ject of
a fu&shy;ture HSS ex&shy;ten&shy;sion&shy;s.
</p>

<a id='_1383' name='Related work'></a><h1 id='_1384' name='Related work'><span id='_1986' hssclass='hoptex-section1'>6</span> Related work </h1>


<p id='_1386'>HSS has first been men&shy;tioned but not de&shy;tailed in an ear&shy;ly
pub&shy;li&shy;ca&shy;tion <span id='bibref1658'  hssclass='hoptex-bib-ref'><a id='_1660' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1659"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1659"), "\uEBADdisplay", "none");

 undefined; }'>7</a><div id='bibref1659' hssclass='hoptex-bib-popup'><table id='_1670'><tr id='_1669'><td id='_1661' class='hoptex-bib-entry-key'>7</td><td id='_1668' class='hoptex-bib-entry-value'><span id='_1662' class='hoptex-bib-entry-author'>Serrano, M. </span><a id='_1664' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html'>The HOP Development Kit<span id='_1663' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html</span></a><span id='_1665' class='hoptex-bib-entry-booktitle'>Invited paper of the Seventh ACM sigplan Workshop on Scheme and Functional Programming</span><span id='_1666' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1667' class='hoptex-bib-entry-date'>Sep 2006</span>.</td></tr></table></div></span>. We have not been able to ob&shy;serve
oth&shy;er ev&shy;i&shy;dence of aca&shy;dem&shy;ic stud&shy;ies con&shy;cern&shy;ing CSS in the main&shy;stream
con&shy;fer&shy;ences and jour&shy;nals ded&shy;i&shy;cat&shy;ed to the web. For in&shy;stance, we have
found no men&shy;tion of CSS stud&shy;ies in any of the 10 last ACM WWW
con&shy;fer&shy;ences. How&shy;ev&shy;er, we think that CSS play&shy;ing an im&shy;por&shy;tant role in
the pro&shy;duc&shy;tion of web ap&shy;pli&shy;ca&shy;tions, it de&shy;serves our at&shy;ten&shy;tion.
</p>
<p id='_1387'>No ar&shy;ti&shy;cle has been writ&shy;ten by the academies or by re&shy;search
in&shy;sti&shy;tutes but some tools have been pro&shy;duced by pri&shy;vate com&shy;pa&shy;nies or
by the free soft&shy;ware ac&shy;tors. In this sec&shy;tion they are com&shy;pared to HSS.
</p>
<ul id='_1402'><li id='_1392'> <strong id='_1388'>Sass</strong>, <span id='bibref1671'  hssclass='hoptex-bib-ref'><a id='_1673' href='http://sass-lang.com/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1672"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1672"), "\uEBADdisplay", "none");

 undefined; }'>3</a><div id='bibref1672' hssclass='hoptex-bib-popup'><table id='_1681'><tr id='_1680'><td id='_1674' class='hoptex-bib-entry-key'>3</td><td id='_1679' class='hoptex-bib-entry-value'><span id='_1675' class='hoptex-bib-entry-author'>Catlin, H.  and Weizenbaum, N. </span><a id='_1677' class='hoptex-bib-entry-title' href='http://sass-lang.com/'>Sass -- Syntactically Awesome StyleSheets<span id='_1676' class='hoptex-bib-entry-url'>http://sass-lang.com/</span></a><span id='_1678' class='hoptex-bib-entry-date'> 2006</span>.</td></tr></table></div></span> or <em id='_1390'>Syntactically Awesome StyleSheets</em>, 
is <q id='_1391'>a meta-language on
top of CSS that's used to describe the style of a document cleanly and
structurally, with more power than flat CSS allows</q>. Sass can be used
as a com&shy;mand-&shy;line tool or as a plu&shy;g&shy;in for Ruby on Rails or Mer&shy;b. Sass
uses its own syn&shy;tax based on tab&shy;u&shy;la&shy;tions and new&shy;lines. It sup&shy;ports
vari&shy;ables, func&shy;tions, blocks, and some fan&shy;cy fea&shy;tures such as prop&shy;er&shy;ty
name-s&shy;paces. As sev&shy;er&shy;al oth&shy;er tools, Sass sup&shy;ports block nest&shy;ing 
which al&shy;lows spec&shy;i&shy;fi&shy;ca&shy;tions of chil&shy;dren to be de&shy;clared in&shy;side their par&shy;en&shy;t.
This fea&shy;ture could be eas&shy;i&shy;ly added to HSS but it does not seem es&shy;sen&shy;tial since
its only pur&shy;pose is to ab&shy;bre&shy;vi&shy;ate se&shy;lec&shy;tors.
</li><li id='_1395'> <strong id='_1393'>H(aXe)SS</strong>: <span id='bibref1682'  hssclass='hoptex-bib-ref'><a id='_1684' href='http://ncannasse.fr/projects/hss' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1683"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1683"), "\uEBADdisplay", "none");

 undefined; }'>2</a><div id='bibref1683' hssclass='hoptex-bib-popup'><table id='_1692'><tr id='_1691'><td id='_1685' class='hoptex-bib-entry-key'>2</td><td id='_1690' class='hoptex-bib-entry-value'><span id='_1686' class='hoptex-bib-entry-author'>Cannasse, N. </span><a id='_1688' class='hoptex-bib-entry-title' href='http://ncannasse.fr/projects/hss'>Haxe HSS<span id='_1687' class='hoptex-bib-entry-url'>http://ncannasse.fr/projects/hss</span></a><span id='_1689' class='hoptex-bib-entry-date'>Oct 2008</span>.</td></tr></table></div></span> is a stand-alone pre-pro&shy;ces&shy;sor for CSS. 
It sup&shy;ports  vari&shy;ables def&shy;i&shy;ni&shy;tions and nest&shy;ed block&shy;s. 
</li><li id='_1398'> <strong id='_1396'>Less</strong> <span id='bibref1693'  hssclass='hoptex-bib-ref'><a id='_1695' href='http://lesscss.org/index.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1694"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1694"), "\uEBADdisplay", "none");

 undefined; }'>6</a><div id='bibref1694' hssclass='hoptex-bib-popup'><table id='_1703'><tr id='_1702'><td id='_1696' class='hoptex-bib-entry-key'>6</td><td id='_1701' class='hoptex-bib-entry-value'><span id='_1697' class='hoptex-bib-entry-author'>Selleir, A.  and Fadeyev, D. </span><a id='_1699' class='hoptex-bib-entry-title' href='http://lesscss.org/index.html'>Less<span id='_1698' class='hoptex-bib-entry-url'>http://lesscss.org/index.html</span></a><span id='_1700' class='hoptex-bib-entry-date'> 2009</span>.</td></tr></table></div></span> is an ex&shy;ten&shy;sion of CSS that sup&shy;ports nest&shy;ed blocks, 
arith&shy;metic op&shy;er&shy;a&shy;tions on num&shy;bers and col&shy;ors, lex&shy;i&shy;cal scoped vari&shy;ables but
it sup&shy;ports no script&shy;ing nor func&shy;tion&shy;s.
</li><li id='_1401'> <strong id='_1399'>CleverCSS</strong> <span id='bibref1704'  hssclass='hoptex-bib-ref'><a id='_1706' href='http://sandbox.pocoo.org/clevercss/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1705"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1705"), "\uEBADdisplay", "none");

 undefined; }'>5</a><div id='bibref1705' hssclass='hoptex-bib-popup'><table id='_1714'><tr id='_1713'><td id='_1707' class='hoptex-bib-entry-key'>5</td><td id='_1712' class='hoptex-bib-entry-value'><span id='_1708' class='hoptex-bib-entry-author'>Ronacher, A. </span><a id='_1710' class='hoptex-bib-entry-title' href='http://sandbox.pocoo.org/clevercss/'>CleverCSS<span id='_1709' class='hoptex-bib-entry-url'>http://sandbox.pocoo.org/clevercss/</span></a><span id='_1711' class='hoptex-bib-entry-date'> 2007</span>.</td></tr></table></div></span> is a CSS gen&shy;er&shy;a&shy;tor that re&shy;lies on a 
Python based syn&shy;tax. It sup&shy;ports em&shy;bed&shy;ded Python ex&shy;pres&shy;sions, vari&shy;ables, 
and nest&shy;ed block&shy;s.
</li></ul>






<div id='fig-related-work' hssclass='hoptex-figure' class='article-figure-centered article-figure-long-label multicolumns' label='This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.'><a id='_1561' name='This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.'></a><table id='_1564' hssclass='hoptex-figure-content'><tr id='_1563'><td id='_1562' hssclass='hoptex-figure-content'><table id='related-work' class='related-work'><tr id='_1414' class='legend'><th id='_1403'>Name</th><th id='_1404'>Syntax</th><th id='_1405'>Host</th><th id='_1406'>UType</th><th id='_1407'>UProp</th><th id='_1408'>Nesting</th><th id='_1409'>Var.</th><th id='_1410'>Fun.</th><th id='_1411'>Block</th><th id='_1412'>Expr.</th><th id='_1413'>Misc</th></tr><tr id='_1444'><td id='_1425'><table id='_1424' class='related-work-system'><tr id='_1419'><th id='_1418'>Sass <span id='bibref1726'  hssclass='hoptex-bib-ref'><a id='_1728' href='http://sass-lang.com/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1727"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1727"), "\uEBADdisplay", "none");

 undefined; }'>3</a><div id='bibref1727' hssclass='hoptex-bib-popup'><table id='_1736'><tr id='_1735'><td id='_1729' class='hoptex-bib-entry-key'>3</td><td id='_1734' class='hoptex-bib-entry-value'><span id='_1730' class='hoptex-bib-entry-author'>Catlin, H.  and Weizenbaum, N. </span><a id='_1732' class='hoptex-bib-entry-title' href='http://sass-lang.com/'>Sass -- Syntactically Awesome StyleSheets<span id='_1731' class='hoptex-bib-entry-url'>http://sass-lang.com/</span></a><span id='_1733' class='hoptex-bib-entry-date'> 2006</span>.</td></tr></table></div></span></th></tr><tr id='_1423'><td id='_1422'><a id='_1421' href='http://sass-lang.com/'><tt id='_1420'>http://sass-lang.com/</tt></a></td></tr></table></td><td id='_1426'>private</td><td id='_1432'><table id='_1431' class='related-work-list'><tr id='_1428'><td id='_1427'>Ruby on Rail</td></tr><tr id='_1430'><td id='_1429'>Merb</td></tr></table></td><td id='_1433'>no</td><td id='_1434'>no</td><td id='_1435'>yes</td><td id='_1436'>yes</td><td id='_1437'>ruby</td><td id='_1438'>yes</td><td id='_1439'>SassScript</td><td id='_1443'><table id='_1442' class='related-work-list'><tr id='_1441'><td id='_1440'>Property name-spaces</td></tr></table></td></tr><tr id='_1472'><td id='_1455'><table id='_1454' class='related-work-system'><tr id='_1449'><th id='_1448'>H(aXe)SS <span id='bibref1748'  hssclass='hoptex-bib-ref'><a id='_1750' href='http://ncannasse.fr/projects/hss' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1749"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1749"), "\uEBADdisplay", "none");

 undefined; }'>2</a><div id='bibref1749' hssclass='hoptex-bib-popup'><table id='_1758'><tr id='_1757'><td id='_1751' class='hoptex-bib-entry-key'>2</td><td id='_1756' class='hoptex-bib-entry-value'><span id='_1752' class='hoptex-bib-entry-author'>Cannasse, N. </span><a id='_1754' class='hoptex-bib-entry-title' href='http://ncannasse.fr/projects/hss'>Haxe HSS<span id='_1753' class='hoptex-bib-entry-url'>http://ncannasse.fr/projects/hss</span></a><span id='_1755' class='hoptex-bib-entry-date'>Oct 2008</span>.</td></tr></table></div></span></th></tr><tr id='_1453'><td id='_1452'><a id='_1451' href='http://ncannasse.fr/projects/hss'><tt id='_1450'>http://ncannasse.fr/projects/hss</tt></a></td></tr></table></td><td id='_1456'>CSS</td><td id='_1460'><table id='_1459' class='related-work-list'><tr id='_1458'><td id='_1457'>stand alone</td></tr></table></td><td id='_1461'>no</td><td id='_1462'>no</td><td id='_1463'>yes</td><td id='_1464'>yes</td><td id='_1465'>no</td><td id='_1466'>yes</td><td id='_1467'>no</td><td id='_1471'><table id='_1470' class='related-work-list'><tr id='_1469'><td id='_1468'></td></tr></table></td></tr><tr id='_1502'><td id='_1483'><table id='_1482' class='related-work-system'><tr id='_1477'><th id='_1476'>Less <span id='bibref1770'  hssclass='hoptex-bib-ref'><a id='_1772' href='http://lesscss.org/index.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1771"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1771"), "\uEBADdisplay", "none");

 undefined; }'>6</a><div id='bibref1771' hssclass='hoptex-bib-popup'><table id='_1780'><tr id='_1779'><td id='_1773' class='hoptex-bib-entry-key'>6</td><td id='_1778' class='hoptex-bib-entry-value'><span id='_1774' class='hoptex-bib-entry-author'>Selleir, A.  and Fadeyev, D. </span><a id='_1776' class='hoptex-bib-entry-title' href='http://lesscss.org/index.html'>Less<span id='_1775' class='hoptex-bib-entry-url'>http://lesscss.org/index.html</span></a><span id='_1777' class='hoptex-bib-entry-date'> 2009</span>.</td></tr></table></div></span></th></tr><tr id='_1481'><td id='_1480'><a id='_1479' href='http://lesscss.org'><tt id='_1478'>http://lesscss.org</tt></a></td></tr></table></td><td id='_1484'>CSS</td><td id='_1490'><table id='_1489' class='related-work-list'><tr id='_1486'><td id='_1485'>command line</td></tr><tr id='_1488'><td id='_1487'>Ruby</td></tr></table></td><td id='_1491'>no</td><td id='_1492'>no</td><td id='_1493'>yes</td><td id='_1494'>yes</td><td id='_1495'>no</td><td id='_1496'>yes</td><td id='_1497'>ad hoc</td><td id='_1501'><table id='_1500' class='related-work-list'><tr id='_1499'><td id='_1498'>Property name-spaces</td></tr></table></td></tr><tr id='_1530'><td id='_1513'><table id='_1512' class='related-work-system'><tr id='_1507'><th id='_1506'>CleverCSS <span id='bibref1792'  hssclass='hoptex-bib-ref'><a id='_1794' href='http://sandbox.pocoo.org/clevercss/' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1793"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1793"), "\uEBADdisplay", "none");

 undefined; }'>5</a><div id='bibref1793' hssclass='hoptex-bib-popup'><table id='_1802'><tr id='_1801'><td id='_1795' class='hoptex-bib-entry-key'>5</td><td id='_1800' class='hoptex-bib-entry-value'><span id='_1796' class='hoptex-bib-entry-author'>Ronacher, A. </span><a id='_1798' class='hoptex-bib-entry-title' href='http://sandbox.pocoo.org/clevercss/'>CleverCSS<span id='_1797' class='hoptex-bib-entry-url'>http://sandbox.pocoo.org/clevercss/</span></a><span id='_1799' class='hoptex-bib-entry-date'> 2007</span>.</td></tr></table></div></span></th></tr><tr id='_1511'><td id='_1510'><a id='_1509' href='http://sandbox.pocoo.org/clevercss'><tt id='_1508'>http://sandbox.pocoo.org/clevercss</tt></a></td></tr></table></td><td id='_1514'>python</td><td id='_1518'><table id='_1517' class='related-work-list'><tr id='_1516'><td id='_1515'>python</td></tr></table></td><td id='_1519'>no</td><td id='_1520'>no</td><td id='_1521'>yes</td><td id='_1522'>yes</td><td id='_1523'>ruby</td><td id='_1524'>-</td><td id='_1525'>python</td><td id='_1529'><table id='_1528' class='related-work-list'><tr id='_1527'><td id='_1526'></td></tr></table></td></tr><tr id='_1560' class='last'><td id='_1541'><table id='_1540' class='related-work-system'><tr id='_1535'><th id='_1534'>HSS <span id='bibref1816'  hssclass='hoptex-bib-ref'><a id='_1818' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html' class='extern' onmouseover='{ var result3250;
result3250 = sc_arity_check(BGl_hoptexzd2popupzd2zzhoptex_clientz00, 3)(("bibref1817"), event, 15);

 undefined; }' onmouseout='{ var result3264;
result3264 = sc_arity_check(node_style_set, 3)(("bibref1817"), "\uEBADdisplay", "none");

 undefined; }'>7</a><div id='bibref1817' hssclass='hoptex-bib-popup'><table id='_1828'><tr id='_1827'><td id='_1819' class='hoptex-bib-entry-key'>7</td><td id='_1826' class='hoptex-bib-entry-value'><span id='_1820' class='hoptex-bib-entry-author'>Serrano, M. </span><a id='_1822' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html'>The HOP Development Kit<span id='_1821' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html</span></a><span id='_1823' class='hoptex-bib-entry-booktitle'>Invited paper of the Seventh ACM sigplan Workshop on Scheme and Functional Programming</span><span id='_1824' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1825' class='hoptex-bib-entry-date'>Sep 2006</span>.</td></tr></table></div></span></th></tr><tr id='_1539'><td id='_1538'><a id='_1537' href='http://hop.inria.fr'><tt id='_1536'>http://hop.inria.fr</tt></a></td></tr></table></td><td id='_1542'>CSS</td><td id='_1548'><table id='_1547' class='related-work-list'><tr id='_1544'><td id='_1543'>stand-alone</td></tr><tr id='_1546'><td id='_1545'>hop</td></tr></table></td><td id='_1549'>yes</td><td id='_1550'>yes</td><td id='_1551'>no</td><td id='_1552'>yes</td><td id='_1553'>hop</td><td id='_1554'>yes</td><td id='_1555'>hop</td><td id='_1559'><table id='_1558' class='related-work-list'><tr id='_1557'><td id='_1556'>skinning</td></tr></table></td></tr></table></td></tr></table><div id='_1566' hssclass='hoptex-figure-caption'><a id='_2040' class='hoptex-figure-ref' href='#fig-related-work' title='Figure 16: This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.'><span id='_1938' hssclass='hoptex-figure-counter'>16</span></a>This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.</div><a id='_1567' name='fig-related-work'></a></div>



<p id='_1569'>All these sys&shy;tems, in&shy;clud&shy;ing HSS, share many fea&shy;tures that help
writ&shy;ing more com&shy;pact and portable CSS files. Fig&shy;ure
<a id='_2041' class='hoptex-figure-ref' href='#fig-related-work' title='Figure 16: This table summarizes the main
characteristics of CSS compilers. Syntax denotes the input syntax of
the compilers. The "Host" column gives indication on how the tool can
be used. The column "Utype" shows which system allows users to define
HTML elements. The column "Uprop" shows which system implements user
properties. "Nesting" denotes the support of nested
selectors declaration. "Var." denotes the possibility to declare variables inside
style files. "Fun." denotes the possibility to develop private functions
and, for those systems that support this feature, the programming
language used for defining functions. "Block" denotes the possibility 
for a variable to contain a CSS value or a complete CSS block. "Expr." 
denotes the possibility to embedded expressions in property declarations 
and the language used for these expressions.'><span id='_1938' hssclass='hoptex-figure-counter'>16</span></a> sum&shy;ma&shy;rizes their main char&shy;ac&shy;ter&shy;is&shy;tic&shy;s.
As HSS some of these oth&shy;er sys&shy;tems raise the ab&shy;strac&shy;tion lev&shy;el used in
CSS files by sup&shy;port&shy;ing func&shy;tions and vari&shy;ables. How&shy;ev&shy;er, we think
that HSS goes one step fur&shy;ther by pre&shy;sent&shy;ing a co&shy;her&shy;ent ex&shy;ten&shy;sion
frame&shy;work that let de&shy;vel&shy;op&shy;ers de&shy;clare func&shy;tions, and vari&shy;ables as well
as new el&shy;e&shy;ment prop&shy;er&shy;ties and new el&shy;e&shy;ment type&shy;s.
</p>

<a id='_1570' name='Conclusion'></a><h1 id='_1571' name='Conclusion'><span id='_1987' hssclass='hoptex-section1'>7</span> Conclusion </h1>

<p id='_1572'>This pa&shy;per has pre&shy;sent&shy;ed HSS that ex&shy;tends CSS with user de&shy;fined
vari&shy;ables, func&shy;tions, and el&shy;e&shy;ment type&shy;s. The pa&shy;per has shown that
gen&shy;er&shy;at&shy;ing CSS files im&shy;proves porta&shy;bil&shy;i&shy;ty and main&shy;tain&shy;abil&shy;i&shy;ty and
rais&shy;es the ab&shy;strac&shy;tion lev&shy;el of CSS.
</p>
<p id='_1573'>The pa&shy;per has pre&shy;sent&shy;ed the HSS com&shy;pi&shy;la&shy;tion al&shy;go&shy;rithm which is
sim&shy;ple enough to be re-im&shy;ple&shy;ment&shy;ed with any we&shy;b-ded&shy;i&shy;cat&shy;ed pro&shy;gram&shy;ming
lan&shy;guage.
</p>
<p id='_1576'>The cur&shy;rent HSS source code is shipped with Hop whose 
de&shy;vel&shy;op&shy;ment kit is avail&shy;able at <tt id='_1575'><a id='_1574' href='http://hop.inria.fr'>http://hop.inria.fr</a></tt>.
</p>
<a id='_1577' name='Acknowledgments'></a><h1 id='_1578' name='Acknowledgments'><span id='_1988' hssclass='hoptex-section1'>8</span> Acknowledgments </h1>

Thanks for the anonymous PPDP'10 referees whose help greatly improved
this paper.



<h1 id='_1579' class='hoptex-bibliography'><span id='_1989' hssclass='hoptex-section1'>9</span>References</h1><div id='References' hssclass='hoptex-bibliography'><div id='_1922' hssclass='hoptex-bib'><div id='_1921' hssclass='hoptex-bib-content'><table id='bibentry1829' ><tr id='_1839' class='hoptex-bib-entry hoptex-bib-entry-inproceedings'><td id='_1831' class='hoptex-bib-entry-key'><a id='_1830' name='hoptex-bib-entry-1'>1</a></td><td id='_1838' class='hoptex-bib-entry-value'><span id='_1833' class='hoptex-bib-entry-author'>Boudol, G. <span id='_1832' class='hoptex-bib-entry-et-al'>et al.</span></span><span id='_1834' class='hoptex-bib-entry-title'>Towards Reasoning for Web Applications: an Operational Semantics for Hop</span><span id='_1835' class='hoptex-bib-entry-booktitle'>Proceedings of the first Workshop on Analysis and Programming Languages for Web Applications and Cloud Applications</span><span id='_1836' class='hoptex-bib-entry-address'>Toronto, Canada</span><span id='_1837' class='hoptex-bib-entry-date'>Jun 2010</span>.</td></tr></table><table id='bibentry1840' ><tr id='_1848' class='hoptex-bib-entry hoptex-bib-entry-misc'><td id='_1842' class='hoptex-bib-entry-key'><a id='_1841' name='hoptex-bib-entry-2'>2</a></td><td id='_1847' class='hoptex-bib-entry-value'><span id='_1843' class='hoptex-bib-entry-author'>Cannasse, N. </span><a id='_1845' class='hoptex-bib-entry-title' href='http://ncannasse.fr/projects/hss'>Haxe HSS<span id='_1844' class='hoptex-bib-entry-url'>http://ncannasse.fr/projects/hss</span></a><span id='_1846' class='hoptex-bib-entry-date'>Oct 2008</span>.</td></tr></table><table id='bibentry1849' ><tr id='_1857' class='hoptex-bib-entry hoptex-bib-entry-misc'><td id='_1851' class='hoptex-bib-entry-key'><a id='_1850' name='hoptex-bib-entry-3'>3</a></td><td id='_1856' class='hoptex-bib-entry-value'><span id='_1852' class='hoptex-bib-entry-author'>Catlin, H.  and Weizenbaum, N. </span><a id='_1854' class='hoptex-bib-entry-title' href='http://sass-lang.com/'>Sass -- Syntactically Awesome StyleSheets<span id='_1853' class='hoptex-bib-entry-url'>http://sass-lang.com/</span></a><span id='_1855' class='hoptex-bib-entry-date'> 2006</span>.</td></tr></table><table id='bibentry1858' ><tr id='_1869' class='hoptex-bib-entry hoptex-bib-entry-inbook'><td id='_1860' class='hoptex-bib-entry-key'><a id='_1859' name='hoptex-bib-entry-4'>4</a></td><td id='_1868' class='hoptex-bib-entry-value'><span id='_1861' class='hoptex-bib-entry-author'>Loitsch, F.  and Serrano, M. </span><span id='_1862' class='hoptex-bib-entry-title'>Trends in Functional Programming</span><span id='_1863' class='hoptex-bib-entry-chapter'>Hop Client-Side Compilation</span><span id='_1864' class='hoptex-bib-entry-publisher'>Seton Hall University, Intellect Bristol, ed. Morazán, M. T.</span><span id='_1865' class='hoptex-bib-entry-address'>UK/Chicago, USA</span><span id='_1866' class='hoptex-bib-entry-date'> 2008</span><span id='_1867' class='hoptex-bib-entry-pages'>141--158</span>.</td></tr></table><table id='bibentry1870' ><tr id='_1878' class='hoptex-bib-entry hoptex-bib-entry-misc'><td id='_1872' class='hoptex-bib-entry-key'><a id='_1871' name='hoptex-bib-entry-5'>5</a></td><td id='_1877' class='hoptex-bib-entry-value'><span id='_1873' class='hoptex-bib-entry-author'>Ronacher, A. </span><a id='_1875' class='hoptex-bib-entry-title' href='http://sandbox.pocoo.org/clevercss/'>CleverCSS<span id='_1874' class='hoptex-bib-entry-url'>http://sandbox.pocoo.org/clevercss/</span></a><span id='_1876' class='hoptex-bib-entry-date'> 2007</span>.</td></tr></table><table id='bibentry1879' ><tr id='_1887' class='hoptex-bib-entry hoptex-bib-entry-misc'><td id='_1881' class='hoptex-bib-entry-key'><a id='_1880' name='hoptex-bib-entry-6'>6</a></td><td id='_1886' class='hoptex-bib-entry-value'><span id='_1882' class='hoptex-bib-entry-author'>Selleir, A.  and Fadeyev, D. </span><a id='_1884' class='hoptex-bib-entry-title' href='http://lesscss.org/index.html'>Less<span id='_1883' class='hoptex-bib-entry-url'>http://lesscss.org/index.html</span></a><span id='_1885' class='hoptex-bib-entry-date'> 2009</span>.</td></tr></table><table id='bibentry1888' ><tr id='_1898' class='hoptex-bib-entry hoptex-bib-entry-inproceedings'><td id='_1890' class='hoptex-bib-entry-key'><a id='_1889' name='hoptex-bib-entry-7'>7</a></td><td id='_1897' class='hoptex-bib-entry-value'><span id='_1891' class='hoptex-bib-entry-author'>Serrano, M. </span><a id='_1893' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html'>The HOP Development Kit<span id='_1892' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/sfp06/article.html</span></a><span id='_1894' class='hoptex-bib-entry-booktitle'>Invited paper of the Seventh ACM sigplan Workshop on Scheme and Functional Programming</span><span id='_1895' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1896' class='hoptex-bib-entry-date'>Sep 2006</span>.</td></tr></table><table id='bibentry1899' ><tr id='_1909' class='hoptex-bib-entry hoptex-bib-entry-inproceedings'><td id='_1901' class='hoptex-bib-entry-key'><a id='_1900' name='hoptex-bib-entry-8'>8</a></td><td id='_1908' class='hoptex-bib-entry-value'><span id='_1902' class='hoptex-bib-entry-author'>Serrano, M.  and Gallesio, E.  and Loitsch, F. </span><a id='_1904' class='hoptex-bib-entry-title' href='http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html'>HOP, a language for programming the Web 2.0<span id='_1903' class='hoptex-bib-entry-url'>http://www.inria.fr/mimosa/Manuel.Serrano/publi/dls06/article.html</span></a><span id='_1905' class='hoptex-bib-entry-booktitle'>Proceedings of the First Dynamic Languages Symposium</span><span id='_1906' class='hoptex-bib-entry-address'>Portland, Oregon, USA</span><span id='_1907' class='hoptex-bib-entry-date'>Oct 2006</span>.</td></tr></table><table id='bibentry1910' ><tr id='_1920' class='hoptex-bib-entry hoptex-bib-entry-techreport'><td id='_1912' class='hoptex-bib-entry-key'><a id='_1911' name='hoptex-bib-entry-9'>9</a></td><td id='_1919' class='hoptex-bib-entry-value'><span id='_1913' class='hoptex-bib-entry-author'>World Wide Web Consortium, </span><a id='_1915' class='hoptex-bib-entry-title' href='http://www.w3.org/TR/2009/CR-CSS2-20090423/'>Cascading Style Sheets level 2 Revision 1 CSS2.1 Specification<span id='_1914' class='hoptex-bib-entry-url'>http://www.w3.org/TR/2009/CR-CSS2-20090423/</span></a><span id='_1916' class='hoptex-bib-entry-number'>CR-CSS2-20090423</span><span id='_1917' class='hoptex-bib-entry-institution'>W3C Recommendation</span><span id='_1918' class='hoptex-bib-entry-date'>Apr 2009</span>.</td></tr></table></div></div></div>


</div></div><div id='FOOT2114' class='foot'><div id='_2117' align='center' class='foot-buttons'><a id='_2116' class='foot-button' href='http://hop.inria.fr' title='HOP home page'><img id='img2115' src='/usr/local/share/hop/buttons/hop.png' alt='HOP home page'/></a><a id='_2113' class='foot-button' href='http://hop.inria.fr' title='HopTeX'><img id='img2112' src='/users/serrano/prgm/project/hop/weblets/hoptex/etc/buttons/hoptex.png' alt='HopTeX'/></a></div></div></body></html>
